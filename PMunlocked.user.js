// ==UserScript==
// @name PM-Unlocked
// @namespace https://github.com/SurvExe1Pc/userscripts
// @description Adds some useful functions to PenguinMod that are disabled due to security issues.
// @version v2.0
// @icon https://penguinmod.com/favicon.ico
// @match *://*/*
// @grant unsafeWindow
// @grant GM_xmlhttpRequest
// @sandbox raw
// @run-at document-end
// ==/UserScript==
// Made By SurvExE1Pc.
// Modified by JoseErnestoOnGithub
(function(){
    //Support for other loaders and the console
    let unsafeWindow = /*UnsafeWindow object*/(function(){ try { unsafeWindow; return unsafeWindow} catch { return window }; })();
    let GM = /*GM Object*/(function(){ try { GM; return(GM) } catch { return {info:{scriptHandler:"None"}} }; })();

    //Tampermonkey functions, since these don't exist in GreaseMonkey I am manually implementing these.
    let GM_log = /*Log function*/(function(){ try { GM_log; return(GM_log) } catch { return function(...args){
        console.log(...args);
    } }; })();
    let GM_addElement = /*Add elm function*/(function(){ try { GM_addElement; return(GM_addElement) } catch { return function(element_type, attributes){
        const element = unsafeWindow.document.createElement(element_type);
        let attr_names = Object.keys(attributes);
        let attr_values = Object.values(attributes);
        for (let attr_idx in attr_names) {
            element[attr_names[attr_idx]] = attr_values[attr_idx];
        };
        unsafeWindow.document.body.appendChild(element);
    } }; })();

    //Main code
    let scriptURL = `data:text/javascript;base64,Ly8gPT1Vc2VyU2NyaXB0PT0NCi8vIEBuYW1lIFBNLVVubG9ja2VkIGNvbnNvbGUgY29tcG9uZW50DQovLyBAbmFtZXNwYWNlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdXJ2RXhlMVBjL3VzZXJzY3JpcHRzDQovLyBAZGVzY3JpcHRpb24gVEhJUyBXSUxMIE5PVCBXT1JLIEFTIFlPVSBBUkUgVVNJTkcgVEhFIENPTlNPTEUgVkVSU0lPTg0KLy8gQHZlcnNpb24gdjEuMC4wDQovLyBAaWNvbiBodHRwczovL3R1cmJvd2FycC5vcmcvZmF2aWNvbi5pY28NCi8vIEBtYXRjaCAqOi8vdHVyYm93YXJwLm9yZy8qDQovLyBAbWF0Y2ggKjovL3d3dy50dXJib3dhcnAub3JnLyoNCi8vIEBtYXRjaCAqOi8vc3R1ZGlvLnBlbmd1aW5tb2QuY29tLyoNCi8vIEBncmFudCAqDQovLyBAcnVuLWF0IGRvY3VtZW50LWVuZA0KLy8gPT0vVXNlclNjcmlwdD09DQoNCi8qIQ0KICogID09SU1QT1JUIFZJQSBCT09LTUFSS0xFVCBPUiBDT05TT0xFPT0NCiAqIFRXLVVubG9ja2VkDQogKiBPdGhlci1zY3JpcHRzOiBodHRwczovL2dpdGh1Yi5jb20vU3VydkV4ZTFQYy91c2Vyc2NyaXB0cw0KICogQWRkcyBzb21lIHVzZWZ1bCBmdW5jdGlvbnMgdG8gUGVuZ3Vpbk1vZCB0aGF0IGFyZSBkaXNhYmxlZCBkdWUgdG8gc2VjdXJpdHkgaXNzdWVzLg0KICogdmVyc2lvbiBiZWxvdw0KICogTWFkZSBCeSBTdXJ2RXhFMVBjLg0KICovDQoNCi8qISB0b2RvOg0KICogICAgICAgMS4gTWFrZSBpdCBzbyB0aGF0IHRoZSBpbWFnZXMgLyBzb3VuZHMgaGF2ZSBhIGN1c3RvbSB0YWcgYW5kIG9ubHkgc2hvdyBvbiBpdCBvciB0aGUgYWxsIHRhZw0KICogICAgICAgICAgKHNvbWUgY29kZSBmb3IgbGF0ZXIgdG8gZ2V0IHRoZSBzZWxlY3RlZCB0YWc6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2RpdltjbGFzc149ImxpYnJhcnlfdGFnLXdyYXBwZXIiXSBzcGFuW2NsYXNzKj0idGFnLWJ1dHRvbl9hY3RpdmUiXScpLnF1ZXJ5U2VsZWN0b3IoJ3NwYW4nKS5pbm5lckhUTUwgKQ0KICogICAgICAgMi4gU3VwcG9ydCBjdXN0b20gc291bmRzDQogKiAgICAgICAoVGVzdGluZyB0aGUgIlRXdW5sb2NrZWQgdGhpbmtzIHRoaXMgaXMgYSBUdXJib1dhcnAgZWRpdG9yIiBwb3B1cCwgd2lsbCBiZSByZW1vdmVkIGlmIG5lZ2F0aXZlIGZlZWRiYWNrKQ0KICovDQp2YXIgSW1wb3J0VFd1bmxvY2sgPSBhc3luYyBmdW5jdGlvbiAoZGVsb2FkLCB2bSkgew0KICBjb25zdCBWRVJTSU9OID0gNS4zLjA7DQoNCiAgLy9EaXNhYmxlIHVzZXJzY3JpcHQuDQogIHZhciB0bXAgPSBudWxsOw0KICB0cnkgew0KICAgIHRtcCA9IEdNLmluZm8uc2NyaXB0SGFuZGxlcjsNCiAgfSBjYXRjaCB7fQ0KICBpZiAodG1wICE9IG51bGwpIGNvbnNvbGUubG9nKCJVU0UgVEhFIFVTRVJTQ1JJUFQgVkVSU0lPTiBOT1QgVEhFIENPTlNPTEUiKTsNCiAgaWYgKHRtcCAhPSBudWxsKSByZXR1cm47DQoNCiAgdmFyIHdpbiA9IHdpbmRvdzsNCg0KICBjb25zb2xlLmxvZygiU2NyaXB0IGxvYWRlZCBzdWNjZXNzZnVsbHkiKTsNCiAgaWYgKGRlbG9hZCkgew0KICAgIGRlbGV0ZSB3aW4uTG9hZGVkVFd1bmxvY2s7DQogICAgdHJ5IHsNCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJUV3VubG9ja2VkLU1vZGFsRGl2IikucmVtb3ZlKCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiVFd1bmxvY2tlZC1HYWxsZXJ5TW9kYWwiKS5yZW1vdmUoKTsNCiAgICB9IGNhdGNoIHt9DQogICAgdHJ5IHsNCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJUV3VubG9ja2VkLWNvc01hbmFnZXIiKS5yZW1vdmUoKTsNCiAgICB9IGNhdGNoIHt9DQogICAgdHJ5IHsNCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJUV3VubG9ja2VkLWRyb3BNYW5hZ2VyIikucmVtb3ZlKCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiVFd1bmxvY2tlZC1leHRNYW5hZ2VyIikucmVtb3ZlKCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBUV3VubG9ja2VkLmF0dGVtcHRSZW1vdmFsT2ZVU01zY3JpcHQoKTsNCiAgICB9IGNhdGNoIHt9DQogICAgdHJ5IHsNCiAgICAgIFRXdW5sb2NrZWQub3BlbkJ1dHRvbi5yZW1vdmUoKTsNCiAgICB9IGNhdGNoIHt9DQogICAgdHJ5IHsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMubG9hZFVyaUV4dEJ0bi5yZW1vdmUoKTsNCiAgICB9IGNhdGNoIHt9DQogICAgVFd1bmxvY2tlZCA9ICIiOw0KICAgIGRlbGV0ZSBUV3VubG9ja2VkOw0KICB9DQoNCiAgaWYgKHdpbi5Mb2FkZWRUV3VubG9jayAhPSB1bmRlZmluZWQpIHsNCiAgICBhbGVydCgiUE0tVW5sb2NrZWQ6IFNjcmlwdCBoYXMgYWxyZWFkeSBiZWVuIGxvYWRlZCIpOw0KICAgIHJldHVybjsNCiAgfQ0KDQogIHdpbi5Mb2FkZWRUV3VubG9jayA9IHRydWU7DQoNCiAgaWYgKHdpbmRvdy5UV1VleHRlbnNpb25QYWdlID09IHRydWUpIHsNCiAgICBjb25zdCBnYWxsZXJ5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiZXh0ZW5zaW9uLWJ1dHRvbnMiKTsNCg0KICAgIGZ1bmN0aW9uIFRXdU92ZXJyaWRlKGVsbSkgew0KICAgICAgdmFyIGVsbXggPSBlbG0uY2hpbGRyZW5bMV07DQogICAgICBlbG14LmhyZWYgPSBlbG14LmhyZWYucmVwbGFjZSgiP2V4dGVuc2lvbj0iLCAiP3R3dS1leHRlbnNpb249Iik7DQogICAgICBlbG14LnN0eWxlLmRpc3BsYXkgPSAiIjsNCiAgICB9DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBnYWxsZXJ5Lmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBlbG0gPSBnYWxsZXJ5Lml0ZW0oaSk7DQogICAgICBUV3VPdmVycmlkZShlbG0pOw0KICAgIH0NCiAgICByZXR1cm47DQogIH0NCg0KICAvL2RvIHNvbWV0aGluZyB3aXRoIHRoaXMNCiAgZnVuY3Rpb24gYXNzdW1lVHVyYm93YXJwKCkgew0KICAgIHZhciBhc3N1bXB0aW9uID0gMDsNCiAgICB0cnkgew0KICAgICAgUmVkdXhTdG9yZS5nZXRTdGF0ZSgpLnNjcmF0Y2hHdWk7DQogICAgICBhc3N1bXB0aW9uICs9IDAuNTsNCiAgICB9IGNhdGNoIHt9DQogICAgdHJ5IHsNCiAgICAgIHZtLmdyZWVuRmxhZy50b1N0cmluZygpOw0KICAgICAgYXNzdW1wdGlvbiArPSAwLjU7DQogICAgfSBjYXRjaCB7fQ0KICAgIHJldHVybiBhc3N1bXB0aW9uID09IDE7DQogIH0NCg0KICAvL29sZDogIShuZXcgUmVnRXhwKCcoKGh0dHAocz8pXDpcL1wvKT8pKHR1cmJvd2FycFwub3JnKSgoXC8pKGVkaXRvcik/KScsJ2dpJykuZXhlYyhkb2N1bWVudC5sb2NhdGlvbi5ocmVmKSkNCiAgbGV0IGN1c3RvbURvbWFpbnMgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgidHd1OmN1c3RvbURvbWFpbnMiKTsNCiAgaWYgKGN1c3RvbURvbWFpbnMpIHsNCiAgICBjdXN0b21Eb21haW5zID0gSlNPTi5wYXJzZShjdXN0b21Eb21haW5zKTsNCiAgfSBlbHNlIHsNCiAgICBjdXN0b21Eb21haW5zID0gW107DQogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oInR3dTpjdXN0b21Eb21haW5zIiwgIltdIik7DQogIH0NCiAgbGV0IF9pc0Rlc2t0b3AgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLmluY2x1ZGVzKA0KICAgICJUdXJib1dhcnAvcmVzb3VyY2VzL2FwcC5hc2FyIg0KICApOw0KICAvKiENCiAgICogUmVhc29uczoNCiAgICogICBHYW5kaUlERTogICBEYW5nZXJvdXMgZGF0YSBjb2xsZWN0aW9uLg0KICAgKiAgIFNjcmF0Y2g6ICAgIFRoaXMganVzdCB3b250IHdvcmsuDQogICAqLw0KICBpZiAoDQogICAgWw0KICAgICAgImdldGdhbmRpLmNvbSIsDQogICAgICAiY29jcmVhLndvcmxkIiwNCiAgICAgICJzY3JhdGNoLm1pdC5lZHUiLA0KICAgIF0uaW5jbHVkZXMoZG9jdW1lbnQubG9jYXRpb24uaG9zdG5hbWUpDQogICkgew0KICAgIGNvbnNvbGUuZXJyb3IoYFBNLVVubG9ja2VkIHYke1ZFUlNJT059IHwgQmxvY2tlZCBwYWdlLmApOw0KICAgIHJldHVybjsNCiAgfQ0KICBpZiAoDQogICAgIVsNCiAgICAgIC4uLmN1c3RvbURvbWFpbnMsDQogICAgICAidHVyYm93YXJwLm9yZyIsDQogICAgICAic3RhZ2luZy50dXJib3dhcnAub3JnIiwNCiAgICAgICJ0d3BsdXMucGFnZXMuZGV2IiwNCiAgICAgICJzdHVkaW8ucGVuZ3Vpbm1vZC5jb20iLA0KICAgIF0uaW5jbHVkZXMoZG9jdW1lbnQubG9jYXRpb24uaG9zdG5hbWUpICYmDQogICAgIV9pc0Rlc2t0b3ANCiAgKSB7DQogICAgY29uc29sZS5lcnJvcigNCiAgICAgIGBQTS1VbmxvY2tlZCB2JHtWRVJTSU9OfSB8IE5vdCBhIHZhbGlkIHBhZ2UuXG5JZiB0aGlzIGlzIGEgIlBlbmd1aW5Nb2QgZWRpdG9yIiB0aGVuIHJ1biBUV3VubG9ja2VkLmFsbG93Q3VycmVudEhvc3RuYW1lKClgDQogICAgKTsNCiAgICBpZiAoYXNzdW1lVHVyYm93YXJwKCkpIHsNCiAgICAgIHZhciBhc3N1bSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpYWxvZyIpOw0KICAgICAgYXNzdW0uaW5uZXJIVE1MID0NCiAgICAgICAgJzxzdHlsZT5idXR0b257YmFja2dyb3VuZC1jb2xvcjojYmJiYmJifTwvc3R5bGU+UE11bmxvY2tlZCB0aGlua3MgdGhpcyBwYWdlIGlzIGEgUGVuZ3Vpbk1vZCBlZGl0b3IuPGJyPjxidXR0b24gb25jbGljaz0idGhpcy5wYXJlbnRFbGVtZW50LnJlbW92ZSgpOyI+Q2xvc2U8L2J1dHRvbj48YnV0dG9uIG9uY2xpY2s9InRoaXMucGFyZW50RWxlbWVudC5yZW1vdmUoKTt0cnl7VFd1bmxvY2tlZC5hbGxvd0N1cnJlbnRIb3N0bmFtZSgpfWNhdGNoe30iPlllcyBpdCBpcyE8L2J1dHRvbj4nOw0KICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhc3N1bSk7DQogICAgICBhc3N1bS5zaG93KCk7DQogICAgICBhc3N1bS5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7DQogICAgICBhc3N1bS5zdHlsZS56SW5kZXggPSAzMjc2NzsNCiAgICAgIGFzc3VtLnN0eWxlLmxlZnQgPQ0KICAgICAgICB3aW5kb3cuaW5uZXJXaWR0aCAtIGFzc3VtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoICogMiArICJweCI7DQogICAgfQ0KICAgIHdpbmRvdy5UV3VubG9ja2VkID0gew0KICAgICAgYWxsb3dDdXJyZW50SG9zdG5hbWUoKSB7DQogICAgICAgIGN1c3RvbURvbWFpbnMgPSBKU09OLnBhcnNlKGN1c3RvbURvbWFpbnMpOw0KICAgICAgICBjdXN0b21Eb21haW5zLnB1c2goZG9jdW1lbnQubG9jYXRpb24uaG9zdG5hbWUpOw0KICAgICAgICBjdXN0b21Eb21haW5zID0gSlNPTi5zdHJpbmdpZnkoY3VzdG9tRG9tYWlucyk7DQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ0d3U6Y3VzdG9tRG9tYWlucyIsIGN1c3RvbURvbWFpbnMpOw0KICAgICAgICBjb25zb2xlLmxvZygiUGxlYXNlIHJlZnJlc2ggdGhlIHBhZ2UgZm9yIHRoaXMgdG8gdGFrZSBlZmZlY3QuIik7DQogICAgICB9LA0KICAgICAgVkVSU0lPTiwNCiAgICB9Ow0KICAgIHJldHVybjsNCiAgfQ0KDQogIGNvbnNvbGUubG9nKGBQTS1VbmxvY2tlZCB2JHtWRVJTSU9OfSB8IExvYWRpbmcuLmApOw0KDQogIHdpbmRvdy5UV3VubG9ja2VkID0gew0KICAgIHJlbW92ZUN1cnJlbnRIb3N0bmFtZUZyb21BbGxvd2VkKCkgew0KICAgICAgbGV0IGhvc3QgPSBkb2N1bWVudC5sb2NhdGlvbi5ob3N0bmFtZTsNCiAgICAgIGlmICghY3VzdG9tRG9tYWlucy5pbmNsdWRlcyhob3N0KSkgew0KICAgICAgICBjb25zb2xlLmxvZygnVGhpcyBwYWdlIGlzIG5vdCBhICJjdXN0b20gdHVyYm93YXJwIGVkaXRvciIuJyk7DQogICAgICB9DQogICAgICBjdXN0b21Eb21haW5zID0gSlNPTi5wYXJzZShjdXN0b21Eb21haW5zKTsNCiAgICAgIGN1c3RvbURvbWFpbnMucG9wKGN1c3RvbURvbWFpbnMuaW5kZXhPZihob3N0KSk7DQogICAgICBjdXN0b21Eb21haW5zID0gSlNPTi5zdHJpbmdpZnkoY3VzdG9tRG9tYWlucyk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgidHd1OmN1c3RvbURvbWFpbnMiLCBjdXN0b21Eb21haW5zKTsNCiAgICAgIGNvbnNvbGUubG9nKCJQbGVhc2UgcmVmcmVzaCB0aGUgcGFnZSBmb3IgdGhpcyB0byB0YWtlIGVmZmVjdC4iKTsNCiAgICB9LA0KICAgIFZFUlNJT04sDQogIH07DQogIFRXdW5sb2NrZWQuaXNEZXNrdG9wID0gX2lzRGVza3RvcDsNCiAgVFd1bmxvY2tlZC51dGlscyA9IHt9Ow0KDQogIC8vVXRpbGl0aWVzDQogIFRXdW5sb2NrZWQudXRpbHMuaWRHZW4gPSBmdW5jdGlvbiogaWRHZW5lcmF0b3IoKSB7DQogICAgbGV0IGluZGV4ID0gMDsNCiAgICB3aGlsZSAodHJ1ZSkgew0KICAgICAgaW5kZXggKz0gMTsNCiAgICAgIHlpZWxkIGluZGV4Ow0KICAgIH0NCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5zZXRDb29raWUgPSBmdW5jdGlvbiAoY25hbWUsIGN2YWx1ZSwgZXhkYXlzKSB7DQogICAgY29uc3QgZCA9IG5ldyBEYXRlKCk7DQogICAgZC5zZXRUaW1lKGQuZ2V0VGltZSgpICsgZXhkYXlzICogMjQgKiA2MCAqIDYwICogMTAwMCk7DQogICAgbGV0IGV4cGlyZXMgPSAiZXhwaXJlcz0iICsgZC50b1VUQ1N0cmluZygpOw0KICAgIGRvY3VtZW50LmNvb2tpZSA9IGNuYW1lICsgIj0iICsgY3ZhbHVlICsgIjsiICsgZXhwaXJlcyArICI7cGF0aD0vIjsNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5nZXRDb29raWUgPSBmdW5jdGlvbiAoY25hbWUpIHsNCiAgICBsZXQgbmFtZSA9IGNuYW1lICsgIj0iOw0KICAgIGxldCBkZWNvZGVkQ29va2llID0gZGVjb2RlVVJJQ29tcG9uZW50KGRvY3VtZW50LmNvb2tpZSk7DQogICAgbGV0IGNhID0gZGVjb2RlZENvb2tpZS5zcGxpdCgiOyIpOw0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2EubGVuZ3RoOyBpKyspIHsNCiAgICAgIGxldCBjID0gY2FbaV07DQogICAgICB3aGlsZSAoYy5jaGFyQXQoMCkgPT0gIiAiKSB7DQogICAgICAgIGMgPSBjLnN1YnN0cmluZygxKTsNCiAgICAgIH0NCiAgICAgIGlmIChjLmluZGV4T2YobmFtZSkgPT0gMCkgew0KICAgICAgICByZXR1cm4gYy5zdWJzdHJpbmcobmFtZS5sZW5ndGgsIGMubGVuZ3RoKTsNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuICIiOw0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLmFUZiA9IGFzeW5jIGZ1bmN0aW9uICgpIHsNCiAgICByZXR1cm4gdHJ1ZTsNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5vU21QdiA9IHsNCiAgICBjZjogdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbkZldGNoLA0KICAgIGNsZWZwOiB2bS5zZWN1cml0eU1hbmFnZXIuY2FuTG9hZEV4dGVuc2lvbkZyb21Qcm9qZWN0LA0KICAgIGNuOiB2bS5zZWN1cml0eU1hbmFnZXIuY2FuTm90aWZ5LA0KICAgIGNvdzogdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbk9wZW5XaW5kb3csDQogICAgY3JjOiB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVhZENsaXBib2FyZCwNCiAgICBjcmE6IHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWNvcmRBdWRpbywNCiAgICBjcnY6IHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWNvcmRWaWRlbywNCiAgICBjcjogdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlZGlyZWN0LA0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaWFsb2ciKTsNCiAgY29uc3QgZmV0Y2hIb3ZlckNsYXNlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgIltjbGFzc149bWVudS1iYXJfbWVudS1iYXItaXRlbV0iDQogICkuY2xhc3NMaXN0Ow0KICBUV3VubG9ja2VkLnV0aWxzLmZpbGVHcm91cCA9IFRXdW5sb2NrZWQuaXNEZXNrdG9wDQogICAgPyAnZGl2W2NsYXNzXj0ibWVudS1iYXJfZmlsZS1ncm91cCJdJw0KICAgIDogJ2RpdltjbGFzc149Im1lbnUtYmFyX2ZpbGUtZ3JvdXAiXSc7DQogIFRXdW5sb2NrZWQudXRpbHMuaG92ZXJhYmxlQ2xhc3MgPSBmZXRjaEhvdmVyQ2xhc2VzWzFdOw0KICBUV3VubG9ja2VkLnV0aWxzLm1lbnVJdGVtQ2xhc3MgPSBmZXRjaEhvdmVyQ2xhc2VzWzBdOw0KICBUV3VubG9ja2VkLnR3TWVudUJ0biA9IGNsYXNzIHsNCiAgICAjZG9jX2VsbTsNCiAgICBjb25zdHJ1Y3RvcigpIHsNCiAgICAgIGNvbnN0IGVtcHR5X2RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgICAgdGhpcy4jZG9jX2VsbSA9IGVtcHR5X2RpdjsNCiAgICAgIHRoaXMuI2RvY19lbG0uY2xhc3NMaXN0LmFkZChUV3VubG9ja2VkLnV0aWxzLm1lbnVJdGVtQ2xhc3MpOw0KICAgICAgdGhpcy4jZG9jX2VsbS5jbGFzc0xpc3QuYWRkKFRXdW5sb2NrZWQudXRpbHMuaG92ZXJhYmxlQ2xhc3MpOw0KICAgICAgdGhpcy4jZG9jX2VsbS5pbm5lckhUTUwgPSAiPGRpdj48c3Bhbj5OZXcgQnV0dG9uPC9zcGFuPjwvZGl2PiI7DQogICAgICB0aGlzLiNkb2NfZWxtLmJhY2t1cF9yZW1vdmUgPSB0aGlzLiNkb2NfZWxtLnJlbW92ZTsNCiAgICAgIHRoaXMuI2RvY19lbG0ucmVtb3ZlID0gKCkgPT4gew0KICAgICAgICByZXR1cm4gIm92ZXJyaWRkZW4sIG5leHRpbWUgdXNlIHRoZSByZW1vdmUgZnVuY3Rpb24gaW4gdGhlIGNsYXNzLiI7DQogICAgICB9Ow0KICAgIH0NCiAgICB2aXNpYmlsaXR5KHVwZGF0ZSkgew0KICAgICAgY29uc3QgY3VycmVudERpc3BsYXkgPSB0aGlzLiNkb2NfZWxtLnN0eWxlLmRpc3BsYXk7DQogICAgICBjb25zdCBpc0ZsZXggPSBjdXJyZW50RGlzcGxheSA9PSAiIjsNCiAgICAgIGlmICh1cGRhdGUgPT0gImdldCIpIHJldHVybiBpc0ZsZXg7DQogICAgICBpZiAoIXVwZGF0ZSkgew0KICAgICAgICB0aGlzLiNkb2NfZWxtLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGlmICh1cGRhdGUpIHsNCiAgICAgICAgdGhpcy4jZG9jX2VsbS5zdHlsZS5kaXNwbGF5ID0gIiI7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICB9DQogICAgcmVtb3ZlKCkgew0KICAgICAgdGhpcy4jZG9jX2VsbS5iYWNrdXBfcmVtb3ZlKCk7DQogICAgfQ0KICAgIHNldENsaWNrQ2FsbGJhY2soY2FsbGJhY2spIHsNCiAgICAgIHRoaXMuI2RvY19lbG0ub25jbGljayA9IGNhbGxiYWNrOw0KICAgIH0NCiAgICBzZXRUZXh0KHRleHQpIHsNCiAgICAgIHRoaXMuI2RvY19lbG0uaW5uZXJUZXh0ID0gdGV4dDsNCiAgICAgIHRoaXMuI2RvY19lbG0uaW5uZXJIVE1MID0gYDxkaXY+PHNwYW4+JHsNCiAgICAgICAgdGhpcy4jZG9jX2VsbS5pbm5lclRleHQNCiAgICAgIH08L3NwYW4+PC9kaXY+YDsNCiAgICB9DQogICAgZXhwb3J0SFRNTCgpIHsNCiAgICAgIHJldHVybiB0aGlzLiNkb2NfZWxtLmlubmVySFRNTDsNCiAgICB9DQogICAgZXhwb3J0RG9jRWxtKCkgew0KICAgICAgcmV0dXJuIHRoaXMuI2RvY19lbG07DQogICAgfQ0KICAgIHNldElEKGVsbV9pZCkgew0KICAgICAgdGhpcy4jZG9jX2VsbS5pZCA9IGVsbV9pZDsNCiAgICB9DQogICAgYWRkU2VsZlRvTmF2KCkgew0KICAgICAgZG9jdW1lbnQNCiAgICAgICAgLnF1ZXJ5U2VsZWN0b3IoVFd1bmxvY2tlZC51dGlscy5maWxlR3JvdXApDQogICAgICAgIC5hcHBlbmRDaGlsZCh0aGlzLiNkb2NfZWxtKTsNCiAgICB9DQogIH07DQogIFRXdW5sb2NrZWQuYWRkTWVudUJ0biA9IGZ1bmN0aW9uIChidXR0b25fdGV4dCwgY2FsbGJhY2spIHsNCiAgICB2YXIgYnV0dG9uID0gbmV3IHRoaXMudHdNZW51QnRuKCk7DQogICAgYnV0dG9uLnNldFRleHQoYnV0dG9uX3RleHQpOw0KICAgIGJ1dHRvbi5zZXRDbGlja0NhbGxiYWNrKGNhbGxiYWNrKTsNCiAgICB2YXIgdG1wID0gYnV0dG9uOw0KICAgIGJ1dHRvbiA9IGJ1dHRvbi5leHBvcnREb2NFbG0oKTsNCiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFRXdW5sb2NrZWQudXRpbHMuZmlsZUdyb3VwKS5hcHBlbmRDaGlsZChidXR0b24pOw0KICAgIHJldHVybiB0bXA7DQogIH07DQoNCiAgLy9HZXQgcHJvamVjdCBkYXRhDQogIFRXdW5sb2NrZWQudXRpbHMuZ2V0UHJvamVjdE1ldGFkYXRhID0gYXN5bmMgKHByb2plY3RJZCkgPT4gew0KICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goDQogICAgICBgaHR0cHM6Ly90cmFtcG9saW5lLnR1cmJvd2FycC5vcmcvYXBpL3Byb2plY3RzLyR7cHJvamVjdElkfWANCiAgICApOw0KICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwNCkgew0KICAgICAgdGhyb3cgbmV3IEVycm9yKCJQTS1VbmxvY2tlZDogRXJyb3IgZmV0Y2hpbmcgcHJvamVjdDogVGhlIHByb2plY3QgcmVxdWVzdGVkIGlzIHVuc2hhcmVkIG9yIGRvZXMgbm90IGV4aXN0LiIpOw0KICAgIH0NCiAgICBpZiAoIXJlc3BvbnNlLm9rKSB7DQogICAgICB0aHJvdyBuZXcgRXJyb3IoDQogICAgICAgIGBQTS1VbmxvY2tlZDogRXJyb3IgZmV0Y2hpbmcgcHJvamVjdDogSFRUUCBlcnJvciAke3Jlc3BvbnNlLnN0YXR1c30gZmV0Y2hpbmcgcHJvamVjdCBtZXRhZGF0YWANCiAgICAgICk7DQogICAgfQ0KICAgIGNvbnN0IGpzb24gPSBhd2FpdCByZXNwb25zZS5qc29uKCk7DQogICAgcmV0dXJuIGpzb247DQogIH07DQogIFRXdW5sb2NrZWQuZ2V0UHJvamVjdERhdGEgPSBhc3luYyAocHJvamVjdElkKSA9PiB7DQogICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCBUV3VubG9ja2VkLnV0aWxzLmdldFByb2plY3RNZXRhZGF0YShwcm9qZWN0SWQpOw0KICAgIGNvbnN0IHRva2VuID0gbWV0YWRhdGEucHJvamVjdF90b2tlbjsNCiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKA0KICAgICAgYGh0dHBzOi8vcHJvamVjdHMuc2NyYXRjaC5taXQuZWR1LyR7cHJvamVjdElkfT90b2tlbj0ke3Rva2VufWANCiAgICApOw0KICAgIGlmICghcmVzcG9uc2Uub2spIHsNCiAgICAgIHRocm93IG5ldyBFcnJvcihgUE0tVW5sb2NrZWQ6IEVycm9yIGZldGNoaW5nIHByb2plY3Q6IEhUVFAgZXJyb3IgJHtyZXNwb25zZS5zdGF0dXN9IGZldGNoaW5nIHByb2plY3QgZGF0YWApOw0KICAgIH0NCiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuYXJyYXlCdWZmZXIoKTsNCiAgICByZXR1cm4gZGF0YTsNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5kYXRlU3RyaW5nTm8gPSBmdW5jdGlvbiAoKSB7DQogICAgcmV0dXJuIG5ldyBEYXRlKCkudG9KU09OKCkucmVwbGFjZSgvLXxcLnx0fHp8Oi9naSwgIiIpOw0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLnJhbmRvbSA9IHt9Ow0KICBUV3VubG9ja2VkLnV0aWxzLnJhbmRvbS5mbG9hdCA9IGZ1bmN0aW9uIChtaW4sIG1heCkgew0KICAgIHJldHVybiBNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikgKyBtaW47DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMucmFuZG9tLmludCA9IGZ1bmN0aW9uIChtaW4sIG1heCkgew0KICAgIHJldHVybiBNYXRoLnJvdW5kKFRXdW5sb2NrZWQudXRpbHMucmFuZG9tLmZsb2F0KTsNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5iaWdubyA9IGZ1bmN0aW9uICgpIHsNCiAgICByZXR1cm4gVFd1bmxvY2tlZC51dGlscy5yYW5kb20uaW50KA0KICAgICAgTnVtYmVyLk1JTl9TQUZFX0lOVEVHRVIsDQogICAgICBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUg0KICAgICk7DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMuZ2V0Q2FjaGVQYXJhbXMgPSBmdW5jdGlvbiAodXJsKSB7DQogICAgdmFyIF91cmxQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHVybCk7DQogICAgX3VybFBhcmFtcy5hcHBlbmQoImJ5cGFzc0NhY2hlIiwgIiIpOw0KICAgIC8vQ09VTlRFUg0KICAgIGNvbnN0IHN0b3JhZ2VJdGVtID0gInR3VW5sb2NrZWQtY2FjaGVJZCI7DQogICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHN0b3JhZ2VJdGVtKSA9PSBudWxsKQ0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oc3RvcmFnZUl0ZW0sIDEpOw0KICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKA0KICAgICAgc3RvcmFnZUl0ZW0sDQogICAgICBwYXJzZUZsb2F0KGxvY2FsU3RvcmFnZS5nZXRJdGVtKHN0b3JhZ2VJdGVtKSkgKyAxDQogICAgKTsNCiAgICBfdXJsUGFyYW1zLmFwcGVuZChsb2NhbFN0b3JhZ2UuZ2V0SXRlbShzdG9yYWdlSXRlbSksICIiKTsNCiAgICAvL1RJTUUNCiAgICBfdXJsUGFyYW1zLmFwcGVuZChUV3VubG9ja2VkLnV0aWxzLmRhdGVTdHJpbmdObygpLCAiIik7DQogICAgLy9SZXR1cm5pbmcgdGhlIHBhcmFtcw0KICAgIHJldHVybiAoIj8iICsgX3VybFBhcmFtcy50b1N0cmluZygpKS5yZXBsYWNlKGVuY29kZVVSSUNvbXBvbmVudCh1cmwpLCAiIik7DQogIH07DQoNCiAgaWYgKCFUV3VubG9ja2VkLmlzRGVza3RvcCkgew0KICAgIGNvbnN0IHN0eWxpbmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOw0KICAgIHN0eWxpbmcuaW5uZXJIVE1MID0gYA0KLlRXdW5sb2NrZWRNb2RhbCBidXR0b24gew0KICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDEwNywgMTA3LCAxMDcsIDEpOw0KfWA7DQogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsaW5nKTsNCiAgfQ0KDQogIC8vTG9hZCBFeHRlbnNpb25zIFVuc2FuZGJveGVkDQogIHZtLmV4dGVuc2lvbk1hbmFnZXIubG9hZFVuc2FuZGJveGVkRXh0ZW5zaW9uID0gZnVuY3Rpb24gKHVybCkgew0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5nZXRTYW5kYm94TW9kZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHsNCiAgICAgIHJldHVybiAidW5zYW5kYm94ZWQiOw0KICAgIH07DQogICAgdm0uZXh0ZW5zaW9uTWFuYWdlci5sb2FkRXh0ZW5zaW9uVVJMKA0KICAgICAgYGh0dHBzOi8vY29yc3Byb3h5LmlvLz8ke2VuY29kZVVSSUNvbXBvbmVudCh1cmwpfWANCiAgICApOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5nZXRTYW5kYm94TW9kZSA9IG9sZFNhbmRib3g7IC8vIFJldHVybiB0aGUgc2FuZGJveCB0byBub3JtYWwuDQogIH07DQogIFRXdW5sb2NrZWQubG9hZEV4dGVuc2lvblVuc2FuZGJveGVkID0gYXN5bmMgZnVuY3Rpb24gKHVybCwgYnlwYXNzQ2FjaGUpIHsNCiAgICBieXBhc3NDYWNoZSA9IG5ldyBCb29sZWFuKGJ5cGFzc0NhY2hlKSB8fCB0cnVlOw0KICAgIGNvbnN0IHNldCA9IHZtLmV4dGVuc2lvbk1hbmFnZXIubG9hZFVuc2FuZGJveGVkRXh0ZW5zaW9uKA0KICAgICAgdXJsICsgKGJ5cGFzc0NhY2hlID8gVFd1bmxvY2tlZC51dGlscy5nZXRDYWNoZVBhcmFtcyh1cmwpIDogIiIpDQogICAgKTsNCiAgICByZXR1cm4gc2V0Ow0KICB9Ow0KDQogIFRXdW5sb2NrZWQudXRpbHMubG9hZFVleHRzRnJvbVVybCA9IGZ1bmN0aW9uIChoYXNQYXJhbSkgew0KICAgIGhhc1BhcmFtID0gaGFzUGFyYW0gfHwgMDsNCiAgICBoYXNQYXJhbSA9IGhhc1BhcmFtID09IDAgPyBmYWxzZSA6IGhhc1BhcmFtOw0KDQogICAgZnVuY3Rpb24gZ2V0UGFyYW1zKHF1ZXJ5KSB7DQogICAgICB2YXIgdG1wMiA9IFtdOw0KICAgICAgdmFyIHRtcDMgPSAwOw0KICAgICAgcXVlcnkuZm9yRWFjaCgodiwgaykgPT4gew0KICAgICAgICB0bXAzICs9IDE7DQogICAgICAgIGlmICh0bXAzID09IDEpIHsNCiAgICAgICAgICBrID0gay5yZXBsYWNlKGRvY3VtZW50LmxvY2F0aW9uLmhyZWYuc3BsaXQoIj8iKVswXSArICI/IiwgIiIpOw0KICAgICAgICB9DQogICAgICAgIHRtcDIucHVzaCh7DQogICAgICAgICAga2V5OiBrLA0KICAgICAgICAgIHZhbHVlOiB2LA0KICAgICAgICB9KTsNCiAgICAgIH0pOw0KICAgICAgcmV0dXJuIHRtcDI7DQogICAgfQ0KICAgIGNvbnN0IHBhcmFtcyA9IGdldFBhcmFtcyhuZXcgVVJMU2VhcmNoUGFyYW1zKGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpKTsNCiAgICB2YXIgZm91bmRQYXJhbSA9IGZhbHNlOw0KICAgIHBhcmFtcy5mb3JFYWNoKGZ1bmN0aW9uIChwYXJhbSkgew0KICAgICAgaWYgKHBhcmFtLmtleSA9PSAidHd1LWV4dGVuc2lvbiIpIHsNCiAgICAgICAgaWYgKGhhc1BhcmFtIHx8IGZvdW5kUGFyYW0pIHsNCiAgICAgICAgICBmb3VuZFBhcmFtID0gdHJ1ZTsNCiAgICAgICAgICByZXR1cm4gZm91bmRQYXJhbTsNCiAgICAgICAgfQ0KICAgICAgICB2YXIgZXh0X2xpbmsgPSBwYXJhbS52YWx1ZTsNCiAgICAgICAgaWYgKHZtLnJ1bnRpbWUuZXh0ZW5zaW9uTWFuYWdlci5faXNWYWxpZEV4dGVuc2lvblVSTChleHRfbGluaykpIHsNCiAgICAgICAgICBUV3VubG9ja2VkLmxvYWRFeHRlbnNpb25VbnNhbmRib3hlZChleHRfbGluayk7DQogICAgICAgIH0gZWxzZSBjb25zb2xlLmVycm9yKGBQTS1VbmxvY2tlZDogRXh0ZW5zaW9uIHVybCBpcyBpbnZhbGlkLlxuVVJMOiAke2V4dF9saW5rfWApOw0KICAgICAgfQ0KICAgIH0pOw0KICAgIGlmIChoYXNQYXJhbSkgcmV0dXJuIGZvdW5kUGFyYW07DQogIH07DQoNCiAgVFd1bmxvY2tlZC5kaXNhYmxlUGVybWlzc2lvblNlY3VyaXR5ID0gYXN5bmMgZnVuY3Rpb24gKCkgew0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5GZXRjaCA9IHRoaXMudXRpbHMuYVRmOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5Mb2FkRXh0ZW5zaW9uRnJvbVByb2plY3QgPSB0aGlzLnV0aWxzLmFUZjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuTm90aWZ5ID0gdGhpcy51dGlscy5hVGY7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbk9wZW5XaW5kb3cgPSB0aGlzLnV0aWxzLmFUZjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVhZENsaXBib2FyZCA9IHRoaXMudXRpbHMuYVRmOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWNvcmRBdWRpbyA9IHRoaXMudXRpbHMuYVRmOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWNvcmRWaWRlbyA9IHRoaXMudXRpbHMuYVRmOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWRpcmVjdCA9IHRoaXMudXRpbHMuYVRmOw0KICB9Ow0KDQogIFRXdW5sb2NrZWQucmVzdG9yZVBlcm1pc3Npb25TZWN1cml0eSA9IGZ1bmN0aW9uICgpIHsNCiAgICBjb25zdCBvbGRfcGVybXMgPSB0aGlzLnV0aWxzLm9TbVB2Ow0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5GZXRjaCA9IG9sZF9wZXJtcy5jZjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuTG9hZEV4dGVuc2lvbkZyb21Qcm9qZWN0ID0gb2xkX3Blcm1zLmNsZWZwOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5Ob3RpZnkgPSBvbGRfcGVybXMuY247DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbk9wZW5XaW5kb3cgPSBvbGRfcGVybXMuY293Ow0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWFkQ2xpcGJvYXJkID0gb2xkX3Blcm1zLmNyYzsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVjb3JkQXVkaW8gPSBvbGRfcGVybXMuY3JhOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWNvcmRWaWRlbyA9IG9sZF9wZXJtcy5jcnY7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlZGlyZWN0ID0gb2xkX3Blcm1zLmNyOw0KICB9Ow0KDQogIFRXdW5sb2NrZWQuVG9nZ2xlT3BlbkJ1dHRvbiA9IGZ1bmN0aW9uICgpIHsNCiAgICBUV3VubG9ja2VkLm9wZW5CdXR0b24udmlzaWJpbGl0eSghVFd1bmxvY2tlZC5vcGVuQnV0dG9uLnZpc2liaWxpdHkoImdldCIpKTsNCiAgfTsNCg0KICBUV3VubG9ja2VkLnV0aWxzLmNyZWF0ZUV4dGVuc2lvbkRpdiA9IGZ1bmN0aW9uIChkYXRhKSB7DQogICAgY29uc3QgaGFzQ3JlYXRvciA9IGRhdGEuaGFzT3duUHJvcGVydHkoImNyZWF0b3IiKTsNCiAgICBpZiAoIWhhc0NyZWF0b3IpIGRhdGFbImNyZWF0b3IiXSA9IHsgbGluazogIiIsIG5hbWU6ICIiIH07DQogICAgdmFyIGJyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnIiKTsNCiAgICB2YXIgZXh0ZW5zaW9uRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgdmFyIGV4dGVuc2lvbkltYWdlQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgdmFyIGV4dGVuc2lvbkltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7DQogICAgZXh0ZW5zaW9uSW1hZ2UubG9hZGluZyA9ICJsYXp5IjsNCiAgICBleHRlbnNpb25JbWFnZS5kcmFnZ2FibGUgPSBmYWxzZTsNCiAgICBleHRlbnNpb25JbWFnZS5zcmMgPSBkYXRhLmltYWdlOw0KICAgIHZhciBleHRlbnNpb25UZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgdmFyIGV4dGVuc2lvblRleHRUaXRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsNCiAgICBleHRlbnNpb25UZXh0VGl0bGUuaW5uZXJIVE1MID0gZGF0YS50aXRsZTsNCiAgICB2YXIgZXh0ZW5zaW9uVGV4dERlc2NyaXB0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOw0KICAgIGV4dGVuc2lvblRleHREZXNjcmlwdGlvbi5pbm5lckhUTUwgPSBkYXRhLmRlc2NyaXB0aW9uOw0KICAgIHZhciBleHRlbnNpb25DcmVhdG9yTGlua091dGVyQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgdmFyIGV4dGVuc2lvbkNyZWF0b3JMaW5rSW5uZXJDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICB2YXIgZXh0ZW5zaW9uQ3JlYXRvckxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7DQogICAgZXh0ZW5zaW9uQ3JlYXRvckxpbmsudGFyZ2V0ID0gIl9ibGFuayI7DQogICAgZXh0ZW5zaW9uQ3JlYXRvckxpbmsucmVsID0gIm5vcmVmZXJyZXIiOw0KICAgIGV4dGVuc2lvbkNyZWF0b3JMaW5rLmhyZWYgPSBkYXRhLmNyZWF0b3IubGluazsNCiAgICBleHRlbnNpb25DcmVhdG9yTGluay5pbm5lckhUTUwgPSBkYXRhLmNyZWF0b3IubmFtZTsNCiAgICBleHRlbnNpb25DcmVhdG9yTGlua0lubmVyQ29udGFpbmVyLmFwcGVuZENoaWxkKGV4dGVuc2lvbkNyZWF0b3JMaW5rKTsNCiAgICBleHRlbnNpb25DcmVhdG9yTGlua091dGVyQ29udGFpbmVyLmFwcGVuZENoaWxkKA0KICAgICAgZXh0ZW5zaW9uQ3JlYXRvckxpbmtJbm5lckNvbnRhaW5lcg0KICAgICk7DQogICAgZG9jdW1lbnQNCiAgICAgIC5xdWVyeVNlbGVjdG9yKCJkaXZbY2xhc3NePWxpYnJhcnktaXRlbV9saWJyYXJ5LWl0ZW1dIikNCiAgICAgIC5jbGFzc0xpc3QuZm9yRWFjaCgoY2xhc3NfKSA9PiB7DQogICAgICAgIGV4dGVuc2lvbkRpdi5jbGFzc0xpc3QuYWRkKGNsYXNzXyk7DQogICAgICB9KTsNCiAgICBkb2N1bWVudA0KICAgICAgLnF1ZXJ5U2VsZWN0b3IoImRpdltjbGFzc149bGlicmFyeS1pdGVtX2ZlYXR1cmVkLWV4dGVuc2lvbi10ZXh0XSIpDQogICAgICAuY2xhc3NMaXN0LmZvckVhY2goKGNsYXNzXykgPT4gew0KICAgICAgICBleHRlbnNpb25UZXh0LmNsYXNzTGlzdC5hZGQoY2xhc3NfKTsNCiAgICAgIH0pOw0KICAgIGV4dGVuc2lvbkltYWdlQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoDQogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKA0KICAgICAgICAiZGl2W2NsYXNzXj1saWJyYXJ5LWl0ZW1fZmVhdHVyZWQtaW1hZ2UtY29udGFpbmVyXSINCiAgICAgICkuY2xhc3NMaXN0WzBdDQogICAgKTsNCiAgICBleHRlbnNpb25JbWFnZS5jbGFzc0xpc3QuYWRkKA0KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiZGl2W2NsYXNzXj1saWJyYXJ5LWl0ZW1fZmVhdHVyZWQtaW1hZ2VdIikNCiAgICAgICAgLmNsYXNzTGlzdFswXQ0KICAgICk7DQogICAgZXh0ZW5zaW9uSW1hZ2VDb250YWluZXIuYXBwZW5kQ2hpbGQoZXh0ZW5zaW9uSW1hZ2UpOw0KICAgIGV4dGVuc2lvblRleHRUaXRsZS5jbGFzc0xpc3QuYWRkKA0KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3Rvcigic3BhbltjbGFzc149bGlicmFyeS1pdGVtX2xpYnJhcnktaXRlbS1uYW1lXSIpDQogICAgICAgIC5jbGFzc0xpc3RbMF0NCiAgICApOw0KICAgIGV4dGVuc2lvblRleHREZXNjcmlwdGlvbi5jbGFzc0xpc3QuYWRkKA0KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3Rvcigic3BhbltjbGFzc149bGlicmFyeS1pdGVtX2ZlYXR1cmVkLWRlc2NyaXB0aW9uXSIpDQogICAgICAgIC5jbGFzc0xpc3RbMF0NCiAgICApOw0KICAgIGlmICghVFd1bmxvY2tlZC5pc0Rlc2t0b3ApDQogICAgICBleHRlbnNpb25DcmVhdG9yTGlua091dGVyQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoDQogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImRpdltjbGFzc149bGlicmFyeS1pdGVtX2V4dGVuc2lvbi1saW5rc10iKQ0KICAgICAgICAgIC5jbGFzc0xpc3RbMF0NCiAgICAgICk7DQogICAgZXh0ZW5zaW9uVGV4dC5hcHBlbmRDaGlsZChleHRlbnNpb25UZXh0VGl0bGUpOw0KICAgIGV4dGVuc2lvblRleHQuYXBwZW5kQ2hpbGQoYnIpOw0KICAgIGV4dGVuc2lvblRleHQuYXBwZW5kQ2hpbGQoZXh0ZW5zaW9uVGV4dERlc2NyaXB0aW9uKTsNCiAgICBleHRlbnNpb25EaXYuYXBwZW5kQ2hpbGQoZXh0ZW5zaW9uSW1hZ2VDb250YWluZXIpOw0KICAgIGV4dGVuc2lvbkRpdi5hcHBlbmRDaGlsZChleHRlbnNpb25UZXh0KTsNCiAgICBpZiAoaGFzQ3JlYXRvcikNCiAgICAgIGV4dGVuc2lvbkRpdi5hcHBlbmRDaGlsZChleHRlbnNpb25DcmVhdG9yTGlua091dGVyQ29udGFpbmVyKTsNCiAgICBpZiAoVFd1bmxvY2tlZC5pc0Rlc2t0b3ApIHsNCiAgICAgIHZhciBleHRlbnNpb25JbmNvbXBhdGlibGVUZXh0Q29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgICBleHRlbnNpb25JbmNvbXBhdGlibGVUZXh0Q29udGFpbmVyLmNsYXNzTGlzdC5hZGQoDQogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgICAgICAgJ2RpdltjbGFzc149ImxpYnJhcnktaXRlbV9pbmNvbXBhdGlibGUtd2l0aC1zY3JhdGNoIl0nDQogICAgICAgICkuY2xhc3NMaXN0WzBdDQogICAgICApOw0KICAgICAgdmFyIGV4dGVuc2lvbkluY29tcGF0aWJsZVRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7DQogICAgICBleHRlbnNpb25JbmNvbXBhdGlibGVUZXh0LmlubmVySFRNTCA9ICJOb3QgY29tcGF0aWJsZSB3aXRoIFNjcmF0Y2guIjsNCiAgICAgIGV4dGVuc2lvbkluY29tcGF0aWJsZVRleHRDb250YWluZXIuYXBwZW5kQ2hpbGQoZXh0ZW5zaW9uSW5jb21wYXRpYmxlVGV4dCk7DQogICAgICBleHRlbnNpb25EaXYuYXBwZW5kQ2hpbGQoZXh0ZW5zaW9uSW5jb21wYXRpYmxlVGV4dENvbnRhaW5lcik7DQogICAgICBleHRlbnNpb25JbWFnZS53aWR0aCA9IDI5NjsNCiAgICAgIGV4dGVuc2lvbkltYWdlLmhlaWdodCA9IDE4NDsNCiAgICB9DQogICAgcmV0dXJuIGV4dGVuc2lvbkRpdjsNCiAgfTsNCg0KICAvL0FkZCBhIGJ1dHRvbiB0byBsb2FkIGEgZXh0ZW5zaW9uIGluIHRoZSBleHRlbnNpb24gcGFnZS4NCiAgVFd1bmxvY2tlZC51dGlscy5hZGRFeHRlbnNpb25Ub0ZlYXR1cmVkR2FsbGVyeSA9IGZ1bmN0aW9uICgNCiAgICBpY29uVXJsLA0KICAgIHVybCwNCiAgICBuYW1lLA0KICAgIGRlc2NyaXB0aW9uDQogICkgew0KICAgIGZ1bmN0aW9uIGxvYWRFeHRlbnNpb24oKSB7DQogICAgICBUV3VubG9ja2VkLmxvYWRFeHRlbnNpb25VbnNhbmRib3hlZCh1cmwsIHRydWUpOw0KICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5LnBhcmVudEVsZW1lbnQuY2hpbGRyZW5bMF0uY2hpbGRyZW5bMV0uY2hpbGRyZW5bMF0uY2xpY2soKTsNCiAgICAgIGFsZXJ0KCJQTS1VbmxvY2tlZDogWW91ciBFeHRlbnNpb24gaXMgbG9hZGluZywgcGxlYXNlIGJlIHBhdGllbnQuIik7DQogICAgfQ0KICAgIGNvbnN0IG15RXh0ZW5zaW9uID0gVFd1bmxvY2tlZC51dGlscy5jcmVhdGVFeHRlbnNpb25EaXYoew0KICAgICAgLy9jcmVhdG9yOiB7bGluazonaHR0cHM6Ly9nb29nbGUuY29tLycsIG5hbWU6J3Rlc3QnfSwNCiAgICAgIHRpdGxlOiBuYW1lLA0KICAgICAgZGVzY3JpcHRpb24sDQogICAgICBpbWFnZTogaWNvblVybCwNCiAgICB9KTsNCiAgICBteUV4dGVuc2lvbi5vbmNsaWNrID0gbG9hZEV4dGVuc2lvbjsNCiAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuaW5zZXJ0QmVmb3JlKA0KICAgICAgbXlFeHRlbnNpb24sDQogICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuY2hpbGROb2Rlc1swXQ0KICAgICk7DQogIH07DQoNCiAgVFd1bmxvY2tlZC51dGlscy5hZGRBbGxuZXdGZWF0dXJlZFRvR2FsbGVyeSA9IGZ1bmN0aW9uICgpIHsNCiAgICBsZXQgZXh0ZW5zaW9ucyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3R3dTpjdXN0b21FeHRlbnNpb25zJykpOw0KICAgIGZvciAoZXh0ZW5zaW9uIGluIGV4dGVuc2lvbnMpIHsNCiAgICAgIGV4dGVuc2lvbiA9IGV4dGVuc2lvbnNbZXh0ZW5zaW9uXTsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMuYWRkRXh0ZW5zaW9uVG9GZWF0dXJlZEdhbGxlcnkoDQogICAgICAgIGV4dGVuc2lvbi5pbWFnZV91cmwsDQogICAgICAgIGV4dGVuc2lvbi51cmwsDQogICAgICAgIGV4dGVuc2lvbi5uYW1lLA0KICAgICAgICBleHRlbnNpb24uZGVzY3JpcHRpb24NCiAgICAgICk7DQogICAgfQ0KICB9Ow0KDQogIFRXdW5sb2NrZWQudXRpbHMuYXR0ZW1wdFRvTG9hZE15R2FsbGVyeSA9IGFzeW5jIGZ1bmN0aW9uICgpIHsNCiAgICB2YXIgZXh0ZW5zaW9ucyA9IFtdOw0KICAgIHZhciBzaXRlID0gImh0dHBzOi8vc3Vydi5pcy1hLmRldi91bnNhZmUtZXh0ZW5zaW9ucyI7DQogICAgaWYgKCFUV3VubG9ja2VkLmlzRGVza3RvcCkNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5pbnNlcnRCZWZvcmUoDQogICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uc0NhdGVnb3J5U2VwYXJhdG9yLmNsb25lTm9kZSh0cnVlKSwNCiAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5LmNoaWxkTm9kZXNbMF0NCiAgICAgICk7DQogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgNCiAgICAgIGZldGNoKHNpdGUgKyAiLyIpDQogICAgICAgIC50aGVuKCh0ZXh0KSA9PiB0ZXh0LnRleHQoKSkNCiAgICAgICAgLnRoZW4oKHRleHQpID0+IHsNCiAgICAgICAgICBsZXQgZG9tID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyh0ZXh0LCAidGV4dC9odG1sIik7DQogICAgICAgICAgZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoImRpdi5leHRlbnNpb24iKS5mb3JFYWNoKChleHQpID0+IHsNCiAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgIGlmIChleHQuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIgfHwgZXh0Lmhhc0F0dHJpYnV0ZSgiaGlkZGVuIikpDQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfSBjYXRjaCB7fQ0KICAgICAgICAgICAgY29uc3QgdXJpID0gKA0KICAgICAgICAgICAgICBleHQucXVlcnlTZWxlY3RvcigiYS5jb3B5IikgfHwgZXh0LnF1ZXJ5U2VsZWN0b3IoImEub3BlbiIpDQogICAgICAgICAgICApLmhyZWYuc3BsaXQoIi8iKTsNCiAgICAgICAgICAgIGxldCBleHRlbnNpb24gPSB7DQogICAgICAgICAgICAgIG5hbWU6IGV4dC5xdWVyeVNlbGVjdG9yKCJoMyIpLmlubmVySFRNTCwNCiAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGV4dC5xdWVyeVNlbGVjdG9yKCJwIikuaW5uZXJIVE1MLA0KICAgICAgICAgICAgICBpbWFnZTogZXh0DQogICAgICAgICAgICAgICAgLnF1ZXJ5U2VsZWN0b3IoImltZy5leHRlbnNpb24taW1hZ2UiKQ0KICAgICAgICAgICAgICAgIC5zcmMucmVwbGFjZShkb2N1bWVudC5sb2NhdGlvbi5vcmlnaW4sIHNpdGUpLA0KICAgICAgICAgICAgICB1cmw6IGBodHRwczovL3N1cnYuaXMtYS5kZXYvdW5zYWZlLWV4dGVuc2lvbnMvJHsNCiAgICAgICAgICAgICAgICB1cmlbdXJpLmxlbmd0aCAtIDJdDQogICAgICAgICAgICAgIH0vJHt1cmlbdXJpLmxlbmd0aCAtIDFdfWAsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgZXh0ZW5zaW9ucy5wdXNoKGV4dGVuc2lvbik7DQogICAgICAgICAgfSk7DQogICAgICAgICAgZm9yIChleHRlbnNpb24gaW4gZXh0ZW5zaW9ucykgew0KICAgICAgICAgICAgZXh0ZW5zaW9uID0gZXh0ZW5zaW9uc1tleHRlbnNpb25dOw0KICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5hZGRFeHRlbnNpb25Ub0ZlYXR1cmVkR2FsbGVyeSgNCiAgICAgICAgICAgICAgZXh0ZW5zaW9uLmltYWdlLA0KICAgICAgICAgICAgICBleHRlbnNpb24udXJsLA0KICAgICAgICAgICAgICBleHRlbnNpb24ubmFtZSwNCiAgICAgICAgICAgICAgZXh0ZW5zaW9uLmRlc2NyaXB0aW9uDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgfSkNCiAgICAgICAgLnRoZW4oKCkgPT4gew0KICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsNCiAgICAgICAgfSkNCiAgICApOw0KICB9Ow0KDQogIFRXdW5sb2NrZWQudXRpbHMuYXR0ZW1wdFRvTG9hZFNQR2FsbGVyeSA9IGFzeW5jIGZ1bmN0aW9uICgpIHsNCiAgICAgIHZhciBrZXlzID0gYXdhaXQgZmV0Y2goJ2h0dHBzOi8vY29yc3Byb3h5LmlvLz9odHRwczovL3NoYXJrcG9vbHMtZXh0ZW5zaW9ucy52ZXJjZWwuYXBwL0dhbGxlcnklMjBGaWxlcy9FeHRlbnNpb24tS2V5cy5qc29uJyk7DQogICAgICBrZXlzID0gYXdhaXQga2V5cy5qc29uKCk7DQogICAgICBrZXlzID0ga2V5cy5leHRlbnNpb25zOw0KICAgICAgZGVsZXRlIGtleXNbJ0ltYWdlLUVmZmVjdHMnXTsgICAgLy8gQnJva2VuIGljb24gOigNCiAgICAgIGRlbGV0ZSBrZXlzWydOaWNoZS1Ub29sYm94J107ICAgIC8vIE5haC4NCiAgICAgIGRlbGV0ZSBrZXlzWydOZXdncm91bmRzLUF1ZGlvJ107IC8vIExlZ2FsIGdyZXkgYXJlYQ0KICAgICAgZGVsZXRlIGtleXNbJ1NpbmNlLTIwMDAnXTsgICAgICAgLy9OYWguDQogICAgICBsZXQgZXh0ZW5zaW9ucyA9IE9iamVjdC5rZXlzKGtleXMpOw0KICAgICAgZXh0ZW5zaW9ucy5wb3AoZXh0ZW5zaW9ucy5sZW5ndGgtMSk7DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGV4dGVuc2lvbnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICBsZXQgZXh0ZW5zaW9uID0gZXh0ZW5zaW9uc1tpXTsNCiAgICAgICAgICBsZXQgb2JqID0ga2V5c1tleHRlbnNpb25dOw0KICAgICAgICAgIG9iai5pbWFnZSA9ICdodHRwczovL2NvcnNwcm94eS5pby8/aHR0cHM6Ly9zaGFya3Bvb2xzLWV4dGVuc2lvbnMudmVyY2VsLmFwcC9leHRlbnNpb24tdGh1bWJzLycrZXh0ZW5zaW9uKycuc3ZnJzsNCiAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmFkZEV4dGVuc2lvblRvRmVhdHVyZWRHYWxsZXJ5KA0KICAgICAgICAgICAgb2JqLmltYWdlLA0KICAgICAgICAgICAgb2JqLnVybCwNCiAgICAgICAgICAgIGV4dGVuc2lvbiwNCiAgICAgICAgICAgIG9iai5jcmVkaXRzDQogICAgICAgICAgKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSk7DQogIH0NCg0KICBUV3VubG9ja2VkLmFkZEV4dGVuc2lvblRvRmVhdHVyZWRHYWxsZXJ5ID0gZnVuY3Rpb24gKA0KICAgIGljb25VcmwsDQogICAgdXJsLA0KICAgIG5hbWUsDQogICAgZGVzY3JpcHRpb24NCiAgKSB7DQogICAgVFd1bmxvY2tlZC51dGlscy5uZXdGZWF0dXJlZEV4dGVuc2lvbnMucHVzaCh7DQogICAgICBpY29uVXJsLA0KICAgICAgdXJsLA0KICAgICAgbmFtZSwNCiAgICAgIGRlc2NyaXB0aW9uLA0KICAgIH0pOw0KICB9Ow0KDQogIFRXdW5sb2NrZWQudXRpbHMuZXh0QnRuQWRkTGlzdGVuID0gZnVuY3Rpb24gKCkgew0KICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvbltjbGFzc149Imd1aV9leHRlbnNpb24tYnV0dG9uIl0nKS5vbmNsaWNrID0NCiAgICAgIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgc2V0VGltZW91dChhc3luYyBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgY29uc3QgbW9kYWxTZXR0aW5ncyA9IFRXdW5sb2NrZWQuZXh0TWFuYWdlci5nZXRNYXJrcygpOw0KICAgICAgICAgIGxldCBteUdhbGxlcnkgPSBtb2RhbFNldHRpbmdzLm15R2FsbGVyeSwgc3BHYWxsZXJ5ID0gbW9kYWxTZXR0aW5ncy5zcEdhbGxlcnk7DQogICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25zQ2F0ZWdvcnlTZXBhcmF0b3IgPQ0KICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaHIiKTsNCiAgICAgICAgICBpZiAoIVRXdW5sb2NrZWQuaXNEZXNrdG9wKQ0KICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25zQ2F0ZWdvcnlTZXBhcmF0b3IuY2xhc3NMaXN0LmFkZCgNCiAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiaHJbY2xhc3NePXNlcGFyYXRvcl9zZXBhcmF0b3JdIikNCiAgICAgICAgICAgICAgICAuY2xhc3NMaXN0WzBdDQogICAgICAgICAgICApOw0KICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgICAgICAgICAnW2NsYXNzXj0ibGlicmFyeV9saWJyYXJ5LXNjcm9sbC1ncmlkIl0nDQogICAgICAgICAgKTsNCiAgICAgICAgICBpZiAoDQogICAgICAgICAgICBteUdhbGxlcnkgfHwNCiAgICAgICAgICAgIHNwR2FsbGVyeQ0KICAgICAgICAgICkgew0KICAgICAgICAgICAgaWYgKHNwR2FsbGVyeSkgew0KICAgICAgICAgICAgICBpZiAoIVRXdW5sb2NrZWQuaXNEZXNrdG9wKQ0KICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuaW5zZXJ0QmVmb3JlKA0KICAgICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uc0NhdGVnb3J5U2VwYXJhdG9yLmNsb25lTm9kZSh0cnVlKSwNCiAgICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuY2hpbGROb2Rlc1swXQ0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgICBhd2FpdCBUV3VubG9ja2VkLnV0aWxzLmF0dGVtcHRUb0xvYWRTUEdhbGxlcnkoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChteUdhbGxlcnkpIHsNCiAgICAgICAgICAgICAgaWYgKCFUV3VubG9ja2VkLmlzRGVza3RvcCkNCiAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5Lmluc2VydEJlZm9yZSgNCiAgICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbnNDYXRlZ29yeVNlcGFyYXRvci5jbG9uZU5vZGUodHJ1ZSksDQogICAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5LmNoaWxkTm9kZXNbMF0NCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgYXdhaXQgVFd1bmxvY2tlZC51dGlscy5hdHRlbXB0VG9Mb2FkTXlHYWxsZXJ5KCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIVRXdW5sb2NrZWQuaXNEZXNrdG9wKQ0KICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuaW5zZXJ0QmVmb3JlKA0KICAgICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uc0NhdGVnb3J5U2VwYXJhdG9yLmNsb25lTm9kZSh0cnVlKSwNCiAgICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuY2hpbGROb2Rlc1swXQ0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5hZGRBbGxuZXdGZWF0dXJlZFRvR2FsbGVyeSgpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBpZiAoIVRXdW5sb2NrZWQuaXNEZXNrdG9wKQ0KICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuaW5zZXJ0QmVmb3JlKA0KICAgICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uc0NhdGVnb3J5U2VwYXJhdG9yLmNsb25lTm9kZSh0cnVlKSwNCiAgICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuY2hpbGROb2Rlc1swXQ0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5hZGRBbGxuZXdGZWF0dXJlZFRvR2FsbGVyeSgpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSwgMTAwMCk7DQogICAgICB9Ow0KICB9Ow0KDQogIFRXdW5sb2NrZWQudXRpbHMuaGFzVHJpZWRUb0FkZEZvckkgPSBmYWxzZTsNCiAgVFd1bmxvY2tlZC51dGlscy5hZGRGb3JJZXh0ZW5zaW9uID0gZnVuY3Rpb24gKCkgew0KICAgIGlmICghVFd1bmxvY2tlZC51dGlscy5oYXNUcmllZFRvQWRkRm9ySSkgew0KICAgICAgVFd1bmxvY2tlZC51dGlscy5oYXNUcmllZFRvQWRkRm9ySSA9IHRydWU7DQogICAgICBUV3VubG9ja2VkLmxvYWRFeHRlbnNpb25VbnNhbmRib3hlZCgNCiAgICAgICAgImh0dHBzOi8vc3Vydi5pcy1hLmRldi9icmluZ0JhY2tGb3JJLmpzIg0KICAgICAgKTsNCiAgICAgIGFsZXJ0KA0KICAgICAgICAiVGhlIGZvciBpIGJsb2NrIHNob3VsZCBhcHBlYXIgd2l0aGluIDEwIHNlY29uZHMsIG90aGVyd2lzZSBjaGVjayB0aGUgY29uc29sZSEiDQogICAgICApOw0KICAgIH0NCiAgfTsNCg0KICBUV3VubG9ja2VkLnV0aWxzLmN1cklkR2VuID0gVFd1bmxvY2tlZC51dGlscy5pZEdlbigpOw0KICBUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkJ1YmJsZXMgPSBbXTsNCiAgVFd1bmxvY2tlZC51dGlscy5oaWRkZW5JY29ucyA9IFtdOw0KICB3aW5kb3cuZ2V0QnViID0gZnVuY3Rpb24gKGV4dCkgew0KICAgIGxldCBidWIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKA0KICAgICAgImRpdi5zY3JhdGNoQ2F0ZWdvcnlJZC0iICsgZXh0DQogICAgKS5wYXJlbnRFbGVtZW50Ow0KICAgIGJ1Yi5pY29uID0NCiAgICAgIGJ1Yi5xdWVyeVNlbGVjdG9yKCJkaXYuc2NyYXRjaENhdGVnb3J5SXRlbUJ1YmJsZSIpIHx8DQogICAgICBidWIucXVlcnlTZWxlY3RvcigiZGl2LnNjcmF0Y2hDYXRlZ29yeUl0ZW1JY29uIik7DQogICAgcmV0dXJuIGJ1YjsNCiAgfTsNCiAgbGV0IGJvdW5kID0gdm0ucnVudGltZS5nZXRCbG9ja3NYTUwuYmluZCh2bS5ydW50aW1lKTsNCiAgdm0ucnVudGltZS5nZXRCbG9ja3NYTUwgPSBmdW5jdGlvbiAoLi4uYXJncykgew0KICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkJ1YmJsZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBsZXQgYnViID0gZ2V0QnViKFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuQnViYmxlc1tpXSk7DQogICAgICAgICAgYnViLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgICAgIH0gY2F0Y2ggKGVycikgew0KICAgICAgICAgIGNvbnNvbGUuZGVidWcoIlBNLVVubG9ja2VkOiBFcnJvciB3aGVuIGhpZGluZyBidWJibGU6ICIgKyBlcnIpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuSWNvbnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBsZXQgYnViID0gZ2V0QnViKFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuSWNvbnNbaV0pOw0KICAgICAgICAgIGJ1Yi5pY29uLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgICAgIH0gY2F0Y2ggKGVycikgew0KICAgICAgICAgIGNvbnNvbGUuZGVidWcoIlBNLVVubG9ja2VkOiBFcnJvciB3aGVuIGhpZGluZyBidWJibGUgaWNvbjogIiArIGVycik7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9LCAxMDAwKTsNCiAgICByZXR1cm4gYm91bmQoLi4uYXJncyk7DQogIH07DQogIGZ1bmN0aW9uIHRvb2xib3hNZW51KGUpIHsNCiAgICBsZXQgdG1wLA0KICAgICAgYnViYmxlID0gZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludChlLmNsaWVudFgsIGUuY2xpZW50WSk7DQogICAgdG1wID0gYnViYmxlLnBhcmVudEVsZW1lbnQ7DQogICAgaWYgKHRtcC5jbGFzc0xpc3QuY29udGFpbnMoInNjcmF0Y2hDYXRlZ29yeU1lbnVJdGVtIikpIGJ1YmJsZSA9IHRtcDsNCiAgICB0bXAgPSBidWJibGUucXVlcnlTZWxlY3RvcigiZGl2LnNjcmF0Y2hDYXRlZ29yeU1lbnVJdGVtIik7DQogICAgaWYgKHRtcCkgYnViYmxlID0gdG1wOw0KICAgIGxldCBleHRlbnNpb24gPSBidWJibGUuY2xhc3NMaXN0WzFdLnJlcGxhY2UoInNjcmF0Y2hDYXRlZ29yeUlkLSIsICIiKTsNCiAgICBjb25zdCBpc0J1aWx0SW4gPSBbDQogICAgICAibW90aW9uIiwNCiAgICAgICJsb29rcyIsDQogICAgICAic291bmQiLA0KICAgICAgInBlbiIsDQogICAgICAiZGF0YSIsDQogICAgICAidmFyaWFibGVzIiwNCiAgICAgICJkYXRhTGlzdHMiLA0KICAgICAgImxpc3RzIiwNCiAgICAgICJldmVudCIsDQogICAgICAiZXZlbnRzIiwNCiAgICAgICJjb250cm9sIiwNCiAgICAgICJzZW5zaW5nIiwNCiAgICAgICJvcGVyYXRvcnMiLA0KICAgICAgIm1vcmUiLA0KICAgICAgIm15QmxvY2tzIiwNCiAgICBdLmluY2x1ZGVzKGV4dGVuc2lvbik7DQogICAgdmFyIGJsb2NrcyA9IHZtLnJ1bnRpbWUuZ2V0RWRpdGluZ1RhcmdldCgpLmJsb2NrczsNCiAgICB2YXIgZGVsZXRpb25zID0gW107DQogICAgYnViYmxlLmljb24gPQ0KICAgICAgYnViYmxlLnBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvcigiZGl2LnNjcmF0Y2hDYXRlZ29yeUl0ZW1CdWJibGUiKSB8fA0KICAgICAgYnViYmxlLnBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvcigiZGl2LnNjcmF0Y2hDYXRlZ29yeUl0ZW1JY29uIik7DQogICAgT2JqZWN0LnZhbHVlcyhibG9ja3MuX2Jsb2NrcykuZm9yRWFjaCgoYmxvY2spID0+IHsNCiAgICAgIGlmIChibG9jay5vcGNvZGUuc3RhcnRzV2l0aChleHRlbnNpb24pKSB7DQogICAgICAgIGxldCBteVVwID0gYmxvY2sucGFyZW50Ow0KICAgICAgICBsZXQgbXlOZXh0ID0gYmxvY2submV4dDsNCiAgICAgICAgYmxvY2sucGFyZW50ID0gbnVsbDsNCiAgICAgICAgYmxvY2submV4dCA9IG51bGw7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgYmxvY2tzLl9ibG9ja3NbbXlVcF0ubmV4dCA9IG15TmV4dDsNCiAgICAgICAgfSBjYXRjaCB7fQ0KICAgICAgICB0cnkgew0KICAgICAgICAgIGJsb2Nrcy5fYmxvY2tzW215TmV4dF0ucGFyZW50ID0gbXlVcDsNCiAgICAgICAgfSBjYXRjaCB7fQ0KICAgICAgICBkZWxldGlvbnMucHVzaChibG9jay5pZCk7DQogICAgICB9DQogICAgfSk7DQogICAgbGV0IHdpZGdpdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIHdpZGdpdC5jbGFzc0xpc3QuYWRkKCJibG9ja2x5V2lkZ2V0RGl2Iik7DQogICAgd2lkZ2l0LnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsNCiAgICB3aWRnaXQuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7DQogICAgd2lkZ2l0LnN0eWxlLmRpcmVjdGlvbiA9ICJsdHIiOw0KICAgIHdpZGdpdC5zdHlsZS50b3AgPSBlLmNsaWVudFkgKyAicHgiOw0KICAgIHdpZGdpdC5zdHlsZS5sZWZ0ID0gZS5jbGllbnRYICsgInB4IjsNCiAgICB3aWRnaXQuc3R5bGUud2lkdGggPSAiMjI0LjJweCI7DQogICAgbGV0IG1lbnVIZWlnaHQgPSAwOw0KICAgIGxldCBtZW51ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgbWVudS5jbGFzc0xpc3QuYWRkKCJnb29nLW1lbnUiKTsNCiAgICBtZW51LmNsYXNzTGlzdC5hZGQoImdvb2ctbWVudS12ZXJ0aWNhbCIpOw0KICAgIG1lbnUuY2xhc3NMaXN0LmFkZCgiYmxvY2tseUNvbnRleHRNZW51Iik7DQogICAgbWVudS5yb2xlID0gIm1lbnUiOw0KICAgIG1lbnUuc3R5bGUudXNlclNlbGVjdCA9ICJub25lIjsNCiAgICBtZW51LnRhYmluZGV4ID0gMDsNCiAgICBmdW5jdGlvbiBtZW51SXRlbSh0ZXh0LCBleHRyYXMsIG9uY2xpY2spIHsNCiAgICAgIGxldCBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgICBpdGVtLmlzRGlzYWJsZWQgPSBleHRyYXMuaXNEaXNhYmxlZDsNCiAgICAgIGlmIChleHRyYXMuYm9yZGVyKSB7DQogICAgICAgIG1lbnVIZWlnaHQgKz0gMzsNCiAgICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKCJzYS1ibG9ja2x5LW1lbnUtaXRlbS1ib3JkZXIiKTsNCiAgICAgICAgaXRlbS5zdHlsZS5wYWRkaW5nVG9wID0gIjJweCI7DQogICAgICAgIGl0ZW0uc3R5bGUuYm9yZGVyVG9wID0gIjFweCBzb2xpZCByZ2JhKDAsIDAsIDAsIDAuMTUpIjsNCiAgICAgIH0NCiAgICAgIGl0ZW0ub25jbGljayA9IGZ1bmN0aW9uICguLi5hcmdzKSB7DQogICAgICAgIGlmIChpdGVtLmlzRGlzYWJsZWQpIHJldHVybjsNCiAgICAgICAgb25jbGljayguLi5hcmdzKTsNCiAgICAgICAgd2lkZ2l0LnJlbW92ZSgpOw0KICAgICAgfTsNCiAgICAgIGl0ZW0ub25tb3VzZW92ZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmIChpdGVtLmlzRGlzYWJsZWQpIHJldHVybjsNCiAgICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKCJnb29nLW1lbnVpdGVtLWhpZ2hsaWdodCIpOw0KICAgICAgfTsNCiAgICAgIGl0ZW0ub25tb3VzZW91dCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKGl0ZW0uaXNEaXNhYmxlZCkgcmV0dXJuOw0KICAgICAgICBpZiAoIWl0ZW0uaXNEaXNhYmxlZCkgaXRlbS5jbGFzc0xpc3QucmVtb3ZlKCJnb29nLW1lbnVpdGVtLWhpZ2hsaWdodCIpOw0KICAgICAgfTsNCiAgICAgIGl0ZW0uaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9Imdvb2ctbWVudWl0ZW0tY29udGVudCIgc3R5bGU9InVzZXItc2VsZWN0OiBub25lOyI+JHt0ZXh0fTwvZGl2PmA7DQogICAgICBpdGVtLmNsYXNzTGlzdC5hZGQoImdvb2ctbWVudWl0ZW0iKTsNCiAgICAgIGlmIChpdGVtLmlzRGlzYWJsZWQpIHsNCiAgICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKCJnb29nLW1lbnVpdGVtLWRpc2FibGVkIik7DQogICAgICB9DQogICAgICBpdGVtLnJvbGUgPSAibWVudWl0ZW0iOw0KICAgICAgaXRlbS5pZCA9IGA6JHtUV3VubG9ja2VkLnV0aWxzLmN1cklkR2VuLm5leHQoKS52YWx1ZX1gOw0KICAgICAgaXRlbS5zdHlsZS51c2VyU2VsZWN0ID0gIm5vbmUiOw0KICAgICAgbWVudUhlaWdodCArPSAyMzsNCiAgICAgIHJldHVybiBpdGVtOw0KICAgIH0NCiAgICBjb25zdCBkZWZhdWx0U2V0dGluZ3MgPSB7DQogICAgICBpc0Rpc2FibGVkOiBmYWxzZSwNCiAgICAgIGJvcmRlcjogZmFsc2UsDQogICAgfTsNCiAgICBtZW51LmFwcGVuZENoaWxkKA0KICAgICAgbWVudUl0ZW0oDQogICAgICAgICJyZW1vdmUgYWxsIGV4dGVuc2lvbiBibG9ja3MiLA0KICAgICAgICB7DQogICAgICAgICAgaXNEaXNhYmxlZDogaXNCdWlsdEluLA0KICAgICAgICAgIGJvcmRlcjogZmFsc2UsDQogICAgICAgIH0sDQogICAgICAgIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICBpZiAoDQogICAgICAgICAgICBjb25maXJtKA0KICAgICAgICAgICAgICAiQXJlIHlvdSBzdXJlIGFib3V0IHRoaXMsIHRoaXMgd2lsbCByZW1vdmUgIiArDQogICAgICAgICAgICAgICAgZGVsZXRpb25zLmxlbmd0aCArDQogICAgICAgICAgICAgICAgIiBibG9ja3M/Ig0KICAgICAgICAgICAgKQ0KICAgICAgICAgICkgew0KICAgICAgICAgICAgZGVsZXRpb25zLmZvckVhY2goKGJsb2NrKSA9PiB7DQogICAgICAgICAgICAgIGRlbGV0ZSBibG9ja3MuX2Jsb2Nrc1tibG9ja107DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIHZtLnJlZnJlc2hXb3Jrc3BhY2UoKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICkNCiAgICApOw0KICAgIG1lbnUuYXBwZW5kQ2hpbGQoDQogICAgICBtZW51SXRlbSgNCiAgICAgICAgImhpZGUgYnViYmxlIiwNCiAgICAgICAgew0KICAgICAgICAgIGlzRGlzYWJsZWQ6IGZhbHNlLA0KICAgICAgICAgIGJvcmRlcjogdHJ1ZSwNCiAgICAgICAgfSwNCiAgICAgICAgZnVuY3Rpb24gKCkgew0KICAgICAgICAgIGlmICgNCiAgICAgICAgICAgIGNvbmZpcm0oDQogICAgICAgICAgICAgICJBcmUgeW91IHN1cmUgYWJvdXQgdGhpcyB5b3Ugd29uJ3QgYmUgYWJsZSB0byBzaG93IGl0IHVubGVzcyB5b3UgcmVsb2FkPyINCiAgICAgICAgICAgICkNCiAgICAgICAgICApIHsNCiAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuQnViYmxlcy5wdXNoKGV4dGVuc2lvbik7DQogICAgICAgICAgICBidWJibGUucGFyZW50RWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgKQ0KICAgICk7DQogICAgaWYgKFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuSWNvbnMuaW5jbHVkZXMoZXh0ZW5zaW9uKSkgew0KICAgICAgbWVudS5hcHBlbmRDaGlsZCgNCiAgICAgICAgbWVudUl0ZW0oInNob3cgaWNvbiIsIGRlZmF1bHRTZXR0aW5ncywgZnVuY3Rpb24gKCkgew0KICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuSWNvbnMucG9wKA0KICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5oaWRkZW5CdWJibGVzLmluZGV4T2YoZXh0ZW5zaW9uKQ0KICAgICAgICAgICk7DQogICAgICAgICAgYnViYmxlLmljb24uc3R5bGUuZGlzcGxheSA9ICIiOw0KICAgICAgICB9KQ0KICAgICAgKTsNCiAgICB9IGVsc2Ugew0KICAgICAgbWVudS5hcHBlbmRDaGlsZCgNCiAgICAgICAgbWVudUl0ZW0oImhpZGUgaWNvbiIsIGRlZmF1bHRTZXR0aW5ncywgZnVuY3Rpb24gKCkgew0KICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuSWNvbnMucHVzaChleHRlbnNpb24pOw0KICAgICAgICAgIGJ1YmJsZS5pY29uLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgICAgIH0pDQogICAgICApOw0KICAgIH0NCiAgICB3aWRnaXQuc3R5bGUuaGVpZ2h0ID0gbWVudUhlaWdodCArICJweCI7DQogICAgd2lkZ2l0LmFwcGVuZENoaWxkKG1lbnUpOw0KICAgIHRtcCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgIHRyeSB7DQogICAgICAgIHdpZGdpdC5yZW1vdmUoKTsNCiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKHRtcCk7DQogICAgICB9IGNhdGNoIHt9DQogICAgfTsNCiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJkaXYuYmxvY2tseVRvb2xib3hEaXYiKS5vbm1vdXNlZG93biA9IHRtcDsNCiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHdpZGdpdCk7DQogIH07DQoNCiAgZnVuY3Rpb24gaW1wb3J0SW1hZ2UodXJsLCBjb3N0dW1lX25hbWUpIHsNCiAgICBjb25zdCBzdG9yYWdlID0gdm0ucnVudGltZS5zdG9yYWdlOw0KICAgIGZ1bmN0aW9uIGdldF91cmxfZXh0ZW5zaW9uKHVyaSkgew0KICAgICAgdmFyIGxlbiA9IHVyaS5zcGxpdCgiLyIpOw0KICAgICAgcmV0dXJuIGxlbltsZW4ubGVuZ3RoIC0gMV0uc3BsaXQoIi4iKVsxXS5zcGxpdCgvWyM/XS9naSlbMF07DQogICAgfQ0KICAgIGxldCBkYXRhVHlwZSA9ICIiLA0KICAgICAgZGF0YUZvcm1hdCA9ICIiOw0KICAgIGlmICh1cmwuc3RhcnRzV2l0aCgiZGF0YTppbWFnZS8iKSkgew0KICAgICAgdXJsID0gdXJsLnJlcGxhY2UoImRhdGE6aW1hZ2UvIiwgIiIpOw0KICAgICAgaWYgKHVybC5zdGFydHNXaXRoKCJzdmciKSkNCiAgICAgICAgKGRhdGFUeXBlID0gInN2ZyIpLCAoZGF0YUZvcm1hdCA9IHN0b3JhZ2UuRGF0YUZvcm1hdC5TVkcpOw0KICAgICAgaWYgKHVybC5zdGFydHNXaXRoKCJwbmciKSkNCiAgICAgICAgKGRhdGFUeXBlID0gInBuZyIpLCAoZGF0YUZvcm1hdCA9IHN0b3JhZ2UuRGF0YUZvcm1hdC5QTkcpOw0KICAgICAgaWYgKHVybC5zdGFydHNXaXRoKCJqcGciKSkNCiAgICAgICAgKGRhdGFUeXBlID0gImpwZyIpLCAoZGF0YUZvcm1hdCA9IHN0b3JhZ2UuRGF0YUZvcm1hdC5KUEcpOw0KICAgICAgaWYgKHVybC5zdGFydHNXaXRoKCJqcGVnIikpDQogICAgICAgIChkYXRhVHlwZSA9ICJqcGciKSwgKGRhdGFGb3JtYXQgPSBzdG9yYWdlLkRhdGFGb3JtYXQuSlBHKTsNCiAgICAgIGlmIChkYXRhVHlwZSA9PSAiIikgcmV0dXJuIC0xOw0KICAgICAgdXJsID0gYGRhdGE6aW1hZ2UvJHt1cmx9YDsNCiAgICB9IGVsc2Ugew0KICAgICAgZGF0YVR5cGUgPSBnZXRfdXJsX2V4dGVuc2lvbih1cmwpOw0KICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZS50b0xvd2VyQ2FzZSgpOw0KICAgICAgc3dpdGNoIChkYXRhVHlwZSkgew0KICAgICAgICBjYXNlICJzdmciOg0KICAgICAgICAgIGRhdGFGb3JtYXQgPSBzdG9yYWdlLkRhdGFGb3JtYXQuU1ZHOw0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICBjYXNlICJwbmciOg0KICAgICAgICAgIGRhdGFGb3JtYXQgPSBzdG9yYWdlLkRhdGFGb3JtYXQuUE5HOw0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgIC8vICpjb3VnaCogdG8gbWFueSBqcGcgZm9ybWF0cw0KICAgICAgICAgIGlmIChbImpwZyIsICJqcGVnIiwgImpmaWYiIC8qIGV0YywgZXRjLi4gKi9dLmluY2x1ZGVzKGRhdGFUeXBlKSkgew0KICAgICAgICAgICAgZGF0YUZvcm1hdCA9IHN0b3JhZ2UuRGF0YUZvcm1hdC5KUEc7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgcmV0dXJuIC0yOw0KICAgICAgfQ0KICAgIH0NCiAgICBkYXRhVHlwZSA9IGRhdGFUeXBlLnRvTG93ZXJDYXNlKCk7DQogICAgd2luZG93DQogICAgICAuZmV0Y2godXJsKQ0KICAgICAgLnRoZW4oKHIpID0+IHIuYXJyYXlCdWZmZXIoKSkNCiAgICAgIC50aGVuKChhcnJheUJ1ZmZlcikgPT4gew0KICAgICAgICBjb25zdCBzdG9yYWdlID0gdm0ucnVudGltZS5zdG9yYWdlOw0KICAgICAgICAvLyAgQHRzLWV4cGVjdC1lcnJvcg0KICAgICAgICB2bS5hZGRDb3N0dW1lKGNvc3R1bWVfbmFtZSArIGAuJHtkYXRhVHlwZS50b1VwcGVyQ2FzZSgpfWAsIHsNCiAgICAgICAgICBuYW1lOiBjb3N0dW1lX25hbWUgKyAiIiwNCiAgICAgICAgICBhc3NldDogbmV3IHN0b3JhZ2UuQXNzZXQoDQogICAgICAgICAgICBkYXRhVHlwZSA9PSAic3ZnIg0KICAgICAgICAgICAgICA/IHN0b3JhZ2UuQXNzZXRUeXBlLkltYWdlVmVjdG9yDQogICAgICAgICAgICAgIDogc3RvcmFnZS5Bc3NldFR5cGUuSW1hZ2VCaXRtYXAsDQogICAgICAgICAgICBudWxsLA0KICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBZRVMgSVQgSVMgU0hVVCBUUyBsb2wNCiAgICAgICAgICAgIGRhdGFGb3JtYXQsDQogICAgICAgICAgICBuZXcgVWludDhBcnJheShhcnJheUJ1ZmZlciksDQogICAgICAgICAgICB0cnVlDQogICAgICAgICAgKSwNCiAgICAgICAgfSk7DQogICAgICB9KTsNCiAgICByZXR1cm4gMTsNCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVJbWFnZShuYW1lLCB1cmwsIG9uY2xpY2spIHsNCiAgICB2YXIgbGliSXRlbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgICAnZGl2W2NsYXNzXj0ibGlicmFyeS1pdGVtX2xpYnJhcnktaXRlbSJdJw0KICAgICk7DQogICAgdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICBsaWJJdGVtLmNsYXNzTGlzdC5mb3JFYWNoKChjbGFzc18pID0+IHsNCiAgICAgIHdyYXBwZXIuY2xhc3NMaXN0LmFkZChjbGFzc18pOw0KICAgIH0pOw0KICAgIHdyYXBwZXIucm9sZSA9ICJidXR0b24iOw0KICAgIHdyYXBwZXIudGFiSW5kZXggPSAiMCI7DQogICAgdmFyIGltYWdlV3JhcHBlck91dGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgdmFyIGltYWdlV3JhcHBlcklubmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgbGliSXRlbS5jaGlsZE5vZGVzWzBdLmNsYXNzTGlzdC5mb3JFYWNoKChjbGFzc18pID0+IHsNCiAgICAgIGltYWdlV3JhcHBlck91dGVyLmNsYXNzTGlzdC5hZGQoY2xhc3NfKTsNCiAgICB9KTsNCiAgICBsaWJJdGVtLmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5jbGFzc0xpc3QuZm9yRWFjaCgoY2xhc3NfKSA9PiB7DQogICAgICBpbWFnZVdyYXBwZXJJbm5lci5jbGFzc0xpc3QuYWRkKGNsYXNzXyk7DQogICAgfSk7DQogICAgdmFyIGltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7DQogICAgaW1hZ2UuY2xhc3NMaXN0LmFkZCgNCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2ltZ1tjbGFzc149ImxpYnJhcnktaXRlbV9saWJyYXJ5LWl0ZW0taW1hZ2UiXScpDQogICAgICAgIC5jbGFzc0xpc3RbMF0NCiAgICApOw0KICAgIGltYWdlLmRyYWdnYWJsZSA9IGZhbHNlOw0KICAgIGltYWdlLmxvYWRpbmcgPSAibGF6eSI7DQogICAgaW1hZ2Uuc3JjID0gdXJsOw0KICAgIGltYWdlV3JhcHBlcklubmVyLmFwcGVuZENoaWxkKGltYWdlKTsNCiAgICBpbWFnZVdyYXBwZXJPdXRlci5hcHBlbmRDaGlsZChpbWFnZVdyYXBwZXJJbm5lcik7DQogICAgd3JhcHBlci5hcHBlbmRDaGlsZChpbWFnZVdyYXBwZXJPdXRlcik7DQogICAgdmFyIHRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOw0KICAgIHRpdGxlLmNsYXNzTGlzdC5hZGQoDQogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdzcGFuW2NsYXNzXj0ibGlicmFyeS1pdGVtX2xpYnJhcnktaXRlbS1uYW1lIl0nKQ0KICAgICAgICAuY2xhc3NMaXN0WzBdDQogICAgKTsNCiAgICB0aXRsZS5pbm5lckhUTUwgPSBuYW1lOw0KICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQodGl0bGUpOw0KICAgIHdyYXBwZXIub25jbGljayA9IGZ1bmN0aW9uIChlKSB7DQogICAgICBvbmNsaWNrKGUsIHRoaXMpOw0KICAgIH07DQogICAgcmV0dXJuIHdyYXBwZXI7DQogIH0NCiAgZnVuY3Rpb24gbG9hZEN1c3RvbUNvc3R1bWVzKG5hbWVzcGFjZSkgew0KICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgbGV0IGxpYnJhcnkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKA0KICAgICAgICAnZGl2W2NsYXNzXj0ibGlicmFyeV9saWJyYXJ5LXNjcm9sbC1ncmlkIl0nDQogICAgICApOw0KICAgICAgZnVuY3Rpb24gYWRkKGVsZW0pIHsNCiAgICAgICAgbGlicmFyeS5jaGlsZE5vZGVzWzBdLmJlZm9yZShlbGVtLCBsaWJyYXJ5LmNoaWxkTm9kZXNbMF0pOw0KICAgICAgfQ0KICAgICAgZnVuY3Rpb24gbG9hZEltYWdlRm4oZSwgc2VsZikgew0KICAgICAgICBpbXBvcnRJbWFnZSgNCiAgICAgICAgICBzZWxmLnF1ZXJ5U2VsZWN0b3IoImltZyIpLnNyYywNCiAgICAgICAgICBzZWxmLnF1ZXJ5U2VsZWN0b3IoInNwYW4iKS5pbm5lckhUTUwNCiAgICAgICAgKTsNCiAgICAgICAgZG9jdW1lbnQNCiAgICAgICAgICAucXVlcnlTZWxlY3RvcigNCiAgICAgICAgICAgICdkaXZbY2xhc3NePSJtb2RhbF9oZWFkZXItaXRlbSJdIHNwYW5bY2xhc3NePSJidXR0b25fb3V0bGluZWQtYnV0dG9uIl0nDQogICAgICAgICAgKQ0KICAgICAgICAgIC5jbGljaygpOw0KICAgICAgfQ0KICAgICAgLy95b3UgZG9udCBuZWVkIHRvIGRvIHRoaXMgaWYgeW91IGFyZSBzdGVhbGluZyBmcm9tIG1lLCB3aGljaCBwbGVhc2UgZG9udCBkbyA6c29iOg0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZSgNCiAgICAgICAgbG9jYWxTdG9yYWdlLmdldEl0ZW0obmFtZXNwYWNlID8/ICJ0d3U6Y3VzdG9tSW1hZ2VzIikNCiAgICAgICk7DQogICAgICBpZiAoZm91bmQubGVuZ3RoID09IDApIHJldHVybjsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZm91bmQubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgbGV0IGNvcyA9IGZvdW5kW2ldOw0KICAgICAgICBhZGQoY3JlYXRlSW1hZ2UoY29zLm5hbWUsIGNvcy51cmwsIGxvYWRJbWFnZUZuKSk7DQogICAgICB9DQogICAgfSwgMjAwMCk7DQogIH0NCiAgZnVuY3Rpb24gbG9hZEN1c3RvbUJhY2tkcm9wcygpIHsNCiAgICBsb2FkQ3VzdG9tQ29zdHVtZXMoInR3dTpjdXN0b21CYWNrZHJvcHMiKTsNCiAgfQ0KICBjb25zdCBvYnNlcnZlckNvbmZpZyA9IHsNCiAgICBhdHRyaWJ1dGVzOiB0cnVlLA0KICAgIGNoaWxkTGlzdDogdHJ1ZSwNCiAgICBjaGFyYWN0ZXJEYXRhOiB0cnVlLA0KICB9Ow0KICBjb25zdCBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKChtdXRhdGlvbnMpID0+IHsNCiAgICBtdXRhdGlvbnMuZm9yRWFjaCgobXV0YXRpb24pID0+IHsNCiAgICAgIGlmIChtdXRhdGlvbi50eXBlID09ICJhdHRyaWJ1dGVzIikgcmV0dXJuOw0KICAgICAgaWYgKG11dGF0aW9uLmFkZGVkTm9kZXMubGVuZ3RoID4gMCkgew0KICAgICAgICBpZiAobXV0YXRpb24uYWRkZWROb2Rlc1swXS5jbGFzc0xpc3QuY29udGFpbnMoIlJlYWN0TW9kYWxQb3J0YWwiKSkgew0KICAgICAgICAgIGxldCBtb2RhbFRpdGxlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigNCiAgICAgICAgICAgICdbY2xhc3NePSJtb2RhbF9oZWFkZXItaXRlbSJdJw0KICAgICAgICAgICkuaW5uZXJIVE1MOw0KICAgICAgICAgIHN3aXRjaCAobW9kYWxUaXRsZSkgew0KICAgICAgICAgICAgY2FzZSAiQ2hvb3NlIGEgU3ByaXRlIjoNCiAgICAgICAgICAgICAgbG9hZEN1c3RvbUNvc3R1bWVzKCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSAiQ2hvb3NlIGEgQmFja2Ryb3AiOg0KICAgICAgICAgICAgICBsb2FkQ3VzdG9tQmFja2Ryb3BzKCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSAiQ2hvb3NlIGEgQ29zdHVtZSI6DQogICAgICAgICAgICAgIGxvYWRDdXN0b21Db3N0dW1lcygpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9KTsNCiAgfSk7DQogIG9ic2VydmVyLm9ic2VydmUoZG9jdW1lbnQuYm9keSwgb2JzZXJ2ZXJDb25maWcpOw0KDQogIC8vU2V0dXAgb3B0aW9ucyBtZW51Lg0KICBjb25zdCBwcmVBcHBlbmQgPSAidHdVb01fIjsNCiAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLmNsYXNzTGlzdC5hZGQoIlRXdW5sb2NrZWRNb2RhbCIpOw0KICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uaW5uZXJIVE1MID0gYDxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLmNsb3NlKCkiPkNsb3NlLjwvYnV0dG9uPjxicj4NCjxkaXY+DQogIDxoND5QTS1VbmxvY2tlZCB8IHYke1ZFUlNJT059PC9oND4NCiAgPGhyPg0KICA8bGFiZWw+PGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLnV0aWxzLmV4dE1hbigpIj5Mb2FkIGV4dGVuc2lvbjwvYnV0dG9uPiA6IA0KICAgIDxpbnB1dCB0eXBlPSJ1cmwiIGlkPSIke3ByZUFwcGVuZH1sZSIvPiZlbXNwOzxsYWJlbD5VbnNhbmRib3hlZDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iJHtwcmVBcHBlbmR9bGVDIiBjaGVja2VkLz4NCiAgPC9sYWJlbD48YnI+PGJ1dHRvbiBzdHlsZT0iZGlzcGxheTpub25lOyIgaWQ9IiR7cHJlQXBwZW5kfSIgb25jbGljaz0iVFd1bmxvY2tlZC51dGlscy5hZGRGb3JJZXh0ZW5zaW9uKCk7dGhpcy5uZXh0RWxlbWVudFNpYmxpbmcucmVtb3ZlKCk7dGhpcy5yZW1vdmUoKTsiIHRpdGxlPSIjQnJpbmcgQmFjayBGb3IgSSI+QnJpbmcgYmFjayB0aGUgRm9yIEkgYmxvY2s8L2J1dHRvbj48YnI+PGhyPg0KICA8YnV0dG9uIGlkPSIke3ByZUFwcGVuZH1zTXMiPkRpc2FibGU8L2J1dHRvbj4gdm0gc2VjdXJpdHkgbWFuYWdlcjxocj4NCiAgPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmV4dE1hbmFnZXIuc2hvdygpOyI+TWFuYWdlIGN1c3RvbSBmZWF0dXJlZCBleHRlbnNpb25zPC9idXR0b24+PGJyPg0KICA8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuY29zTWFuYWdlci5zaG93KCk7Ij5NYW5hZ2UgY3VzdG9tIGNvc3R1bWVzPC9idXR0b24+PGJyPg0KICA8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuZHJvcE1hbmFnZXIuc2hvdygpOyI+TWFuYWdlIGN1c3RvbSBiYWNrZHJvcHM8L2J1dHRvbj48YnI+DQogIDxidXR0b24gb25jbGljaz0idm0ucnVudGltZS5leHRlbnNpb25NYW5hZ2VyLnJlZnJlc2hCbG9ja3MoKSI+UmVmcmVzaCBCbG9ja3M8L2J1dHRvbj48YnI+DQogIDxidXR0b24gb25jbGljaz0idm0ucmVmcmVzaFdvcmtzcGFjZSgpIj5SZWZyZXNoIFdvcmtzcGFjZTwvYnV0dG9uPg0KICA8aHI+DQogIFN1Ym1pdCBhbiBleHRlbnNpb24gdGhhdCBjYW5ub3QgYmUgb24gdGhlIGdhbGxlcnkgdG86IDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9TdXJ2RXhlMVBjL3Vuc2FmZS1leHRlbnNpb25zIj5IRVJFLCBDbGljayBtZSEhPC9hPg0KICA8aHI+DQo8L2Rpdj5gOw0KICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uaWQgPSAiVFd1bmxvY2tlZC1Nb2RhbERpdiI7DQogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtKTsNCiAgLy8gKmNvdWdoKiBpbWEgY29weSBwYXN0ZSBmb3IgYmFja2Ryb3BzLCBhbmQgc291bmRzLCBhbmQgZXh0ZW5zaW9ucy4uLiAqY291Z2gqDQogIC8vQmFja2Ryb3AgbGlicmFyeSBhZGRlciBtb2RhbA0KICBUV3VubG9ja2VkLmRyb3BNYW5hZ2VyID0gew0KICAgIG1lbnVPcGVuOiBmYWxzZSwNCiAgICBsc0lkOiAidHd1OmN1c3RvbUJhY2tkcm9wcyIsDQogICAgZWxlbTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGlhbG9nIiksDQogICAgcG9wKCkgew0KICAgICAgdGhpcy5lbGVtLnJlbW92ZSgpOw0KICAgIH0sDQogICAgY2xvc2UoKSB7DQogICAgICB0aGlzLmVsZW0uY2xvc2UoKTsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5zaG93TW9kYWwoKTsNCiAgICB9LA0KICAgIHNob3coKSB7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uY2xvc2UoKTsNCiAgICAgIHRoaXMuZWxlbS5zaG93TW9kYWwoKTsNCiAgICB9LA0KICAgIHJlZnJlc2hNZW51KCkgew0KICAgICAgY29uc3QgbWVudUJ0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGJ1dHRvbiMke3ByZUFwcGVuZH1kcm9wTWVudUJ0bmApOw0KICAgICAgaWYgKFRXdW5sb2NrZWQuZHJvcE1hbmFnZXIuZWxlbS5vcGVuICYmIHRoaXMubWVudU9wZW4pIHsNCiAgICAgICAgbWVudUJ0bi5jbGljaygpOw0KICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsNCiAgICAgICAgICBtZW51QnRuLmNsaWNrKCk7DQogICAgICAgIH0sIDEwMCk7DQogICAgICB9DQogICAgfSwNCiAgICBhZGQoKSB7DQogICAgICBsZXQgaU5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBpbnB1dCMke3ByZUFwcGVuZH1kcm9waU5hbWVgKTsNCiAgICAgIGxldCBpVXJsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgaW5wdXQjJHtwcmVBcHBlbmR9ZHJvcGlVcmxgKTsNCiAgICAgIHZhciB0bXAgPSBpTmFtZS52YWx1ZTsNCiAgICAgIGlOYW1lLnZhbHVlID0gIiI7DQogICAgICBpTmFtZSA9IHRtcDsNCiAgICAgIHRtcCA9IGlVcmwudmFsdWU7DQogICAgICBpVXJsLnZhbHVlID0gIiI7DQogICAgICBpVXJsID0gdG1wOw0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzSWQpKTsNCiAgICAgIGZvdW5kLnB1c2goeyBuYW1lOiBpTmFtZSwgdXJsOiBpVXJsIH0pOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc0lkLCBKU09OLnN0cmluZ2lmeShmb3VuZCkpOw0KICAgICAgdGhpcy5yZWZyZXNoTWVudSgpOw0KICAgIH0sDQogICAgZ2V0VWwoKSB7DQogICAgICBsZXQgaXRlbXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ1bCIpOw0KICAgICAgaWYgKCFsb2NhbFN0b3JhZ2UuaGFzT3duUHJvcGVydHkodGhpcy5sc0lkKSkNCiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc0lkLCBKU09OLnN0cmluZ2lmeShbXSkpOw0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzSWQpKTsNCiAgICAgIGNvbnN0IG5vSXRlbXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7DQogICAgICBub0l0ZW1zLmlubmVySFRNTCA9ICImbmJzcDsmbmJzcDtObyBiYWNrZHJvcHMgZm91bmQsIHRyeSBhZGRpbmcgc29tZSEiOw0KICAgICAgaWYgKGZvdW5kLmxlbmd0aCA9PSAwKSByZXR1cm4gbm9JdGVtczsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZm91bmQubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgbGV0IGRyb3AgPSBmb3VuZFtpXTsNCiAgICAgICAgdmFyIHRtcDIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOw0KICAgICAgICB0bXAyLmlubmVySFRNTCA9IGAke2Ryb3AubmFtZX0mbmJzcDsmbmJzcDs8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuZHJvcE1hbmFnZXIucG9wSXRlbSgke2l9KSI+UmVtb3ZlPC9idXR0b24+YDsNCiAgICAgICAgaXRlbXMuYXBwZW5kQ2hpbGQodG1wMik7DQogICAgICB9DQogICAgICByZXR1cm4gaXRlbXM7DQogICAgfSwNCiAgICBwb3BJdGVtKG51bSkgew0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzSWQpKTsNCiAgICAgIGZvdW5kLnBvcChudW0pOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc0lkLCBKU09OLnN0cmluZ2lmeShmb3VuZCkpOw0KICAgICAgdGhpcy5yZWZyZXNoTWVudSgpOw0KICAgIH0sDQogICAgdXBkYXRlTWVudSgpIHsNCiAgICAgIGxldCBtZW51QnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgYnV0dG9uIyR7cHJlQXBwZW5kfWRyb3BNZW51QnRuYCk7DQogICAgICBsZXQgbWVudSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGRpdiMke3ByZUFwcGVuZH1kcm9wTWVudWApOw0KICAgICAgaWYgKG1lbnUuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIpIHsNCiAgICAgICAgdGhpcy5tZW51T3BlbiA9IHRydWU7DQogICAgICAgIG1lbnVCdXR0b24uaW5uZXJIVE1MID0gIkhpZGUgbWVudSI7DQogICAgICAgIG1lbnUuc3R5bGUuZGlzcGxheSA9ICIiOw0KICAgICAgICB3aGlsZSAobWVudS5oYXNDaGlsZE5vZGVzKCkpIHsNCiAgICAgICAgICBtZW51LmZpcnN0Q2hpbGQucmVtb3ZlKCk7DQogICAgICAgIH0NCiAgICAgICAgbWVudS5hcHBlbmRDaGlsZCh0aGlzLmdldFVsKCkpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy5tZW51T3BlbiA9IGZhbHNlOw0KICAgICAgICBtZW51QnV0dG9uLmlubmVySFRNTCA9ICJTaG93IG1lbnUiOw0KICAgICAgICBtZW51LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgICB9DQogICAgfSwNCiAgfTsNCiAgVFd1bmxvY2tlZC5kcm9wTWFuYWdlci5lbGVtLmlkID0gIlRXdW5sb2NrZWQtZHJvcE1hbmFnZXIiOw0KICBUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLmVsZW0uaW5uZXJIVE1MID0gYDxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5kcm9wTWFuYWdlci5jbG9zZSgpIj5CYWNrPC9idXR0b24+PGhyPg0KICA8aDM+QWRkIGEgY3VzdG9tIGJhY2tkcm9wIGltYWdlOjwvaDM+DQogIDxsYWJlbD5JbWFnZSBuYW1lOiA8aW5wdXQgaWQ9IiR7cHJlQXBwZW5kfWRyb3BpTmFtZSIvPjxicj48L2xhYmVsPg0KICA8bGFiZWw+SW1hZ2UgdXJsOiA8aW5wdXQgaWQ9IiR7cHJlQXBwZW5kfWRyb3BpVXJsIi8+PGJyPjwvbGFiZWw+DQogIDxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5kcm9wTWFuYWdlci5hZGQoKSI+QWRkPC9idXR0b24+PGhyPg0KICA8c3Bhbj5DdXN0b20gaW1hZ2VzOiA8ZGl2IGlkPSIke3ByZUFwcGVuZH1kcm9wTWVudSIgc3R5bGU9ImRpc3BsYXk6bm9uZTsiPjwvZGl2Pg0KICA8YnV0dG9uIGlkPSIke3ByZUFwcGVuZH1kcm9wTWVudUJ0biIgb25jbGljaz0iVFd1bmxvY2tlZC5kcm9wTWFuYWdlci51cGRhdGVNZW51KCkiPlNob3cgbWVudTwvYnV0dG9uPjxicj48L3NwYW4+YDsNCiAgVFd1bmxvY2tlZC5kcm9wTWFuYWdlci5lbGVtLmNsYXNzTGlzdC5hZGQoIlRXdW5sb2NrZWRNb2RhbCIpOw0KICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKFRXdW5sb2NrZWQuZHJvcE1hbmFnZXIuZWxlbSk7DQogIC8vQ29zdHVtZSBsaWJyYXJ5IGFkZGVyIG1vZGFsDQogIFRXdW5sb2NrZWQuY29zTWFuYWdlciA9IHsNCiAgICBtZW51T3BlbjogZmFsc2UsDQogICAgZWxlbTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGlhbG9nIiksDQogICAgbHNJZDogInR3dTpjdXN0b21JbWFnZXMiLA0KICAgIHBvcCgpIHsNCiAgICAgIHRoaXMuZWxlbS5yZW1vdmUoKTsNCiAgICB9LA0KICAgIGNsb3NlKCkgew0KICAgICAgdGhpcy5lbGVtLmNsb3NlKCk7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uc2hvd01vZGFsKCk7DQogICAgfSwNCiAgICBzaG93KCkgew0KICAgICAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLmNsb3NlKCk7DQogICAgICB0aGlzLmVsZW0uc2hvd01vZGFsKCk7DQogICAgfSwNCiAgICByZWZyZXNoTWVudSgpIHsNCiAgICAgIGNvbnN0IG1lbnVCdG4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBidXR0b24jJHtwcmVBcHBlbmR9Y29zTWVudUJ0bmApOw0KICAgICAgaWYgKFRXdW5sb2NrZWQuY29zTWFuYWdlci5lbGVtLm9wZW4gJiYgdGhpcy5tZW51T3Blbikgew0KICAgICAgICBtZW51QnRuLmNsaWNrKCk7DQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gew0KICAgICAgICAgIG1lbnVCdG4uY2xpY2soKTsNCiAgICAgICAgfSwgMTAwKTsNCiAgICAgIH0NCiAgICB9LA0KICAgIGFkZCgpIHsNCiAgICAgIGxldCBpTmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGlucHV0IyR7cHJlQXBwZW5kfWNvc2lOYW1lYCk7DQogICAgICBsZXQgaVVybCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGlucHV0IyR7cHJlQXBwZW5kfWNvc2lVcmxgKTsNCiAgICAgIHZhciB0bXAgPSBpTmFtZS52YWx1ZTsNCiAgICAgIGlOYW1lLnZhbHVlID0gIiI7DQogICAgICBpTmFtZSA9IHRtcDsNCiAgICAgIHRtcCA9IGlVcmwudmFsdWU7DQogICAgICBpVXJsLnZhbHVlID0gIiI7DQogICAgICBpVXJsID0gdG1wOw0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzSWQpKTsNCiAgICAgIGZvdW5kLnB1c2goeyBuYW1lOiBpTmFtZSwgdXJsOiBpVXJsIH0pOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc0lkLCBKU09OLnN0cmluZ2lmeShmb3VuZCkpOw0KICAgICAgdGhpcy5yZWZyZXNoTWVudSgpOw0KICAgIH0sDQogICAgZ2V0VWwoKSB7DQogICAgICBsZXQgaXRlbXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ1bCIpOw0KICAgICAgaWYgKCFsb2NhbFN0b3JhZ2UuaGFzT3duUHJvcGVydHkodGhpcy5sc0lkKSkNCiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc0lkLCBKU09OLnN0cmluZ2lmeShbXSkpOw0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzSWQpKTsNCiAgICAgIGNvbnN0IG5vSXRlbXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7DQogICAgICBub0l0ZW1zLmlubmVySFRNTCA9ICImbmJzcDsmbmJzcDtObyBjb3N0dW1lcyBmb3VuZCwgdHJ5IGFkZGluZyBzb21lISI7DQogICAgICBpZiAoZm91bmQubGVuZ3RoID09IDApIHJldHVybiBub0l0ZW1zOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmb3VuZC5sZW5ndGg7IGkrKykgew0KICAgICAgICBsZXQgY29zID0gZm91bmRbaV07DQogICAgICAgIHZhciB0bXAyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsNCiAgICAgICAgdG1wMi5pbm5lckhUTUwgPSBgJHtjb3MubmFtZX0mbmJzcDsmbmJzcDs8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuY29zTWFuYWdlci5wb3BJdGVtKCR7aX0pIj5SZW1vdmU8L2J1dHRvbj5gOw0KICAgICAgICBpdGVtcy5hcHBlbmRDaGlsZCh0bXAyKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBpdGVtczsNCiAgICB9LA0KICAgIHBvcEl0ZW0obnVtKSB7DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNJZCkpOw0KICAgICAgZm91bmQucG9wKG51bSk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzSWQsIEpTT04uc3RyaW5naWZ5KGZvdW5kKSk7DQogICAgICB0aGlzLnJlZnJlc2hNZW51KCk7DQogICAgfSwNCiAgICB1cGRhdGVNZW51KCkgew0KICAgICAgbGV0IG1lbnVCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBidXR0b24jJHtwcmVBcHBlbmR9Y29zTWVudUJ0bmApOw0KICAgICAgbGV0IG1lbnUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBkaXYjJHtwcmVBcHBlbmR9Y29zTWVudWApOw0KICAgICAgaWYgKG1lbnUuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIpIHsNCiAgICAgICAgdGhpcy5tZW51T3BlbiA9IHRydWU7DQogICAgICAgIG1lbnVCdXR0b24uaW5uZXJIVE1MID0gIkhpZGUgbWVudSI7DQogICAgICAgIG1lbnUuc3R5bGUuZGlzcGxheSA9ICIiOw0KICAgICAgICB3aGlsZSAobWVudS5oYXNDaGlsZE5vZGVzKCkpIHsNCiAgICAgICAgICBtZW51LmZpcnN0Q2hpbGQucmVtb3ZlKCk7DQogICAgICAgIH0NCiAgICAgICAgbWVudS5hcHBlbmRDaGlsZCh0aGlzLmdldFVsKCkpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy5tZW51T3BlbiA9IGZhbHNlOw0KICAgICAgICBtZW51QnV0dG9uLmlubmVySFRNTCA9ICJTaG93IG1lbnUiOw0KICAgICAgICBtZW51LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgICB9DQogICAgfSwNCiAgfTsNCiAgVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLmVsZW0uaWQgPSAiVFd1bmxvY2tlZC1jb3NNYW5hZ2VyIjsNCiAgVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLmVsZW0uaW5uZXJIVE1MID0gYDxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLmNsb3NlKCkiPkJhY2s8L2J1dHRvbj48aHI+DQo8aDM+QWRkIGEgY3VzdG9tIHNwcml0ZSAvIGNvc3R1bWUgaW1hZ2U6PC9oMz4NCjxsYWJlbD5JbWFnZSBuYW1lOiA8aW5wdXQgaWQ9IiR7cHJlQXBwZW5kfWNvc2lOYW1lIi8+PGJyPjwvbGFiZWw+DQo8bGFiZWw+SW1hZ2UgdXJsOiA8aW5wdXQgaWQ9IiR7cHJlQXBwZW5kfWNvc2lVcmwiLz48YnI+PC9sYWJlbD4NCjxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLmFkZCgpIj5BZGQ8L2J1dHRvbj48aHI+DQo8c3Bhbj5DdXN0b20gaW1hZ2VzOiA8ZGl2IGlkPSIke3ByZUFwcGVuZH1jb3NNZW51IiBzdHlsZT0iZGlzcGxheTpub25lOyI+PC9kaXY+DQo8YnV0dG9uIGlkPSIke3ByZUFwcGVuZH1jb3NNZW51QnRuIiBvbmNsaWNrPSJUV3VubG9ja2VkLmNvc01hbmFnZXIudXBkYXRlTWVudSgpIj5TaG93IG1lbnU8L2J1dHRvbj48YnI+PC9zcGFuPmA7DQogIFRXdW5sb2NrZWQuY29zTWFuYWdlci5lbGVtLmNsYXNzTGlzdC5hZGQoIlRXdW5sb2NrZWRNb2RhbCIpOw0KICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKFRXdW5sb2NrZWQuY29zTWFuYWdlci5lbGVtKTsNCiAgLy9leHRlbnNpb24gbGlicmFyeSBhZGRlciBtb2RhbA0KICBUV3VubG9ja2VkLmV4dE1hbmFnZXIgPSB7DQogICAgbWVudU9wZW46IGZhbHNlLA0KICAgIGVsZW06IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpYWxvZyIpLA0KICAgIGxzSWQ6ICJ0d3U6Y3VzdG9tRXh0ZW5zaW9ucyIsDQogICAgbHNTSWQ6ICJ0d3U6Y3VzdG9tRXh0ZW5zaW9uc1NldHRpbmdzIiwNCiAgICBwb3AoKSB7DQogICAgICB0aGlzLmVsZW0ucmVtb3ZlKCk7DQogICAgfSwNCiAgICBjbG9zZSgpIHsNCiAgICAgIHRoaXMuZWxlbS5jbG9zZSgpOw0KICAgICAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLnNob3dNb2RhbCgpOw0KICAgIH0sDQogICAgc2hvdygpIHsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5jbG9zZSgpOw0KICAgICAgdGhpcy5lbGVtLnNob3dNb2RhbCgpOw0KICAgIH0sDQogICAgcmVmcmVzaE1lbnUoKSB7DQogICAgICBjb25zdCBtZW51QnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgYnV0dG9uIyR7cHJlQXBwZW5kfWV4dE1lbnVCdG5gKTsNCiAgICAgIGlmIChUV3VubG9ja2VkLmV4dE1hbmFnZXIuZWxlbS5vcGVuICYmIHRoaXMubWVudU9wZW4pIHsNCiAgICAgICAgbWVudUJ0bi5jbGljaygpOw0KICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsNCiAgICAgICAgICBtZW51QnRuLmNsaWNrKCk7DQogICAgICAgIH0sIDEwMCk7DQogICAgICB9DQogICAgfSwNCiAgICBhZGQoKSB7DQogICAgICBsZXQgaU5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBpbnB1dCMke3ByZUFwcGVuZH1leHRpTmFtZWApOw0KICAgICAgbGV0IGlVcmwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBpbnB1dCMke3ByZUFwcGVuZH1leHRpVXJsYCk7DQogICAgICBsZXQgYVVybCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGlucHV0IyR7cHJlQXBwZW5kfWV4dGFVcmxgKTsNCiAgICAgIGxldCBiVXJsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgdGV4dGFyZWEjJHtwcmVBcHBlbmR9ZXh0YlVybGApOw0KICAgICAgdmFyIHRtcCA9IGlOYW1lLnZhbHVlOw0KICAgICAgaU5hbWUudmFsdWUgPSAiIjsNCiAgICAgIGlOYW1lID0gdG1wOw0KICAgICAgdG1wID0gaVVybC52YWx1ZTsNCiAgICAgIGlVcmwudmFsdWUgPSAiIjsNCiAgICAgIGlVcmwgPSB0bXA7DQogICAgICB0bXAgPSBhVXJsLnZhbHVlOw0KICAgICAgYVVybC52YWx1ZSA9ICIiOw0KICAgICAgYVVybCA9IHRtcDsNCiAgICAgIHRtcCA9IGJVcmwudmFsdWU7DQogICAgICBiVXJsLnZhbHVlID0gIiI7DQogICAgICBiVXJsID0gdG1wOw0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzSWQpKTsNCiAgICAgIGZvdW5kLnB1c2goeyBuYW1lOiBpTmFtZSwgdXJsOiBpVXJsLCBpbWFnZV91cmw6IGFVcmwsIGRlc2NyaXB0aW9uOiBiVXJsIH0pOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc0lkLCBKU09OLnN0cmluZ2lmeShmb3VuZCkpOw0KICAgICAgdGhpcy5yZWZyZXNoTWVudSgpOw0KICAgIH0sDQogICAgZ2V0VWwoKSB7DQogICAgICBsZXQgaXRlbXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ1bCIpOw0KICAgICAgaWYgKCFsb2NhbFN0b3JhZ2UuaGFzT3duUHJvcGVydHkodGhpcy5sc0lkKSkNCiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc0lkLCBKU09OLnN0cmluZ2lmeShbXSkpOw0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzSWQpKTsNCiAgICAgIGNvbnN0IG5vSXRlbXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7DQogICAgICBub0l0ZW1zLmlubmVySFRNTCA9ICImbmJzcDsmbmJzcDtObyBleHRlbnNpb25zIGZvdW5kLCB0cnkgYWRkaW5nIHNvbWUhIjsNCiAgICAgIGlmIChmb3VuZC5sZW5ndGggPT0gMCkgcmV0dXJuIG5vSXRlbXM7DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZvdW5kLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGxldCBleHQgPSBmb3VuZFtpXTsNCiAgICAgICAgdmFyIHRtcDIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOw0KICAgICAgICB0bXAyLmlubmVySFRNTCA9IGAke2V4dC5uYW1lfSZuYnNwOyZuYnNwOzxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5leHRNYW5hZ2VyLnBvcEl0ZW0oJHtpfSkiPlJlbW92ZTwvYnV0dG9uPmA7DQogICAgICAgIGl0ZW1zLmFwcGVuZENoaWxkKHRtcDIpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIGl0ZW1zOw0KICAgIH0sDQogICAgcG9wSXRlbShudW0pIHsNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc0lkKSk7DQogICAgICBmb3VuZC5wb3AobnVtKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNJZCwgSlNPTi5zdHJpbmdpZnkoZm91bmQpKTsNCiAgICAgIHRoaXMucmVmcmVzaE1lbnUoKTsNCiAgICB9LA0KICAgIHVwZGF0ZU1lbnUoKSB7DQogICAgICBsZXQgbWVudUJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGJ1dHRvbiMke3ByZUFwcGVuZH1leHRNZW51QnRuYCk7DQogICAgICBsZXQgbWVudSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGRpdiMke3ByZUFwcGVuZH1leHRNZW51YCk7DQogICAgICBpZiAobWVudS5zdHlsZS5kaXNwbGF5ID09ICJub25lIikgew0KICAgICAgICB0aGlzLm1lbnVPcGVuID0gdHJ1ZTsNCiAgICAgICAgbWVudUJ1dHRvbi5pbm5lckhUTUwgPSAiSGlkZSBtZW51IjsNCiAgICAgICAgbWVudS5zdHlsZS5kaXNwbGF5ID0gIiI7DQogICAgICAgIHdoaWxlIChtZW51Lmhhc0NoaWxkTm9kZXMoKSkgew0KICAgICAgICAgIG1lbnUuZmlyc3RDaGlsZC5yZW1vdmUoKTsNCiAgICAgICAgfQ0KICAgICAgICBtZW51LmFwcGVuZENoaWxkKHRoaXMuZ2V0VWwoKSk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLm1lbnVPcGVuID0gZmFsc2U7DQogICAgICAgIG1lbnVCdXR0b24uaW5uZXJIVE1MID0gIlNob3cgbWVudSI7DQogICAgICAgIG1lbnUuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICAgIH0NCiAgICB9LA0KICAgIGdldE1hcmtzKCkgew0KICAgICAgbGV0IGZvdW5kID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc1NJZCk7DQogICAgICBpZiAoZm91bmQgPT0gdW5kZWZpbmVkIHx8IGZvdW5kID09IG51bGwgfHwgZm91bmQgPT0gJ3VuZGVmaW5lZCcpIGZvdW5kID0gew0KICAgICAgICBteUdhbGxlcnk6IGZhbHNlLA0KICAgICAgICBzcEdhbGxlcnk6IGZhbHNlDQogICAgICB9DQogICAgICBpZiAodHlwZW9mIGZvdW5kICE9PSAnb2JqZWN0JykgZm91bmQgPSBKU09OLnBhcnNlKGZvdW5kKTsNCiAgICAgIGlmICghZm91bmQuaGFzT3duUHJvcGVydHkoJ215R2FsbGVyeScpKSBmb3VuZC5teUdhbGxlcnkgPSBmYWxzZTsNCiAgICAgIGlmICghZm91bmQuaGFzT3duUHJvcGVydHkoJ3NwR2FsbGVyeScpKSBmb3VuZC5zcEdhbGxlcnkgPSBmYWxzZTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNTSWQsIEpTT04uc3RyaW5naWZ5KGZvdW5kKSk7DQogICAgICByZXR1cm4gZm91bmQ7DQogICAgfSwNCiAgICB1cGRhdGVDaGVja21hcmtzKCkgew0KICAgICAgbGV0IGZvdW5kID0gdGhpcy5nZXRNYXJrcygpOw0KICAgICAgZm91bmQubXlHYWxsZXJ5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgaW5wdXQjJHtwcmVBcHBlbmR9ZXh0Z0xvYWRNaW5lYCkuY2hlY2tlZDsNCiAgICAgIGZvdW5kLnNwR2FsbGVyeSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGlucHV0IyR7cHJlQXBwZW5kfWV4dGdMb2FkU1BgKS5jaGVja2VkOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc1NJZCwgSlNPTi5zdHJpbmdpZnkoZm91bmQpKTsNCiAgICB9LA0KICAgIGdldENoZWNrKGNoZWNrKSB7DQogICAgICBsZXQgZm91bmQgPSB0aGlzLmdldE1hcmtzKCk7DQogICAgICByZXR1cm4gZm91bmRbY2hlY2tdOw0KICAgIH0sDQogIH07DQogIFRXdW5sb2NrZWQuZXh0TWFuYWdlci5lbGVtLmlkID0gIlRXdW5sb2NrZWQtZXh0TWFuYWdlciI7DQogIFRXdW5sb2NrZWQuZXh0TWFuYWdlci5lbGVtLmlubmVySFRNTCA9IGA8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuZXh0TWFuYWdlci5jbG9zZSgpIj5CYWNrPC9idXR0b24+PGhyPg0KPGgzPkFkZCBhIGN1c3RvbSBleHRlbnNpb248L2gzPg0KPGxhYmVsPkV4dGVuc2lvbiBuYW1lOiA8aW5wdXQgaWQ9IiR7cHJlQXBwZW5kfWV4dGlOYW1lIi8+PGJyPjwvbGFiZWw+DQo8bGFiZWw+RXh0ZW5zaW9uIHVybDogPGlucHV0IGlkPSIke3ByZUFwcGVuZH1leHRpVXJsIi8+PGJyPjwvbGFiZWw+DQo8bGFiZWw+RXh0ZW5zaW9uIGltYWdlIHVybDogPGlucHV0IGlkPSIke3ByZUFwcGVuZH1leHRhVXJsIi8+PGJyPjwvbGFiZWw+DQo8bGFiZWw+RXh0ZW5zaW9uIGRlc2NyaXB0aW9uOiA8dGV4dGFyZWEgaWQ9IiR7cHJlQXBwZW5kfWV4dGJVcmwiPjwvdGV4dGFyZWE+PGJyPjwvbGFiZWw+DQo8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuZXh0TWFuYWdlci5hZGQoKSI+QWRkPC9idXR0b24+PGhyPg0KPHNwYW4+Q3VzdG9tIGV4dGVuc2lvbnM6IDxkaXYgaWQ9IiR7cHJlQXBwZW5kfWV4dE1lbnUiIHN0eWxlPSJkaXNwbGF5Om5vbmU7Ij48L2Rpdj4NCjxidXR0b24gaWQ9IiR7cHJlQXBwZW5kfWV4dE1lbnVCdG4iIG9uY2xpY2s9IlRXdW5sb2NrZWQuZXh0TWFuYWdlci51cGRhdGVNZW51KCkiPlNob3cgbWVudTwvYnV0dG9uPjxicj48L3NwYW4+DQo8bGFiZWw+YXV0byBsb2FkIGZyb20gPGEgaHJlZj0iaHR0cHM6Ly9zdXJ2LmlzLWEuZGV2L3Vuc2FmZS1leHRlbnNpb25zLyI+dW5zYWZlLWdhbGxlcnk8L2E+OiA8aW5wdXQgaWQ9IiR7cHJlQXBwZW5kfWV4dGdMb2FkTWluZSIgdHlwZT0iY2hlY2tib3giJHsoVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmdldENoZWNrKCdteUdhbGxlcnknKSA/ICcgY2hlY2tlZCcgOiAnJyl9IG9uY2xpY2s9IlRXdW5sb2NrZWQuZXh0TWFuYWdlci51cGRhdGVDaGVja21hcmtzKCkiLz48YnI+PC9sYWJlbD4NCjxsYWJlbD5hdXRvIGxvYWQgZnJvbSA8YSBocmVmPSJodHRwczovL3N1cnYuaXMtYS5kZXYvdW5zYWZlLWV4dGVuc2lvbnMvIj5zaGFya3Bvb2xzIGdhbGxlcnk8L2E+OiA8aW5wdXQgaWQ9IiR7cHJlQXBwZW5kfWV4dGdMb2FkU1AiIHR5cGU9ImNoZWNrYm94IiR7KFRXdW5sb2NrZWQuZXh0TWFuYWdlci5nZXRDaGVjaygnc3BHYWxsZXJ5JykgPyAnIGNoZWNrZWQnIDogJycpfSBvbmNsaWNrPSJUV3VubG9ja2VkLmV4dE1hbmFnZXIudXBkYXRlQ2hlY2ttYXJrcygpIi8+PGJyPjwvbGFiZWw+YDsNCiAgVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmVsZW0uY2xhc3NMaXN0LmFkZCgiVFd1bmxvY2tlZE1vZGFsIik7DQogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmVsZW0pOw0KICBjb25zdCBsb2FkRXh0ZW5zaW9uSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChwcmVBcHBlbmQgKyAibGUiKTsNCiAgY29uc3QgbG9hZEV4dGVuc2lvbl91bnNhbmRib3hlZENoZWNrID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoDQogICAgcHJlQXBwZW5kICsgImxlQyINCiAgKTsNCiAgY29uc3Qgc2VjdXJpdHlNYW5hZ2VyU3dpdGNoQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocHJlQXBwZW5kICsgInNNcyIpOw0KICBzZWN1cml0eU1hbmFnZXJTd2l0Y2hCdG4ub25jbGljayA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAodGhpcy5pbm5lclRleHQgPT0gIkRpc2FibGUiKSB7DQogICAgICB0aGlzLmlubmVyVGV4dCA9ICJFbmFibGUiOw0KICAgICAgVFd1bmxvY2tlZC5kaXNhYmxlUGVybWlzc2lvblNlY3VyaXR5KCk7DQogICAgfSBlbHNlIHsNCiAgICAgIHRoaXMuaW5uZXJUZXh0ID0gIkRpc2FibGUiOw0KICAgICAgVFd1bmxvY2tlZC5yZXN0b3JlUGVybWlzc2lvblNlY3VyaXR5KCk7DQogICAgfQ0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLmV4dE1hbiA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAobG9hZEV4dGVuc2lvbl91bnNhbmRib3hlZENoZWNrLmNoZWNrZWQpIHsNCiAgICAgIFRXdW5sb2NrZWQubG9hZEV4dGVuc2lvblVuc2FuZGJveGVkKGxvYWRFeHRlbnNpb25JbnB1dC52YWx1ZSk7DQogICAgfSBlbHNlIHsNCiAgICAgIHZtLnJ1bnRpbWUuZXh0ZW5zaW9uTWFuYWdlci5sb2FkRXh0ZW5zaW9uVVJMKGxvYWRFeHRlbnNpb25JbnB1dC52YWx1ZSk7DQogICAgfQ0KICB9Ow0KDQogIFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uID0ge307DQogIFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uLmRvbnRGaXhCdXR0b24gPSBUV3VubG9ja2VkLmlzRGVza3RvcDsNCiAgVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24ub2xkSHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7DQogIFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uLnVwZGF0ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAoVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24uZG9udEZpeEJ1dHRvbikgew0KICAgICAgY2xlYXJJbnRlcnZhbChUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbi5idG5JdmwpOw0KICAgICAgVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24uYnRuSXZsID0gInN0b3BwZWQiOw0KICAgICAgVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24gPSAiIjsNCiAgICAgIGRlbGV0ZSBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbjsNCiAgICAgIHJldHVybjsNCiAgICB9DQogICAgaWYgKA0KICAgICAgIVRXdW5sb2NrZWQuaXNEZXNrdG9wICYmDQogICAgICAoZG9jdW1lbnQubG9jYXRpb24uaHJlZiAhPSBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbi5vbGRIcmVmIHx8DQogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJUV3VubG9ja2VkLU5hdkJ0biIpID09IG51bGwpDQogICAgKSB7DQogICAgICBUV3VubG9ja2VkLm9wZW5CdXR0b24uYWRkU2VsZlRvTmF2KCk7DQogICAgICByZXR1cm47DQogICAgfQ0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbi5idG5JdmwgPSBzZXRJbnRlcnZhbCgNCiAgICBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbi51cGRhdGUsDQogICAgNTANCiAgKTsNCiAgVFd1bmxvY2tlZC51dGlscy51cGRhdGVUaWNrID0gZnVuY3Rpb24gKCkgew0KICAgIGlmIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdidXR0b25bY2xhc3NePSJndWlfZXh0ZW5zaW9uLWJ1dHRvbiJdJykpDQogICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dEJ0bkFkZExpc3RlbigpOw0KICAgIGxldCB0b29sYm94ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiZGl2LmJsb2NrbHlUb29sYm94RGl2Iik7DQogICAgaWYgKHRvb2xib3ggJiYgdG9vbGJveC5vbmNvbnRleHRtZW51ID09IG51bGwpDQogICAgICB0b29sYm94Lm9uY29udGV4dG1lbnUgPSB0b29sYm94TWVudTsNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy51cGRhdGVJdmwgPSBzZXRJbnRlcnZhbChUV3VubG9ja2VkLnV0aWxzLnVwZGF0ZVRpY2ssIDUwKTsNCg0KICAvL1VTTQ0KICBUV3VubG9ja2VkLmF0dGVtcHRSZW1vdmFsT2ZVU01zY3JpcHQgPSBmdW5jdGlvbiAoKSB7DQogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIlRXdW5sb2NrZWQtU2NyaXB0LSIgKyBUV3VubG9ja2VkLnRvcExvYWRlcik7DQogIH07DQoNCiAgLy9BZGQgdGhlIG1vZGFsLg0KICBUV3VubG9ja2VkLm9wZW5CdXR0b24gPSBUV3VubG9ja2VkLmFkZE1lbnVCdG4oIlBNLVVubG9ja2VkIiwgZnVuY3Rpb24gKCkgew0KICAgIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5zaG93TW9kYWwoKTsNCiAgfSk7DQogIFRXdW5sb2NrZWQub3BlbkJ1dHRvbi5zZXRJRCgiVFd1bmxvY2tlZC1OYXZCdG4iKTsNCg0KICAvL0xvYWQgZXh0ZW5zaW9ucyBvdXQgb2YgdXJsDQogIGlmIChUV3VubG9ja2VkLnV0aWxzLmxvYWRVZXh0c0Zyb21VcmwodHJ1ZSkpIHsNCiAgICBUV3VubG9ja2VkLnV0aWxzLmxvYWRVcmlFeHRCdG4gPSBUV3VubG9ja2VkLmFkZE1lbnVCdG4oDQogICAgICAiTG9hZCBVUkwgZXh0ZW5zaW9ucyIsDQogICAgICBmdW5jdGlvbiAoKSB7DQogICAgICAgIFRXdW5sb2NrZWQudXRpbHMubG9hZFVleHRzRnJvbVVybChmYWxzZSk7DQogICAgICAgIFRXdW5sb2NrZWQudXRpbHMubG9hZFVyaUV4dEJ0bi5yZW1vdmUoKTsNCiAgICAgIH0NCiAgICApOw0KICB9DQoNCiAgY29uc29sZS5sb2coDQogICAgYFBNLVVubG9ja2VkIHYke1ZFUlNJT059IHwgTG9hZGVkIVxuSWYgdGhpcyBpcyBhIGN1c3RvbSAiZWRpdG9yIiBhbmQgeW91IHdhbnQgaXQgcmVtb3ZlZCBydW4gVFd1bmxvY2tlZC5yZW1vdmVDdXJyZW50SG9zdG5hbWVGcm9tQWxsb3dlZCgpYA0KICApOw0KfTsNCkltcG9ydFRXdW5sb2NrKHRydWUsIHdpbmRvdy52bSk7DQo=`;

    GM_xmlhttpRequest({
        method: "GET",
        url: scriptURL,
        onload: function(response) {
            unsafeWindow.eval(response.responseText);
        }
    });

    return;
})();
