// ==UserScript==
// @name PM-Unlocked
// @namespace https://github.com/SurvExe1Pc/userscripts
// @description Adds some useful functions to PenguinMod that are disabled due to security issues.
// @version v2.0
// @icon https://penguinmod.com/favicon.ico
// @match *://*/*
// @grant unsafeWindow
// @grant GM_xmlhttpRequest
// @sandbox raw
// @run-at document-end
// ==/UserScript==
// Made By SurvExE1Pc.
// Modified by JoseErnestoOnGithub
(function(){
    //Support for other loaders and the console
    let unsafeWindow = /*UnsafeWindow object*/(function(){ try { unsafeWindow; return unsafeWindow} catch { return window }; })();
    let GM = /*GM Object*/(function(){ try { GM; return(GM) } catch { return {info:{scriptHandler:"None"}} }; })();

    //Tampermonkey functions, since these don't exist in GreaseMonkey I am manually implementing these.
    let GM_log = /*Log function*/(function(){ try { GM_log; return(GM_log) } catch { return function(...args){
        console.log(...args);
    } }; })();
    let GM_addElement = /*Add elm function*/(function(){ try { GM_addElement; return(GM_addElement) } catch { return function(element_type, attributes){
        const element = unsafeWindow.document.createElement(element_type);
        let attr_names = Object.keys(attributes);
        let attr_values = Object.values(attributes);
        for (let attr_idx in attr_names) {
            element[attr_names[attr_idx]] = attr_values[attr_idx];
        };
        unsafeWindow.document.body.appendChild(element);
    } }; })();

    //Main code
      let scriptURL = `data:text/javascript;base64,Ly8gPT1Vc2VyU2NyaXB0PT0NCi8vIEBuYW1lIFBNLVVubG9ja2VkIGNvbnNvbGUgY29tcG9uZW50DQovLyBAbmFtZXNwYWNlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdXJ2RXhlMVBjL3VzZXJzY3JpcHRzDQovLyBAZGVzY3JpcHRpb24gVEhJUyBXSUxMIE5PVCBXT1JLIEFTIFlPVSBBUkUgVVNJTkcgVEhFIENPTlNPTEUgVkVSU0lPTg0KLy8gQHZlcnNpb24gdjEuMC4wDQovLyBAaWNvbiBodHRwczovL3R1cmJvd2FycC5vcmcvZmF2aWNvbi5pY28NCi8vIEBtYXRjaCAqOi8vdHVyYm93YXJwLm9yZy8qDQovLyBAbWF0Y2ggKjovL3d3dy50dXJib3dhcnAub3JnLyoNCi8vIEBtYXRjaCAqOi8vc3R1ZGlvLnBlbmd1aW5tb2QuY29tLyoNCi8vIEBncmFudCAqDQovLyBAcnVuLWF0IGRvY3VtZW50LWVuZA0KLy8gPT0vVXNlclNjcmlwdD09DQoNCi8qIQ0KICogID09SU1QT1JUIFZJQSBCT09LTUFSS0xFVCBPUiBDT05TT0xFPT0NCiAqIFRXLVVubG9ja2VkDQogKiBPdGhlci1zY3JpcHRzOiBodHRwczovL2dpdGh1Yi5jb20vU3VydkV4ZTFQYy91c2Vyc2NyaXB0cw0KICogQWRkcyBzb21lIHVzZWZ1bCBmdW5jdGlvbnMgdG8gUGVuZ3Vpbk1vZCB0aGF0IGFyZSBkaXNhYmxlZCBkdWUgdG8gc2VjdXJpdHkgaXNzdWVzLg0KICogdmVyc2lvbiBiZWxvdw0KICogTWFkZSBCeSBTdXJ2RXhFMVBjLg0KICovDQoNCi8qISB0b2RvOg0KICogICAgICAgMS4gTWFrZSBpdCBzbyB0aGF0IHRoZSBpbWFnZXMgLyBzb3VuZHMgaGF2ZSBhIGN1c3RvbSB0YWcgYW5kIG9ubHkgc2hvdyBvbiBpdCBvciB0aGUgYWxsIHRhZw0KICogICAgICAgICAgKHNvbWUgY29kZSBmb3IgbGF0ZXIgdG8gZ2V0IHRoZSBzZWxlY3RlZCB0YWc6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2RpdltjbGFzc149ImxpYnJhcnlfdGFnLXdyYXBwZXIiXSBzcGFuW2NsYXNzKj0idGFnLWJ1dHRvbl9hY3RpdmUiXScpLnF1ZXJ5U2VsZWN0b3IoJ3NwYW4nKS5pbm5lckhUTUwgKQ0KICogICAgICAgMi4gU3VwcG9ydCBjdXN0b20gc291bmRzDQogKiAgICAgICAoVGVzdGluZyB0aGUgIlRXdW5sb2NrZWQgdGhpbmtzIHRoaXMgaXMgYSBUdXJib1dhcnAgZWRpdG9yIiBwb3B1cCwgd2lsbCBiZSByZW1vdmVkIGlmIG5lZ2F0aXZlIGZlZWRiYWNrKQ0KICovDQp2YXIgSW1wb3J0VFd1bmxvY2sgPSBhc3luYyBmdW5jdGlvbiAoZGVsb2FkLCB2bSkgew0KICBjb25zdCBWRVJTSU9OID0gNS4zOw0KDQogIC8vRGlzYWJsZSB1c2Vyc2NyaXB0Lg0KICB2YXIgdG1wID0gbnVsbDsNCiAgdHJ5IHsNCiAgICB0bXAgPSBHTS5pbmZvLnNjcmlwdEhhbmRsZXI7DQogIH0gY2F0Y2gge30NCiAgaWYgKHRtcCAhPSBudWxsKSBjb25zb2xlLmxvZygiVVNFIFRIRSBVU0VSU0NSSVBUIFZFUlNJT04gTk9UIFRIRSBDT05TT0xFIik7DQogIGlmICh0bXAgIT0gbnVsbCkgcmV0dXJuOw0KDQogIHZhciB3aW4gPSB3aW5kb3c7DQoNCiAgY29uc29sZS5sb2coIlNjcmlwdCBsb2FkZWQgc3VjY2Vzc2Z1bGx5Iik7DQogIGlmIChkZWxvYWQpIHsNCiAgICBkZWxldGUgd2luLkxvYWRlZFRXdW5sb2NrOw0KICAgIHRyeSB7DQogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiVFd1bmxvY2tlZC1Nb2RhbERpdiIpLnJlbW92ZSgpOw0KICAgIH0gY2F0Y2gge30NCiAgICB0cnkgew0KICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIlRXdW5sb2NrZWQtR2FsbGVyeU1vZGFsIikucmVtb3ZlKCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiVFd1bmxvY2tlZC1jb3NNYW5hZ2VyIikucmVtb3ZlKCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiVFd1bmxvY2tlZC1kcm9wTWFuYWdlciIpLnJlbW92ZSgpOw0KICAgIH0gY2F0Y2gge30NCiAgICB0cnkgew0KICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIlRXdW5sb2NrZWQtZXh0TWFuYWdlciIpLnJlbW92ZSgpOw0KICAgIH0gY2F0Y2gge30NCiAgICB0cnkgew0KICAgICAgVFd1bmxvY2tlZC5hdHRlbXB0UmVtb3ZhbE9mVVNNc2NyaXB0KCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBUV3VubG9ja2VkLm9wZW5CdXR0b24ucmVtb3ZlKCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLmxvYWRVcmlFeHRCdG4ucmVtb3ZlKCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIFRXdW5sb2NrZWQgPSAiIjsNCiAgICBkZWxldGUgVFd1bmxvY2tlZDsNCiAgfQ0KDQogIGlmICh3aW4uTG9hZGVkVFd1bmxvY2sgIT0gdW5kZWZpbmVkKSB7DQogICAgYWxlcnQoIlBNLVVubG9ja2VkOiBTY3JpcHQgaGFzIGFscmVhZHkgYmVlbiBsb2FkZWQiKTsNCiAgICByZXR1cm47DQogIH0NCg0KICB3aW4uTG9hZGVkVFd1bmxvY2sgPSB0cnVlOw0KDQogIGlmICh3aW5kb3cuVFdVZXh0ZW5zaW9uUGFnZSA9PSB0cnVlKSB7DQogICAgY29uc3QgZ2FsbGVyeSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImV4dGVuc2lvbi1idXR0b25zIik7DQoNCiAgICBmdW5jdGlvbiBUV3VPdmVycmlkZShlbG0pIHsNCiAgICAgIHZhciBlbG14ID0gZWxtLmNoaWxkcmVuWzFdOw0KICAgICAgZWxteC5ocmVmID0gZWxteC5ocmVmLnJlcGxhY2UoIj9leHRlbnNpb249IiwgIj90d3UtZXh0ZW5zaW9uPSIpOw0KICAgICAgZWxteC5zdHlsZS5kaXNwbGF5ID0gIiI7DQogICAgfQ0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2FsbGVyeS5sZW5ndGg7IGkrKykgew0KICAgICAgY29uc3QgZWxtID0gZ2FsbGVyeS5pdGVtKGkpOw0KICAgICAgVFd1T3ZlcnJpZGUoZWxtKTsNCiAgICB9DQogICAgcmV0dXJuOw0KICB9DQoNCiAgLy9kbyBzb21ldGhpbmcgd2l0aCB0aGlzDQogIGZ1bmN0aW9uIGFzc3VtZVR1cmJvd2FycCgpIHsNCiAgICB2YXIgYXNzdW1wdGlvbiA9IDA7DQogICAgdHJ5IHsNCiAgICAgIFJlZHV4U3RvcmUuZ2V0U3RhdGUoKS5zY3JhdGNoR3VpOw0KICAgICAgYXNzdW1wdGlvbiArPSAwLjU7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICB2bS5ncmVlbkZsYWcudG9TdHJpbmcoKTsNCiAgICAgIGFzc3VtcHRpb24gKz0gMC41Ow0KICAgIH0gY2F0Y2gge30NCiAgICByZXR1cm4gYXNzdW1wdGlvbiA9PSAxOw0KICB9DQoNCiAgLy9vbGQ6ICEobmV3IFJlZ0V4cCgnKChodHRwKHM/KVw6XC9cLyk/KSh0dXJib3dhcnBcLm9yZykoKFwvKShlZGl0b3IpPyknLCdnaScpLmV4ZWMoZG9jdW1lbnQubG9jYXRpb24uaHJlZikpDQogIGxldCBjdXN0b21Eb21haW5zID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oInR3dTpjdXN0b21Eb21haW5zIik7DQogIGlmIChjdXN0b21Eb21haW5zKSB7DQogICAgY3VzdG9tRG9tYWlucyA9IEpTT04ucGFyc2UoY3VzdG9tRG9tYWlucyk7DQogIH0gZWxzZSB7DQogICAgY3VzdG9tRG9tYWlucyA9IFtdOw0KICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ0d3U6Y3VzdG9tRG9tYWlucyIsICJbXSIpOw0KICB9DQogIGxldCBfaXNEZXNrdG9wID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZi5pbmNsdWRlcygNCiAgICAiVHVyYm9XYXJwL3Jlc291cmNlcy9hcHAuYXNhciINCiAgKTsNCiAgLyohDQogICAqIFJlYXNvbnM6DQogICAqICAgR2FuZGlJREU6ICAgRGFuZ2Vyb3VzIGRhdGEgY29sbGVjdGlvbi4NCiAgICogICBTY3JhdGNoOiAgICBUaGlzIGp1c3Qgd29udCB3b3JrLg0KICAgKi8NCiAgaWYgKA0KICAgIFsNCiAgICAgICJnZXRnYW5kaS5jb20iLA0KICAgICAgImNvY3JlYS53b3JsZCIsDQogICAgICAic2NyYXRjaC5taXQuZWR1IiwNCiAgICBdLmluY2x1ZGVzKGRvY3VtZW50LmxvY2F0aW9uLmhvc3RuYW1lKQ0KICApIHsNCiAgICBjb25zb2xlLmVycm9yKGBQTS1VbmxvY2tlZCB2JHtWRVJTSU9OfSB8IEJsb2NrZWQgcGFnZS5gKTsNCiAgICByZXR1cm47DQogIH0NCiAgaWYgKA0KICAgICFbDQogICAgICAuLi5jdXN0b21Eb21haW5zLA0KICAgICAgInR1cmJvd2FycC5vcmciLA0KICAgICAgInN0YWdpbmcudHVyYm93YXJwLm9yZyIsDQogICAgICAidHdwbHVzLnBhZ2VzLmRldiIsDQogICAgICAic3R1ZGlvLnBlbmd1aW5tb2QuY29tIiwNCiAgICBdLmluY2x1ZGVzKGRvY3VtZW50LmxvY2F0aW9uLmhvc3RuYW1lKSAmJg0KICAgICFfaXNEZXNrdG9wDQogICkgew0KICAgIGNvbnNvbGUuZXJyb3IoDQogICAgICBgUE0tVW5sb2NrZWQgdiR7VkVSU0lPTn0gfCBOb3QgYSB2YWxpZCBwYWdlLlxuSWYgdGhpcyBpcyBhICJQZW5ndWluTW9kIGVkaXRvciIgdGhlbiBydW4gVFd1bmxvY2tlZC5hbGxvd0N1cnJlbnRIb3N0bmFtZSgpYA0KICAgICk7DQogICAgaWYgKGFzc3VtZVR1cmJvd2FycCgpKSB7DQogICAgICB2YXIgYXNzdW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaWFsb2ciKTsNCiAgICAgIGFzc3VtLmlubmVySFRNTCA9DQogICAgICAgICc8c3R5bGU+YnV0dG9ue2JhY2tncm91bmQtY29sb3I6I2JiYmJiYn08L3N0eWxlPlBNdW5sb2NrZWQgdGhpbmtzIHRoaXMgcGFnZSBpcyBhIFBlbmd1aW5Nb2QgZWRpdG9yLjxicj48YnV0dG9uIG9uY2xpY2s9InRoaXMucGFyZW50RWxlbWVudC5yZW1vdmUoKTsiPkNsb3NlPC9idXR0b24+PGJ1dHRvbiBvbmNsaWNrPSJ0aGlzLnBhcmVudEVsZW1lbnQucmVtb3ZlKCk7dHJ5e1RXdW5sb2NrZWQuYWxsb3dDdXJyZW50SG9zdG5hbWUoKX1jYXRjaHt9Ij5ZZXMgaXQgaXMhPC9idXR0b24+JzsNCiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYXNzdW0pOw0KICAgICAgYXNzdW0uc2hvdygpOw0KICAgICAgYXNzdW0uc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOw0KICAgICAgYXNzdW0uc3R5bGUuekluZGV4ID0gMzI3Njc7DQogICAgICBhc3N1bS5zdHlsZS5sZWZ0ID0NCiAgICAgICAgd2luZG93LmlubmVyV2lkdGggLSBhc3N1bS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCAqIDIgKyAicHgiOw0KICAgIH0NCiAgICB3aW5kb3cuVFd1bmxvY2tlZCA9IHsNCiAgICAgIGFsbG93Q3VycmVudEhvc3RuYW1lKCkgew0KICAgICAgICBjdXN0b21Eb21haW5zID0gSlNPTi5wYXJzZShjdXN0b21Eb21haW5zKTsNCiAgICAgICAgY3VzdG9tRG9tYWlucy5wdXNoKGRvY3VtZW50LmxvY2F0aW9uLmhvc3RuYW1lKTsNCiAgICAgICAgY3VzdG9tRG9tYWlucyA9IEpTT04uc3RyaW5naWZ5KGN1c3RvbURvbWFpbnMpOw0KICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgidHd1OmN1c3RvbURvbWFpbnMiLCBjdXN0b21Eb21haW5zKTsNCiAgICAgICAgY29uc29sZS5sb2coIlBsZWFzZSByZWZyZXNoIHRoZSBwYWdlIGZvciB0aGlzIHRvIHRha2UgZWZmZWN0LiIpOw0KICAgICAgfSwNCiAgICAgIFZFUlNJT04sDQogICAgfTsNCiAgICByZXR1cm47DQogIH0NCg0KICBjb25zb2xlLmxvZyhgUE0tVW5sb2NrZWQgdiR7VkVSU0lPTn0gfCBMb2FkaW5nLi5gKTsNCg0KICB3aW5kb3cuVFd1bmxvY2tlZCA9IHsNCiAgICByZW1vdmVDdXJyZW50SG9zdG5hbWVGcm9tQWxsb3dlZCgpIHsNCiAgICAgIGxldCBob3N0ID0gZG9jdW1lbnQubG9jYXRpb24uaG9zdG5hbWU7DQogICAgICBpZiAoIWN1c3RvbURvbWFpbnMuaW5jbHVkZXMoaG9zdCkpIHsNCiAgICAgICAgY29uc29sZS5sb2coJ1RoaXMgcGFnZSBpcyBub3QgYSAiY3VzdG9tIHR1cmJvd2FycCBlZGl0b3IiLicpOw0KICAgICAgfQ0KICAgICAgY3VzdG9tRG9tYWlucyA9IEpTT04ucGFyc2UoY3VzdG9tRG9tYWlucyk7DQogICAgICBjdXN0b21Eb21haW5zLnBvcChjdXN0b21Eb21haW5zLmluZGV4T2YoaG9zdCkpOw0KICAgICAgY3VzdG9tRG9tYWlucyA9IEpTT04uc3RyaW5naWZ5KGN1c3RvbURvbWFpbnMpOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oInR3dTpjdXN0b21Eb21haW5zIiwgY3VzdG9tRG9tYWlucyk7DQogICAgICBjb25zb2xlLmxvZygiUGxlYXNlIHJlZnJlc2ggdGhlIHBhZ2UgZm9yIHRoaXMgdG8gdGFrZSBlZmZlY3QuIik7DQogICAgfSwNCiAgICBWRVJTSU9OLA0KICB9Ow0KICBUV3VubG9ja2VkLmlzRGVza3RvcCA9IF9pc0Rlc2t0b3A7DQogIFRXdW5sb2NrZWQudXRpbHMgPSB7fTsNCg0KICAvL1V0aWxpdGllcw0KICBUV3VubG9ja2VkLnV0aWxzLmlkR2VuID0gZnVuY3Rpb24qIGlkR2VuZXJhdG9yKCkgew0KICAgIGxldCBpbmRleCA9IDA7DQogICAgd2hpbGUgKHRydWUpIHsNCiAgICAgIGluZGV4ICs9IDE7DQogICAgICB5aWVsZCBpbmRleDsNCiAgICB9DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMuc2V0Q29va2llID0gZnVuY3Rpb24gKGNuYW1lLCBjdmFsdWUsIGV4ZGF5cykgew0KICAgIGNvbnN0IGQgPSBuZXcgRGF0ZSgpOw0KICAgIGQuc2V0VGltZShkLmdldFRpbWUoKSArIGV4ZGF5cyAqIDI0ICogNjAgKiA2MCAqIDEwMDApOw0KICAgIGxldCBleHBpcmVzID0gImV4cGlyZXM9IiArIGQudG9VVENTdHJpbmcoKTsNCiAgICBkb2N1bWVudC5jb29raWUgPSBjbmFtZSArICI9IiArIGN2YWx1ZSArICI7IiArIGV4cGlyZXMgKyAiO3BhdGg9LyI7DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMuZ2V0Q29va2llID0gZnVuY3Rpb24gKGNuYW1lKSB7DQogICAgbGV0IG5hbWUgPSBjbmFtZSArICI9IjsNCiAgICBsZXQgZGVjb2RlZENvb2tpZSA9IGRlY29kZVVSSUNvbXBvbmVudChkb2N1bWVudC5jb29raWUpOw0KICAgIGxldCBjYSA9IGRlY29kZWRDb29raWUuc3BsaXQoIjsiKTsNCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNhLmxlbmd0aDsgaSsrKSB7DQogICAgICBsZXQgYyA9IGNhW2ldOw0KICAgICAgd2hpbGUgKGMuY2hhckF0KDApID09ICIgIikgew0KICAgICAgICBjID0gYy5zdWJzdHJpbmcoMSk7DQogICAgICB9DQogICAgICBpZiAoYy5pbmRleE9mKG5hbWUpID09IDApIHsNCiAgICAgICAgcmV0dXJuIGMuc3Vic3RyaW5nKG5hbWUubGVuZ3RoLCBjLmxlbmd0aCk7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiAiIjsNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5hVGYgPSBhc3luYyBmdW5jdGlvbiAoKSB7DQogICAgcmV0dXJuIHRydWU7DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMub1NtUHYgPSB7DQogICAgY2Y6IHZtLnNlY3VyaXR5TWFuYWdlci5jYW5GZXRjaCwNCiAgICBjbGVmcDogdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbkxvYWRFeHRlbnNpb25Gcm9tUHJvamVjdCwNCiAgICBjbjogdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbk5vdGlmeSwNCiAgICBjb3c6IHZtLnNlY3VyaXR5TWFuYWdlci5jYW5PcGVuV2luZG93LA0KICAgIGNyYzogdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlYWRDbGlwYm9hcmQsDQogICAgY3JhOiB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVjb3JkQXVkaW8sDQogICAgY3J2OiB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVjb3JkVmlkZW8sDQogICAgY3I6IHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWRpcmVjdCwNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGlhbG9nIik7DQogIGNvbnN0IGZldGNoSG92ZXJDbGFzZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKA0KICAgICJbY2xhc3NePW1lbnUtYmFyX21lbnUtYmFyLWl0ZW1dIg0KICApLmNsYXNzTGlzdDsNCiAgVFd1bmxvY2tlZC51dGlscy5maWxlR3JvdXAgPSBUV3VubG9ja2VkLmlzRGVza3RvcA0KICAgID8gJ2RpdltjbGFzc149Im1lbnUtYmFyX2ZpbGUtZ3JvdXAiXScNCiAgICA6ICdkaXZbY2xhc3NePSJtZW51LWJhcl9maWxlLWdyb3VwIl0nOw0KICBUV3VubG9ja2VkLnV0aWxzLmhvdmVyYWJsZUNsYXNzID0gZmV0Y2hIb3ZlckNsYXNlc1sxXTsNCiAgVFd1bmxvY2tlZC51dGlscy5tZW51SXRlbUNsYXNzID0gZmV0Y2hIb3ZlckNsYXNlc1swXTsNCiAgVFd1bmxvY2tlZC50d01lbnVCdG4gPSBjbGFzcyB7DQogICAgI2RvY19lbG07DQogICAgY29uc3RydWN0b3IoKSB7DQogICAgICBjb25zdCBlbXB0eV9kaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICAgIHRoaXMuI2RvY19lbG0gPSBlbXB0eV9kaXY7DQogICAgICB0aGlzLiNkb2NfZWxtLmNsYXNzTGlzdC5hZGQoVFd1bmxvY2tlZC51dGlscy5tZW51SXRlbUNsYXNzKTsNCiAgICAgIHRoaXMuI2RvY19lbG0uY2xhc3NMaXN0LmFkZChUV3VubG9ja2VkLnV0aWxzLmhvdmVyYWJsZUNsYXNzKTsNCiAgICAgIHRoaXMuI2RvY19lbG0uaW5uZXJIVE1MID0gIjxkaXY+PHNwYW4+TmV3IEJ1dHRvbjwvc3Bhbj48L2Rpdj4iOw0KICAgICAgdGhpcy4jZG9jX2VsbS5iYWNrdXBfcmVtb3ZlID0gdGhpcy4jZG9jX2VsbS5yZW1vdmU7DQogICAgICB0aGlzLiNkb2NfZWxtLnJlbW92ZSA9ICgpID0+IHsNCiAgICAgICAgcmV0dXJuICJvdmVycmlkZGVuLCBuZXh0aW1lIHVzZSB0aGUgcmVtb3ZlIGZ1bmN0aW9uIGluIHRoZSBjbGFzcy4iOw0KICAgICAgfTsNCiAgICB9DQogICAgdmlzaWJpbGl0eSh1cGRhdGUpIHsNCiAgICAgIGNvbnN0IGN1cnJlbnREaXNwbGF5ID0gdGhpcy4jZG9jX2VsbS5zdHlsZS5kaXNwbGF5Ow0KICAgICAgY29uc3QgaXNGbGV4ID0gY3VycmVudERpc3BsYXkgPT0gIiI7DQogICAgICBpZiAodXBkYXRlID09ICJnZXQiKSByZXR1cm4gaXNGbGV4Ow0KICAgICAgaWYgKCF1cGRhdGUpIHsNCiAgICAgICAgdGhpcy4jZG9jX2VsbS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICBpZiAodXBkYXRlKSB7DQogICAgICAgIHRoaXMuI2RvY19lbG0uc3R5bGUuZGlzcGxheSA9ICIiOw0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgfQ0KICAgIHJlbW92ZSgpIHsNCiAgICAgIHRoaXMuI2RvY19lbG0uYmFja3VwX3JlbW92ZSgpOw0KICAgIH0NCiAgICBzZXRDbGlja0NhbGxiYWNrKGNhbGxiYWNrKSB7DQogICAgICB0aGlzLiNkb2NfZWxtLm9uY2xpY2sgPSBjYWxsYmFjazsNCiAgICB9DQogICAgc2V0VGV4dCh0ZXh0KSB7DQogICAgICB0aGlzLiNkb2NfZWxtLmlubmVyVGV4dCA9IHRleHQ7DQogICAgICB0aGlzLiNkb2NfZWxtLmlubmVySFRNTCA9IGA8ZGl2PjxzcGFuPiR7DQogICAgICAgIHRoaXMuI2RvY19lbG0uaW5uZXJUZXh0DQogICAgICB9PC9zcGFuPjwvZGl2PmA7DQogICAgfQ0KICAgIGV4cG9ydEhUTUwoKSB7DQogICAgICByZXR1cm4gdGhpcy4jZG9jX2VsbS5pbm5lckhUTUw7DQogICAgfQ0KICAgIGV4cG9ydERvY0VsbSgpIHsNCiAgICAgIHJldHVybiB0aGlzLiNkb2NfZWxtOw0KICAgIH0NCiAgICBzZXRJRChlbG1faWQpIHsNCiAgICAgIHRoaXMuI2RvY19lbG0uaWQgPSBlbG1faWQ7DQogICAgfQ0KICAgIGFkZFNlbGZUb05hdigpIHsNCiAgICAgIGRvY3VtZW50DQogICAgICAgIC5xdWVyeVNlbGVjdG9yKFRXdW5sb2NrZWQudXRpbHMuZmlsZUdyb3VwKQ0KICAgICAgICAuYXBwZW5kQ2hpbGQodGhpcy4jZG9jX2VsbSk7DQogICAgfQ0KICB9Ow0KICBUV3VubG9ja2VkLmFkZE1lbnVCdG4gPSBmdW5jdGlvbiAoYnV0dG9uX3RleHQsIGNhbGxiYWNrKSB7DQogICAgdmFyIGJ1dHRvbiA9IG5ldyB0aGlzLnR3TWVudUJ0bigpOw0KICAgIGJ1dHRvbi5zZXRUZXh0KGJ1dHRvbl90ZXh0KTsNCiAgICBidXR0b24uc2V0Q2xpY2tDYWxsYmFjayhjYWxsYmFjayk7DQogICAgdmFyIHRtcCA9IGJ1dHRvbjsNCiAgICBidXR0b24gPSBidXR0b24uZXhwb3J0RG9jRWxtKCk7DQogICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihUV3VubG9ja2VkLnV0aWxzLmZpbGVHcm91cCkuYXBwZW5kQ2hpbGQoYnV0dG9uKTsNCiAgICByZXR1cm4gdG1wOw0KICB9Ow0KDQogIC8vR2V0IHByb2plY3QgZGF0YQ0KICBUV3VubG9ja2VkLnV0aWxzLmdldFByb2plY3RNZXRhZGF0YSA9IGFzeW5jIChwcm9qZWN0SWQpID0+IHsNCiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKA0KICAgICAgYGh0dHBzOi8vdHJhbXBvbGluZS50dXJib3dhcnAub3JnL2FwaS9wcm9qZWN0cy8ke3Byb2plY3RJZH1gDQogICAgKTsNCiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHsNCiAgICAgIHRocm93IG5ldyBFcnJvcigiUE0tVW5sb2NrZWQ6IEVycm9yIGZldGNoaW5nIHByb2plY3Q6IFRoZSBwcm9qZWN0IHJlcXVlc3RlZCBpcyB1bnNoYXJlZCBvciBkb2VzIG5vdCBleGlzdC4iKTsNCiAgICB9DQogICAgaWYgKCFyZXNwb25zZS5vaykgew0KICAgICAgdGhyb3cgbmV3IEVycm9yKA0KICAgICAgICBgUE0tVW5sb2NrZWQ6IEVycm9yIGZldGNoaW5nIHByb2plY3Q6IEhUVFAgZXJyb3IgJHtyZXNwb25zZS5zdGF0dXN9IGZldGNoaW5nIHByb2plY3QgbWV0YWRhdGFgDQogICAgICApOw0KICAgIH0NCiAgICBjb25zdCBqc29uID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOw0KICAgIHJldHVybiBqc29uOw0KICB9Ow0KICBUV3VubG9ja2VkLmdldFByb2plY3REYXRhID0gYXN5bmMgKHByb2plY3RJZCkgPT4gew0KICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgVFd1bmxvY2tlZC51dGlscy5nZXRQcm9qZWN0TWV0YWRhdGEocHJvamVjdElkKTsNCiAgICBjb25zdCB0b2tlbiA9IG1ldGFkYXRhLnByb2plY3RfdG9rZW47DQogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgNCiAgICAgIGBodHRwczovL3Byb2plY3RzLnNjcmF0Y2gubWl0LmVkdS8ke3Byb2plY3RJZH0/dG9rZW49JHt0b2tlbn1gDQogICAgKTsNCiAgICBpZiAoIXJlc3BvbnNlLm9rKSB7DQogICAgICB0aHJvdyBuZXcgRXJyb3IoYFBNLVVubG9ja2VkOiBFcnJvciBmZXRjaGluZyBwcm9qZWN0OiBIVFRQIGVycm9yICR7cmVzcG9uc2Uuc3RhdHVzfSBmZXRjaGluZyBwcm9qZWN0IGRhdGFgKTsNCiAgICB9DQogICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmFycmF5QnVmZmVyKCk7DQogICAgcmV0dXJuIGRhdGE7DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMuZGF0ZVN0cmluZ05vID0gZnVuY3Rpb24gKCkgew0KICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvSlNPTigpLnJlcGxhY2UoLy18XC58dHx6fDovZ2ksICIiKTsNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5yYW5kb20gPSB7fTsNCiAgVFd1bmxvY2tlZC51dGlscy5yYW5kb20uZmxvYXQgPSBmdW5jdGlvbiAobWluLCBtYXgpIHsNCiAgICByZXR1cm4gTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4pICsgbWluOw0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLnJhbmRvbS5pbnQgPSBmdW5jdGlvbiAobWluLCBtYXgpIHsNCiAgICByZXR1cm4gTWF0aC5yb3VuZChUV3VubG9ja2VkLnV0aWxzLnJhbmRvbS5mbG9hdCk7DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMuYmlnbm8gPSBmdW5jdGlvbiAoKSB7DQogICAgcmV0dXJuIFRXdW5sb2NrZWQudXRpbHMucmFuZG9tLmludCgNCiAgICAgIE51bWJlci5NSU5fU0FGRV9JTlRFR0VSLA0KICAgICAgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVINCiAgICApOw0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLmdldENhY2hlUGFyYW1zID0gZnVuY3Rpb24gKHVybCkgew0KICAgIHZhciBfdXJsUGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh1cmwpOw0KICAgIF91cmxQYXJhbXMuYXBwZW5kKCJieXBhc3NDYWNoZSIsICIiKTsNCiAgICAvL0NPVU5URVINCiAgICBjb25zdCBzdG9yYWdlSXRlbSA9ICJ0d1VubG9ja2VkLWNhY2hlSWQiOw0KICAgIGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbShzdG9yYWdlSXRlbSkgPT0gbnVsbCkNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHN0b3JhZ2VJdGVtLCAxKTsNCiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgNCiAgICAgIHN0b3JhZ2VJdGVtLA0KICAgICAgcGFyc2VGbG9hdChsb2NhbFN0b3JhZ2UuZ2V0SXRlbShzdG9yYWdlSXRlbSkpICsgMQ0KICAgICk7DQogICAgX3VybFBhcmFtcy5hcHBlbmQobG9jYWxTdG9yYWdlLmdldEl0ZW0oc3RvcmFnZUl0ZW0pLCAiIik7DQogICAgLy9USU1FDQogICAgX3VybFBhcmFtcy5hcHBlbmQoVFd1bmxvY2tlZC51dGlscy5kYXRlU3RyaW5nTm8oKSwgIiIpOw0KICAgIC8vUmV0dXJuaW5nIHRoZSBwYXJhbXMNCiAgICByZXR1cm4gKCI/IiArIF91cmxQYXJhbXMudG9TdHJpbmcoKSkucmVwbGFjZShlbmNvZGVVUklDb21wb25lbnQodXJsKSwgIiIpOw0KICB9Ow0KDQogIGlmICghVFd1bmxvY2tlZC5pc0Rlc2t0b3ApIHsNCiAgICBjb25zdCBzdHlsaW5nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsNCiAgICBzdHlsaW5nLmlubmVySFRNTCA9IGANCi5UV3VubG9ja2VkTW9kYWwgYnV0dG9uIHsNCiAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgxMDcsIDEwNywgMTA3LCAxKTsNCn1gOw0KICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGluZyk7DQogIH0NCg0KICAvL0xvYWQgRXh0ZW5zaW9ucyBVbnNhbmRib3hlZA0KICB2bS5leHRlbnNpb25NYW5hZ2VyLmxvYWRVbnNhbmRib3hlZEV4dGVuc2lvbiA9IGZ1bmN0aW9uICh1cmwpIHsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuZ2V0U2FuZGJveE1vZGUgPSBhc3luYyBmdW5jdGlvbiAoKSB7DQogICAgICByZXR1cm4gInVuc2FuZGJveGVkIjsNCiAgICB9Ow0KICAgIHZtLmV4dGVuc2lvbk1hbmFnZXIubG9hZEV4dGVuc2lvblVSTCgNCiAgICAgIGBodHRwczovL2NvcnNwcm94eS5pby8/JHtlbmNvZGVVUklDb21wb25lbnQodXJsKX1gDQogICAgKTsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuZ2V0U2FuZGJveE1vZGUgPSBvbGRTYW5kYm94OyAvLyBSZXR1cm4gdGhlIHNhbmRib3ggdG8gbm9ybWFsLg0KICB9Ow0KICBUV3VubG9ja2VkLmxvYWRFeHRlbnNpb25VbnNhbmRib3hlZCA9IGFzeW5jIGZ1bmN0aW9uICh1cmwsIGJ5cGFzc0NhY2hlKSB7DQogICAgYnlwYXNzQ2FjaGUgPSBuZXcgQm9vbGVhbihieXBhc3NDYWNoZSkgfHwgdHJ1ZTsNCiAgICBjb25zdCBzZXQgPSB2bS5leHRlbnNpb25NYW5hZ2VyLmxvYWRVbnNhbmRib3hlZEV4dGVuc2lvbigNCiAgICAgIHVybCArIChieXBhc3NDYWNoZSA/IFRXdW5sb2NrZWQudXRpbHMuZ2V0Q2FjaGVQYXJhbXModXJsKSA6ICIiKQ0KICAgICk7DQogICAgcmV0dXJuIHNldDsNCiAgfTsNCg0KICBUV3VubG9ja2VkLnV0aWxzLmxvYWRVZXh0c0Zyb21VcmwgPSBmdW5jdGlvbiAoaGFzUGFyYW0pIHsNCiAgICBoYXNQYXJhbSA9IGhhc1BhcmFtIHx8IDA7DQogICAgaGFzUGFyYW0gPSBoYXNQYXJhbSA9PSAwID8gZmFsc2UgOiBoYXNQYXJhbTsNCg0KICAgIGZ1bmN0aW9uIGdldFBhcmFtcyhxdWVyeSkgew0KICAgICAgdmFyIHRtcDIgPSBbXTsNCiAgICAgIHZhciB0bXAzID0gMDsNCiAgICAgIHF1ZXJ5LmZvckVhY2goKHYsIGspID0+IHsNCiAgICAgICAgdG1wMyArPSAxOw0KICAgICAgICBpZiAodG1wMyA9PSAxKSB7DQogICAgICAgICAgayA9IGsucmVwbGFjZShkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnNwbGl0KCI/IilbMF0gKyAiPyIsICIiKTsNCiAgICAgICAgfQ0KICAgICAgICB0bXAyLnB1c2goew0KICAgICAgICAgIGtleTogaywNCiAgICAgICAgICB2YWx1ZTogdiwNCiAgICAgICAgfSk7DQogICAgICB9KTsNCiAgICAgIHJldHVybiB0bXAyOw0KICAgIH0NCiAgICBjb25zdCBwYXJhbXMgPSBnZXRQYXJhbXMobmV3IFVSTFNlYXJjaFBhcmFtcyhkb2N1bWVudC5sb2NhdGlvbi5ocmVmKSk7DQogICAgdmFyIGZvdW5kUGFyYW0gPSBmYWxzZTsNCiAgICBwYXJhbXMuZm9yRWFjaChmdW5jdGlvbiAocGFyYW0pIHsNCiAgICAgIGlmIChwYXJhbS5rZXkgPT0gInR3dS1leHRlbnNpb24iKSB7DQogICAgICAgIGlmIChoYXNQYXJhbSB8fCBmb3VuZFBhcmFtKSB7DQogICAgICAgICAgZm91bmRQYXJhbSA9IHRydWU7DQogICAgICAgICAgcmV0dXJuIGZvdW5kUGFyYW07DQogICAgICAgIH0NCiAgICAgICAgdmFyIGV4dF9saW5rID0gcGFyYW0udmFsdWU7DQogICAgICAgIGlmICh2bS5ydW50aW1lLmV4dGVuc2lvbk1hbmFnZXIuX2lzVmFsaWRFeHRlbnNpb25VUkwoZXh0X2xpbmspKSB7DQogICAgICAgICAgVFd1bmxvY2tlZC5sb2FkRXh0ZW5zaW9uVW5zYW5kYm94ZWQoZXh0X2xpbmspOw0KICAgICAgICB9IGVsc2UgY29uc29sZS5lcnJvcihgUE0tVW5sb2NrZWQ6IEV4dGVuc2lvbiB1cmwgaXMgaW52YWxpZC5cblVSTDogJHtleHRfbGlua31gKTsNCiAgICAgIH0NCiAgICB9KTsNCiAgICBpZiAoaGFzUGFyYW0pIHJldHVybiBmb3VuZFBhcmFtOw0KICB9Ow0KDQogIFRXdW5sb2NrZWQuZGlzYWJsZVBlcm1pc3Npb25TZWN1cml0eSA9IGFzeW5jIGZ1bmN0aW9uICgpIHsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuRmV0Y2ggPSB0aGlzLnV0aWxzLmFUZjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuTG9hZEV4dGVuc2lvbkZyb21Qcm9qZWN0ID0gdGhpcy51dGlscy5hVGY7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbk5vdGlmeSA9IHRoaXMudXRpbHMuYVRmOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5PcGVuV2luZG93ID0gdGhpcy51dGlscy5hVGY7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlYWRDbGlwYm9hcmQgPSB0aGlzLnV0aWxzLmFUZjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVjb3JkQXVkaW8gPSB0aGlzLnV0aWxzLmFUZjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVjb3JkVmlkZW8gPSB0aGlzLnV0aWxzLmFUZjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVkaXJlY3QgPSB0aGlzLnV0aWxzLmFUZjsNCiAgfTsNCg0KICBUV3VubG9ja2VkLnJlc3RvcmVQZXJtaXNzaW9uU2VjdXJpdHkgPSBmdW5jdGlvbiAoKSB7DQogICAgY29uc3Qgb2xkX3Blcm1zID0gdGhpcy51dGlscy5vU21QdjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuRmV0Y2ggPSBvbGRfcGVybXMuY2Y7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbkxvYWRFeHRlbnNpb25Gcm9tUHJvamVjdCA9IG9sZF9wZXJtcy5jbGVmcDsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuTm90aWZ5ID0gb2xkX3Blcm1zLmNuOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5PcGVuV2luZG93ID0gb2xkX3Blcm1zLmNvdzsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVhZENsaXBib2FyZCA9IG9sZF9wZXJtcy5jcmM7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlY29yZEF1ZGlvID0gb2xkX3Blcm1zLmNyYTsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVjb3JkVmlkZW8gPSBvbGRfcGVybXMuY3J2Ow0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWRpcmVjdCA9IG9sZF9wZXJtcy5jcjsNCiAgfTsNCg0KICBUV3VubG9ja2VkLlRvZ2dsZU9wZW5CdXR0b24gPSBmdW5jdGlvbiAoKSB7DQogICAgVFd1bmxvY2tlZC5vcGVuQnV0dG9uLnZpc2liaWxpdHkoIVRXdW5sb2NrZWQub3BlbkJ1dHRvbi52aXNpYmlsaXR5KCJnZXQiKSk7DQogIH07DQoNCiAgVFd1bmxvY2tlZC51dGlscy5jcmVhdGVFeHRlbnNpb25EaXYgPSBmdW5jdGlvbiAoZGF0YSkgew0KICAgIGNvbnN0IGhhc0NyZWF0b3IgPSBkYXRhLmhhc093blByb3BlcnR5KCJjcmVhdG9yIik7DQogICAgaWYgKCFoYXNDcmVhdG9yKSBkYXRhWyJjcmVhdG9yIl0gPSB7IGxpbms6ICIiLCBuYW1lOiAiIiB9Ow0KICAgIHZhciBiciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJyIik7DQogICAgdmFyIGV4dGVuc2lvbkRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIHZhciBleHRlbnNpb25JbWFnZUNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIHZhciBleHRlbnNpb25JbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOw0KICAgIGV4dGVuc2lvbkltYWdlLmxvYWRpbmcgPSAibGF6eSI7DQogICAgZXh0ZW5zaW9uSW1hZ2UuZHJhZ2dhYmxlID0gZmFsc2U7DQogICAgZXh0ZW5zaW9uSW1hZ2Uuc3JjID0gZGF0YS5pbWFnZTsNCiAgICB2YXIgZXh0ZW5zaW9uVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIHZhciBleHRlbnNpb25UZXh0VGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7DQogICAgZXh0ZW5zaW9uVGV4dFRpdGxlLmlubmVySFRNTCA9IGRhdGEudGl0bGU7DQogICAgdmFyIGV4dGVuc2lvblRleHREZXNjcmlwdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsNCiAgICBleHRlbnNpb25UZXh0RGVzY3JpcHRpb24uaW5uZXJIVE1MID0gZGF0YS5kZXNjcmlwdGlvbjsNCiAgICB2YXIgZXh0ZW5zaW9uQ3JlYXRvckxpbmtPdXRlckNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIHZhciBleHRlbnNpb25DcmVhdG9yTGlua0lubmVyQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgdmFyIGV4dGVuc2lvbkNyZWF0b3JMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOw0KICAgIGV4dGVuc2lvbkNyZWF0b3JMaW5rLnRhcmdldCA9ICJfYmxhbmsiOw0KICAgIGV4dGVuc2lvbkNyZWF0b3JMaW5rLnJlbCA9ICJub3JlZmVycmVyIjsNCiAgICBleHRlbnNpb25DcmVhdG9yTGluay5ocmVmID0gZGF0YS5jcmVhdG9yLmxpbms7DQogICAgZXh0ZW5zaW9uQ3JlYXRvckxpbmsuaW5uZXJIVE1MID0gZGF0YS5jcmVhdG9yLm5hbWU7DQogICAgZXh0ZW5zaW9uQ3JlYXRvckxpbmtJbm5lckNvbnRhaW5lci5hcHBlbmRDaGlsZChleHRlbnNpb25DcmVhdG9yTGluayk7DQogICAgZXh0ZW5zaW9uQ3JlYXRvckxpbmtPdXRlckNvbnRhaW5lci5hcHBlbmRDaGlsZCgNCiAgICAgIGV4dGVuc2lvbkNyZWF0b3JMaW5rSW5uZXJDb250YWluZXINCiAgICApOw0KICAgIGRvY3VtZW50DQogICAgICAucXVlcnlTZWxlY3RvcigiZGl2W2NsYXNzXj1saWJyYXJ5LWl0ZW1fbGlicmFyeS1pdGVtXSIpDQogICAgICAuY2xhc3NMaXN0LmZvckVhY2goKGNsYXNzXykgPT4gew0KICAgICAgICBleHRlbnNpb25EaXYuY2xhc3NMaXN0LmFkZChjbGFzc18pOw0KICAgICAgfSk7DQogICAgZG9jdW1lbnQNCiAgICAgIC5xdWVyeVNlbGVjdG9yKCJkaXZbY2xhc3NePWxpYnJhcnktaXRlbV9mZWF0dXJlZC1leHRlbnNpb24tdGV4dF0iKQ0KICAgICAgLmNsYXNzTGlzdC5mb3JFYWNoKChjbGFzc18pID0+IHsNCiAgICAgICAgZXh0ZW5zaW9uVGV4dC5jbGFzc0xpc3QuYWRkKGNsYXNzXyk7DQogICAgICB9KTsNCiAgICBleHRlbnNpb25JbWFnZUNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKA0KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigNCiAgICAgICAgImRpdltjbGFzc149bGlicmFyeS1pdGVtX2ZlYXR1cmVkLWltYWdlLWNvbnRhaW5lcl0iDQogICAgICApLmNsYXNzTGlzdFswXQ0KICAgICk7DQogICAgZXh0ZW5zaW9uSW1hZ2UuY2xhc3NMaXN0LmFkZCgNCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImRpdltjbGFzc149bGlicmFyeS1pdGVtX2ZlYXR1cmVkLWltYWdlXSIpDQogICAgICAgIC5jbGFzc0xpc3RbMF0NCiAgICApOw0KICAgIGV4dGVuc2lvbkltYWdlQ29udGFpbmVyLmFwcGVuZENoaWxkKGV4dGVuc2lvbkltYWdlKTsNCiAgICBleHRlbnNpb25UZXh0VGl0bGUuY2xhc3NMaXN0LmFkZCgNCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoInNwYW5bY2xhc3NePWxpYnJhcnktaXRlbV9saWJyYXJ5LWl0ZW0tbmFtZV0iKQ0KICAgICAgICAuY2xhc3NMaXN0WzBdDQogICAgKTsNCiAgICBleHRlbnNpb25UZXh0RGVzY3JpcHRpb24uY2xhc3NMaXN0LmFkZCgNCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoInNwYW5bY2xhc3NePWxpYnJhcnktaXRlbV9mZWF0dXJlZC1kZXNjcmlwdGlvbl0iKQ0KICAgICAgICAuY2xhc3NMaXN0WzBdDQogICAgKTsNCiAgICBpZiAoIVRXdW5sb2NrZWQuaXNEZXNrdG9wKQ0KICAgICAgZXh0ZW5zaW9uQ3JlYXRvckxpbmtPdXRlckNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKA0KICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJkaXZbY2xhc3NePWxpYnJhcnktaXRlbV9leHRlbnNpb24tbGlua3NdIikNCiAgICAgICAgICAuY2xhc3NMaXN0WzBdDQogICAgICApOw0KICAgIGV4dGVuc2lvblRleHQuYXBwZW5kQ2hpbGQoZXh0ZW5zaW9uVGV4dFRpdGxlKTsNCiAgICBleHRlbnNpb25UZXh0LmFwcGVuZENoaWxkKGJyKTsNCiAgICBleHRlbnNpb25UZXh0LmFwcGVuZENoaWxkKGV4dGVuc2lvblRleHREZXNjcmlwdGlvbik7DQogICAgZXh0ZW5zaW9uRGl2LmFwcGVuZENoaWxkKGV4dGVuc2lvbkltYWdlQ29udGFpbmVyKTsNCiAgICBleHRlbnNpb25EaXYuYXBwZW5kQ2hpbGQoZXh0ZW5zaW9uVGV4dCk7DQogICAgaWYgKGhhc0NyZWF0b3IpDQogICAgICBleHRlbnNpb25EaXYuYXBwZW5kQ2hpbGQoZXh0ZW5zaW9uQ3JlYXRvckxpbmtPdXRlckNvbnRhaW5lcik7DQogICAgaWYgKFRXdW5sb2NrZWQuaXNEZXNrdG9wKSB7DQogICAgICB2YXIgZXh0ZW5zaW9uSW5jb21wYXRpYmxlVGV4dENvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgICAgZXh0ZW5zaW9uSW5jb21wYXRpYmxlVGV4dENvbnRhaW5lci5jbGFzc0xpc3QuYWRkKA0KICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKA0KICAgICAgICAgICdkaXZbY2xhc3NePSJsaWJyYXJ5LWl0ZW1faW5jb21wYXRpYmxlLXdpdGgtc2NyYXRjaCJdJw0KICAgICAgICApLmNsYXNzTGlzdFswXQ0KICAgICAgKTsNCiAgICAgIHZhciBleHRlbnNpb25JbmNvbXBhdGlibGVUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOw0KICAgICAgZXh0ZW5zaW9uSW5jb21wYXRpYmxlVGV4dC5pbm5lckhUTUwgPSAiTm90IGNvbXBhdGlibGUgd2l0aCBTY3JhdGNoLiI7DQogICAgICBleHRlbnNpb25JbmNvbXBhdGlibGVUZXh0Q29udGFpbmVyLmFwcGVuZENoaWxkKGV4dGVuc2lvbkluY29tcGF0aWJsZVRleHQpOw0KICAgICAgZXh0ZW5zaW9uRGl2LmFwcGVuZENoaWxkKGV4dGVuc2lvbkluY29tcGF0aWJsZVRleHRDb250YWluZXIpOw0KICAgICAgZXh0ZW5zaW9uSW1hZ2Uud2lkdGggPSAyOTY7DQogICAgICBleHRlbnNpb25JbWFnZS5oZWlnaHQgPSAxODQ7DQogICAgfQ0KICAgIHJldHVybiBleHRlbnNpb25EaXY7DQogIH07DQoNCiAgLy9BZGQgYSBidXR0b24gdG8gbG9hZCBhIGV4dGVuc2lvbiBpbiB0aGUgZXh0ZW5zaW9uIHBhZ2UuDQogIFRXdW5sb2NrZWQudXRpbHMuYWRkRXh0ZW5zaW9uVG9GZWF0dXJlZEdhbGxlcnkgPSBmdW5jdGlvbiAoDQogICAgaWNvblVybCwNCiAgICB1cmwsDQogICAgbmFtZSwNCiAgICBkZXNjcmlwdGlvbg0KICApIHsNCiAgICBmdW5jdGlvbiBsb2FkRXh0ZW5zaW9uKCkgew0KICAgICAgVFd1bmxvY2tlZC5sb2FkRXh0ZW5zaW9uVW5zYW5kYm94ZWQodXJsLCB0cnVlKTsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5wYXJlbnRFbGVtZW50LmNoaWxkcmVuWzBdLmNoaWxkcmVuWzFdLmNoaWxkcmVuWzBdLmNsaWNrKCk7DQogICAgICBhbGVydCgiUE0tVW5sb2NrZWQ6IFlvdXIgRXh0ZW5zaW9uIGlzIGxvYWRpbmcsIHBsZWFzZSBiZSBwYXRpZW50LiIpOw0KICAgIH0NCiAgICBjb25zdCBteUV4dGVuc2lvbiA9IFRXdW5sb2NrZWQudXRpbHMuY3JlYXRlRXh0ZW5zaW9uRGl2KHsNCiAgICAgIC8vY3JlYXRvcjoge2xpbms6J2h0dHBzOi8vZ29vZ2xlLmNvbS8nLCBuYW1lOid0ZXN0J30sDQogICAgICB0aXRsZTogbmFtZSwNCiAgICAgIGRlc2NyaXB0aW9uLA0KICAgICAgaW1hZ2U6IGljb25VcmwsDQogICAgfSk7DQogICAgbXlFeHRlbnNpb24ub25jbGljayA9IGxvYWRFeHRlbnNpb247DQogICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5Lmluc2VydEJlZm9yZSgNCiAgICAgIG15RXh0ZW5zaW9uLA0KICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5LmNoaWxkTm9kZXNbMF0NCiAgICApOw0KICB9Ow0KDQogIFRXdW5sb2NrZWQudXRpbHMuYWRkQWxsbmV3RmVhdHVyZWRUb0dhbGxlcnkgPSBmdW5jdGlvbiAoKSB7DQogICAgbGV0IGV4dGVuc2lvbnMgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCd0d3U6Y3VzdG9tRXh0ZW5zaW9ucycpKTsNCiAgICBmb3IgKGV4dGVuc2lvbiBpbiBleHRlbnNpb25zKSB7DQogICAgICBleHRlbnNpb24gPSBleHRlbnNpb25zW2V4dGVuc2lvbl07DQogICAgICBUV3VubG9ja2VkLnV0aWxzLmFkZEV4dGVuc2lvblRvRmVhdHVyZWRHYWxsZXJ5KA0KICAgICAgICBleHRlbnNpb24uaW1hZ2VfdXJsLA0KICAgICAgICBleHRlbnNpb24udXJsLA0KICAgICAgICBleHRlbnNpb24ubmFtZSwNCiAgICAgICAgZXh0ZW5zaW9uLmRlc2NyaXB0aW9uDQogICAgICApOw0KICAgIH0NCiAgfTsNCg0KICBUV3VubG9ja2VkLnV0aWxzLmF0dGVtcHRUb0xvYWRNeUdhbGxlcnkgPSBhc3luYyBmdW5jdGlvbiAoKSB7DQogICAgdmFyIGV4dGVuc2lvbnMgPSBbXTsNCiAgICB2YXIgc2l0ZSA9ICJodHRwczovL3N1cnYuaXMtYS5kZXYvdW5zYWZlLWV4dGVuc2lvbnMiOw0KICAgIGlmICghVFd1bmxvY2tlZC5pc0Rlc2t0b3ApDQogICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuaW5zZXJ0QmVmb3JlKA0KICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbnNDYXRlZ29yeVNlcGFyYXRvci5jbG9uZU5vZGUodHJ1ZSksDQogICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5jaGlsZE5vZGVzWzBdDQogICAgICApOw0KICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoDQogICAgICBmZXRjaChzaXRlICsgIi8iKQ0KICAgICAgICAudGhlbigodGV4dCkgPT4gdGV4dC50ZXh0KCkpDQogICAgICAgIC50aGVuKCh0ZXh0KSA9PiB7DQogICAgICAgICAgbGV0IGRvbSA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcodGV4dCwgInRleHQvaHRtbCIpOw0KICAgICAgICAgIGRvbS5xdWVyeVNlbGVjdG9yQWxsKCJkaXYuZXh0ZW5zaW9uIikuZm9yRWFjaCgoZXh0KSA9PiB7DQogICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICBpZiAoZXh0LnN0eWxlLmRpc3BsYXkgPT0gIm5vbmUiIHx8IGV4dC5oYXNBdHRyaWJ1dGUoImhpZGRlbiIpKQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0gY2F0Y2gge30NCiAgICAgICAgICAgIGNvbnN0IHVyaSA9ICgNCiAgICAgICAgICAgICAgZXh0LnF1ZXJ5U2VsZWN0b3IoImEuY29weSIpIHx8IGV4dC5xdWVyeVNlbGVjdG9yKCJhLm9wZW4iKQ0KICAgICAgICAgICAgKS5ocmVmLnNwbGl0KCIvIik7DQogICAgICAgICAgICBsZXQgZXh0ZW5zaW9uID0gew0KICAgICAgICAgICAgICBuYW1lOiBleHQucXVlcnlTZWxlY3RvcigiaDMiKS5pbm5lckhUTUwsDQogICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBleHQucXVlcnlTZWxlY3RvcigicCIpLmlubmVySFRNTCwNCiAgICAgICAgICAgICAgaW1hZ2U6IGV4dA0KICAgICAgICAgICAgICAgIC5xdWVyeVNlbGVjdG9yKCJpbWcuZXh0ZW5zaW9uLWltYWdlIikNCiAgICAgICAgICAgICAgICAuc3JjLnJlcGxhY2UoZG9jdW1lbnQubG9jYXRpb24ub3JpZ2luLCBzaXRlKSwNCiAgICAgICAgICAgICAgdXJsOiBgaHR0cHM6Ly9zdXJ2LmlzLWEuZGV2L3Vuc2FmZS1leHRlbnNpb25zLyR7DQogICAgICAgICAgICAgICAgdXJpW3VyaS5sZW5ndGggLSAyXQ0KICAgICAgICAgICAgICB9LyR7dXJpW3VyaS5sZW5ndGggLSAxXX1gLA0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIGV4dGVuc2lvbnMucHVzaChleHRlbnNpb24pOw0KICAgICAgICAgIH0pOw0KICAgICAgICAgIGZvciAoZXh0ZW5zaW9uIGluIGV4dGVuc2lvbnMpIHsNCiAgICAgICAgICAgIGV4dGVuc2lvbiA9IGV4dGVuc2lvbnNbZXh0ZW5zaW9uXTsNCiAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuYWRkRXh0ZW5zaW9uVG9GZWF0dXJlZEdhbGxlcnkoDQogICAgICAgICAgICAgIGV4dGVuc2lvbi5pbWFnZSwNCiAgICAgICAgICAgICAgZXh0ZW5zaW9uLnVybCwNCiAgICAgICAgICAgICAgZXh0ZW5zaW9uLm5hbWUsDQogICAgICAgICAgICAgIGV4dGVuc2lvbi5kZXNjcmlwdGlvbg0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pDQogICAgICAgIC50aGVuKCgpID0+IHsNCiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7DQogICAgICAgIH0pDQogICAgKTsNCiAgfTsNCg0KICBUV3VubG9ja2VkLnV0aWxzLmF0dGVtcHRUb0xvYWRTUEdhbGxlcnkgPSBhc3luYyBmdW5jdGlvbiAoKSB7DQogICAgICB2YXIga2V5cyA9IGF3YWl0IGZldGNoKCdodHRwczovL2NvcnNwcm94eS5pby8/aHR0cHM6Ly9zaGFya3Bvb2xzLWV4dGVuc2lvbnMudmVyY2VsLmFwcC9HYWxsZXJ5JTIwRmlsZXMvRXh0ZW5zaW9uLUtleXMuanNvbicpOw0KICAgICAga2V5cyA9IGF3YWl0IGtleXMuanNvbigpOw0KICAgICAga2V5cyA9IGtleXMuZXh0ZW5zaW9uczsNCiAgICAgIGRlbGV0ZSBrZXlzWydJbWFnZS1FZmZlY3RzJ107ICAgIC8vIEJyb2tlbiBpY29uIDooDQogICAgICBkZWxldGUga2V5c1snTmljaGUtVG9vbGJveCddOyAgICAvLyBOYWguDQogICAgICBkZWxldGUga2V5c1snTmV3Z3JvdW5kcy1BdWRpbyddOyAvLyBMZWdhbCBncmV5IGFyZWENCiAgICAgIGRlbGV0ZSBrZXlzWydTaW5jZS0yMDAwJ107ICAgICAgIC8vTmFoLg0KICAgICAgbGV0IGV4dGVuc2lvbnMgPSBPYmplY3Qua2V5cyhrZXlzKTsNCiAgICAgIGV4dGVuc2lvbnMucG9wKGV4dGVuc2lvbnMubGVuZ3RoLTEpOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBleHRlbnNpb25zLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgbGV0IGV4dGVuc2lvbiA9IGV4dGVuc2lvbnNbaV07DQogICAgICAgICAgbGV0IG9iaiA9IGtleXNbZXh0ZW5zaW9uXTsNCiAgICAgICAgICBvYmouaW1hZ2UgPSAnaHR0cHM6Ly9jb3JzcHJveHkuaW8vP2h0dHBzOi8vc2hhcmtwb29scy1leHRlbnNpb25zLnZlcmNlbC5hcHAvZXh0ZW5zaW9uLXRodW1icy8nK2V4dGVuc2lvbisnLnN2Zyc7DQogICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5hZGRFeHRlbnNpb25Ub0ZlYXR1cmVkR2FsbGVyeSgNCiAgICAgICAgICAgIG9iai5pbWFnZSwNCiAgICAgICAgICAgIG9iai51cmwsDQogICAgICAgICAgICBleHRlbnNpb24sDQogICAgICAgICAgICBvYmouY3JlZGl0cw0KICAgICAgICAgICk7DQogICAgICB9DQogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpOw0KICB9DQoNCiAgVFd1bmxvY2tlZC5hZGRFeHRlbnNpb25Ub0ZlYXR1cmVkR2FsbGVyeSA9IGZ1bmN0aW9uICgNCiAgICBpY29uVXJsLA0KICAgIHVybCwNCiAgICBuYW1lLA0KICAgIGRlc2NyaXB0aW9uDQogICkgew0KICAgIFRXdW5sb2NrZWQudXRpbHMubmV3RmVhdHVyZWRFeHRlbnNpb25zLnB1c2goew0KICAgICAgaWNvblVybCwNCiAgICAgIHVybCwNCiAgICAgIG5hbWUsDQogICAgICBkZXNjcmlwdGlvbiwNCiAgICB9KTsNCiAgfTsNCg0KICBUV3VubG9ja2VkLnV0aWxzLmV4dEJ0bkFkZExpc3RlbiA9IGZ1bmN0aW9uICgpIHsNCiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdidXR0b25bY2xhc3NePSJndWlfZXh0ZW5zaW9uLWJ1dHRvbiJdJykub25jbGljayA9DQogICAgICBmdW5jdGlvbiAoKSB7DQogICAgICAgIHNldFRpbWVvdXQoYXN5bmMgZnVuY3Rpb24gKCkgew0KICAgICAgICAgIGNvbnN0IG1vZGFsU2V0dGluZ3MgPSBUV3VubG9ja2VkLmV4dE1hbmFnZXIuZ2V0TWFya3MoKTsNCiAgICAgICAgICBsZXQgbXlHYWxsZXJ5ID0gbW9kYWxTZXR0aW5ncy5teUdhbGxlcnksIHNwR2FsbGVyeSA9IG1vZGFsU2V0dGluZ3Muc3BHYWxsZXJ5Ow0KICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uc0NhdGVnb3J5U2VwYXJhdG9yID0NCiAgICAgICAgICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImhyIik7DQogICAgICAgICAgaWYgKCFUV3VubG9ja2VkLmlzRGVza3RvcCkNCiAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uc0NhdGVnb3J5U2VwYXJhdG9yLmNsYXNzTGlzdC5hZGQoDQogICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImhyW2NsYXNzXj1zZXBhcmF0b3Jfc2VwYXJhdG9yXSIpDQogICAgICAgICAgICAgICAgLmNsYXNzTGlzdFswXQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKA0KICAgICAgICAgICAgJ1tjbGFzc149ImxpYnJhcnlfbGlicmFyeS1zY3JvbGwtZ3JpZCJdJw0KICAgICAgICAgICk7DQogICAgICAgICAgaWYgKA0KICAgICAgICAgICAgbXlHYWxsZXJ5IHx8DQogICAgICAgICAgICBzcEdhbGxlcnkNCiAgICAgICAgICApIHsNCiAgICAgICAgICAgIGlmIChzcEdhbGxlcnkpIHsNCiAgICAgICAgICAgICAgaWYgKCFUV3VubG9ja2VkLmlzRGVza3RvcCkNCiAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5Lmluc2VydEJlZm9yZSgNCiAgICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbnNDYXRlZ29yeVNlcGFyYXRvci5jbG9uZU5vZGUodHJ1ZSksDQogICAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5LmNoaWxkTm9kZXNbMF0NCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgYXdhaXQgVFd1bmxvY2tlZC51dGlscy5hdHRlbXB0VG9Mb2FkU1BHYWxsZXJ5KCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAobXlHYWxsZXJ5KSB7DQogICAgICAgICAgICAgIGlmICghVFd1bmxvY2tlZC5pc0Rlc2t0b3ApDQogICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5pbnNlcnRCZWZvcmUoDQogICAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25zQ2F0ZWdvcnlTZXBhcmF0b3IuY2xvbmVOb2RlKHRydWUpLA0KICAgICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5jaGlsZE5vZGVzWzBdDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgIGF3YWl0IFRXdW5sb2NrZWQudXRpbHMuYXR0ZW1wdFRvTG9hZE15R2FsbGVyeSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKCFUV3VubG9ja2VkLmlzRGVza3RvcCkNCiAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5Lmluc2VydEJlZm9yZSgNCiAgICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbnNDYXRlZ29yeVNlcGFyYXRvci5jbG9uZU5vZGUodHJ1ZSksDQogICAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5LmNoaWxkTm9kZXNbMF0NCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuYWRkQWxsbmV3RmVhdHVyZWRUb0dhbGxlcnkoKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgaWYgKCFUV3VubG9ja2VkLmlzRGVza3RvcCkNCiAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5Lmluc2VydEJlZm9yZSgNCiAgICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbnNDYXRlZ29yeVNlcGFyYXRvci5jbG9uZU5vZGUodHJ1ZSksDQogICAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5LmNoaWxkTm9kZXNbMF0NCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuYWRkQWxsbmV3RmVhdHVyZWRUb0dhbGxlcnkoKTsNCiAgICAgICAgICB9DQogICAgICAgIH0sIDEwMDApOw0KICAgICAgfTsNCiAgfTsNCg0KICBUV3VubG9ja2VkLnV0aWxzLmhhc1RyaWVkVG9BZGRGb3JJID0gZmFsc2U7DQogIFRXdW5sb2NrZWQudXRpbHMuYWRkRm9ySWV4dGVuc2lvbiA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAoIVRXdW5sb2NrZWQudXRpbHMuaGFzVHJpZWRUb0FkZEZvckkpIHsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMuaGFzVHJpZWRUb0FkZEZvckkgPSB0cnVlOw0KICAgICAgVFd1bmxvY2tlZC5sb2FkRXh0ZW5zaW9uVW5zYW5kYm94ZWQoDQogICAgICAgICJodHRwczovL3N1cnYuaXMtYS5kZXYvYnJpbmdCYWNrRm9ySS5qcyINCiAgICAgICk7DQogICAgICBhbGVydCgNCiAgICAgICAgIlRoZSBmb3IgaSBibG9jayBzaG91bGQgYXBwZWFyIHdpdGhpbiAxMCBzZWNvbmRzLCBvdGhlcndpc2UgY2hlY2sgdGhlIGNvbnNvbGUhIg0KICAgICAgKTsNCiAgICB9DQogIH07DQoNCiAgVFd1bmxvY2tlZC51dGlscy5jdXJJZEdlbiA9IFRXdW5sb2NrZWQudXRpbHMuaWRHZW4oKTsNCiAgVFd1bmxvY2tlZC51dGlscy5oaWRkZW5CdWJibGVzID0gW107DQogIFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuSWNvbnMgPSBbXTsNCiAgd2luZG93LmdldEJ1YiA9IGZ1bmN0aW9uIChleHQpIHsNCiAgICBsZXQgYnViID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigNCiAgICAgICJkaXYuc2NyYXRjaENhdGVnb3J5SWQtIiArIGV4dA0KICAgICkucGFyZW50RWxlbWVudDsNCiAgICBidWIuaWNvbiA9DQogICAgICBidWIucXVlcnlTZWxlY3RvcigiZGl2LnNjcmF0Y2hDYXRlZ29yeUl0ZW1CdWJibGUiKSB8fA0KICAgICAgYnViLnF1ZXJ5U2VsZWN0b3IoImRpdi5zY3JhdGNoQ2F0ZWdvcnlJdGVtSWNvbiIpOw0KICAgIHJldHVybiBidWI7DQogIH07DQogIGxldCBib3VuZCA9IHZtLnJ1bnRpbWUuZ2V0QmxvY2tzWE1MLmJpbmQodm0ucnVudGltZSk7DQogIHZtLnJ1bnRpbWUuZ2V0QmxvY2tzWE1MID0gZnVuY3Rpb24gKC4uLmFyZ3MpIHsNCiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgVFd1bmxvY2tlZC51dGlscy5oaWRkZW5CdWJibGVzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgbGV0IGJ1YiA9IGdldEJ1YihUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkJ1YmJsZXNbaV0pOw0KICAgICAgICAgIGJ1Yi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgICAgICB9IGNhdGNoIChlcnIpIHsNCiAgICAgICAgICBjb25zb2xlLmRlYnVnKCJQTS1VbmxvY2tlZDogRXJyb3Igd2hlbiBoaWRpbmcgYnViYmxlOiAiICsgZXJyKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkljb25zLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgbGV0IGJ1YiA9IGdldEJ1YihUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkljb25zW2ldKTsNCiAgICAgICAgICBidWIuaWNvbi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgICAgICB9IGNhdGNoIChlcnIpIHsNCiAgICAgICAgICBjb25zb2xlLmRlYnVnKCJQTS1VbmxvY2tlZDogRXJyb3Igd2hlbiBoaWRpbmcgYnViYmxlIGljb246ICIgKyBlcnIpOw0KICAgICAgICB9DQogICAgICB9DQogICAgfSwgMTAwMCk7DQogICAgcmV0dXJuIGJvdW5kKC4uLmFyZ3MpOw0KICB9Ow0KICBmdW5jdGlvbiB0b29sYm94TWVudShlKSB7DQogICAgbGV0IHRtcCwNCiAgICAgIGJ1YmJsZSA9IGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQoZS5jbGllbnRYLCBlLmNsaWVudFkpOw0KICAgIHRtcCA9IGJ1YmJsZS5wYXJlbnRFbGVtZW50Ow0KICAgIGlmICh0bXAuY2xhc3NMaXN0LmNvbnRhaW5zKCJzY3JhdGNoQ2F0ZWdvcnlNZW51SXRlbSIpKSBidWJibGUgPSB0bXA7DQogICAgdG1wID0gYnViYmxlLnF1ZXJ5U2VsZWN0b3IoImRpdi5zY3JhdGNoQ2F0ZWdvcnlNZW51SXRlbSIpOw0KICAgIGlmICh0bXApIGJ1YmJsZSA9IHRtcDsNCiAgICBsZXQgZXh0ZW5zaW9uID0gYnViYmxlLmNsYXNzTGlzdFsxXS5yZXBsYWNlKCJzY3JhdGNoQ2F0ZWdvcnlJZC0iLCAiIik7DQogICAgY29uc3QgaXNCdWlsdEluID0gWw0KICAgICAgIm1vdGlvbiIsDQogICAgICAibG9va3MiLA0KICAgICAgInNvdW5kIiwNCiAgICAgICJwZW4iLA0KICAgICAgImRhdGEiLA0KICAgICAgInZhcmlhYmxlcyIsDQogICAgICAiZGF0YUxpc3RzIiwNCiAgICAgICJsaXN0cyIsDQogICAgICAiZXZlbnQiLA0KICAgICAgImV2ZW50cyIsDQogICAgICAiY29udHJvbCIsDQogICAgICAic2Vuc2luZyIsDQogICAgICAib3BlcmF0b3JzIiwNCiAgICAgICJtb3JlIiwNCiAgICAgICJteUJsb2NrcyIsDQogICAgXS5pbmNsdWRlcyhleHRlbnNpb24pOw0KICAgIHZhciBibG9ja3MgPSB2bS5ydW50aW1lLmdldEVkaXRpbmdUYXJnZXQoKS5ibG9ja3M7DQogICAgdmFyIGRlbGV0aW9ucyA9IFtdOw0KICAgIGJ1YmJsZS5pY29uID0NCiAgICAgIGJ1YmJsZS5wYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoImRpdi5zY3JhdGNoQ2F0ZWdvcnlJdGVtQnViYmxlIikgfHwNCiAgICAgIGJ1YmJsZS5wYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoImRpdi5zY3JhdGNoQ2F0ZWdvcnlJdGVtSWNvbiIpOw0KICAgIE9iamVjdC52YWx1ZXMoYmxvY2tzLl9ibG9ja3MpLmZvckVhY2goKGJsb2NrKSA9PiB7DQogICAgICBpZiAoYmxvY2sub3Bjb2RlLnN0YXJ0c1dpdGgoZXh0ZW5zaW9uKSkgew0KICAgICAgICBsZXQgbXlVcCA9IGJsb2NrLnBhcmVudDsNCiAgICAgICAgbGV0IG15TmV4dCA9IGJsb2NrLm5leHQ7DQogICAgICAgIGJsb2NrLnBhcmVudCA9IG51bGw7DQogICAgICAgIGJsb2NrLm5leHQgPSBudWxsOw0KICAgICAgICB0cnkgew0KICAgICAgICAgIGJsb2Nrcy5fYmxvY2tzW215VXBdLm5leHQgPSBteU5leHQ7DQogICAgICAgIH0gY2F0Y2gge30NCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBibG9ja3MuX2Jsb2Nrc1tteU5leHRdLnBhcmVudCA9IG15VXA7DQogICAgICAgIH0gY2F0Y2gge30NCiAgICAgICAgZGVsZXRpb25zLnB1c2goYmxvY2suaWQpOw0KICAgICAgfQ0KICAgIH0pOw0KICAgIGxldCB3aWRnaXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICB3aWRnaXQuY2xhc3NMaXN0LmFkZCgiYmxvY2tseVdpZGdldERpdiIpOw0KICAgIHdpZGdpdC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7DQogICAgd2lkZ2l0LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgIHdpZGdpdC5zdHlsZS5kaXJlY3Rpb24gPSAibHRyIjsNCiAgICB3aWRnaXQuc3R5bGUudG9wID0gZS5jbGllbnRZICsgInB4IjsNCiAgICB3aWRnaXQuc3R5bGUubGVmdCA9IGUuY2xpZW50WCArICJweCI7DQogICAgd2lkZ2l0LnN0eWxlLndpZHRoID0gIjIyNC4ycHgiOw0KICAgIGxldCBtZW51SGVpZ2h0ID0gMDsNCiAgICBsZXQgbWVudSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIG1lbnUuY2xhc3NMaXN0LmFkZCgiZ29vZy1tZW51Iik7DQogICAgbWVudS5jbGFzc0xpc3QuYWRkKCJnb29nLW1lbnUtdmVydGljYWwiKTsNCiAgICBtZW51LmNsYXNzTGlzdC5hZGQoImJsb2NrbHlDb250ZXh0TWVudSIpOw0KICAgIG1lbnUucm9sZSA9ICJtZW51IjsNCiAgICBtZW51LnN0eWxlLnVzZXJTZWxlY3QgPSAibm9uZSI7DQogICAgbWVudS50YWJpbmRleCA9IDA7DQogICAgZnVuY3Rpb24gbWVudUl0ZW0odGV4dCwgZXh0cmFzLCBvbmNsaWNrKSB7DQogICAgICBsZXQgaXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgICAgaXRlbS5pc0Rpc2FibGVkID0gZXh0cmFzLmlzRGlzYWJsZWQ7DQogICAgICBpZiAoZXh0cmFzLmJvcmRlcikgew0KICAgICAgICBtZW51SGVpZ2h0ICs9IDM7DQogICAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZCgic2EtYmxvY2tseS1tZW51LWl0ZW0tYm9yZGVyIik7DQogICAgICAgIGl0ZW0uc3R5bGUucGFkZGluZ1RvcCA9ICIycHgiOw0KICAgICAgICBpdGVtLnN0eWxlLmJvcmRlclRvcCA9ICIxcHggc29saWQgcmdiYSgwLCAwLCAwLCAwLjE1KSI7DQogICAgICB9DQogICAgICBpdGVtLm9uY2xpY2sgPSBmdW5jdGlvbiAoLi4uYXJncykgew0KICAgICAgICBpZiAoaXRlbS5pc0Rpc2FibGVkKSByZXR1cm47DQogICAgICAgIG9uY2xpY2soLi4uYXJncyk7DQogICAgICAgIHdpZGdpdC5yZW1vdmUoKTsNCiAgICAgIH07DQogICAgICBpdGVtLm9ubW91c2VvdmVyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAoaXRlbS5pc0Rpc2FibGVkKSByZXR1cm47DQogICAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZCgiZ29vZy1tZW51aXRlbS1oaWdobGlnaHQiKTsNCiAgICAgIH07DQogICAgICBpdGVtLm9ubW91c2VvdXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmIChpdGVtLmlzRGlzYWJsZWQpIHJldHVybjsNCiAgICAgICAgaWYgKCFpdGVtLmlzRGlzYWJsZWQpIGl0ZW0uY2xhc3NMaXN0LnJlbW92ZSgiZ29vZy1tZW51aXRlbS1oaWdobGlnaHQiKTsNCiAgICAgIH07DQogICAgICBpdGVtLmlubmVySFRNTCA9IGA8ZGl2IGNsYXNzPSJnb29nLW1lbnVpdGVtLWNvbnRlbnQiIHN0eWxlPSJ1c2VyLXNlbGVjdDogbm9uZTsiPiR7dGV4dH08L2Rpdj5gOw0KICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKCJnb29nLW1lbnVpdGVtIik7DQogICAgICBpZiAoaXRlbS5pc0Rpc2FibGVkKSB7DQogICAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZCgiZ29vZy1tZW51aXRlbS1kaXNhYmxlZCIpOw0KICAgICAgfQ0KICAgICAgaXRlbS5yb2xlID0gIm1lbnVpdGVtIjsNCiAgICAgIGl0ZW0uaWQgPSBgOiR7VFd1bmxvY2tlZC51dGlscy5jdXJJZEdlbi5uZXh0KCkudmFsdWV9YDsNCiAgICAgIGl0ZW0uc3R5bGUudXNlclNlbGVjdCA9ICJub25lIjsNCiAgICAgIG1lbnVIZWlnaHQgKz0gMjM7DQogICAgICByZXR1cm4gaXRlbTsNCiAgICB9DQogICAgY29uc3QgZGVmYXVsdFNldHRpbmdzID0gew0KICAgICAgaXNEaXNhYmxlZDogZmFsc2UsDQogICAgICBib3JkZXI6IGZhbHNlLA0KICAgIH07DQogICAgbWVudS5hcHBlbmRDaGlsZCgNCiAgICAgIG1lbnVJdGVtKA0KICAgICAgICAicmVtb3ZlIGFsbCBleHRlbnNpb24gYmxvY2tzIiwNCiAgICAgICAgew0KICAgICAgICAgIGlzRGlzYWJsZWQ6IGlzQnVpbHRJbiwNCiAgICAgICAgICBib3JkZXI6IGZhbHNlLA0KICAgICAgICB9LA0KICAgICAgICBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgaWYgKA0KICAgICAgICAgICAgY29uZmlybSgNCiAgICAgICAgICAgICAgIkFyZSB5b3Ugc3VyZSBhYm91dCB0aGlzLCB0aGlzIHdpbGwgcmVtb3ZlICIgKw0KICAgICAgICAgICAgICAgIGRlbGV0aW9ucy5sZW5ndGggKw0KICAgICAgICAgICAgICAgICIgYmxvY2tzPyINCiAgICAgICAgICAgICkNCiAgICAgICAgICApIHsNCiAgICAgICAgICAgIGRlbGV0aW9ucy5mb3JFYWNoKChibG9jaykgPT4gew0KICAgICAgICAgICAgICBkZWxldGUgYmxvY2tzLl9ibG9ja3NbYmxvY2tdOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB2bS5yZWZyZXNoV29ya3NwYWNlKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICApDQogICAgKTsNCiAgICBtZW51LmFwcGVuZENoaWxkKA0KICAgICAgbWVudUl0ZW0oDQogICAgICAgICJoaWRlIGJ1YmJsZSIsDQogICAgICAgIHsNCiAgICAgICAgICBpc0Rpc2FibGVkOiBmYWxzZSwNCiAgICAgICAgICBib3JkZXI6IHRydWUsDQogICAgICAgIH0sDQogICAgICAgIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICBpZiAoDQogICAgICAgICAgICBjb25maXJtKA0KICAgICAgICAgICAgICAiQXJlIHlvdSBzdXJlIGFib3V0IHRoaXMgeW91IHdvbid0IGJlIGFibGUgdG8gc2hvdyBpdCB1bmxlc3MgeW91IHJlbG9hZD8iDQogICAgICAgICAgICApDQogICAgICAgICAgKSB7DQogICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkJ1YmJsZXMucHVzaChleHRlbnNpb24pOw0KICAgICAgICAgICAgYnViYmxlLnBhcmVudEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICkNCiAgICApOw0KICAgIGlmIChUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkljb25zLmluY2x1ZGVzKGV4dGVuc2lvbikpIHsNCiAgICAgIG1lbnUuYXBwZW5kQ2hpbGQoDQogICAgICAgIG1lbnVJdGVtKCJzaG93IGljb24iLCBkZWZhdWx0U2V0dGluZ3MsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkljb25zLnBvcCgNCiAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuQnViYmxlcy5pbmRleE9mKGV4dGVuc2lvbikNCiAgICAgICAgICApOw0KICAgICAgICAgIGJ1YmJsZS5pY29uLnN0eWxlLmRpc3BsYXkgPSAiIjsNCiAgICAgICAgfSkNCiAgICAgICk7DQogICAgfSBlbHNlIHsNCiAgICAgIG1lbnUuYXBwZW5kQ2hpbGQoDQogICAgICAgIG1lbnVJdGVtKCJoaWRlIGljb24iLCBkZWZhdWx0U2V0dGluZ3MsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkljb25zLnB1c2goZXh0ZW5zaW9uKTsNCiAgICAgICAgICBidWJibGUuaWNvbi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgICAgICB9KQ0KICAgICAgKTsNCiAgICB9DQogICAgd2lkZ2l0LnN0eWxlLmhlaWdodCA9IG1lbnVIZWlnaHQgKyAicHgiOw0KICAgIHdpZGdpdC5hcHBlbmRDaGlsZChtZW51KTsNCiAgICB0bXAgPSBmdW5jdGlvbiAoKSB7DQogICAgICB0cnkgew0KICAgICAgICB3aWRnaXQucmVtb3ZlKCk7DQogICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcih0bXApOw0KICAgICAgfSBjYXRjaCB7fQ0KICAgIH07DQogICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiZGl2LmJsb2NrbHlUb29sYm94RGl2Iikub25tb3VzZWRvd24gPSB0bXA7DQogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh3aWRnaXQpOw0KICB9Ow0KDQogIGZ1bmN0aW9uIGltcG9ydEltYWdlKHVybCwgY29zdHVtZV9uYW1lKSB7DQogICAgY29uc3Qgc3RvcmFnZSA9IHZtLnJ1bnRpbWUuc3RvcmFnZTsNCiAgICBmdW5jdGlvbiBnZXRfdXJsX2V4dGVuc2lvbih1cmkpIHsNCiAgICAgIHZhciBsZW4gPSB1cmkuc3BsaXQoIi8iKTsNCiAgICAgIHJldHVybiBsZW5bbGVuLmxlbmd0aCAtIDFdLnNwbGl0KCIuIilbMV0uc3BsaXQoL1sjP10vZ2kpWzBdOw0KICAgIH0NCiAgICBsZXQgZGF0YVR5cGUgPSAiIiwNCiAgICAgIGRhdGFGb3JtYXQgPSAiIjsNCiAgICBpZiAodXJsLnN0YXJ0c1dpdGgoImRhdGE6aW1hZ2UvIikpIHsNCiAgICAgIHVybCA9IHVybC5yZXBsYWNlKCJkYXRhOmltYWdlLyIsICIiKTsNCiAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCgic3ZnIikpDQogICAgICAgIChkYXRhVHlwZSA9ICJzdmciKSwgKGRhdGFGb3JtYXQgPSBzdG9yYWdlLkRhdGFGb3JtYXQuU1ZHKTsNCiAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCgicG5nIikpDQogICAgICAgIChkYXRhVHlwZSA9ICJwbmciKSwgKGRhdGFGb3JtYXQgPSBzdG9yYWdlLkRhdGFGb3JtYXQuUE5HKTsNCiAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCgianBnIikpDQogICAgICAgIChkYXRhVHlwZSA9ICJqcGciKSwgKGRhdGFGb3JtYXQgPSBzdG9yYWdlLkRhdGFGb3JtYXQuSlBHKTsNCiAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCgianBlZyIpKQ0KICAgICAgICAoZGF0YVR5cGUgPSAianBnIiksIChkYXRhRm9ybWF0ID0gc3RvcmFnZS5EYXRhRm9ybWF0LkpQRyk7DQogICAgICBpZiAoZGF0YVR5cGUgPT0gIiIpIHJldHVybiAtMTsNCiAgICAgIHVybCA9IGBkYXRhOmltYWdlLyR7dXJsfWA7DQogICAgfSBlbHNlIHsNCiAgICAgIGRhdGFUeXBlID0gZ2V0X3VybF9leHRlbnNpb24odXJsKTsNCiAgICAgIGRhdGFUeXBlID0gZGF0YVR5cGUudG9Mb3dlckNhc2UoKTsNCiAgICAgIHN3aXRjaCAoZGF0YVR5cGUpIHsNCiAgICAgICAgY2FzZSAic3ZnIjoNCiAgICAgICAgICBkYXRhRm9ybWF0ID0gc3RvcmFnZS5EYXRhRm9ybWF0LlNWRzsNCiAgICAgICAgICBicmVhazsNCiAgICAgICAgY2FzZSAicG5nIjoNCiAgICAgICAgICBkYXRhRm9ybWF0ID0gc3RvcmFnZS5EYXRhRm9ybWF0LlBORzsNCiAgICAgICAgICBicmVhazsNCiAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAvLyAqY291Z2gqIHRvIG1hbnkganBnIGZvcm1hdHMNCiAgICAgICAgICBpZiAoWyJqcGciLCAianBlZyIsICJqZmlmIiAvKiBldGMsIGV0Yy4uICovXS5pbmNsdWRlcyhkYXRhVHlwZSkpIHsNCiAgICAgICAgICAgIGRhdGFGb3JtYXQgPSBzdG9yYWdlLkRhdGFGb3JtYXQuSlBHOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIHJldHVybiAtMjsNCiAgICAgIH0NCiAgICB9DQogICAgZGF0YVR5cGUgPSBkYXRhVHlwZS50b0xvd2VyQ2FzZSgpOw0KICAgIHdpbmRvdw0KICAgICAgLmZldGNoKHVybCkNCiAgICAgIC50aGVuKChyKSA9PiByLmFycmF5QnVmZmVyKCkpDQogICAgICAudGhlbigoYXJyYXlCdWZmZXIpID0+IHsNCiAgICAgICAgY29uc3Qgc3RvcmFnZSA9IHZtLnJ1bnRpbWUuc3RvcmFnZTsNCiAgICAgICAgLy8gIEB0cy1leHBlY3QtZXJyb3INCiAgICAgICAgdm0uYWRkQ29zdHVtZShjb3N0dW1lX25hbWUgKyBgLiR7ZGF0YVR5cGUudG9VcHBlckNhc2UoKX1gLCB7DQogICAgICAgICAgbmFtZTogY29zdHVtZV9uYW1lICsgIiIsDQogICAgICAgICAgYXNzZXQ6IG5ldyBzdG9yYWdlLkFzc2V0KA0KICAgICAgICAgICAgZGF0YVR5cGUgPT0gInN2ZyINCiAgICAgICAgICAgICAgPyBzdG9yYWdlLkFzc2V0VHlwZS5JbWFnZVZlY3Rvcg0KICAgICAgICAgICAgICA6IHN0b3JhZ2UuQXNzZXRUeXBlLkltYWdlQml0bWFwLA0KICAgICAgICAgICAgbnVsbCwNCiAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgWUVTIElUIElTIFNIVVQgVFMgbG9sDQogICAgICAgICAgICBkYXRhRm9ybWF0LA0KICAgICAgICAgICAgbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWZmZXIpLA0KICAgICAgICAgICAgdHJ1ZQ0KICAgICAgICAgICksDQogICAgICAgIH0pOw0KICAgICAgfSk7DQogICAgcmV0dXJuIDE7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlSW1hZ2UobmFtZSwgdXJsLCBvbmNsaWNrKSB7DQogICAgdmFyIGxpYkl0ZW0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKA0KICAgICAgJ2RpdltjbGFzc149ImxpYnJhcnktaXRlbV9saWJyYXJ5LWl0ZW0iXScNCiAgICApOw0KICAgIHZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgbGliSXRlbS5jbGFzc0xpc3QuZm9yRWFjaCgoY2xhc3NfKSA9PiB7DQogICAgICB3cmFwcGVyLmNsYXNzTGlzdC5hZGQoY2xhc3NfKTsNCiAgICB9KTsNCiAgICB3cmFwcGVyLnJvbGUgPSAiYnV0dG9uIjsNCiAgICB3cmFwcGVyLnRhYkluZGV4ID0gIjAiOw0KICAgIHZhciBpbWFnZVdyYXBwZXJPdXRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIHZhciBpbWFnZVdyYXBwZXJJbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIGxpYkl0ZW0uY2hpbGROb2Rlc1swXS5jbGFzc0xpc3QuZm9yRWFjaCgoY2xhc3NfKSA9PiB7DQogICAgICBpbWFnZVdyYXBwZXJPdXRlci5jbGFzc0xpc3QuYWRkKGNsYXNzXyk7DQogICAgfSk7DQogICAgbGliSXRlbS5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0uY2xhc3NMaXN0LmZvckVhY2goKGNsYXNzXykgPT4gew0KICAgICAgaW1hZ2VXcmFwcGVySW5uZXIuY2xhc3NMaXN0LmFkZChjbGFzc18pOw0KICAgIH0pOw0KICAgIHZhciBpbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOw0KICAgIGltYWdlLmNsYXNzTGlzdC5hZGQoDQogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdpbWdbY2xhc3NePSJsaWJyYXJ5LWl0ZW1fbGlicmFyeS1pdGVtLWltYWdlIl0nKQ0KICAgICAgICAuY2xhc3NMaXN0WzBdDQogICAgKTsNCiAgICBpbWFnZS5kcmFnZ2FibGUgPSBmYWxzZTsNCiAgICBpbWFnZS5sb2FkaW5nID0gImxhenkiOw0KICAgIGltYWdlLnNyYyA9IHVybDsNCiAgICBpbWFnZVdyYXBwZXJJbm5lci5hcHBlbmRDaGlsZChpbWFnZSk7DQogICAgaW1hZ2VXcmFwcGVyT3V0ZXIuYXBwZW5kQ2hpbGQoaW1hZ2VXcmFwcGVySW5uZXIpOw0KICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW1hZ2VXcmFwcGVyT3V0ZXIpOw0KICAgIHZhciB0aXRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsNCiAgICB0aXRsZS5jbGFzc0xpc3QuYWRkKA0KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3Rvcignc3BhbltjbGFzc149ImxpYnJhcnktaXRlbV9saWJyYXJ5LWl0ZW0tbmFtZSJdJykNCiAgICAgICAgLmNsYXNzTGlzdFswXQ0KICAgICk7DQogICAgdGl0bGUuaW5uZXJIVE1MID0gbmFtZTsNCiAgICB3cmFwcGVyLmFwcGVuZENoaWxkKHRpdGxlKTsNCiAgICB3cmFwcGVyLm9uY2xpY2sgPSBmdW5jdGlvbiAoZSkgew0KICAgICAgb25jbGljayhlLCB0aGlzKTsNCiAgICB9Ow0KICAgIHJldHVybiB3cmFwcGVyOw0KICB9DQogIGZ1bmN0aW9uIGxvYWRDdXN0b21Db3N0dW1lcyhuYW1lc3BhY2UpIHsNCiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgIGxldCBsaWJyYXJ5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigNCiAgICAgICAgJ2RpdltjbGFzc149ImxpYnJhcnlfbGlicmFyeS1zY3JvbGwtZ3JpZCJdJw0KICAgICAgKTsNCiAgICAgIGZ1bmN0aW9uIGFkZChlbGVtKSB7DQogICAgICAgIGxpYnJhcnkuY2hpbGROb2Rlc1swXS5iZWZvcmUoZWxlbSwgbGlicmFyeS5jaGlsZE5vZGVzWzBdKTsNCiAgICAgIH0NCiAgICAgIGZ1bmN0aW9uIGxvYWRJbWFnZUZuKGUsIHNlbGYpIHsNCiAgICAgICAgaW1wb3J0SW1hZ2UoDQogICAgICAgICAgc2VsZi5xdWVyeVNlbGVjdG9yKCJpbWciKS5zcmMsDQogICAgICAgICAgc2VsZi5xdWVyeVNlbGVjdG9yKCJzcGFuIikuaW5uZXJIVE1MDQogICAgICAgICk7DQogICAgICAgIGRvY3VtZW50DQogICAgICAgICAgLnF1ZXJ5U2VsZWN0b3IoDQogICAgICAgICAgICAnZGl2W2NsYXNzXj0ibW9kYWxfaGVhZGVyLWl0ZW0iXSBzcGFuW2NsYXNzXj0iYnV0dG9uX291dGxpbmVkLWJ1dHRvbiJdJw0KICAgICAgICAgICkNCiAgICAgICAgICAuY2xpY2soKTsNCiAgICAgIH0NCiAgICAgIC8veW91IGRvbnQgbmVlZCB0byBkbyB0aGlzIGlmIHlvdSBhcmUgc3RlYWxpbmcgZnJvbSBtZSwgd2hpY2ggcGxlYXNlIGRvbnQgZG8gOnNvYjoNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UoDQogICAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKG5hbWVzcGFjZSA/PyAidHd1OmN1c3RvbUltYWdlcyIpDQogICAgICApOw0KICAgICAgaWYgKGZvdW5kLmxlbmd0aCA9PSAwKSByZXR1cm47DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZvdW5kLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGxldCBjb3MgPSBmb3VuZFtpXTsNCiAgICAgICAgYWRkKGNyZWF0ZUltYWdlKGNvcy5uYW1lLCBjb3MudXJsLCBsb2FkSW1hZ2VGbikpOw0KICAgICAgfQ0KICAgIH0sIDIwMDApOw0KICB9DQogIGZ1bmN0aW9uIGxvYWRDdXN0b21CYWNrZHJvcHMoKSB7DQogICAgbG9hZEN1c3RvbUNvc3R1bWVzKCJ0d3U6Y3VzdG9tQmFja2Ryb3BzIik7DQogIH0NCiAgY29uc3Qgb2JzZXJ2ZXJDb25maWcgPSB7DQogICAgYXR0cmlidXRlczogdHJ1ZSwNCiAgICBjaGlsZExpc3Q6IHRydWUsDQogICAgY2hhcmFjdGVyRGF0YTogdHJ1ZSwNCiAgfTsNCiAgY29uc3Qgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigobXV0YXRpb25zKSA9PiB7DQogICAgbXV0YXRpb25zLmZvckVhY2goKG11dGF0aW9uKSA9PiB7DQogICAgICBpZiAobXV0YXRpb24udHlwZSA9PSAiYXR0cmlidXRlcyIpIHJldHVybjsNCiAgICAgIGlmIChtdXRhdGlvbi5hZGRlZE5vZGVzLmxlbmd0aCA+IDApIHsNCiAgICAgICAgaWYgKG11dGF0aW9uLmFkZGVkTm9kZXNbMF0uY2xhc3NMaXN0LmNvbnRhaW5zKCJSZWFjdE1vZGFsUG9ydGFsIikpIHsNCiAgICAgICAgICBsZXQgbW9kYWxUaXRsZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgICAgICAgICAnW2NsYXNzXj0ibW9kYWxfaGVhZGVyLWl0ZW0iXScNCiAgICAgICAgICApLmlubmVySFRNTDsNCiAgICAgICAgICBzd2l0Y2ggKG1vZGFsVGl0bGUpIHsNCiAgICAgICAgICAgIGNhc2UgIkNob29zZSBhIFNwcml0ZSI6DQogICAgICAgICAgICAgIGxvYWRDdXN0b21Db3N0dW1lcygpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgIkNob29zZSBhIEJhY2tkcm9wIjoNCiAgICAgICAgICAgICAgbG9hZEN1c3RvbUJhY2tkcm9wcygpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgIkNob29zZSBhIENvc3R1bWUiOg0KICAgICAgICAgICAgICBsb2FkQ3VzdG9tQ29zdHVtZXMoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfSk7DQogIH0pOw0KICBvYnNlcnZlci5vYnNlcnZlKGRvY3VtZW50LmJvZHksIG9ic2VydmVyQ29uZmlnKTsNCg0KICAvL1NldHVwIG9wdGlvbnMgbWVudS4NCiAgY29uc3QgcHJlQXBwZW5kID0gInR3VW9NXyI7DQogIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5jbGFzc0xpc3QuYWRkKCJUV3VubG9ja2VkTW9kYWwiKTsNCiAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLmlubmVySFRNTCA9IGA8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5jbG9zZSgpIj5DbG9zZS48L2J1dHRvbj48YnI+DQo8ZGl2Pg0KICA8aDQ+UE0tVW5sb2NrZWQgfCB2JHtWRVJTSU9OfTwvaDQ+DQogIDxocj4NCiAgPGxhYmVsPjxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC51dGlscy5leHRNYW4oKSI+TG9hZCBleHRlbnNpb248L2J1dHRvbj4gOiANCiAgICA8aW5wdXQgdHlwZT0idXJsIiBpZD0iJHtwcmVBcHBlbmR9bGUiLz4mZW1zcDs8bGFiZWw+VW5zYW5kYm94ZWQ6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9IiR7cHJlQXBwZW5kfWxlQyIgY2hlY2tlZC8+DQogIDwvbGFiZWw+PGJyPjxidXR0b24gc3R5bGU9ImRpc3BsYXk6bm9uZTsiIGlkPSIke3ByZUFwcGVuZH0iIG9uY2xpY2s9IlRXdW5sb2NrZWQudXRpbHMuYWRkRm9ySWV4dGVuc2lvbigpO3RoaXMubmV4dEVsZW1lbnRTaWJsaW5nLnJlbW92ZSgpO3RoaXMucmVtb3ZlKCk7IiB0aXRsZT0iI0JyaW5nIEJhY2sgRm9yIEkiPkJyaW5nIGJhY2sgdGhlIEZvciBJIGJsb2NrPC9idXR0b24+PGJyPjxocj4NCiAgPGJ1dHRvbiBpZD0iJHtwcmVBcHBlbmR9c01zIj5EaXNhYmxlPC9idXR0b24+IHZtIHNlY3VyaXR5IG1hbmFnZXI8aHI+DQogIDxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5leHRNYW5hZ2VyLnNob3coKTsiPk1hbmFnZSBjdXN0b20gZmVhdHVyZWQgZXh0ZW5zaW9uczwvYnV0dG9uPjxicj4NCiAgPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmNvc01hbmFnZXIuc2hvdygpOyI+TWFuYWdlIGN1c3RvbSBjb3N0dW1lczwvYnV0dG9uPjxicj4NCiAgPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLnNob3coKTsiPk1hbmFnZSBjdXN0b20gYmFja2Ryb3BzPC9idXR0b24+PGJyPg0KICA8YnV0dG9uIG9uY2xpY2s9InZtLnJ1bnRpbWUuZXh0ZW5zaW9uTWFuYWdlci5yZWZyZXNoQmxvY2tzKCkiPlJlZnJlc2ggQmxvY2tzPC9idXR0b24+PGJyPg0KICA8YnV0dG9uIG9uY2xpY2s9InZtLnJlZnJlc2hXb3Jrc3BhY2UoKSI+UmVmcmVzaCBXb3Jrc3BhY2U8L2J1dHRvbj4NCiAgPGhyPg0KICBTdWJtaXQgYW4gZXh0ZW5zaW9uIHRoYXQgY2Fubm90IGJlIG9uIHRoZSBnYWxsZXJ5IHRvOiA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vU3VydkV4ZTFQYy91bnNhZmUtZXh0ZW5zaW9ucyI+SEVSRSwgQ2xpY2sgbWUhITwvYT4NCiAgPGhyPg0KPC9kaXY+YDsNCiAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLmlkID0gIlRXdW5sb2NrZWQtTW9kYWxEaXYiOw0KICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbSk7DQogIC8vICpjb3VnaCogaW1hIGNvcHkgcGFzdGUgZm9yIGJhY2tkcm9wcywgYW5kIHNvdW5kcywgYW5kIGV4dGVuc2lvbnMuLi4gKmNvdWdoKg0KICAvL0JhY2tkcm9wIGxpYnJhcnkgYWRkZXIgbW9kYWwNCiAgVFd1bmxvY2tlZC5kcm9wTWFuYWdlciA9IHsNCiAgICBtZW51T3BlbjogZmFsc2UsDQogICAgbHNJZDogInR3dTpjdXN0b21CYWNrZHJvcHMiLA0KICAgIGVsZW06IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpYWxvZyIpLA0KICAgIHBvcCgpIHsNCiAgICAgIHRoaXMuZWxlbS5yZW1vdmUoKTsNCiAgICB9LA0KICAgIGNsb3NlKCkgew0KICAgICAgdGhpcy5lbGVtLmNsb3NlKCk7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uc2hvd01vZGFsKCk7DQogICAgfSwNCiAgICBzaG93KCkgew0KICAgICAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLmNsb3NlKCk7DQogICAgICB0aGlzLmVsZW0uc2hvd01vZGFsKCk7DQogICAgfSwNCiAgICByZWZyZXNoTWVudSgpIHsNCiAgICAgIGNvbnN0IG1lbnVCdG4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBidXR0b24jJHtwcmVBcHBlbmR9ZHJvcE1lbnVCdG5gKTsNCiAgICAgIGlmIChUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLmVsZW0ub3BlbiAmJiB0aGlzLm1lbnVPcGVuKSB7DQogICAgICAgIG1lbnVCdG4uY2xpY2soKTsNCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7DQogICAgICAgICAgbWVudUJ0bi5jbGljaygpOw0KICAgICAgICB9LCAxMDApOw0KICAgICAgfQ0KICAgIH0sDQogICAgYWRkKCkgew0KICAgICAgbGV0IGlOYW1lID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgaW5wdXQjJHtwcmVBcHBlbmR9ZHJvcGlOYW1lYCk7DQogICAgICBsZXQgaVVybCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGlucHV0IyR7cHJlQXBwZW5kfWRyb3BpVXJsYCk7DQogICAgICB2YXIgdG1wID0gaU5hbWUudmFsdWU7DQogICAgICBpTmFtZS52YWx1ZSA9ICIiOw0KICAgICAgaU5hbWUgPSB0bXA7DQogICAgICB0bXAgPSBpVXJsLnZhbHVlOw0KICAgICAgaVVybC52YWx1ZSA9ICIiOw0KICAgICAgaVVybCA9IHRtcDsNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc0lkKSk7DQogICAgICBmb3VuZC5wdXNoKHsgbmFtZTogaU5hbWUsIHVybDogaVVybCB9KTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNJZCwgSlNPTi5zdHJpbmdpZnkoZm91bmQpKTsNCiAgICAgIHRoaXMucmVmcmVzaE1lbnUoKTsNCiAgICB9LA0KICAgIGdldFVsKCkgew0KICAgICAgbGV0IGl0ZW1zID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidWwiKTsNCiAgICAgIGlmICghbG9jYWxTdG9yYWdlLmhhc093blByb3BlcnR5KHRoaXMubHNJZCkpDQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNJZCwgSlNPTi5zdHJpbmdpZnkoW10pKTsNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc0lkKSk7DQogICAgICBjb25zdCBub0l0ZW1zID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOw0KICAgICAgbm9JdGVtcy5pbm5lckhUTUwgPSAiJm5ic3A7Jm5ic3A7Tm8gYmFja2Ryb3BzIGZvdW5kLCB0cnkgYWRkaW5nIHNvbWUhIjsNCiAgICAgIGlmIChmb3VuZC5sZW5ndGggPT0gMCkgcmV0dXJuIG5vSXRlbXM7DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZvdW5kLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGxldCBkcm9wID0gZm91bmRbaV07DQogICAgICAgIHZhciB0bXAyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsNCiAgICAgICAgdG1wMi5pbm5lckhUTUwgPSBgJHtkcm9wLm5hbWV9Jm5ic3A7Jm5ic3A7PGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLnBvcEl0ZW0oJHtpfSkiPlJlbW92ZTwvYnV0dG9uPmA7DQogICAgICAgIGl0ZW1zLmFwcGVuZENoaWxkKHRtcDIpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIGl0ZW1zOw0KICAgIH0sDQogICAgcG9wSXRlbShudW0pIHsNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc0lkKSk7DQogICAgICBmb3VuZC5wb3AobnVtKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNJZCwgSlNPTi5zdHJpbmdpZnkoZm91bmQpKTsNCiAgICAgIHRoaXMucmVmcmVzaE1lbnUoKTsNCiAgICB9LA0KICAgIHVwZGF0ZU1lbnUoKSB7DQogICAgICBsZXQgbWVudUJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGJ1dHRvbiMke3ByZUFwcGVuZH1kcm9wTWVudUJ0bmApOw0KICAgICAgbGV0IG1lbnUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBkaXYjJHtwcmVBcHBlbmR9ZHJvcE1lbnVgKTsNCiAgICAgIGlmIChtZW51LnN0eWxlLmRpc3BsYXkgPT0gIm5vbmUiKSB7DQogICAgICAgIHRoaXMubWVudU9wZW4gPSB0cnVlOw0KICAgICAgICBtZW51QnV0dG9uLmlubmVySFRNTCA9ICJIaWRlIG1lbnUiOw0KICAgICAgICBtZW51LnN0eWxlLmRpc3BsYXkgPSAiIjsNCiAgICAgICAgd2hpbGUgKG1lbnUuaGFzQ2hpbGROb2RlcygpKSB7DQogICAgICAgICAgbWVudS5maXJzdENoaWxkLnJlbW92ZSgpOw0KICAgICAgICB9DQogICAgICAgIG1lbnUuYXBwZW5kQ2hpbGQodGhpcy5nZXRVbCgpKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMubWVudU9wZW4gPSBmYWxzZTsNCiAgICAgICAgbWVudUJ1dHRvbi5pbm5lckhUTUwgPSAiU2hvdyBtZW51IjsNCiAgICAgICAgbWVudS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgICAgfQ0KICAgIH0sDQogIH07DQogIFRXdW5sb2NrZWQuZHJvcE1hbmFnZXIuZWxlbS5pZCA9ICJUV3VubG9ja2VkLWRyb3BNYW5hZ2VyIjsNCiAgVFd1bmxvY2tlZC5kcm9wTWFuYWdlci5lbGVtLmlubmVySFRNTCA9IGA8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuZHJvcE1hbmFnZXIuY2xvc2UoKSI+QmFjazwvYnV0dG9uPjxocj4NCiAgPGgzPkFkZCBhIGN1c3RvbSBiYWNrZHJvcCBpbWFnZTo8L2gzPg0KICA8bGFiZWw+SW1hZ2UgbmFtZTogPGlucHV0IGlkPSIke3ByZUFwcGVuZH1kcm9waU5hbWUiLz48YnI+PC9sYWJlbD4NCiAgPGxhYmVsPkltYWdlIHVybDogPGlucHV0IGlkPSIke3ByZUFwcGVuZH1kcm9waVVybCIvPjxicj48L2xhYmVsPg0KICA8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuZHJvcE1hbmFnZXIuYWRkKCkiPkFkZDwvYnV0dG9uPjxocj4NCiAgPHNwYW4+Q3VzdG9tIGltYWdlczogPGRpdiBpZD0iJHtwcmVBcHBlbmR9ZHJvcE1lbnUiIHN0eWxlPSJkaXNwbGF5Om5vbmU7Ij48L2Rpdj4NCiAgPGJ1dHRvbiBpZD0iJHtwcmVBcHBlbmR9ZHJvcE1lbnVCdG4iIG9uY2xpY2s9IlRXdW5sb2NrZWQuZHJvcE1hbmFnZXIudXBkYXRlTWVudSgpIj5TaG93IG1lbnU8L2J1dHRvbj48YnI+PC9zcGFuPmA7DQogIFRXdW5sb2NrZWQuZHJvcE1hbmFnZXIuZWxlbS5jbGFzc0xpc3QuYWRkKCJUV3VubG9ja2VkTW9kYWwiKTsNCiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLmVsZW0pOw0KICAvL0Nvc3R1bWUgbGlicmFyeSBhZGRlciBtb2RhbA0KICBUV3VubG9ja2VkLmNvc01hbmFnZXIgPSB7DQogICAgbWVudU9wZW46IGZhbHNlLA0KICAgIGVsZW06IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpYWxvZyIpLA0KICAgIGxzSWQ6ICJ0d3U6Y3VzdG9tSW1hZ2VzIiwNCiAgICBwb3AoKSB7DQogICAgICB0aGlzLmVsZW0ucmVtb3ZlKCk7DQogICAgfSwNCiAgICBjbG9zZSgpIHsNCiAgICAgIHRoaXMuZWxlbS5jbG9zZSgpOw0KICAgICAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLnNob3dNb2RhbCgpOw0KICAgIH0sDQogICAgc2hvdygpIHsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5jbG9zZSgpOw0KICAgICAgdGhpcy5lbGVtLnNob3dNb2RhbCgpOw0KICAgIH0sDQogICAgcmVmcmVzaE1lbnUoKSB7DQogICAgICBjb25zdCBtZW51QnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgYnV0dG9uIyR7cHJlQXBwZW5kfWNvc01lbnVCdG5gKTsNCiAgICAgIGlmIChUV3VubG9ja2VkLmNvc01hbmFnZXIuZWxlbS5vcGVuICYmIHRoaXMubWVudU9wZW4pIHsNCiAgICAgICAgbWVudUJ0bi5jbGljaygpOw0KICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsNCiAgICAgICAgICBtZW51QnRuLmNsaWNrKCk7DQogICAgICAgIH0sIDEwMCk7DQogICAgICB9DQogICAgfSwNCiAgICBhZGQoKSB7DQogICAgICBsZXQgaU5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBpbnB1dCMke3ByZUFwcGVuZH1jb3NpTmFtZWApOw0KICAgICAgbGV0IGlVcmwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBpbnB1dCMke3ByZUFwcGVuZH1jb3NpVXJsYCk7DQogICAgICB2YXIgdG1wID0gaU5hbWUudmFsdWU7DQogICAgICBpTmFtZS52YWx1ZSA9ICIiOw0KICAgICAgaU5hbWUgPSB0bXA7DQogICAgICB0bXAgPSBpVXJsLnZhbHVlOw0KICAgICAgaVVybC52YWx1ZSA9ICIiOw0KICAgICAgaVVybCA9IHRtcDsNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc0lkKSk7DQogICAgICBmb3VuZC5wdXNoKHsgbmFtZTogaU5hbWUsIHVybDogaVVybCB9KTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNJZCwgSlNPTi5zdHJpbmdpZnkoZm91bmQpKTsNCiAgICAgIHRoaXMucmVmcmVzaE1lbnUoKTsNCiAgICB9LA0KICAgIGdldFVsKCkgew0KICAgICAgbGV0IGl0ZW1zID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidWwiKTsNCiAgICAgIGlmICghbG9jYWxTdG9yYWdlLmhhc093blByb3BlcnR5KHRoaXMubHNJZCkpDQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNJZCwgSlNPTi5zdHJpbmdpZnkoW10pKTsNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc0lkKSk7DQogICAgICBjb25zdCBub0l0ZW1zID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOw0KICAgICAgbm9JdGVtcy5pbm5lckhUTUwgPSAiJm5ic3A7Jm5ic3A7Tm8gY29zdHVtZXMgZm91bmQsIHRyeSBhZGRpbmcgc29tZSEiOw0KICAgICAgaWYgKGZvdW5kLmxlbmd0aCA9PSAwKSByZXR1cm4gbm9JdGVtczsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZm91bmQubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgbGV0IGNvcyA9IGZvdW5kW2ldOw0KICAgICAgICB2YXIgdG1wMiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7DQogICAgICAgIHRtcDIuaW5uZXJIVE1MID0gYCR7Y29zLm5hbWV9Jm5ic3A7Jm5ic3A7PGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmNvc01hbmFnZXIucG9wSXRlbSgke2l9KSI+UmVtb3ZlPC9idXR0b24+YDsNCiAgICAgICAgaXRlbXMuYXBwZW5kQ2hpbGQodG1wMik7DQogICAgICB9DQogICAgICByZXR1cm4gaXRlbXM7DQogICAgfSwNCiAgICBwb3BJdGVtKG51bSkgew0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzSWQpKTsNCiAgICAgIGZvdW5kLnBvcChudW0pOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc0lkLCBKU09OLnN0cmluZ2lmeShmb3VuZCkpOw0KICAgICAgdGhpcy5yZWZyZXNoTWVudSgpOw0KICAgIH0sDQogICAgdXBkYXRlTWVudSgpIHsNCiAgICAgIGxldCBtZW51QnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgYnV0dG9uIyR7cHJlQXBwZW5kfWNvc01lbnVCdG5gKTsNCiAgICAgIGxldCBtZW51ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgZGl2IyR7cHJlQXBwZW5kfWNvc01lbnVgKTsNCiAgICAgIGlmIChtZW51LnN0eWxlLmRpc3BsYXkgPT0gIm5vbmUiKSB7DQogICAgICAgIHRoaXMubWVudU9wZW4gPSB0cnVlOw0KICAgICAgICBtZW51QnV0dG9uLmlubmVySFRNTCA9ICJIaWRlIG1lbnUiOw0KICAgICAgICBtZW51LnN0eWxlLmRpc3BsYXkgPSAiIjsNCiAgICAgICAgd2hpbGUgKG1lbnUuaGFzQ2hpbGROb2RlcygpKSB7DQogICAgICAgICAgbWVudS5maXJzdENoaWxkLnJlbW92ZSgpOw0KICAgICAgICB9DQogICAgICAgIG1lbnUuYXBwZW5kQ2hpbGQodGhpcy5nZXRVbCgpKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMubWVudU9wZW4gPSBmYWxzZTsNCiAgICAgICAgbWVudUJ1dHRvbi5pbm5lckhUTUwgPSAiU2hvdyBtZW51IjsNCiAgICAgICAgbWVudS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgICAgfQ0KICAgIH0sDQogIH07DQogIFRXdW5sb2NrZWQuY29zTWFuYWdlci5lbGVtLmlkID0gIlRXdW5sb2NrZWQtY29zTWFuYWdlciI7DQogIFRXdW5sb2NrZWQuY29zTWFuYWdlci5lbGVtLmlubmVySFRNTCA9IGA8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuY29zTWFuYWdlci5jbG9zZSgpIj5CYWNrPC9idXR0b24+PGhyPg0KPGgzPkFkZCBhIGN1c3RvbSBzcHJpdGUgLyBjb3N0dW1lIGltYWdlOjwvaDM+DQo8bGFiZWw+SW1hZ2UgbmFtZTogPGlucHV0IGlkPSIke3ByZUFwcGVuZH1jb3NpTmFtZSIvPjxicj48L2xhYmVsPg0KPGxhYmVsPkltYWdlIHVybDogPGlucHV0IGlkPSIke3ByZUFwcGVuZH1jb3NpVXJsIi8+PGJyPjwvbGFiZWw+DQo8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuY29zTWFuYWdlci5hZGQoKSI+QWRkPC9idXR0b24+PGhyPg0KPHNwYW4+Q3VzdG9tIGltYWdlczogPGRpdiBpZD0iJHtwcmVBcHBlbmR9Y29zTWVudSIgc3R5bGU9ImRpc3BsYXk6bm9uZTsiPjwvZGl2Pg0KPGJ1dHRvbiBpZD0iJHtwcmVBcHBlbmR9Y29zTWVudUJ0biIgb25jbGljaz0iVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLnVwZGF0ZU1lbnUoKSI+U2hvdyBtZW51PC9idXR0b24+PGJyPjwvc3Bhbj5gOw0KICBUV3VubG9ja2VkLmNvc01hbmFnZXIuZWxlbS5jbGFzc0xpc3QuYWRkKCJUV3VubG9ja2VkTW9kYWwiKTsNCiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChUV3VubG9ja2VkLmNvc01hbmFnZXIuZWxlbSk7DQogIC8vZXh0ZW5zaW9uIGxpYnJhcnkgYWRkZXIgbW9kYWwNCiAgVFd1bmxvY2tlZC5leHRNYW5hZ2VyID0gew0KICAgIG1lbnVPcGVuOiBmYWxzZSwNCiAgICBlbGVtOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaWFsb2ciKSwNCiAgICBsc0lkOiAidHd1OmN1c3RvbUV4dGVuc2lvbnMiLA0KICAgIGxzU0lkOiAidHd1OmN1c3RvbUV4dGVuc2lvbnNTZXR0aW5ncyIsDQogICAgcG9wKCkgew0KICAgICAgdGhpcy5lbGVtLnJlbW92ZSgpOw0KICAgIH0sDQogICAgY2xvc2UoKSB7DQogICAgICB0aGlzLmVsZW0uY2xvc2UoKTsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5zaG93TW9kYWwoKTsNCiAgICB9LA0KICAgIHNob3coKSB7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uY2xvc2UoKTsNCiAgICAgIHRoaXMuZWxlbS5zaG93TW9kYWwoKTsNCiAgICB9LA0KICAgIHJlZnJlc2hNZW51KCkgew0KICAgICAgY29uc3QgbWVudUJ0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGJ1dHRvbiMke3ByZUFwcGVuZH1leHRNZW51QnRuYCk7DQogICAgICBpZiAoVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmVsZW0ub3BlbiAmJiB0aGlzLm1lbnVPcGVuKSB7DQogICAgICAgIG1lbnVCdG4uY2xpY2soKTsNCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7DQogICAgICAgICAgbWVudUJ0bi5jbGljaygpOw0KICAgICAgICB9LCAxMDApOw0KICAgICAgfQ0KICAgIH0sDQogICAgYWRkKCkgew0KICAgICAgbGV0IGlOYW1lID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgaW5wdXQjJHtwcmVBcHBlbmR9ZXh0aU5hbWVgKTsNCiAgICAgIGxldCBpVXJsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgaW5wdXQjJHtwcmVBcHBlbmR9ZXh0aVVybGApOw0KICAgICAgbGV0IGFVcmwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBpbnB1dCMke3ByZUFwcGVuZH1leHRhVXJsYCk7DQogICAgICBsZXQgYlVybCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHRleHRhcmVhIyR7cHJlQXBwZW5kfWV4dGJVcmxgKTsNCiAgICAgIHZhciB0bXAgPSBpTmFtZS52YWx1ZTsNCiAgICAgIGlOYW1lLnZhbHVlID0gIiI7DQogICAgICBpTmFtZSA9IHRtcDsNCiAgICAgIHRtcCA9IGlVcmwudmFsdWU7DQogICAgICBpVXJsLnZhbHVlID0gIiI7DQogICAgICBpVXJsID0gdG1wOw0KICAgICAgdG1wID0gYVVybC52YWx1ZTsNCiAgICAgIGFVcmwudmFsdWUgPSAiIjsNCiAgICAgIGFVcmwgPSB0bXA7DQogICAgICB0bXAgPSBiVXJsLnZhbHVlOw0KICAgICAgYlVybC52YWx1ZSA9ICIiOw0KICAgICAgYlVybCA9IHRtcDsNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc0lkKSk7DQogICAgICBmb3VuZC5wdXNoKHsgbmFtZTogaU5hbWUsIHVybDogaVVybCwgaW1hZ2VfdXJsOiBhVXJsLCBkZXNjcmlwdGlvbjogYlVybCB9KTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNJZCwgSlNPTi5zdHJpbmdpZnkoZm91bmQpKTsNCiAgICAgIHRoaXMucmVmcmVzaE1lbnUoKTsNCiAgICB9LA0KICAgIGdldFVsKCkgew0KICAgICAgbGV0IGl0ZW1zID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidWwiKTsNCiAgICAgIGlmICghbG9jYWxTdG9yYWdlLmhhc093blByb3BlcnR5KHRoaXMubHNJZCkpDQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNJZCwgSlNPTi5zdHJpbmdpZnkoW10pKTsNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc0lkKSk7DQogICAgICBjb25zdCBub0l0ZW1zID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOw0KICAgICAgbm9JdGVtcy5pbm5lckhUTUwgPSAiJm5ic3A7Jm5ic3A7Tm8gZXh0ZW5zaW9ucyBmb3VuZCwgdHJ5IGFkZGluZyBzb21lISI7DQogICAgICBpZiAoZm91bmQubGVuZ3RoID09IDApIHJldHVybiBub0l0ZW1zOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmb3VuZC5sZW5ndGg7IGkrKykgew0KICAgICAgICBsZXQgZXh0ID0gZm91bmRbaV07DQogICAgICAgIHZhciB0bXAyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsNCiAgICAgICAgdG1wMi5pbm5lckhUTUwgPSBgJHtleHQubmFtZX0mbmJzcDsmbmJzcDs8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuZXh0TWFuYWdlci5wb3BJdGVtKCR7aX0pIj5SZW1vdmU8L2J1dHRvbj5gOw0KICAgICAgICBpdGVtcy5hcHBlbmRDaGlsZCh0bXAyKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBpdGVtczsNCiAgICB9LA0KICAgIHBvcEl0ZW0obnVtKSB7DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNJZCkpOw0KICAgICAgZm91bmQucG9wKG51bSk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzSWQsIEpTT04uc3RyaW5naWZ5KGZvdW5kKSk7DQogICAgICB0aGlzLnJlZnJlc2hNZW51KCk7DQogICAgfSwNCiAgICB1cGRhdGVNZW51KCkgew0KICAgICAgbGV0IG1lbnVCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBidXR0b24jJHtwcmVBcHBlbmR9ZXh0TWVudUJ0bmApOw0KICAgICAgbGV0IG1lbnUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBkaXYjJHtwcmVBcHBlbmR9ZXh0TWVudWApOw0KICAgICAgaWYgKG1lbnUuc3R5bGUuZGlzcGxheSA9PSAibm9uZSIpIHsNCiAgICAgICAgdGhpcy5tZW51T3BlbiA9IHRydWU7DQogICAgICAgIG1lbnVCdXR0b24uaW5uZXJIVE1MID0gIkhpZGUgbWVudSI7DQogICAgICAgIG1lbnUuc3R5bGUuZGlzcGxheSA9ICIiOw0KICAgICAgICB3aGlsZSAobWVudS5oYXNDaGlsZE5vZGVzKCkpIHsNCiAgICAgICAgICBtZW51LmZpcnN0Q2hpbGQucmVtb3ZlKCk7DQogICAgICAgIH0NCiAgICAgICAgbWVudS5hcHBlbmRDaGlsZCh0aGlzLmdldFVsKCkpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy5tZW51T3BlbiA9IGZhbHNlOw0KICAgICAgICBtZW51QnV0dG9uLmlubmVySFRNTCA9ICJTaG93IG1lbnUiOw0KICAgICAgICBtZW51LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgICB9DQogICAgfSwNCiAgICBnZXRNYXJrcygpIHsNCiAgICAgIGxldCBmb3VuZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNTSWQpOw0KICAgICAgaWYgKGZvdW5kID09IHVuZGVmaW5lZCB8fCBmb3VuZCA9PSBudWxsIHx8IGZvdW5kID09ICd1bmRlZmluZWQnKSBmb3VuZCA9IHsNCiAgICAgICAgbXlHYWxsZXJ5OiBmYWxzZSwNCiAgICAgICAgc3BHYWxsZXJ5OiBmYWxzZQ0KICAgICAgfQ0KICAgICAgaWYgKHR5cGVvZiBmb3VuZCAhPT0gJ29iamVjdCcpIGZvdW5kID0gSlNPTi5wYXJzZShmb3VuZCk7DQogICAgICBpZiAoIWZvdW5kLmhhc093blByb3BlcnR5KCdteUdhbGxlcnknKSkgZm91bmQubXlHYWxsZXJ5ID0gZmFsc2U7DQogICAgICBpZiAoIWZvdW5kLmhhc093blByb3BlcnR5KCdzcEdhbGxlcnknKSkgZm91bmQuc3BHYWxsZXJ5ID0gZmFsc2U7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzU0lkLCBKU09OLnN0cmluZ2lmeShmb3VuZCkpOw0KICAgICAgcmV0dXJuIGZvdW5kOw0KICAgIH0sDQogICAgdXBkYXRlQ2hlY2ttYXJrcygpIHsNCiAgICAgIGxldCBmb3VuZCA9IHRoaXMuZ2V0TWFya3MoKTsNCiAgICAgIGZvdW5kLm15R2FsbGVyeSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGlucHV0IyR7cHJlQXBwZW5kfWV4dGdMb2FkTWluZWApLmNoZWNrZWQ7DQogICAgICBmb3VuZC5zcEdhbGxlcnkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBpbnB1dCMke3ByZUFwcGVuZH1leHRnTG9hZFNQYCkuY2hlY2tlZDsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNTSWQsIEpTT04uc3RyaW5naWZ5KGZvdW5kKSk7DQogICAgfSwNCiAgICBnZXRDaGVjayhjaGVjaykgew0KICAgICAgbGV0IGZvdW5kID0gdGhpcy5nZXRNYXJrcygpOw0KICAgICAgcmV0dXJuIGZvdW5kW2NoZWNrXTsNCiAgICB9LA0KICB9Ow0KICBUV3VubG9ja2VkLmV4dE1hbmFnZXIuZWxlbS5pZCA9ICJUV3VubG9ja2VkLWV4dE1hbmFnZXIiOw0KICBUV3VubG9ja2VkLmV4dE1hbmFnZXIuZWxlbS5pbm5lckhUTUwgPSBgPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmV4dE1hbmFnZXIuY2xvc2UoKSI+QmFjazwvYnV0dG9uPjxocj4NCjxoMz5BZGQgYSBjdXN0b20gZXh0ZW5zaW9uPC9oMz4NCjxsYWJlbD5FeHRlbnNpb24gbmFtZTogPGlucHV0IGlkPSIke3ByZUFwcGVuZH1leHRpTmFtZSIvPjxicj48L2xhYmVsPg0KPGxhYmVsPkV4dGVuc2lvbiB1cmw6IDxpbnB1dCBpZD0iJHtwcmVBcHBlbmR9ZXh0aVVybCIvPjxicj48L2xhYmVsPg0KPGxhYmVsPkV4dGVuc2lvbiBpbWFnZSB1cmw6IDxpbnB1dCBpZD0iJHtwcmVBcHBlbmR9ZXh0YVVybCIvPjxicj48L2xhYmVsPg0KPGxhYmVsPkV4dGVuc2lvbiBkZXNjcmlwdGlvbjogPHRleHRhcmVhIGlkPSIke3ByZUFwcGVuZH1leHRiVXJsIj48L3RleHRhcmVhPjxicj48L2xhYmVsPg0KPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmV4dE1hbmFnZXIuYWRkKCkiPkFkZDwvYnV0dG9uPjxocj4NCjxzcGFuPkN1c3RvbSBleHRlbnNpb25zOiA8ZGl2IGlkPSIke3ByZUFwcGVuZH1leHRNZW51IiBzdHlsZT0iZGlzcGxheTpub25lOyI+PC9kaXY+DQo8YnV0dG9uIGlkPSIke3ByZUFwcGVuZH1leHRNZW51QnRuIiBvbmNsaWNrPSJUV3VubG9ja2VkLmV4dE1hbmFnZXIudXBkYXRlTWVudSgpIj5TaG93IG1lbnU8L2J1dHRvbj48YnI+PC9zcGFuPg0KPGxhYmVsPmF1dG8gbG9hZCBmcm9tIDxhIGhyZWY9Imh0dHBzOi8vc3Vydi5pcy1hLmRldi91bnNhZmUtZXh0ZW5zaW9ucy8iPnVuc2FmZS1nYWxsZXJ5PC9hPjogPGlucHV0IGlkPSIke3ByZUFwcGVuZH1leHRnTG9hZE1pbmUiIHR5cGU9ImNoZWNrYm94IiR7KFRXdW5sb2NrZWQuZXh0TWFuYWdlci5nZXRDaGVjaygnbXlHYWxsZXJ5JykgPyAnIGNoZWNrZWQnIDogJycpfSBvbmNsaWNrPSJUV3VubG9ja2VkLmV4dE1hbmFnZXIudXBkYXRlQ2hlY2ttYXJrcygpIi8+PGJyPjwvbGFiZWw+DQo8bGFiZWw+YXV0byBsb2FkIGZyb20gPGEgaHJlZj0iaHR0cHM6Ly9zdXJ2LmlzLWEuZGV2L3Vuc2FmZS1leHRlbnNpb25zLyI+c2hhcmtwb29scyBnYWxsZXJ5PC9hPjogPGlucHV0IGlkPSIke3ByZUFwcGVuZH1leHRnTG9hZFNQIiB0eXBlPSJjaGVja2JveCIkeyhUV3VubG9ja2VkLmV4dE1hbmFnZXIuZ2V0Q2hlY2soJ3NwR2FsbGVyeScpID8gJyBjaGVja2VkJyA6ICcnKX0gb25jbGljaz0iVFd1bmxvY2tlZC5leHRNYW5hZ2VyLnVwZGF0ZUNoZWNrbWFya3MoKSIvPjxicj48L2xhYmVsPmA7DQogIFRXdW5sb2NrZWQuZXh0TWFuYWdlci5lbGVtLmNsYXNzTGlzdC5hZGQoIlRXdW5sb2NrZWRNb2RhbCIpOw0KICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKFRXdW5sb2NrZWQuZXh0TWFuYWdlci5lbGVtKTsNCiAgY29uc3QgbG9hZEV4dGVuc2lvbklucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocHJlQXBwZW5kICsgImxlIik7DQogIGNvbnN0IGxvYWRFeHRlbnNpb25fdW5zYW5kYm94ZWRDaGVjayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKA0KICAgIHByZUFwcGVuZCArICJsZUMiDQogICk7DQogIGNvbnN0IHNlY3VyaXR5TWFuYWdlclN3aXRjaEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHByZUFwcGVuZCArICJzTXMiKTsNCiAgc2VjdXJpdHlNYW5hZ2VyU3dpdGNoQnRuLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7DQogICAgaWYgKHRoaXMuaW5uZXJUZXh0ID09ICJEaXNhYmxlIikgew0KICAgICAgdGhpcy5pbm5lclRleHQgPSAiRW5hYmxlIjsNCiAgICAgIFRXdW5sb2NrZWQuZGlzYWJsZVBlcm1pc3Npb25TZWN1cml0eSgpOw0KICAgIH0gZWxzZSB7DQogICAgICB0aGlzLmlubmVyVGV4dCA9ICJEaXNhYmxlIjsNCiAgICAgIFRXdW5sb2NrZWQucmVzdG9yZVBlcm1pc3Npb25TZWN1cml0eSgpOw0KICAgIH0NCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5leHRNYW4gPSBmdW5jdGlvbiAoKSB7DQogICAgaWYgKGxvYWRFeHRlbnNpb25fdW5zYW5kYm94ZWRDaGVjay5jaGVja2VkKSB7DQogICAgICBUV3VubG9ja2VkLmxvYWRFeHRlbnNpb25VbnNhbmRib3hlZChsb2FkRXh0ZW5zaW9uSW5wdXQudmFsdWUpOw0KICAgIH0gZWxzZSB7DQogICAgICB2bS5ydW50aW1lLmV4dGVuc2lvbk1hbmFnZXIubG9hZEV4dGVuc2lvblVSTChsb2FkRXh0ZW5zaW9uSW5wdXQudmFsdWUpOw0KICAgIH0NCiAgfTsNCg0KICBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbiA9IHt9Ow0KICBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbi5kb250Rml4QnV0dG9uID0gVFd1bmxvY2tlZC5pc0Rlc2t0b3A7DQogIFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uLm9sZEhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOw0KICBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbi51cGRhdGUgPSBmdW5jdGlvbiAoKSB7DQogICAgaWYgKFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uLmRvbnRGaXhCdXR0b24pIHsNCiAgICAgIGNsZWFySW50ZXJ2YWwoVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24uYnRuSXZsKTsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uLmJ0bkl2bCA9ICJzdG9wcGVkIjsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uID0gIiI7DQogICAgICBkZWxldGUgVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b247DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGlmICgNCiAgICAgICFUV3VubG9ja2VkLmlzRGVza3RvcCAmJg0KICAgICAgKGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgIT0gVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24ub2xkSHJlZiB8fA0KICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiVFd1bmxvY2tlZC1OYXZCdG4iKSA9PSBudWxsKQ0KICAgICkgew0KICAgICAgVFd1bmxvY2tlZC5vcGVuQnV0dG9uLmFkZFNlbGZUb05hdigpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24uYnRuSXZsID0gc2V0SW50ZXJ2YWwoDQogICAgVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24udXBkYXRlLA0KICAgIDUwDQogICk7DQogIFRXdW5sb2NrZWQudXRpbHMudXBkYXRlVGljayA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYnV0dG9uW2NsYXNzXj0iZ3VpX2V4dGVuc2lvbi1idXR0b24iXScpKQ0KICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRCdG5BZGRMaXN0ZW4oKTsNCiAgICBsZXQgdG9vbGJveCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImRpdi5ibG9ja2x5VG9vbGJveERpdiIpOw0KICAgIGlmICh0b29sYm94ICYmIHRvb2xib3gub25jb250ZXh0bWVudSA9PSBudWxsKQ0KICAgICAgdG9vbGJveC5vbmNvbnRleHRtZW51ID0gdG9vbGJveE1lbnU7DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMudXBkYXRlSXZsID0gc2V0SW50ZXJ2YWwoVFd1bmxvY2tlZC51dGlscy51cGRhdGVUaWNrLCA1MCk7DQoNCiAgLy9VU00NCiAgVFd1bmxvY2tlZC5hdHRlbXB0UmVtb3ZhbE9mVVNNc2NyaXB0ID0gZnVuY3Rpb24gKCkgew0KICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJUV3VubG9ja2VkLVNjcmlwdC0iICsgVFd1bmxvY2tlZC50b3BMb2FkZXIpOw0KICB9Ow0KDQogIC8vQWRkIHRoZSBtb2RhbC4NCiAgVFd1bmxvY2tlZC5vcGVuQnV0dG9uID0gVFd1bmxvY2tlZC5hZGRNZW51QnRuKCJQTS1VbmxvY2tlZCIsIGZ1bmN0aW9uICgpIHsNCiAgICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uc2hvd01vZGFsKCk7DQogIH0pOw0KICBUV3VubG9ja2VkLm9wZW5CdXR0b24uc2V0SUQoIlRXdW5sb2NrZWQtTmF2QnRuIik7DQoNCiAgLy9Mb2FkIGV4dGVuc2lvbnMgb3V0IG9mIHVybA0KICBpZiAoVFd1bmxvY2tlZC51dGlscy5sb2FkVWV4dHNGcm9tVXJsKHRydWUpKSB7DQogICAgVFd1bmxvY2tlZC51dGlscy5sb2FkVXJpRXh0QnRuID0gVFd1bmxvY2tlZC5hZGRNZW51QnRuKA0KICAgICAgIkxvYWQgVVJMIGV4dGVuc2lvbnMiLA0KICAgICAgZnVuY3Rpb24gKCkgew0KICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmxvYWRVZXh0c0Zyb21VcmwoZmFsc2UpOw0KICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmxvYWRVcmlFeHRCdG4ucmVtb3ZlKCk7DQogICAgICB9DQogICAgKTsNCiAgfQ0KDQogIGNvbnNvbGUubG9nKA0KICAgIGBQTS1VbmxvY2tlZCB2JHtWRVJTSU9OfSB8IExvYWRlZCFcbklmIHRoaXMgaXMgYSBjdXN0b20gImVkaXRvciIgYW5kIHlvdSB3YW50IGl0IHJlbW92ZWQgcnVuIFRXdW5sb2NrZWQucmVtb3ZlQ3VycmVudEhvc3RuYW1lRnJvbUFsbG93ZWQoKWANCiAgKTsNCn07DQpJbXBvcnRUV3VubG9jayh0cnVlLCB3aW5kb3cudm0pOw0K`;

    GM_xmlhttpRequest({
        method: "GET",
        url: scriptURL,
        onload: function(response) {
            unsafeWindow.eval(response.responseText);
        }
    });

    return;
})();
