// ==UserScript==
// @name PM-Unlocked
// @namespace https://github.com/SurvExe1Pc/userscripts
// @description Adds some useful functions to PenguinMod that are disabled due to security issues.
// @version v1.9
// @icon https://penguinmod.com/favicon.ico
// @match *://*/*
// @grant unsafeWindow
// @grant GM_xmlhttpRequest
// @sandbox raw
// @run-at document-end
// ==/UserScript==
// Made By SurvExE1Pc.
// Modified by JoseErnestoOnGithub
(function(){
    //Support for other loaders and the console
    let unsafeWindow = /*UnsafeWindow object*/(function(){ try { unsafeWindow; return unsafeWindow} catch { return window }; })();
    let GM = /*GM Object*/(function(){ try { GM; return(GM) } catch { return {info:{scriptHandler:"None"}} }; })();

    //Tampermonkey functions, since these don't exist in GreaseMonkey I am manually implementing these.
    let GM_log = /*Log function*/(function(){ try { GM_log; return(GM_log) } catch { return function(...args){
        console.log(...args);
    } }; })();
    let GM_addElement = /*Add elm function*/(function(){ try { GM_addElement; return(GM_addElement) } catch { return function(element_type, attributes){
        const element = unsafeWindow.document.createElement(element_type);
        let attr_names = Object.keys(attributes);
        let attr_values = Object.values(attributes);
        for (let attr_idx in attr_names) {
            element[attr_names[attr_idx]] = attr_values[attr_idx];
        };
        unsafeWindow.document.body.appendChild(element);
    } }; })();

    //Main code
    let scriptURL = `data:text/javascript;base64,Ly8gPT1Vc2VyU2NyaXB0PT0NCi8vIEBuYW1lIFBNLVVubG9ja2VkIGNvbnNvbGUgY29tcG9uZW50DQovLyBAbmFtZXNwYWNlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdXJ2RXhlMVBjL3VzZXJzY3JpcHRzDQovLyBAZGVzY3JpcHRpb24gVEhJUyBXSUxMIE5PVCBXT1JLIEFTIFlPVSBBUkUgVVNJTkcgVEhFIENPTlNPTEUgVkVSU0lPTg0KLy8gQHZlcnNpb24gdjEuMC4wDQovLyBAaWNvbiBodHRwczovL3R1cmJvd2FycC5vcmcvZmF2aWNvbi5pY28NCi8vIEBtYXRjaCAqOi8vdHVyYm93YXJwLm9yZy8qDQovLyBAbWF0Y2ggKjovL3d3dy50dXJib3dhcnAub3JnLyoNCi8vIEBtYXRjaCAqOi8vc3R1ZGlvLnBlbmd1aW5tb2QuY29tLyoNCi8vIEBncmFudCAqDQovLyBAcnVuLWF0IGRvY3VtZW50LWVuZA0KLy8gPT0vVXNlclNjcmlwdD09DQovL1RoZSBhYm92ZSBpcyBmYWtlIGRhdGENCg0KLyohDQogKiAgPT1JTVBPUlQgVklBIEJPT0tNQVJLTEVUIE9SIENPTlNPTEU9PQ0KICogVFctVW5sb2NrZWQNCiAqIE90aGVyLXNjcmlwdHM6IGh0dHBzOi8vZ2l0aHViLmNvbS9TdXJ2RXhlMVBjL3VzZXJzY3JpcHRzDQogKiBBZGRzIHNvbWUgdXNlZnVsIGZ1bmN0aW9ucyB0byBQZW5ndWluTW9kIHRoYXQgYXJlIGRpc2FibGVkIGR1ZSB0byBzZWN1cml0eSBpc3N1ZXMuDQogKiB2ZXJzaW9uIGJlbG93DQogKiBNYWRlIEJ5IFN1cnZFeEUxUGMuDQogKi8NCg0KLyohIHRvZG86DQogKiAgICAgICAxLiBNYWtlIGl0IHNvIHRoYXQgdGhlIGltYWdlcyAvIHNvdW5kcyBoYXZlIGEgY3VzdG9tIHRhZyBhbmQgb25seSBzaG93IG9uIGl0IG9yIHRoZSBhbGwgdGFnDQogKiAgICAgICAgICAoc29tZSBjb2RlIGZvciBsYXRlciB0byBnZXQgdGhlIHNlbGVjdGVkIHRhZzogZG9jdW1lbnQucXVlcnlTZWxlY3RvcignZGl2W2NsYXNzXj0ibGlicmFyeV90YWctd3JhcHBlciJdIHNwYW5bY2xhc3MqPSJ0YWctYnV0dG9uX2FjdGl2ZSJdJykucXVlcnlTZWxlY3Rvcignc3BhbicpLmlubmVySFRNTCApDQogKiAgICAgICAyLiBTdXBwb3J0IGN1c3RvbSBzb3VuZHMNCiAqICAgICAgIChUZXN0aW5nIHRoZSAiVFd1bmxvY2tlZCB0aGlua3MgdGhpcyBpcyBhIFR1cmJvV2FycCBlZGl0b3IiIHBvcHVwLCB3aWxsIGJlIHJlbW92ZWQgaWYgbmVnYXRpdmUgZmVlZGJhY2spDQogKi8NCnZhciBJbXBvcnRUV3VubG9jayA9IGFzeW5jIGZ1bmN0aW9uIChkZWxvYWQsIHZtKSB7DQogIGNvbnN0IFZFUlNJT04gPSA1LjI7DQoNCiAgLy9EaXNhYmxlIHVzZXJzY3JpcHQuDQogIHZhciB0bXAgPSBudWxsOw0KICB0cnkgew0KICAgIHRtcCA9IEdNLmluZm8uc2NyaXB0SGFuZGxlcjsNCiAgfSBjYXRjaCB7fQ0KICBpZiAodG1wICE9IG51bGwpIGNvbnNvbGUubG9nKCJVU0UgVEhFIFVTRVJTQ1JJUFQgVkVSU0lPTiBOT1QgVEhFIENPTlNPTEUiKTsNCiAgaWYgKHRtcCAhPSBudWxsKSByZXR1cm47DQoNCiAgdmFyIHdpbiA9IHdpbmRvdzsNCg0KICBjb25zb2xlLmxvZygiTG9hZGVkIFRXLVVubG9ja2VkLiIpOw0KICBpZiAoZGVsb2FkKSB7DQogICAgZGVsZXRlIHdpbi5Mb2FkZWRUV3VubG9jazsNCiAgICB0cnkgew0KICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIlRXdW5sb2NrZWQtTW9kYWxEaXYiKS5yZW1vdmUoKTsNCiAgICB9IGNhdGNoIHt9DQogICAgdHJ5IHsNCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJUV3VubG9ja2VkLUdhbGxlcnlNb2RhbCIpLnJlbW92ZSgpOw0KICAgIH0gY2F0Y2gge30NCiAgICB0cnkgew0KICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIlRXdW5sb2NrZWQtY29zTWFuYWdlciIpLnJlbW92ZSgpOw0KICAgIH0gY2F0Y2gge30NCiAgICB0cnkgew0KICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIlRXdW5sb2NrZWQtZHJvcE1hbmFnZXIiKS5yZW1vdmUoKTsNCiAgICB9IGNhdGNoIHt9DQogICAgdHJ5IHsNCiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJUV3VubG9ja2VkLWV4dE1hbmFnZXIiKS5yZW1vdmUoKTsNCiAgICB9IGNhdGNoIHt9DQogICAgdHJ5IHsNCiAgICAgIFRXdW5sb2NrZWQuYXR0ZW1wdFJlbW92YWxPZlVTTXNjcmlwdCgpOw0KICAgIH0gY2F0Y2gge30NCiAgICB0cnkgew0KICAgICAgVFd1bmxvY2tlZC5vcGVuQnV0dG9uLnJlbW92ZSgpOw0KICAgIH0gY2F0Y2gge30NCiAgICB0cnkgew0KICAgICAgVFd1bmxvY2tlZC51dGlscy5sb2FkVXJpRXh0QnRuLnJlbW92ZSgpOw0KICAgIH0gY2F0Y2gge30NCiAgICBUV3VubG9ja2VkID0gIiI7DQogICAgZGVsZXRlIFRXdW5sb2NrZWQ7DQogIH0NCg0KICBpZiAod2luLkxvYWRlZFRXdW5sb2NrICE9IHVuZGVmaW5lZCkgew0KICAgIGFsZXJ0KCJQTS1VbmxvY2tlZDogU2NyaXB0IGhhcyBhbHJlYWR5IGJlZW4gbG9hZGVkIik7DQogICAgcmV0dXJuOw0KICB9DQoNCiAgd2luLkxvYWRlZFRXdW5sb2NrID0gdHJ1ZTsNCg0KICBpZiAod2luZG93LlRXVWV4dGVuc2lvblBhZ2UgPT0gdHJ1ZSkgew0KICAgIGNvbnN0IGdhbGxlcnkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJleHRlbnNpb24tYnV0dG9ucyIpOw0KDQogICAgZnVuY3Rpb24gVFd1T3ZlcnJpZGUoZWxtKSB7DQogICAgICB2YXIgZWxteCA9IGVsbS5jaGlsZHJlblsxXTsNCiAgICAgIGVsbXguaHJlZiA9IGVsbXguaHJlZi5yZXBsYWNlKCI/ZXh0ZW5zaW9uPSIsICI/dHd1LWV4dGVuc2lvbj0iKTsNCiAgICAgIGVsbXguc3R5bGUuZGlzcGxheSA9ICIiOw0KICAgIH0NCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdhbGxlcnkubGVuZ3RoOyBpKyspIHsNCiAgICAgIGNvbnN0IGVsbSA9IGdhbGxlcnkuaXRlbShpKTsNCiAgICAgIFRXdU92ZXJyaWRlKGVsbSk7DQogICAgfQ0KICAgIHJldHVybjsNCiAgfQ0KDQogIC8vZG8gc29tZXRoaW5nIHdpdGggdGhpcw0KICBmdW5jdGlvbiBhc3N1bWVUdXJib3dhcnAoKSB7DQogICAgdmFyIGFzc3VtcHRpb24gPSAwOw0KICAgIHRyeSB7DQogICAgICBSZWR1eFN0b3JlLmdldFN0YXRlKCkuc2NyYXRjaEd1aTsNCiAgICAgIGFzc3VtcHRpb24gKz0gMC41Ow0KICAgIH0gY2F0Y2gge30NCiAgICB0cnkgew0KICAgICAgdm0uZ3JlZW5GbGFnLnRvU3RyaW5nKCk7DQogICAgICBhc3N1bXB0aW9uICs9IDAuNTsNCiAgICB9IGNhdGNoIHt9DQogICAgcmV0dXJuIGFzc3VtcHRpb24gPT0gMTsNCiAgfQ0KDQogIC8vb2xkOiAhKG5ldyBSZWdFeHAoJygoaHR0cChzPylcOlwvXC8pPykodHVyYm93YXJwXC5vcmcpKChcLykoZWRpdG9yKT8pJywnZ2knKS5leGVjKGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpKQ0KICBsZXQgY3VzdG9tRG9tYWlucyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ0d3U6Y3VzdG9tRG9tYWlucyIpOw0KICBpZiAoY3VzdG9tRG9tYWlucykgew0KICAgIGN1c3RvbURvbWFpbnMgPSBKU09OLnBhcnNlKGN1c3RvbURvbWFpbnMpOw0KICB9IGVsc2Ugew0KICAgIGN1c3RvbURvbWFpbnMgPSBbXTsNCiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgidHd1OmN1c3RvbURvbWFpbnMiLCAiW10iKTsNCiAgfQ0KICBsZXQgX2lzRGVza3RvcCA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYuaW5jbHVkZXMoDQogICAgIlR1cmJvV2FycC9yZXNvdXJjZXMvYXBwLmFzYXIiDQogICk7DQogIC8qIQ0KICAgKiBSZWFzb25zOg0KICAgKiAgIEdhbmRpSURFOiAgIERhbmdlcm91cyBkYXRhIGNvbGxlY3Rpb24uDQogICAqICAgU2NyYXRjaDogICAgVGhpcyBqdXN0IHdvbnQgd29yay4NCiAgICovDQogIGlmICgNCiAgICBbDQogICAgICAiZ2V0Z2FuZGkuY29tIiwNCiAgICAgICJjb2NyZWEud29ybGQiLA0KICAgICAgInNjcmF0Y2gubWl0LmVkdSIsDQogICAgXS5pbmNsdWRlcyhkb2N1bWVudC5sb2NhdGlvbi5ob3N0bmFtZSkNCiAgKSB7DQogICAgY29uc29sZS5lcnJvcihgVFctVW5sb2NrZWQgdiR7VkVSU0lPTn0gfCBCbG9ja2VkIHBhZ2UuYCk7DQogICAgcmV0dXJuOw0KICB9DQogIGlmICgNCiAgICAhWw0KICAgICAgLi4uY3VzdG9tRG9tYWlucywNCiAgICAgICJ0dXJib3dhcnAub3JnIiwNCiAgICAgICJzdGFnaW5nLnR1cmJvd2FycC5vcmciLA0KICAgICAgInR3cGx1cy5wYWdlcy5kZXYiLA0KICAgICAgInN0dWRpby5wZW5ndWlubW9kLmNvbSIsDQogICAgXS5pbmNsdWRlcyhkb2N1bWVudC5sb2NhdGlvbi5ob3N0bmFtZSkgJiYNCiAgICAhX2lzRGVza3RvcA0KICApIHsNCiAgICBjb25zb2xlLmVycm9yKA0KICAgICAgYFBNLVVubG9ja2VkIHYke1ZFUlNJT059IHwgTm90IGEgdmFsaWQgcGFnZS5cbklmIHRoaXMgaXMgYSAiUGVuZ3Vpbk1vZCBlZGl0b3IiIHRoZW4gcnVuIFRXdW5sb2NrZWQuYWxsb3dDdXJyZW50SG9zdG5hbWUoKWANCiAgICApOw0KICAgIGlmIChhc3N1bWVUdXJib3dhcnAoKSkgew0KICAgICAgdmFyIGFzc3VtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGlhbG9nIik7DQogICAgICBhc3N1bS5pbm5lckhUTUwgPQ0KICAgICAgICAnPHN0eWxlPmJ1dHRvbntiYWNrZ3JvdW5kLWNvbG9yOiNiYmJiYmJ9PC9zdHlsZT5QTXVubG9ja2VkIHRoaW5rcyB0aGlzIHBhZ2UgaXMgYSBQZW5ndWluTW9kIGVkaXRvci48YnI+PGJ1dHRvbiBvbmNsaWNrPSJ0aGlzLnBhcmVudEVsZW1lbnQucmVtb3ZlKCk7Ij5DbG9zZTwvYnV0dG9uPjxidXR0b24gb25jbGljaz0idGhpcy5wYXJlbnRFbGVtZW50LnJlbW92ZSgpO3RyeXtUV3VubG9ja2VkLmFsbG93Q3VycmVudEhvc3RuYW1lKCl9Y2F0Y2h7fSI+WWVzIGl0IGlzITwvYnV0dG9uPic7DQogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGFzc3VtKTsNCiAgICAgIGFzc3VtLnNob3coKTsNCiAgICAgIGFzc3VtLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsNCiAgICAgIGFzc3VtLnN0eWxlLnpJbmRleCA9IDMyNzY3Ow0KICAgICAgYXNzdW0uc3R5bGUubGVmdCA9DQogICAgICAgIHdpbmRvdy5pbm5lcldpZHRoIC0gYXNzdW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggKiAyICsgInB4IjsNCiAgICB9DQogICAgd2luZG93LlRXdW5sb2NrZWQgPSB7DQogICAgICBhbGxvd0N1cnJlbnRIb3N0bmFtZSgpIHsNCiAgICAgICAgY3VzdG9tRG9tYWlucyA9IEpTT04ucGFyc2UoY3VzdG9tRG9tYWlucyk7DQogICAgICAgIGN1c3RvbURvbWFpbnMucHVzaChkb2N1bWVudC5sb2NhdGlvbi5ob3N0bmFtZSk7DQogICAgICAgIGN1c3RvbURvbWFpbnMgPSBKU09OLnN0cmluZ2lmeShjdXN0b21Eb21haW5zKTsNCiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oInR3dTpjdXN0b21Eb21haW5zIiwgY3VzdG9tRG9tYWlucyk7DQogICAgICAgIGNvbnNvbGUubG9nKCJQbGVhc2UgcmVmcmVzaCB0aGUgcGFnZSBmb3IgdGhpcyB0byB0YWtlIGVmZmVjdC4iKTsNCiAgICAgIH0sDQogICAgICBWRVJTSU9OLA0KICAgIH07DQogICAgcmV0dXJuOw0KICB9DQoNCiAgY29uc29sZS5sb2coYFBNLVVubG9ja2VkIHYke1ZFUlNJT059IHwgTG9hZGluZy4uYCk7DQoNCiAgd2luZG93LlRXdW5sb2NrZWQgPSB7DQogICAgcmVtb3ZlQ3VycmVudEhvc3RuYW1lRnJvbUFsbG93ZWQoKSB7DQogICAgICBsZXQgaG9zdCA9IGRvY3VtZW50LmxvY2F0aW9uLmhvc3RuYW1lOw0KICAgICAgaWYgKCFjdXN0b21Eb21haW5zLmluY2x1ZGVzKGhvc3QpKSB7DQogICAgICAgIGNvbnNvbGUubG9nKCdUaGlzIHBhZ2UgaXMgbm90IGEgImN1c3RvbSB0dXJib3dhcnAgZWRpdG9yIi4nKTsNCiAgICAgIH0NCiAgICAgIGN1c3RvbURvbWFpbnMgPSBKU09OLnBhcnNlKGN1c3RvbURvbWFpbnMpOw0KICAgICAgY3VzdG9tRG9tYWlucy5wb3AoY3VzdG9tRG9tYWlucy5pbmRleE9mKGhvc3QpKTsNCiAgICAgIGN1c3RvbURvbWFpbnMgPSBKU09OLnN0cmluZ2lmeShjdXN0b21Eb21haW5zKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ0d3U6Y3VzdG9tRG9tYWlucyIsIGN1c3RvbURvbWFpbnMpOw0KICAgICAgY29uc29sZS5sb2coIlBsZWFzZSByZWZyZXNoIHRoZSBwYWdlIGZvciB0aGlzIHRvIHRha2UgZWZmZWN0LiIpOw0KICAgIH0sDQogICAgVkVSU0lPTiwNCiAgfTsNCiAgVFd1bmxvY2tlZC5pc0Rlc2t0b3AgPSBfaXNEZXNrdG9wOw0KICBUV3VubG9ja2VkLnV0aWxzID0ge307DQoNCiAgLy9VdGlsaXRpZXMNCiAgVFd1bmxvY2tlZC51dGlscy5pZEdlbiA9IGZ1bmN0aW9uKiBpZEdlbmVyYXRvcigpIHsNCiAgICBsZXQgaW5kZXggPSAwOw0KICAgIHdoaWxlICh0cnVlKSB7DQogICAgICBpbmRleCArPSAxOw0KICAgICAgeWllbGQgaW5kZXg7DQogICAgfQ0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLnNldENvb2tpZSA9IGZ1bmN0aW9uIChjbmFtZSwgY3ZhbHVlLCBleGRheXMpIHsNCiAgICBjb25zdCBkID0gbmV3IERhdGUoKTsNCiAgICBkLnNldFRpbWUoZC5nZXRUaW1lKCkgKyBleGRheXMgKiAyNCAqIDYwICogNjAgKiAxMDAwKTsNCiAgICBsZXQgZXhwaXJlcyA9ICJleHBpcmVzPSIgKyBkLnRvVVRDU3RyaW5nKCk7DQogICAgZG9jdW1lbnQuY29va2llID0gY25hbWUgKyAiPSIgKyBjdmFsdWUgKyAiOyIgKyBleHBpcmVzICsgIjtwYXRoPS8iOw0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLmdldENvb2tpZSA9IGZ1bmN0aW9uIChjbmFtZSkgew0KICAgIGxldCBuYW1lID0gY25hbWUgKyAiPSI7DQogICAgbGV0IGRlY29kZWRDb29raWUgPSBkZWNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQuY29va2llKTsNCiAgICBsZXQgY2EgPSBkZWNvZGVkQ29va2llLnNwbGl0KCI7Iik7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjYS5sZW5ndGg7IGkrKykgew0KICAgICAgbGV0IGMgPSBjYVtpXTsNCiAgICAgIHdoaWxlIChjLmNoYXJBdCgwKSA9PSAiICIpIHsNCiAgICAgICAgYyA9IGMuc3Vic3RyaW5nKDEpOw0KICAgICAgfQ0KICAgICAgaWYgKGMuaW5kZXhPZihuYW1lKSA9PSAwKSB7DQogICAgICAgIHJldHVybiBjLnN1YnN0cmluZyhuYW1lLmxlbmd0aCwgYy5sZW5ndGgpOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gIiI7DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMuYVRmID0gYXN5bmMgZnVuY3Rpb24gKCkgew0KICAgIHJldHVybiB0cnVlOw0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLm9TbVB2ID0gew0KICAgIGNmOiB2bS5zZWN1cml0eU1hbmFnZXIuY2FuRmV0Y2gsDQogICAgY2xlZnA6IHZtLnNlY3VyaXR5TWFuYWdlci5jYW5Mb2FkRXh0ZW5zaW9uRnJvbVByb2plY3QsDQogICAgY246IHZtLnNlY3VyaXR5TWFuYWdlci5jYW5Ob3RpZnksDQogICAgY293OiB2bS5zZWN1cml0eU1hbmFnZXIuY2FuT3BlbldpbmRvdywNCiAgICBjcmM6IHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWFkQ2xpcGJvYXJkLA0KICAgIGNyYTogdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlY29yZEF1ZGlvLA0KICAgIGNydjogdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlY29yZFZpZGVvLA0KICAgIGNyOiB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVkaXJlY3QsDQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpYWxvZyIpOw0KICBjb25zdCBmZXRjaEhvdmVyQ2xhc2VzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigNCiAgICAiW2NsYXNzXj1tZW51LWJhcl9tZW51LWJhci1pdGVtXSINCiAgKS5jbGFzc0xpc3Q7DQogIFRXdW5sb2NrZWQudXRpbHMuZmlsZUdyb3VwID0gVFd1bmxvY2tlZC5pc0Rlc2t0b3ANCiAgICA/ICdkaXZbY2xhc3NePSJtZW51LWJhcl9maWxlLWdyb3VwIl0nDQogICAgOiAnZGl2W2NsYXNzXj0ibWVudS1iYXJfZmlsZS1ncm91cCJdJzsNCiAgVFd1bmxvY2tlZC51dGlscy5ob3ZlcmFibGVDbGFzcyA9IGZldGNoSG92ZXJDbGFzZXNbMV07DQogIFRXdW5sb2NrZWQudXRpbHMubWVudUl0ZW1DbGFzcyA9IGZldGNoSG92ZXJDbGFzZXNbMF07DQogIFRXdW5sb2NrZWQudHdNZW51QnRuID0gY2xhc3Mgew0KICAgICNkb2NfZWxtOw0KICAgIGNvbnN0cnVjdG9yKCkgew0KICAgICAgY29uc3QgZW1wdHlfZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgICB0aGlzLiNkb2NfZWxtID0gZW1wdHlfZGl2Ow0KICAgICAgdGhpcy4jZG9jX2VsbS5jbGFzc0xpc3QuYWRkKFRXdW5sb2NrZWQudXRpbHMubWVudUl0ZW1DbGFzcyk7DQogICAgICB0aGlzLiNkb2NfZWxtLmNsYXNzTGlzdC5hZGQoVFd1bmxvY2tlZC51dGlscy5ob3ZlcmFibGVDbGFzcyk7DQogICAgICB0aGlzLiNkb2NfZWxtLmlubmVySFRNTCA9ICI8ZGl2PjxzcGFuPk5ldyBCdXR0b248L3NwYW4+PC9kaXY+IjsNCiAgICAgIHRoaXMuI2RvY19lbG0uYmFja3VwX3JlbW92ZSA9IHRoaXMuI2RvY19lbG0ucmVtb3ZlOw0KICAgICAgdGhpcy4jZG9jX2VsbS5yZW1vdmUgPSAoKSA9PiB7DQogICAgICAgIHJldHVybiAib3ZlcnJpZGRlbiwgbmV4dGltZSB1c2UgdGhlIHJlbW92ZSBmdW5jdGlvbiBpbiB0aGUgY2xhc3MuIjsNCiAgICAgIH07DQogICAgfQ0KICAgIHZpc2liaWxpdHkodXBkYXRlKSB7DQogICAgICBjb25zdCBjdXJyZW50RGlzcGxheSA9IHRoaXMuI2RvY19lbG0uc3R5bGUuZGlzcGxheTsNCiAgICAgIGNvbnN0IGlzRmxleCA9IGN1cnJlbnREaXNwbGF5ID09ICIiOw0KICAgICAgaWYgKHVwZGF0ZSA9PSAiZ2V0IikgcmV0dXJuIGlzRmxleDsNCiAgICAgIGlmICghdXBkYXRlKSB7DQogICAgICAgIHRoaXMuI2RvY19lbG0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgaWYgKHVwZGF0ZSkgew0KICAgICAgICB0aGlzLiNkb2NfZWxtLnN0eWxlLmRpc3BsYXkgPSAiIjsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgIH0NCiAgICByZW1vdmUoKSB7DQogICAgICB0aGlzLiNkb2NfZWxtLmJhY2t1cF9yZW1vdmUoKTsNCiAgICB9DQogICAgc2V0Q2xpY2tDYWxsYmFjayhjYWxsYmFjaykgew0KICAgICAgdGhpcy4jZG9jX2VsbS5vbmNsaWNrID0gY2FsbGJhY2s7DQogICAgfQ0KICAgIHNldFRleHQodGV4dCkgew0KICAgICAgdGhpcy4jZG9jX2VsbS5pbm5lclRleHQgPSB0ZXh0Ow0KICAgICAgdGhpcy4jZG9jX2VsbS5pbm5lckhUTUwgPSBgPGRpdj48c3Bhbj4kew0KICAgICAgICB0aGlzLiNkb2NfZWxtLmlubmVyVGV4dA0KICAgICAgfTwvc3Bhbj48L2Rpdj5gOw0KICAgIH0NCiAgICBleHBvcnRIVE1MKCkgew0KICAgICAgcmV0dXJuIHRoaXMuI2RvY19lbG0uaW5uZXJIVE1MOw0KICAgIH0NCiAgICBleHBvcnREb2NFbG0oKSB7DQogICAgICByZXR1cm4gdGhpcy4jZG9jX2VsbTsNCiAgICB9DQogICAgc2V0SUQoZWxtX2lkKSB7DQogICAgICB0aGlzLiNkb2NfZWxtLmlkID0gZWxtX2lkOw0KICAgIH0NCiAgICBhZGRTZWxmVG9OYXYoKSB7DQogICAgICBkb2N1bWVudA0KICAgICAgICAucXVlcnlTZWxlY3RvcihUV3VubG9ja2VkLnV0aWxzLmZpbGVHcm91cCkNCiAgICAgICAgLmFwcGVuZENoaWxkKHRoaXMuI2RvY19lbG0pOw0KICAgIH0NCiAgfTsNCiAgVFd1bmxvY2tlZC5hZGRNZW51QnRuID0gZnVuY3Rpb24gKGJ1dHRvbl90ZXh0LCBjYWxsYmFjaykgew0KICAgIHZhciBidXR0b24gPSBuZXcgdGhpcy50d01lbnVCdG4oKTsNCiAgICBidXR0b24uc2V0VGV4dChidXR0b25fdGV4dCk7DQogICAgYnV0dG9uLnNldENsaWNrQ2FsbGJhY2soY2FsbGJhY2spOw0KICAgIHZhciB0bXAgPSBidXR0b247DQogICAgYnV0dG9uID0gYnV0dG9uLmV4cG9ydERvY0VsbSgpOw0KICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoVFd1bmxvY2tlZC51dGlscy5maWxlR3JvdXApLmFwcGVuZENoaWxkKGJ1dHRvbik7DQogICAgcmV0dXJuIHRtcDsNCiAgfTsNCg0KICAvL0dldCBwcm9qZWN0IGRhdGENCiAgVFd1bmxvY2tlZC51dGlscy5nZXRQcm9qZWN0TWV0YWRhdGEgPSBhc3luYyAocHJvamVjdElkKSA9PiB7DQogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgNCiAgICAgIGBodHRwczovL3RyYW1wb2xpbmUudHVyYm93YXJwLm9yZy9hcGkvcHJvamVjdHMvJHtwcm9qZWN0SWR9YA0KICAgICk7DQogICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7DQogICAgICB0aHJvdyBuZXcgRXJyb3IoIlBNLVVubG9ja2VkOiBFcnJvciBmZXRjaGluZyBwcm9qZWN0OiBUaGUgcHJvamVjdCByZXF1ZXN0ZWQgaXMgdW5zaGFyZWQgb3IgZG9lcyBub3QgZXhpc3QuIik7DQogICAgfQ0KICAgIGlmICghcmVzcG9uc2Uub2spIHsNCiAgICAgIHRocm93IG5ldyBFcnJvcigNCiAgICAgICAgYFBNLVVubG9ja2VkOiBFcnJvciBmZXRjaGluZyBwcm9qZWN0OiBIVFRQIGVycm9yICR7cmVzcG9uc2Uuc3RhdHVzfSBmZXRjaGluZyBwcm9qZWN0IG1ldGFkYXRhYA0KICAgICAgKTsNCiAgICB9DQogICAgY29uc3QganNvbiA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsNCiAgICByZXR1cm4ganNvbjsNCiAgfTsNCiAgVFd1bmxvY2tlZC5nZXRQcm9qZWN0RGF0YSA9IGFzeW5jIChwcm9qZWN0SWQpID0+IHsNCiAgICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IFRXdW5sb2NrZWQudXRpbHMuZ2V0UHJvamVjdE1ldGFkYXRhKHByb2plY3RJZCk7DQogICAgY29uc3QgdG9rZW4gPSBtZXRhZGF0YS5wcm9qZWN0X3Rva2VuOw0KICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goDQogICAgICBgaHR0cHM6Ly9wcm9qZWN0cy5zY3JhdGNoLm1pdC5lZHUvJHtwcm9qZWN0SWR9P3Rva2VuPSR7dG9rZW59YA0KICAgICk7DQogICAgaWYgKCFyZXNwb25zZS5vaykgew0KICAgICAgdGhyb3cgbmV3IEVycm9yKGBQTS1VbmxvY2tlZDogRXJyb3IgZmV0Y2hpbmcgcHJvamVjdDogSFRUUCBlcnJvciAke3Jlc3BvbnNlLnN0YXR1c30gZmV0Y2hpbmcgcHJvamVjdCBkYXRhYCk7DQogICAgfQ0KICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpOw0KICAgIHJldHVybiBkYXRhOw0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLmRhdGVTdHJpbmdObyA9IGZ1bmN0aW9uICgpIHsNCiAgICByZXR1cm4gbmV3IERhdGUoKS50b0pTT04oKS5yZXBsYWNlKC8tfFwufHR8enw6L2dpLCAiIik7DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMucmFuZG9tID0ge307DQogIFRXdW5sb2NrZWQudXRpbHMucmFuZG9tLmZsb2F0ID0gZnVuY3Rpb24gKG1pbiwgbWF4KSB7DQogICAgcmV0dXJuIE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluKSArIG1pbjsNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5yYW5kb20uaW50ID0gZnVuY3Rpb24gKG1pbiwgbWF4KSB7DQogICAgcmV0dXJuIE1hdGgucm91bmQoVFd1bmxvY2tlZC51dGlscy5yYW5kb20uZmxvYXQpOw0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLmJpZ25vID0gZnVuY3Rpb24gKCkgew0KICAgIHJldHVybiBUV3VubG9ja2VkLnV0aWxzLnJhbmRvbS5pbnQoDQogICAgICBOdW1iZXIuTUlOX1NBRkVfSU5URUdFUiwNCiAgICAgIE51bWJlci5NQVhfU0FGRV9JTlRFR0VSDQogICAgKTsNCiAgfTsNCiAgVFd1bmxvY2tlZC51dGlscy5nZXRDYWNoZVBhcmFtcyA9IGZ1bmN0aW9uICh1cmwpIHsNCiAgICB2YXIgX3VybFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXModXJsKTsNCiAgICBfdXJsUGFyYW1zLmFwcGVuZCgiYnlwYXNzQ2FjaGUiLCAiIik7DQogICAgLy9DT1VOVEVSDQogICAgY29uc3Qgc3RvcmFnZUl0ZW0gPSAidHdVbmxvY2tlZC1jYWNoZUlkIjsNCiAgICBpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oc3RvcmFnZUl0ZW0pID09IG51bGwpDQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShzdG9yYWdlSXRlbSwgMSk7DQogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oDQogICAgICBzdG9yYWdlSXRlbSwNCiAgICAgIHBhcnNlRmxvYXQobG9jYWxTdG9yYWdlLmdldEl0ZW0oc3RvcmFnZUl0ZW0pKSArIDENCiAgICApOw0KICAgIF91cmxQYXJhbXMuYXBwZW5kKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHN0b3JhZ2VJdGVtKSwgIiIpOw0KICAgIC8vVElNRQ0KICAgIF91cmxQYXJhbXMuYXBwZW5kKFRXdW5sb2NrZWQudXRpbHMuZGF0ZVN0cmluZ05vKCksICIiKTsNCiAgICAvL1JldHVybmluZyB0aGUgcGFyYW1zDQogICAgcmV0dXJuICgiPyIgKyBfdXJsUGFyYW1zLnRvU3RyaW5nKCkpLnJlcGxhY2UoZW5jb2RlVVJJQ29tcG9uZW50KHVybCksICIiKTsNCiAgfTsNCg0KICBpZiAoIVRXdW5sb2NrZWQuaXNEZXNrdG9wKSB7DQogICAgY29uc3Qgc3R5bGluZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0eWxlIik7DQogICAgc3R5bGluZy5pbm5lckhUTUwgPSBgDQouVFd1bmxvY2tlZE1vZGFsIGJ1dHRvbiB7DQogIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMTA3LCAxMDcsIDEwNywgMSk7DQp9YDsNCiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxpbmcpOw0KICB9DQoNCiAgLy9Mb2FkIEV4dGVuc2lvbnMgVW5zYW5kYm94ZWQNCiAgdm0uZXh0ZW5zaW9uTWFuYWdlci5sb2FkVW5zYW5kYm94ZWRFeHRlbnNpb24gPSBmdW5jdGlvbiAodXJsKSB7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmdldFNhbmRib3hNb2RlID0gYXN5bmMgZnVuY3Rpb24gKCkgew0KICAgICAgcmV0dXJuICJ1bnNhbmRib3hlZCI7DQogICAgfTsNCiAgICB2bS5leHRlbnNpb25NYW5hZ2VyLmxvYWRFeHRlbnNpb25VUkwoDQogICAgICBgaHR0cHM6Ly9jb3JzcHJveHkuaW8vPyR7ZW5jb2RlVVJJQ29tcG9uZW50KHVybCl9YA0KICAgICk7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmdldFNhbmRib3hNb2RlID0gb2xkU2FuZGJveDsgLy8gUmV0dXJuIHRoZSBzYW5kYm94IHRvIG5vcm1hbC4NCiAgfTsNCiAgVFd1bmxvY2tlZC5sb2FkRXh0ZW5zaW9uVW5zYW5kYm94ZWQgPSBhc3luYyBmdW5jdGlvbiAodXJsLCBieXBhc3NDYWNoZSkgew0KICAgIGJ5cGFzc0NhY2hlID0gbmV3IEJvb2xlYW4oYnlwYXNzQ2FjaGUpIHx8IHRydWU7DQogICAgY29uc3Qgc2V0ID0gdm0uZXh0ZW5zaW9uTWFuYWdlci5sb2FkVW5zYW5kYm94ZWRFeHRlbnNpb24oDQogICAgICB1cmwgKyAoYnlwYXNzQ2FjaGUgPyBUV3VubG9ja2VkLnV0aWxzLmdldENhY2hlUGFyYW1zKHVybCkgOiAiIikNCiAgICApOw0KICAgIHJldHVybiBzZXQ7DQogIH07DQoNCiAgVFd1bmxvY2tlZC51dGlscy5sb2FkVWV4dHNGcm9tVXJsID0gZnVuY3Rpb24gKGhhc1BhcmFtKSB7DQogICAgaGFzUGFyYW0gPSBoYXNQYXJhbSB8fCAwOw0KICAgIGhhc1BhcmFtID0gaGFzUGFyYW0gPT0gMCA/IGZhbHNlIDogaGFzUGFyYW07DQoNCiAgICBmdW5jdGlvbiBnZXRQYXJhbXMocXVlcnkpIHsNCiAgICAgIHZhciB0bXAyID0gW107DQogICAgICB2YXIgdG1wMyA9IDA7DQogICAgICBxdWVyeS5mb3JFYWNoKCh2LCBrKSA9PiB7DQogICAgICAgIHRtcDMgKz0gMTsNCiAgICAgICAgaWYgKHRtcDMgPT0gMSkgew0KICAgICAgICAgIGsgPSBrLnJlcGxhY2UoZG9jdW1lbnQubG9jYXRpb24uaHJlZi5zcGxpdCgiPyIpWzBdICsgIj8iLCAiIik7DQogICAgICAgIH0NCiAgICAgICAgdG1wMi5wdXNoKHsNCiAgICAgICAgICBrZXk6IGssDQogICAgICAgICAgdmFsdWU6IHYsDQogICAgICAgIH0pOw0KICAgICAgfSk7DQogICAgICByZXR1cm4gdG1wMjsNCiAgICB9DQogICAgY29uc3QgcGFyYW1zID0gZ2V0UGFyYW1zKG5ldyBVUkxTZWFyY2hQYXJhbXMoZG9jdW1lbnQubG9jYXRpb24uaHJlZikpOw0KICAgIHZhciBmb3VuZFBhcmFtID0gZmFsc2U7DQogICAgcGFyYW1zLmZvckVhY2goZnVuY3Rpb24gKHBhcmFtKSB7DQogICAgICBpZiAocGFyYW0ua2V5ID09ICJ0d3UtZXh0ZW5zaW9uIikgew0KICAgICAgICBpZiAoaGFzUGFyYW0gfHwgZm91bmRQYXJhbSkgew0KICAgICAgICAgIGZvdW5kUGFyYW0gPSB0cnVlOw0KICAgICAgICAgIHJldHVybiBmb3VuZFBhcmFtOw0KICAgICAgICB9DQogICAgICAgIHZhciBleHRfbGluayA9IHBhcmFtLnZhbHVlOw0KICAgICAgICBpZiAodm0ucnVudGltZS5leHRlbnNpb25NYW5hZ2VyLl9pc1ZhbGlkRXh0ZW5zaW9uVVJMKGV4dF9saW5rKSkgew0KICAgICAgICAgIFRXdW5sb2NrZWQubG9hZEV4dGVuc2lvblVuc2FuZGJveGVkKGV4dF9saW5rKTsNCiAgICAgICAgfSBlbHNlIGNvbnNvbGUuZXJyb3IoYFBNLVVubG9ja2VkOiBFeHRlbnNpb24gdXJsIGlzIGludmFsaWQuXG5VUkw6ICR7ZXh0X2xpbmt9YCk7DQogICAgICB9DQogICAgfSk7DQogICAgaWYgKGhhc1BhcmFtKSByZXR1cm4gZm91bmRQYXJhbTsNCiAgfTsNCg0KICBUV3VubG9ja2VkLmRpc2FibGVQZXJtaXNzaW9uU2VjdXJpdHkgPSBhc3luYyBmdW5jdGlvbiAoKSB7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbkZldGNoID0gdGhpcy51dGlscy5hVGY7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbkxvYWRFeHRlbnNpb25Gcm9tUHJvamVjdCA9IHRoaXMudXRpbHMuYVRmOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5Ob3RpZnkgPSB0aGlzLnV0aWxzLmFUZjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuT3BlbldpbmRvdyA9IHRoaXMudXRpbHMuYVRmOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWFkQ2xpcGJvYXJkID0gdGhpcy51dGlscy5hVGY7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlY29yZEF1ZGlvID0gdGhpcy51dGlscy5hVGY7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlY29yZFZpZGVvID0gdGhpcy51dGlscy5hVGY7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlZGlyZWN0ID0gdGhpcy51dGlscy5hVGY7DQogIH07DQoNCiAgVFd1bmxvY2tlZC5yZXN0b3JlUGVybWlzc2lvblNlY3VyaXR5ID0gZnVuY3Rpb24gKCkgew0KICAgIGNvbnN0IG9sZF9wZXJtcyA9IHRoaXMudXRpbHMub1NtUHY7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbkZldGNoID0gb2xkX3Blcm1zLmNmOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5Mb2FkRXh0ZW5zaW9uRnJvbVByb2plY3QgPSBvbGRfcGVybXMuY2xlZnA7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhbk5vdGlmeSA9IG9sZF9wZXJtcy5jbjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuT3BlbldpbmRvdyA9IG9sZF9wZXJtcy5jb3c7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlYWRDbGlwYm9hcmQgPSBvbGRfcGVybXMuY3JjOw0KICAgIHZtLnNlY3VyaXR5TWFuYWdlci5jYW5SZWNvcmRBdWRpbyA9IG9sZF9wZXJtcy5jcmE7DQogICAgdm0uc2VjdXJpdHlNYW5hZ2VyLmNhblJlY29yZFZpZGVvID0gb2xkX3Blcm1zLmNydjsNCiAgICB2bS5zZWN1cml0eU1hbmFnZXIuY2FuUmVkaXJlY3QgPSBvbGRfcGVybXMuY3I7DQogIH07DQoNCiAgVFd1bmxvY2tlZC5Ub2dnbGVPcGVuQnV0dG9uID0gZnVuY3Rpb24gKCkgew0KICAgIFRXdW5sb2NrZWQub3BlbkJ1dHRvbi52aXNpYmlsaXR5KCFUV3VubG9ja2VkLm9wZW5CdXR0b24udmlzaWJpbGl0eSgiZ2V0IikpOw0KICB9Ow0KDQogIFRXdW5sb2NrZWQudXRpbHMuY3JlYXRlRXh0ZW5zaW9uRGl2ID0gZnVuY3Rpb24gKGRhdGEpIHsNCiAgICBjb25zdCBoYXNDcmVhdG9yID0gZGF0YS5oYXNPd25Qcm9wZXJ0eSgiY3JlYXRvciIpOw0KICAgIGlmICghaGFzQ3JlYXRvcikgZGF0YVsiY3JlYXRvciJdID0geyBsaW5rOiAiIiwgbmFtZTogIiIgfTsNCiAgICB2YXIgYnIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJiciIpOw0KICAgIHZhciBleHRlbnNpb25EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICB2YXIgZXh0ZW5zaW9uSW1hZ2VDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICB2YXIgZXh0ZW5zaW9uSW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsNCiAgICBleHRlbnNpb25JbWFnZS5sb2FkaW5nID0gImxhenkiOw0KICAgIGV4dGVuc2lvbkltYWdlLmRyYWdnYWJsZSA9IGZhbHNlOw0KICAgIGV4dGVuc2lvbkltYWdlLnNyYyA9IGRhdGEuaW1hZ2U7DQogICAgdmFyIGV4dGVuc2lvblRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICB2YXIgZXh0ZW5zaW9uVGV4dFRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOw0KICAgIGV4dGVuc2lvblRleHRUaXRsZS5pbm5lckhUTUwgPSBkYXRhLnRpdGxlOw0KICAgIHZhciBleHRlbnNpb25UZXh0RGVzY3JpcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7DQogICAgZXh0ZW5zaW9uVGV4dERlc2NyaXB0aW9uLmlubmVySFRNTCA9IGRhdGEuZGVzY3JpcHRpb247DQogICAgdmFyIGV4dGVuc2lvbkNyZWF0b3JMaW5rT3V0ZXJDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICB2YXIgZXh0ZW5zaW9uQ3JlYXRvckxpbmtJbm5lckNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIHZhciBleHRlbnNpb25DcmVhdG9yTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsNCiAgICBleHRlbnNpb25DcmVhdG9yTGluay50YXJnZXQgPSAiX2JsYW5rIjsNCiAgICBleHRlbnNpb25DcmVhdG9yTGluay5yZWwgPSAibm9yZWZlcnJlciI7DQogICAgZXh0ZW5zaW9uQ3JlYXRvckxpbmsuaHJlZiA9IGRhdGEuY3JlYXRvci5saW5rOw0KICAgIGV4dGVuc2lvbkNyZWF0b3JMaW5rLmlubmVySFRNTCA9IGRhdGEuY3JlYXRvci5uYW1lOw0KICAgIGV4dGVuc2lvbkNyZWF0b3JMaW5rSW5uZXJDb250YWluZXIuYXBwZW5kQ2hpbGQoZXh0ZW5zaW9uQ3JlYXRvckxpbmspOw0KICAgIGV4dGVuc2lvbkNyZWF0b3JMaW5rT3V0ZXJDb250YWluZXIuYXBwZW5kQ2hpbGQoDQogICAgICBleHRlbnNpb25DcmVhdG9yTGlua0lubmVyQ29udGFpbmVyDQogICAgKTsNCiAgICBkb2N1bWVudA0KICAgICAgLnF1ZXJ5U2VsZWN0b3IoImRpdltjbGFzc149bGlicmFyeS1pdGVtX2xpYnJhcnktaXRlbV0iKQ0KICAgICAgLmNsYXNzTGlzdC5mb3JFYWNoKChjbGFzc18pID0+IHsNCiAgICAgICAgZXh0ZW5zaW9uRGl2LmNsYXNzTGlzdC5hZGQoY2xhc3NfKTsNCiAgICAgIH0pOw0KICAgIGRvY3VtZW50DQogICAgICAucXVlcnlTZWxlY3RvcigiZGl2W2NsYXNzXj1saWJyYXJ5LWl0ZW1fZmVhdHVyZWQtZXh0ZW5zaW9uLXRleHRdIikNCiAgICAgIC5jbGFzc0xpc3QuZm9yRWFjaCgoY2xhc3NfKSA9PiB7DQogICAgICAgIGV4dGVuc2lvblRleHQuY2xhc3NMaXN0LmFkZChjbGFzc18pOw0KICAgICAgfSk7DQogICAgZXh0ZW5zaW9uSW1hZ2VDb250YWluZXIuY2xhc3NMaXN0LmFkZCgNCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgICAgICJkaXZbY2xhc3NePWxpYnJhcnktaXRlbV9mZWF0dXJlZC1pbWFnZS1jb250YWluZXJdIg0KICAgICAgKS5jbGFzc0xpc3RbMF0NCiAgICApOw0KICAgIGV4dGVuc2lvbkltYWdlLmNsYXNzTGlzdC5hZGQoDQogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJkaXZbY2xhc3NePWxpYnJhcnktaXRlbV9mZWF0dXJlZC1pbWFnZV0iKQ0KICAgICAgICAuY2xhc3NMaXN0WzBdDQogICAgKTsNCiAgICBleHRlbnNpb25JbWFnZUNvbnRhaW5lci5hcHBlbmRDaGlsZChleHRlbnNpb25JbWFnZSk7DQogICAgZXh0ZW5zaW9uVGV4dFRpdGxlLmNsYXNzTGlzdC5hZGQoDQogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJzcGFuW2NsYXNzXj1saWJyYXJ5LWl0ZW1fbGlicmFyeS1pdGVtLW5hbWVdIikNCiAgICAgICAgLmNsYXNzTGlzdFswXQ0KICAgICk7DQogICAgZXh0ZW5zaW9uVGV4dERlc2NyaXB0aW9uLmNsYXNzTGlzdC5hZGQoDQogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJzcGFuW2NsYXNzXj1saWJyYXJ5LWl0ZW1fZmVhdHVyZWQtZGVzY3JpcHRpb25dIikNCiAgICAgICAgLmNsYXNzTGlzdFswXQ0KICAgICk7DQogICAgaWYgKCFUV3VubG9ja2VkLmlzRGVza3RvcCkNCiAgICAgIGV4dGVuc2lvbkNyZWF0b3JMaW5rT3V0ZXJDb250YWluZXIuY2xhc3NMaXN0LmFkZCgNCiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiZGl2W2NsYXNzXj1saWJyYXJ5LWl0ZW1fZXh0ZW5zaW9uLWxpbmtzXSIpDQogICAgICAgICAgLmNsYXNzTGlzdFswXQ0KICAgICAgKTsNCiAgICBleHRlbnNpb25UZXh0LmFwcGVuZENoaWxkKGV4dGVuc2lvblRleHRUaXRsZSk7DQogICAgZXh0ZW5zaW9uVGV4dC5hcHBlbmRDaGlsZChicik7DQogICAgZXh0ZW5zaW9uVGV4dC5hcHBlbmRDaGlsZChleHRlbnNpb25UZXh0RGVzY3JpcHRpb24pOw0KICAgIGV4dGVuc2lvbkRpdi5hcHBlbmRDaGlsZChleHRlbnNpb25JbWFnZUNvbnRhaW5lcik7DQogICAgZXh0ZW5zaW9uRGl2LmFwcGVuZENoaWxkKGV4dGVuc2lvblRleHQpOw0KICAgIGlmIChoYXNDcmVhdG9yKQ0KICAgICAgZXh0ZW5zaW9uRGl2LmFwcGVuZENoaWxkKGV4dGVuc2lvbkNyZWF0b3JMaW5rT3V0ZXJDb250YWluZXIpOw0KICAgIGlmIChUV3VubG9ja2VkLmlzRGVza3RvcCkgew0KICAgICAgdmFyIGV4dGVuc2lvbkluY29tcGF0aWJsZVRleHRDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICAgIGV4dGVuc2lvbkluY29tcGF0aWJsZVRleHRDb250YWluZXIuY2xhc3NMaXN0LmFkZCgNCiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigNCiAgICAgICAgICAnZGl2W2NsYXNzXj0ibGlicmFyeS1pdGVtX2luY29tcGF0aWJsZS13aXRoLXNjcmF0Y2giXScNCiAgICAgICAgKS5jbGFzc0xpc3RbMF0NCiAgICAgICk7DQogICAgICB2YXIgZXh0ZW5zaW9uSW5jb21wYXRpYmxlVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsNCiAgICAgIGV4dGVuc2lvbkluY29tcGF0aWJsZVRleHQuaW5uZXJIVE1MID0gIk5vdCBjb21wYXRpYmxlIHdpdGggU2NyYXRjaC4iOw0KICAgICAgZXh0ZW5zaW9uSW5jb21wYXRpYmxlVGV4dENvbnRhaW5lci5hcHBlbmRDaGlsZChleHRlbnNpb25JbmNvbXBhdGlibGVUZXh0KTsNCiAgICAgIGV4dGVuc2lvbkRpdi5hcHBlbmRDaGlsZChleHRlbnNpb25JbmNvbXBhdGlibGVUZXh0Q29udGFpbmVyKTsNCiAgICAgIGV4dGVuc2lvbkltYWdlLndpZHRoID0gMjk2Ow0KICAgICAgZXh0ZW5zaW9uSW1hZ2UuaGVpZ2h0ID0gMTg0Ow0KICAgIH0NCiAgICByZXR1cm4gZXh0ZW5zaW9uRGl2Ow0KICB9Ow0KDQogIC8vQWRkIGEgYnV0dG9uIHRvIGxvYWQgYSBleHRlbnNpb24gaW4gdGhlIGV4dGVuc2lvbiBwYWdlLg0KICBUV3VubG9ja2VkLnV0aWxzLmFkZEV4dGVuc2lvblRvRmVhdHVyZWRHYWxsZXJ5ID0gZnVuY3Rpb24gKA0KICAgIGljb25VcmwsDQogICAgdXJsLA0KICAgIG5hbWUsDQogICAgZGVzY3JpcHRpb24NCiAgKSB7DQogICAgZnVuY3Rpb24gbG9hZEV4dGVuc2lvbigpIHsNCiAgICAgIFRXdW5sb2NrZWQubG9hZEV4dGVuc2lvblVuc2FuZGJveGVkKHVybCwgdHJ1ZSk7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkucGFyZW50RWxlbWVudC5jaGlsZHJlblswXS5jaGlsZHJlblsxXS5jaGlsZHJlblswXS5jbGljaygpOw0KICAgICAgYWxlcnQoIlBNLVVubG9ja2VkOiBZb3VyIEV4dGVuc2lvbiBpcyBsb2FkaW5nLCBwbGVhc2UgYmUgcGF0aWVudC4iKTsNCiAgICB9DQogICAgY29uc3QgbXlFeHRlbnNpb24gPSBUV3VubG9ja2VkLnV0aWxzLmNyZWF0ZUV4dGVuc2lvbkRpdih7DQogICAgICAvL2NyZWF0b3I6IHtsaW5rOidodHRwczovL2dvb2dsZS5jb20vJywgbmFtZTondGVzdCd9LA0KICAgICAgdGl0bGU6IG5hbWUsDQogICAgICBkZXNjcmlwdGlvbiwNCiAgICAgIGltYWdlOiBpY29uVXJsLA0KICAgIH0pOw0KICAgIG15RXh0ZW5zaW9uLm9uY2xpY2sgPSBsb2FkRXh0ZW5zaW9uOw0KICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5pbnNlcnRCZWZvcmUoDQogICAgICBteUV4dGVuc2lvbiwNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5jaGlsZE5vZGVzWzBdDQogICAgKTsNCiAgfTsNCg0KICBUV3VubG9ja2VkLnV0aWxzLmFkZEFsbG5ld0ZlYXR1cmVkVG9HYWxsZXJ5ID0gZnVuY3Rpb24gKCkgew0KICAgIGxldCBleHRlbnNpb25zID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndHd1OmN1c3RvbUV4dGVuc2lvbnMnKSk7DQogICAgZm9yIChleHRlbnNpb24gaW4gZXh0ZW5zaW9ucykgew0KICAgICAgZXh0ZW5zaW9uID0gZXh0ZW5zaW9uc1tleHRlbnNpb25dOw0KICAgICAgVFd1bmxvY2tlZC51dGlscy5hZGRFeHRlbnNpb25Ub0ZlYXR1cmVkR2FsbGVyeSgNCiAgICAgICAgZXh0ZW5zaW9uLmltYWdlX3VybCwNCiAgICAgICAgZXh0ZW5zaW9uLnVybCwNCiAgICAgICAgZXh0ZW5zaW9uLm5hbWUsDQogICAgICAgIGV4dGVuc2lvbi5kZXNjcmlwdGlvbg0KICAgICAgKTsNCiAgICB9DQogIH07DQoNCiAgVFd1bmxvY2tlZC51dGlscy5hdHRlbXB0VG9Mb2FkTXlHYWxsZXJ5ID0gYXN5bmMgZnVuY3Rpb24gKCkgew0KICAgIHZhciBleHRlbnNpb25zID0gW107DQogICAgdmFyIHNpdGUgPSAiaHR0cHM6Ly9zdXJ2LmlzLWEuZGV2L3Vuc2FmZS1leHRlbnNpb25zIjsNCiAgICBpZiAoIVRXdW5sb2NrZWQuaXNEZXNrdG9wKQ0KICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5Lmluc2VydEJlZm9yZSgNCiAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25zQ2F0ZWdvcnlTZXBhcmF0b3IuY2xvbmVOb2RlKHRydWUpLA0KICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuY2hpbGROb2Rlc1swXQ0KICAgICAgKTsNCiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKA0KICAgICAgZmV0Y2goc2l0ZSArICIvIikNCiAgICAgICAgLnRoZW4oKHRleHQpID0+IHRleHQudGV4dCgpKQ0KICAgICAgICAudGhlbigodGV4dCkgPT4gew0KICAgICAgICAgIGxldCBkb20gPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHRleHQsICJ0ZXh0L2h0bWwiKTsNCiAgICAgICAgICBkb20ucXVlcnlTZWxlY3RvckFsbCgiZGl2LmV4dGVuc2lvbiIpLmZvckVhY2goKGV4dCkgPT4gew0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgaWYgKGV4dC5zdHlsZS5kaXNwbGF5ID09ICJub25lIiB8fCBleHQuaGFzQXR0cmlidXRlKCJoaWRkZW4iKSkNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9IGNhdGNoIHt9DQogICAgICAgICAgICBjb25zdCB1cmkgPSAoDQogICAgICAgICAgICAgIGV4dC5xdWVyeVNlbGVjdG9yKCJhLmNvcHkiKSB8fCBleHQucXVlcnlTZWxlY3RvcigiYS5vcGVuIikNCiAgICAgICAgICAgICkuaHJlZi5zcGxpdCgiLyIpOw0KICAgICAgICAgICAgbGV0IGV4dGVuc2lvbiA9IHsNCiAgICAgICAgICAgICAgbmFtZTogZXh0LnF1ZXJ5U2VsZWN0b3IoImgzIikuaW5uZXJIVE1MLA0KICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogZXh0LnF1ZXJ5U2VsZWN0b3IoInAiKS5pbm5lckhUTUwsDQogICAgICAgICAgICAgIGltYWdlOiBleHQNCiAgICAgICAgICAgICAgICAucXVlcnlTZWxlY3RvcigiaW1nLmV4dGVuc2lvbi1pbWFnZSIpDQogICAgICAgICAgICAgICAgLnNyYy5yZXBsYWNlKGRvY3VtZW50LmxvY2F0aW9uLm9yaWdpbiwgc2l0ZSksDQogICAgICAgICAgICAgIHVybDogYGh0dHBzOi8vc3Vydi5pcy1hLmRldi91bnNhZmUtZXh0ZW5zaW9ucy8kew0KICAgICAgICAgICAgICAgIHVyaVt1cmkubGVuZ3RoIC0gMl0NCiAgICAgICAgICAgICAgfS8ke3VyaVt1cmkubGVuZ3RoIC0gMV19YCwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICBleHRlbnNpb25zLnB1c2goZXh0ZW5zaW9uKTsNCiAgICAgICAgICB9KTsNCiAgICAgICAgICBmb3IgKGV4dGVuc2lvbiBpbiBleHRlbnNpb25zKSB7DQogICAgICAgICAgICBleHRlbnNpb24gPSBleHRlbnNpb25zW2V4dGVuc2lvbl07DQogICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmFkZEV4dGVuc2lvblRvRmVhdHVyZWRHYWxsZXJ5KA0KICAgICAgICAgICAgICBleHRlbnNpb24uaW1hZ2UsDQogICAgICAgICAgICAgIGV4dGVuc2lvbi51cmwsDQogICAgICAgICAgICAgIGV4dGVuc2lvbi5uYW1lLA0KICAgICAgICAgICAgICBleHRlbnNpb24uZGVzY3JpcHRpb24NCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICB9KQ0KICAgICAgICAudGhlbigoKSA9PiB7DQogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOw0KICAgICAgICB9KQ0KICAgICk7DQogIH07DQoNCiAgVFd1bmxvY2tlZC51dGlscy5hdHRlbXB0VG9Mb2FkU1BHYWxsZXJ5ID0gYXN5bmMgZnVuY3Rpb24gKCkgew0KICAgICAgdmFyIGtleXMgPSBhd2FpdCBmZXRjaCgnaHR0cHM6Ly9jb3JzcHJveHkuaW8vP2h0dHBzOi8vc2hhcmtwb29scy1leHRlbnNpb25zLnZlcmNlbC5hcHAvR2FsbGVyeSUyMEZpbGVzL0V4dGVuc2lvbi1LZXlzLmpzb24nKTsNCiAgICAgIGtleXMgPSBhd2FpdCBrZXlzLmpzb24oKTsNCiAgICAgIGtleXMgPSBrZXlzLmV4dGVuc2lvbnM7DQogICAgICBkZWxldGUga2V5c1snSW1hZ2UtRWZmZWN0cyddOyAgICAvLyBCcm9rZW4gaWNvbiA6KA0KICAgICAgZGVsZXRlIGtleXNbJ05pY2hlLVRvb2xib3gnXTsgICAgLy8gTmFoLg0KICAgICAgZGVsZXRlIGtleXNbJ05ld2dyb3VuZHMtQXVkaW8nXTsgLy8gTGVnYWwgZ3JleSBhcmVhDQogICAgICBkZWxldGUga2V5c1snU2luY2UtMjAwMCddOyAgICAgICAvL05haC4NCiAgICAgIGxldCBleHRlbnNpb25zID0gT2JqZWN0LmtleXMoa2V5cyk7DQogICAgICBleHRlbnNpb25zLnBvcChleHRlbnNpb25zLmxlbmd0aC0xKTsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXh0ZW5zaW9ucy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgIGxldCBleHRlbnNpb24gPSBleHRlbnNpb25zW2ldOw0KICAgICAgICAgIGxldCBvYmogPSBrZXlzW2V4dGVuc2lvbl07DQogICAgICAgICAgb2JqLmltYWdlID0gJ2h0dHBzOi8vY29yc3Byb3h5LmlvLz9odHRwczovL3NoYXJrcG9vbHMtZXh0ZW5zaW9ucy52ZXJjZWwuYXBwL2V4dGVuc2lvbi10aHVtYnMvJytleHRlbnNpb24rJy5zdmcnOw0KICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuYWRkRXh0ZW5zaW9uVG9GZWF0dXJlZEdhbGxlcnkoDQogICAgICAgICAgICBvYmouaW1hZ2UsDQogICAgICAgICAgICBvYmoudXJsLA0KICAgICAgICAgICAgZXh0ZW5zaW9uLA0KICAgICAgICAgICAgb2JqLmNyZWRpdHMNCiAgICAgICAgICApOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTsNCiAgfQ0KDQogIFRXdW5sb2NrZWQuYWRkRXh0ZW5zaW9uVG9GZWF0dXJlZEdhbGxlcnkgPSBmdW5jdGlvbiAoDQogICAgaWNvblVybCwNCiAgICB1cmwsDQogICAgbmFtZSwNCiAgICBkZXNjcmlwdGlvbg0KICApIHsNCiAgICBUV3VubG9ja2VkLnV0aWxzLm5ld0ZlYXR1cmVkRXh0ZW5zaW9ucy5wdXNoKHsNCiAgICAgIGljb25VcmwsDQogICAgICB1cmwsDQogICAgICBuYW1lLA0KICAgICAgZGVzY3JpcHRpb24sDQogICAgfSk7DQogIH07DQoNCiAgVFd1bmxvY2tlZC51dGlscy5leHRCdG5BZGRMaXN0ZW4gPSBmdW5jdGlvbiAoKSB7DQogICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYnV0dG9uW2NsYXNzXj0iZ3VpX2V4dGVuc2lvbi1idXR0b24iXScpLm9uY2xpY2sgPQ0KICAgICAgZnVuY3Rpb24gKCkgew0KICAgICAgICBzZXRUaW1lb3V0KGFzeW5jIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICBjb25zdCBtb2RhbFNldHRpbmdzID0gVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmdldE1hcmtzKCk7DQogICAgICAgICAgbGV0IG15R2FsbGVyeSA9IG1vZGFsU2V0dGluZ3MubXlHYWxsZXJ5LCBzcEdhbGxlcnkgPSBtb2RhbFNldHRpbmdzLnNwR2FsbGVyeTsNCiAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbnNDYXRlZ29yeVNlcGFyYXRvciA9DQogICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJociIpOw0KICAgICAgICAgIGlmICghVFd1bmxvY2tlZC5pc0Rlc2t0b3ApDQogICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbnNDYXRlZ29yeVNlcGFyYXRvci5jbGFzc0xpc3QuYWRkKA0KICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJocltjbGFzc149c2VwYXJhdG9yX3NlcGFyYXRvcl0iKQ0KICAgICAgICAgICAgICAgIC5jbGFzc0xpc3RbMF0NCiAgICAgICAgICAgICk7DQogICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25MaWJyYXJ5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigNCiAgICAgICAgICAgICdbY2xhc3NePSJsaWJyYXJ5X2xpYnJhcnktc2Nyb2xsLWdyaWQiXScNCiAgICAgICAgICApOw0KICAgICAgICAgIGlmICgNCiAgICAgICAgICAgIG15R2FsbGVyeSB8fA0KICAgICAgICAgICAgc3BHYWxsZXJ5DQogICAgICAgICAgKSB7DQogICAgICAgICAgICBpZiAoc3BHYWxsZXJ5KSB7DQogICAgICAgICAgICAgIGlmICghVFd1bmxvY2tlZC5pc0Rlc2t0b3ApDQogICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5pbnNlcnRCZWZvcmUoDQogICAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25zQ2F0ZWdvcnlTZXBhcmF0b3IuY2xvbmVOb2RlKHRydWUpLA0KICAgICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5jaGlsZE5vZGVzWzBdDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgIGF3YWl0IFRXdW5sb2NrZWQudXRpbHMuYXR0ZW1wdFRvTG9hZFNQR2FsbGVyeSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKG15R2FsbGVyeSkgew0KICAgICAgICAgICAgICBpZiAoIVRXdW5sb2NrZWQuaXNEZXNrdG9wKQ0KICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuaW5zZXJ0QmVmb3JlKA0KICAgICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uc0NhdGVnb3J5U2VwYXJhdG9yLmNsb25lTm9kZSh0cnVlKSwNCiAgICAgICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmV4dGVuc2lvbkxpYnJhcnkuY2hpbGROb2Rlc1swXQ0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgICBhd2FpdCBUV3VubG9ja2VkLnV0aWxzLmF0dGVtcHRUb0xvYWRNeUdhbGxlcnkoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICghVFd1bmxvY2tlZC5pc0Rlc2t0b3ApDQogICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5pbnNlcnRCZWZvcmUoDQogICAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25zQ2F0ZWdvcnlTZXBhcmF0b3IuY2xvbmVOb2RlKHRydWUpLA0KICAgICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5jaGlsZE5vZGVzWzBdDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmFkZEFsbG5ld0ZlYXR1cmVkVG9HYWxsZXJ5KCk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGlmICghVFd1bmxvY2tlZC5pc0Rlc2t0b3ApDQogICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5pbnNlcnRCZWZvcmUoDQogICAgICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5leHRlbnNpb25zQ2F0ZWdvcnlTZXBhcmF0b3IuY2xvbmVOb2RlKHRydWUpLA0KICAgICAgICAgICAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0ZW5zaW9uTGlicmFyeS5jaGlsZE5vZGVzWzBdDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmFkZEFsbG5ld0ZlYXR1cmVkVG9HYWxsZXJ5KCk7DQogICAgICAgICAgfQ0KICAgICAgICB9LCAxMDAwKTsNCiAgICAgIH07DQogIH07DQoNCiAgVFd1bmxvY2tlZC51dGlscy5oYXNUcmllZFRvQWRkRm9ySSA9IGZhbHNlOw0KICBUV3VubG9ja2VkLnV0aWxzLmFkZEZvcklleHRlbnNpb24gPSBmdW5jdGlvbiAoKSB7DQogICAgaWYgKCFUV3VubG9ja2VkLnV0aWxzLmhhc1RyaWVkVG9BZGRGb3JJKSB7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLmhhc1RyaWVkVG9BZGRGb3JJID0gdHJ1ZTsNCiAgICAgIFRXdW5sb2NrZWQubG9hZEV4dGVuc2lvblVuc2FuZGJveGVkKA0KICAgICAgICAiaHR0cHM6Ly9zdXJ2LmlzLWEuZGV2L2JyaW5nQmFja0ZvckkuanMiDQogICAgICApOw0KICAgICAgYWxlcnQoDQogICAgICAgICJUaGUgZm9yIGkgYmxvY2sgc2hvdWxkIGFwcGVhciB3aXRoaW4gMTAgc2Vjb25kcywgb3RoZXJ3aXNlIGNoZWNrIHRoZSBjb25zb2xlISINCiAgICAgICk7DQogICAgfQ0KICB9Ow0KDQogIFRXdW5sb2NrZWQudXRpbHMuY3VySWRHZW4gPSBUV3VubG9ja2VkLnV0aWxzLmlkR2VuKCk7DQogIFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuQnViYmxlcyA9IFtdOw0KICBUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkljb25zID0gW107DQogIHdpbmRvdy5nZXRCdWIgPSBmdW5jdGlvbiAoZXh0KSB7DQogICAgbGV0IGJ1YiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgICAiZGl2LnNjcmF0Y2hDYXRlZ29yeUlkLSIgKyBleHQNCiAgICApLnBhcmVudEVsZW1lbnQ7DQogICAgYnViLmljb24gPQ0KICAgICAgYnViLnF1ZXJ5U2VsZWN0b3IoImRpdi5zY3JhdGNoQ2F0ZWdvcnlJdGVtQnViYmxlIikgfHwNCiAgICAgIGJ1Yi5xdWVyeVNlbGVjdG9yKCJkaXYuc2NyYXRjaENhdGVnb3J5SXRlbUljb24iKTsNCiAgICByZXR1cm4gYnViOw0KICB9Ow0KICBsZXQgYm91bmQgPSB2bS5ydW50aW1lLmdldEJsb2Nrc1hNTC5iaW5kKHZtLnJ1bnRpbWUpOw0KICB2bS5ydW50aW1lLmdldEJsb2Nrc1hNTCA9IGZ1bmN0aW9uICguLi5hcmdzKSB7DQogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IFRXdW5sb2NrZWQudXRpbHMuaGlkZGVuQnViYmxlcy5sZW5ndGg7IGkrKykgew0KICAgICAgICB0cnkgew0KICAgICAgICAgIGxldCBidWIgPSBnZXRCdWIoVFd1bmxvY2tlZC51dGlscy5oaWRkZW5CdWJibGVzW2ldKTsNCiAgICAgICAgICBidWIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7DQogICAgICAgICAgY29uc29sZS5kZWJ1ZygiUE0tVW5sb2NrZWQ6IEVycm9yIHdoZW4gaGlkaW5nIGJ1YmJsZTogIiArIGVycik7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgVFd1bmxvY2tlZC51dGlscy5oaWRkZW5JY29ucy5sZW5ndGg7IGkrKykgew0KICAgICAgICB0cnkgew0KICAgICAgICAgIGxldCBidWIgPSBnZXRCdWIoVFd1bmxvY2tlZC51dGlscy5oaWRkZW5JY29uc1tpXSk7DQogICAgICAgICAgYnViLmljb24uc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7DQogICAgICAgICAgY29uc29sZS5kZWJ1ZygiUE0tVW5sb2NrZWQ6IEVycm9yIHdoZW4gaGlkaW5nIGJ1YmJsZSBpY29uOiAiICsgZXJyKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0sIDEwMDApOw0KICAgIHJldHVybiBib3VuZCguLi5hcmdzKTsNCiAgfTsNCiAgZnVuY3Rpb24gdG9vbGJveE1lbnUoZSkgew0KICAgIGxldCB0bXAsDQogICAgICBidWJibGUgPSBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KGUuY2xpZW50WCwgZS5jbGllbnRZKTsNCiAgICB0bXAgPSBidWJibGUucGFyZW50RWxlbWVudDsNCiAgICBpZiAodG1wLmNsYXNzTGlzdC5jb250YWlucygic2NyYXRjaENhdGVnb3J5TWVudUl0ZW0iKSkgYnViYmxlID0gdG1wOw0KICAgIHRtcCA9IGJ1YmJsZS5xdWVyeVNlbGVjdG9yKCJkaXYuc2NyYXRjaENhdGVnb3J5TWVudUl0ZW0iKTsNCiAgICBpZiAodG1wKSBidWJibGUgPSB0bXA7DQogICAgbGV0IGV4dGVuc2lvbiA9IGJ1YmJsZS5jbGFzc0xpc3RbMV0ucmVwbGFjZSgic2NyYXRjaENhdGVnb3J5SWQtIiwgIiIpOw0KICAgIGNvbnN0IGlzQnVpbHRJbiA9IFsNCiAgICAgICJtb3Rpb24iLA0KICAgICAgImxvb2tzIiwNCiAgICAgICJzb3VuZCIsDQogICAgICAicGVuIiwNCiAgICAgICJkYXRhIiwNCiAgICAgICJ2YXJpYWJsZXMiLA0KICAgICAgImRhdGFMaXN0cyIsDQogICAgICAibGlzdHMiLA0KICAgICAgImV2ZW50IiwNCiAgICAgICJldmVudHMiLA0KICAgICAgImNvbnRyb2wiLA0KICAgICAgInNlbnNpbmciLA0KICAgICAgIm9wZXJhdG9ycyIsDQogICAgICAibW9yZSIsDQogICAgICAibXlCbG9ja3MiLA0KICAgIF0uaW5jbHVkZXMoZXh0ZW5zaW9uKTsNCiAgICB2YXIgYmxvY2tzID0gdm0ucnVudGltZS5nZXRFZGl0aW5nVGFyZ2V0KCkuYmxvY2tzOw0KICAgIHZhciBkZWxldGlvbnMgPSBbXTsNCiAgICBidWJibGUuaWNvbiA9DQogICAgICBidWJibGUucGFyZW50RWxlbWVudC5xdWVyeVNlbGVjdG9yKCJkaXYuc2NyYXRjaENhdGVnb3J5SXRlbUJ1YmJsZSIpIHx8DQogICAgICBidWJibGUucGFyZW50RWxlbWVudC5xdWVyeVNlbGVjdG9yKCJkaXYuc2NyYXRjaENhdGVnb3J5SXRlbUljb24iKTsNCiAgICBPYmplY3QudmFsdWVzKGJsb2Nrcy5fYmxvY2tzKS5mb3JFYWNoKChibG9jaykgPT4gew0KICAgICAgaWYgKGJsb2NrLm9wY29kZS5zdGFydHNXaXRoKGV4dGVuc2lvbikpIHsNCiAgICAgICAgbGV0IG15VXAgPSBibG9jay5wYXJlbnQ7DQogICAgICAgIGxldCBteU5leHQgPSBibG9jay5uZXh0Ow0KICAgICAgICBibG9jay5wYXJlbnQgPSBudWxsOw0KICAgICAgICBibG9jay5uZXh0ID0gbnVsbDsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBibG9ja3MuX2Jsb2Nrc1tteVVwXS5uZXh0ID0gbXlOZXh0Ow0KICAgICAgICB9IGNhdGNoIHt9DQogICAgICAgIHRyeSB7DQogICAgICAgICAgYmxvY2tzLl9ibG9ja3NbbXlOZXh0XS5wYXJlbnQgPSBteVVwOw0KICAgICAgICB9IGNhdGNoIHt9DQogICAgICAgIGRlbGV0aW9ucy5wdXNoKGJsb2NrLmlkKTsNCiAgICAgIH0NCiAgICB9KTsNCiAgICBsZXQgd2lkZ2l0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgd2lkZ2l0LmNsYXNzTGlzdC5hZGQoImJsb2NrbHlXaWRnZXREaXYiKTsNCiAgICB3aWRnaXQuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOw0KICAgIHdpZGdpdC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCiAgICB3aWRnaXQuc3R5bGUuZGlyZWN0aW9uID0gImx0ciI7DQogICAgd2lkZ2l0LnN0eWxlLnRvcCA9IGUuY2xpZW50WSArICJweCI7DQogICAgd2lkZ2l0LnN0eWxlLmxlZnQgPSBlLmNsaWVudFggKyAicHgiOw0KICAgIHdpZGdpdC5zdHlsZS53aWR0aCA9ICIyMjQuMnB4IjsNCiAgICBsZXQgbWVudUhlaWdodCA9IDA7DQogICAgbGV0IG1lbnUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICBtZW51LmNsYXNzTGlzdC5hZGQoImdvb2ctbWVudSIpOw0KICAgIG1lbnUuY2xhc3NMaXN0LmFkZCgiZ29vZy1tZW51LXZlcnRpY2FsIik7DQogICAgbWVudS5jbGFzc0xpc3QuYWRkKCJibG9ja2x5Q29udGV4dE1lbnUiKTsNCiAgICBtZW51LnJvbGUgPSAibWVudSI7DQogICAgbWVudS5zdHlsZS51c2VyU2VsZWN0ID0gIm5vbmUiOw0KICAgIG1lbnUudGFiaW5kZXggPSAwOw0KICAgIGZ1bmN0aW9uIG1lbnVJdGVtKHRleHQsIGV4dHJhcywgb25jbGljaykgew0KICAgICAgbGV0IGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICAgIGl0ZW0uaXNEaXNhYmxlZCA9IGV4dHJhcy5pc0Rpc2FibGVkOw0KICAgICAgaWYgKGV4dHJhcy5ib3JkZXIpIHsNCiAgICAgICAgbWVudUhlaWdodCArPSAzOw0KICAgICAgICBpdGVtLmNsYXNzTGlzdC5hZGQoInNhLWJsb2NrbHktbWVudS1pdGVtLWJvcmRlciIpOw0KICAgICAgICBpdGVtLnN0eWxlLnBhZGRpbmdUb3AgPSAiMnB4IjsNCiAgICAgICAgaXRlbS5zdHlsZS5ib3JkZXJUb3AgPSAiMXB4IHNvbGlkIHJnYmEoMCwgMCwgMCwgMC4xNSkiOw0KICAgICAgfQ0KICAgICAgaXRlbS5vbmNsaWNrID0gZnVuY3Rpb24gKC4uLmFyZ3MpIHsNCiAgICAgICAgaWYgKGl0ZW0uaXNEaXNhYmxlZCkgcmV0dXJuOw0KICAgICAgICBvbmNsaWNrKC4uLmFyZ3MpOw0KICAgICAgICB3aWRnaXQucmVtb3ZlKCk7DQogICAgICB9Ow0KICAgICAgaXRlbS5vbm1vdXNlb3ZlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKGl0ZW0uaXNEaXNhYmxlZCkgcmV0dXJuOw0KICAgICAgICBpdGVtLmNsYXNzTGlzdC5hZGQoImdvb2ctbWVudWl0ZW0taGlnaGxpZ2h0Iik7DQogICAgICB9Ow0KICAgICAgaXRlbS5vbm1vdXNlb3V0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAoaXRlbS5pc0Rpc2FibGVkKSByZXR1cm47DQogICAgICAgIGlmICghaXRlbS5pc0Rpc2FibGVkKSBpdGVtLmNsYXNzTGlzdC5yZW1vdmUoImdvb2ctbWVudWl0ZW0taGlnaGxpZ2h0Iik7DQogICAgICB9Ow0KICAgICAgaXRlbS5pbm5lckhUTUwgPSBgPGRpdiBjbGFzcz0iZ29vZy1tZW51aXRlbS1jb250ZW50IiBzdHlsZT0idXNlci1zZWxlY3Q6IG5vbmU7Ij4ke3RleHR9PC9kaXY+YDsNCiAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZCgiZ29vZy1tZW51aXRlbSIpOw0KICAgICAgaWYgKGl0ZW0uaXNEaXNhYmxlZCkgew0KICAgICAgICBpdGVtLmNsYXNzTGlzdC5hZGQoImdvb2ctbWVudWl0ZW0tZGlzYWJsZWQiKTsNCiAgICAgIH0NCiAgICAgIGl0ZW0ucm9sZSA9ICJtZW51aXRlbSI7DQogICAgICBpdGVtLmlkID0gYDoke1RXdW5sb2NrZWQudXRpbHMuY3VySWRHZW4ubmV4dCgpLnZhbHVlfWA7DQogICAgICBpdGVtLnN0eWxlLnVzZXJTZWxlY3QgPSAibm9uZSI7DQogICAgICBtZW51SGVpZ2h0ICs9IDIzOw0KICAgICAgcmV0dXJuIGl0ZW07DQogICAgfQ0KICAgIGNvbnN0IGRlZmF1bHRTZXR0aW5ncyA9IHsNCiAgICAgIGlzRGlzYWJsZWQ6IGZhbHNlLA0KICAgICAgYm9yZGVyOiBmYWxzZSwNCiAgICB9Ow0KICAgIG1lbnUuYXBwZW5kQ2hpbGQoDQogICAgICBtZW51SXRlbSgNCiAgICAgICAgInJlbW92ZSBhbGwgZXh0ZW5zaW9uIGJsb2NrcyIsDQogICAgICAgIHsNCiAgICAgICAgICBpc0Rpc2FibGVkOiBpc0J1aWx0SW4sDQogICAgICAgICAgYm9yZGVyOiBmYWxzZSwNCiAgICAgICAgfSwNCiAgICAgICAgZnVuY3Rpb24gKCkgew0KICAgICAgICAgIGlmICgNCiAgICAgICAgICAgIGNvbmZpcm0oDQogICAgICAgICAgICAgICJBcmUgeW91IHN1cmUgYWJvdXQgdGhpcywgdGhpcyB3aWxsIHJlbW92ZSAiICsNCiAgICAgICAgICAgICAgICBkZWxldGlvbnMubGVuZ3RoICsNCiAgICAgICAgICAgICAgICAiIGJsb2Nrcz8iDQogICAgICAgICAgICApDQogICAgICAgICAgKSB7DQogICAgICAgICAgICBkZWxldGlvbnMuZm9yRWFjaCgoYmxvY2spID0+IHsNCiAgICAgICAgICAgICAgZGVsZXRlIGJsb2Nrcy5fYmxvY2tzW2Jsb2NrXTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgdm0ucmVmcmVzaFdvcmtzcGFjZSgpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgKQ0KICAgICk7DQogICAgbWVudS5hcHBlbmRDaGlsZCgNCiAgICAgIG1lbnVJdGVtKA0KICAgICAgICAiaGlkZSBidWJibGUiLA0KICAgICAgICB7DQogICAgICAgICAgaXNEaXNhYmxlZDogZmFsc2UsDQogICAgICAgICAgYm9yZGVyOiB0cnVlLA0KICAgICAgICB9LA0KICAgICAgICBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgaWYgKA0KICAgICAgICAgICAgY29uZmlybSgNCiAgICAgICAgICAgICAgIkFyZSB5b3Ugc3VyZSBhYm91dCB0aGlzIHlvdSB3b24ndCBiZSBhYmxlIHRvIHNob3cgaXQgdW5sZXNzIHlvdSByZWxvYWQ/Ig0KICAgICAgICAgICAgKQ0KICAgICAgICAgICkgew0KICAgICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5oaWRkZW5CdWJibGVzLnB1c2goZXh0ZW5zaW9uKTsNCiAgICAgICAgICAgIGJ1YmJsZS5wYXJlbnRFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICApDQogICAgKTsNCiAgICBpZiAoVFd1bmxvY2tlZC51dGlscy5oaWRkZW5JY29ucy5pbmNsdWRlcyhleHRlbnNpb24pKSB7DQogICAgICBtZW51LmFwcGVuZENoaWxkKA0KICAgICAgICBtZW51SXRlbSgic2hvdyBpY29uIiwgZGVmYXVsdFNldHRpbmdzLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5oaWRkZW5JY29ucy5wb3AoDQogICAgICAgICAgICBUV3VubG9ja2VkLnV0aWxzLmhpZGRlbkJ1YmJsZXMuaW5kZXhPZihleHRlbnNpb24pDQogICAgICAgICAgKTsNCiAgICAgICAgICBidWJibGUuaWNvbi5zdHlsZS5kaXNwbGF5ID0gIiI7DQogICAgICAgIH0pDQogICAgICApOw0KICAgIH0gZWxzZSB7DQogICAgICBtZW51LmFwcGVuZENoaWxkKA0KICAgICAgICBtZW51SXRlbSgiaGlkZSBpY29uIiwgZGVmYXVsdFNldHRpbmdzLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgVFd1bmxvY2tlZC51dGlscy5oaWRkZW5JY29ucy5wdXNoKGV4dGVuc2lvbik7DQogICAgICAgICAgYnViYmxlLmljb24uc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICAgICAgfSkNCiAgICAgICk7DQogICAgfQ0KICAgIHdpZGdpdC5zdHlsZS5oZWlnaHQgPSBtZW51SGVpZ2h0ICsgInB4IjsNCiAgICB3aWRnaXQuYXBwZW5kQ2hpbGQobWVudSk7DQogICAgdG1wID0gZnVuY3Rpb24gKCkgew0KICAgICAgdHJ5IHsNCiAgICAgICAgd2lkZ2l0LnJlbW92ZSgpOw0KICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIodG1wKTsNCiAgICAgIH0gY2F0Y2gge30NCiAgICB9Ow0KICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImRpdi5ibG9ja2x5VG9vbGJveERpdiIpLm9ubW91c2Vkb3duID0gdG1wOw0KICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQod2lkZ2l0KTsNCiAgfTsNCg0KICBmdW5jdGlvbiBpbXBvcnRJbWFnZSh1cmwsIGNvc3R1bWVfbmFtZSkgew0KICAgIGNvbnN0IHN0b3JhZ2UgPSB2bS5ydW50aW1lLnN0b3JhZ2U7DQogICAgZnVuY3Rpb24gZ2V0X3VybF9leHRlbnNpb24odXJpKSB7DQogICAgICB2YXIgbGVuID0gdXJpLnNwbGl0KCIvIik7DQogICAgICByZXR1cm4gbGVuW2xlbi5sZW5ndGggLSAxXS5zcGxpdCgiLiIpWzFdLnNwbGl0KC9bIz9dL2dpKVswXTsNCiAgICB9DQogICAgbGV0IGRhdGFUeXBlID0gIiIsDQogICAgICBkYXRhRm9ybWF0ID0gIiI7DQogICAgaWYgKHVybC5zdGFydHNXaXRoKCJkYXRhOmltYWdlLyIpKSB7DQogICAgICB1cmwgPSB1cmwucmVwbGFjZSgiZGF0YTppbWFnZS8iLCAiIik7DQogICAgICBpZiAodXJsLnN0YXJ0c1dpdGgoInN2ZyIpKQ0KICAgICAgICAoZGF0YVR5cGUgPSAic3ZnIiksIChkYXRhRm9ybWF0ID0gc3RvcmFnZS5EYXRhRm9ybWF0LlNWRyk7DQogICAgICBpZiAodXJsLnN0YXJ0c1dpdGgoInBuZyIpKQ0KICAgICAgICAoZGF0YVR5cGUgPSAicG5nIiksIChkYXRhRm9ybWF0ID0gc3RvcmFnZS5EYXRhRm9ybWF0LlBORyk7DQogICAgICBpZiAodXJsLnN0YXJ0c1dpdGgoImpwZyIpKQ0KICAgICAgICAoZGF0YVR5cGUgPSAianBnIiksIChkYXRhRm9ybWF0ID0gc3RvcmFnZS5EYXRhRm9ybWF0LkpQRyk7DQogICAgICBpZiAodXJsLnN0YXJ0c1dpdGgoImpwZWciKSkNCiAgICAgICAgKGRhdGFUeXBlID0gImpwZyIpLCAoZGF0YUZvcm1hdCA9IHN0b3JhZ2UuRGF0YUZvcm1hdC5KUEcpOw0KICAgICAgaWYgKGRhdGFUeXBlID09ICIiKSByZXR1cm4gLTE7DQogICAgICB1cmwgPSBgZGF0YTppbWFnZS8ke3VybH1gOw0KICAgIH0gZWxzZSB7DQogICAgICBkYXRhVHlwZSA9IGdldF91cmxfZXh0ZW5zaW9uKHVybCk7DQogICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlLnRvTG93ZXJDYXNlKCk7DQogICAgICBzd2l0Y2ggKGRhdGFUeXBlKSB7DQogICAgICAgIGNhc2UgInN2ZyI6DQogICAgICAgICAgZGF0YUZvcm1hdCA9IHN0b3JhZ2UuRGF0YUZvcm1hdC5TVkc7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGNhc2UgInBuZyI6DQogICAgICAgICAgZGF0YUZvcm1hdCA9IHN0b3JhZ2UuRGF0YUZvcm1hdC5QTkc7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgLy8gKmNvdWdoKiB0byBtYW55IGpwZyBmb3JtYXRzDQogICAgICAgICAgaWYgKFsianBnIiwgImpwZWciLCAiamZpZiIgLyogZXRjLCBldGMuLiAqL10uaW5jbHVkZXMoZGF0YVR5cGUpKSB7DQogICAgICAgICAgICBkYXRhRm9ybWF0ID0gc3RvcmFnZS5EYXRhRm9ybWF0LkpQRzsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICByZXR1cm4gLTI7DQogICAgICB9DQogICAgfQ0KICAgIGRhdGFUeXBlID0gZGF0YVR5cGUudG9Mb3dlckNhc2UoKTsNCiAgICB3aW5kb3cNCiAgICAgIC5mZXRjaCh1cmwpDQogICAgICAudGhlbigocikgPT4gci5hcnJheUJ1ZmZlcigpKQ0KICAgICAgLnRoZW4oKGFycmF5QnVmZmVyKSA9PiB7DQogICAgICAgIGNvbnN0IHN0b3JhZ2UgPSB2bS5ydW50aW1lLnN0b3JhZ2U7DQogICAgICAgIC8vICBAdHMtZXhwZWN0LWVycm9yDQogICAgICAgIHZtLmFkZENvc3R1bWUoY29zdHVtZV9uYW1lICsgYC4ke2RhdGFUeXBlLnRvVXBwZXJDYXNlKCl9YCwgew0KICAgICAgICAgIG5hbWU6IGNvc3R1bWVfbmFtZSArICIiLA0KICAgICAgICAgIGFzc2V0OiBuZXcgc3RvcmFnZS5Bc3NldCgNCiAgICAgICAgICAgIGRhdGFUeXBlID09ICJzdmciDQogICAgICAgICAgICAgID8gc3RvcmFnZS5Bc3NldFR5cGUuSW1hZ2VWZWN0b3INCiAgICAgICAgICAgICAgOiBzdG9yYWdlLkFzc2V0VHlwZS5JbWFnZUJpdG1hcCwNCiAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFlFUyBJVCBJUyBTSFVUIFRTIGxvbA0KICAgICAgICAgICAgZGF0YUZvcm1hdCwNCiAgICAgICAgICAgIG5ldyBVaW50OEFycmF5KGFycmF5QnVmZmVyKSwNCiAgICAgICAgICAgIHRydWUNCiAgICAgICAgICApLA0KICAgICAgICB9KTsNCiAgICAgIH0pOw0KICAgIHJldHVybiAxOw0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZUltYWdlKG5hbWUsIHVybCwgb25jbGljaykgew0KICAgIHZhciBsaWJJdGVtID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigNCiAgICAgICdkaXZbY2xhc3NePSJsaWJyYXJ5LWl0ZW1fbGlicmFyeS1pdGVtIl0nDQogICAgKTsNCiAgICB2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIGxpYkl0ZW0uY2xhc3NMaXN0LmZvckVhY2goKGNsYXNzXykgPT4gew0KICAgICAgd3JhcHBlci5jbGFzc0xpc3QuYWRkKGNsYXNzXyk7DQogICAgfSk7DQogICAgd3JhcHBlci5yb2xlID0gImJ1dHRvbiI7DQogICAgd3JhcHBlci50YWJJbmRleCA9ICIwIjsNCiAgICB2YXIgaW1hZ2VXcmFwcGVyT3V0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICB2YXIgaW1hZ2VXcmFwcGVySW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICBsaWJJdGVtLmNoaWxkTm9kZXNbMF0uY2xhc3NMaXN0LmZvckVhY2goKGNsYXNzXykgPT4gew0KICAgICAgaW1hZ2VXcmFwcGVyT3V0ZXIuY2xhc3NMaXN0LmFkZChjbGFzc18pOw0KICAgIH0pOw0KICAgIGxpYkl0ZW0uY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLmNsYXNzTGlzdC5mb3JFYWNoKChjbGFzc18pID0+IHsNCiAgICAgIGltYWdlV3JhcHBlcklubmVyLmNsYXNzTGlzdC5hZGQoY2xhc3NfKTsNCiAgICB9KTsNCiAgICB2YXIgaW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsNCiAgICBpbWFnZS5jbGFzc0xpc3QuYWRkKA0KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaW1nW2NsYXNzXj0ibGlicmFyeS1pdGVtX2xpYnJhcnktaXRlbS1pbWFnZSJdJykNCiAgICAgICAgLmNsYXNzTGlzdFswXQ0KICAgICk7DQogICAgaW1hZ2UuZHJhZ2dhYmxlID0gZmFsc2U7DQogICAgaW1hZ2UubG9hZGluZyA9ICJsYXp5IjsNCiAgICBpbWFnZS5zcmMgPSB1cmw7DQogICAgaW1hZ2VXcmFwcGVySW5uZXIuYXBwZW5kQ2hpbGQoaW1hZ2UpOw0KICAgIGltYWdlV3JhcHBlck91dGVyLmFwcGVuZENoaWxkKGltYWdlV3JhcHBlcklubmVyKTsNCiAgICB3cmFwcGVyLmFwcGVuZENoaWxkKGltYWdlV3JhcHBlck91dGVyKTsNCiAgICB2YXIgdGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7DQogICAgdGl0bGUuY2xhc3NMaXN0LmFkZCgNCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ3NwYW5bY2xhc3NePSJsaWJyYXJ5LWl0ZW1fbGlicmFyeS1pdGVtLW5hbWUiXScpDQogICAgICAgIC5jbGFzc0xpc3RbMF0NCiAgICApOw0KICAgIHRpdGxlLmlubmVySFRNTCA9IG5hbWU7DQogICAgd3JhcHBlci5hcHBlbmRDaGlsZCh0aXRsZSk7DQogICAgd3JhcHBlci5vbmNsaWNrID0gZnVuY3Rpb24gKGUpIHsNCiAgICAgIG9uY2xpY2soZSwgdGhpcyk7DQogICAgfTsNCiAgICByZXR1cm4gd3JhcHBlcjsNCiAgfQ0KICBmdW5jdGlvbiBsb2FkQ3VzdG9tQ29zdHVtZXMobmFtZXNwYWNlKSB7DQogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7DQogICAgICBsZXQgbGlicmFyeSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgICAgICdkaXZbY2xhc3NePSJsaWJyYXJ5X2xpYnJhcnktc2Nyb2xsLWdyaWQiXScNCiAgICAgICk7DQogICAgICBmdW5jdGlvbiBhZGQoZWxlbSkgew0KICAgICAgICBsaWJyYXJ5LmNoaWxkTm9kZXNbMF0uYmVmb3JlKGVsZW0sIGxpYnJhcnkuY2hpbGROb2Rlc1swXSk7DQogICAgICB9DQogICAgICBmdW5jdGlvbiBsb2FkSW1hZ2VGbihlLCBzZWxmKSB7DQogICAgICAgIGltcG9ydEltYWdlKA0KICAgICAgICAgIHNlbGYucXVlcnlTZWxlY3RvcigiaW1nIikuc3JjLA0KICAgICAgICAgIHNlbGYucXVlcnlTZWxlY3Rvcigic3BhbiIpLmlubmVySFRNTA0KICAgICAgICApOw0KICAgICAgICBkb2N1bWVudA0KICAgICAgICAgIC5xdWVyeVNlbGVjdG9yKA0KICAgICAgICAgICAgJ2RpdltjbGFzc149Im1vZGFsX2hlYWRlci1pdGVtIl0gc3BhbltjbGFzc149ImJ1dHRvbl9vdXRsaW5lZC1idXR0b24iXScNCiAgICAgICAgICApDQogICAgICAgICAgLmNsaWNrKCk7DQogICAgICB9DQogICAgICAvL3lvdSBkb250IG5lZWQgdG8gZG8gdGhpcyBpZiB5b3UgYXJlIHN0ZWFsaW5nIGZyb20gbWUsIHdoaWNoIHBsZWFzZSBkb250IGRvIDpzb2I6DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKA0KICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShuYW1lc3BhY2UgPz8gInR3dTpjdXN0b21JbWFnZXMiKQ0KICAgICAgKTsNCiAgICAgIGlmIChmb3VuZC5sZW5ndGggPT0gMCkgcmV0dXJuOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmb3VuZC5sZW5ndGg7IGkrKykgew0KICAgICAgICBsZXQgY29zID0gZm91bmRbaV07DQogICAgICAgIGFkZChjcmVhdGVJbWFnZShjb3MubmFtZSwgY29zLnVybCwgbG9hZEltYWdlRm4pKTsNCiAgICAgIH0NCiAgICB9LCAyMDAwKTsNCiAgfQ0KICBmdW5jdGlvbiBsb2FkQ3VzdG9tQmFja2Ryb3BzKCkgew0KICAgIGxvYWRDdXN0b21Db3N0dW1lcygidHd1OmN1c3RvbUJhY2tkcm9wcyIpOw0KICB9DQogIGNvbnN0IG9ic2VydmVyQ29uZmlnID0gew0KICAgIGF0dHJpYnV0ZXM6IHRydWUsDQogICAgY2hpbGRMaXN0OiB0cnVlLA0KICAgIGNoYXJhY3RlckRhdGE6IHRydWUsDQogIH07DQogIGNvbnN0IG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoKG11dGF0aW9ucykgPT4gew0KICAgIG11dGF0aW9ucy5mb3JFYWNoKChtdXRhdGlvbikgPT4gew0KICAgICAgaWYgKG11dGF0aW9uLnR5cGUgPT0gImF0dHJpYnV0ZXMiKSByZXR1cm47DQogICAgICBpZiAobXV0YXRpb24uYWRkZWROb2Rlcy5sZW5ndGggPiAwKSB7DQogICAgICAgIGlmIChtdXRhdGlvbi5hZGRlZE5vZGVzWzBdLmNsYXNzTGlzdC5jb250YWlucygiUmVhY3RNb2RhbFBvcnRhbCIpKSB7DQogICAgICAgICAgbGV0IG1vZGFsVGl0bGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKA0KICAgICAgICAgICAgJ1tjbGFzc149Im1vZGFsX2hlYWRlci1pdGVtIl0nDQogICAgICAgICAgKS5pbm5lckhUTUw7DQogICAgICAgICAgc3dpdGNoIChtb2RhbFRpdGxlKSB7DQogICAgICAgICAgICBjYXNlICJDaG9vc2UgYSBTcHJpdGUiOg0KICAgICAgICAgICAgICBsb2FkQ3VzdG9tQ29zdHVtZXMoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBjYXNlICJDaG9vc2UgYSBCYWNrZHJvcCI6DQogICAgICAgICAgICAgIGxvYWRDdXN0b21CYWNrZHJvcHMoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBjYXNlICJDaG9vc2UgYSBDb3N0dW1lIjoNCiAgICAgICAgICAgICAgbG9hZEN1c3RvbUNvc3R1bWVzKCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0pOw0KICB9KTsNCiAgb2JzZXJ2ZXIub2JzZXJ2ZShkb2N1bWVudC5ib2R5LCBvYnNlcnZlckNvbmZpZyk7DQoNCiAgLy9TZXR1cCBvcHRpb25zIG1lbnUuDQogIGNvbnN0IHByZUFwcGVuZCA9ICJ0d1VvTV8iOw0KICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uY2xhc3NMaXN0LmFkZCgiVFd1bmxvY2tlZE1vZGFsIik7DQogIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5pbm5lckhUTUwgPSBgPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uY2xvc2UoKSI+Q2xvc2UuPC9idXR0b24+PGJyPg0KPGRpdj4NCiAgPGg0PlRXLVVubG9ja2VkIHwgdiR7VkVSU0lPTn08L2g0Pg0KICA8aHI+DQogIDxsYWJlbD48YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQudXRpbHMuZXh0TWFuKCkiPkxvYWQgZXh0ZW5zaW9uPC9idXR0b24+IDogDQogICAgPGlucHV0IHR5cGU9InVybCIgaWQ9IiR7cHJlQXBwZW5kfWxlIi8+JmVtc3A7PGxhYmVsPlVuc2FuZGJveGVkOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSIke3ByZUFwcGVuZH1sZUMiIGNoZWNrZWQvPg0KICA8L2xhYmVsPjxicj48YnV0dG9uIHN0eWxlPSJkaXNwbGF5Om5vbmU7IiBpZD0iJHtwcmVBcHBlbmR9IiBvbmNsaWNrPSJUV3VubG9ja2VkLnV0aWxzLmFkZEZvcklleHRlbnNpb24oKTt0aGlzLm5leHRFbGVtZW50U2libGluZy5yZW1vdmUoKTt0aGlzLnJlbW92ZSgpOyIgdGl0bGU9IiNCcmluZyBCYWNrIEZvciBJIj5CcmluZyBiYWNrIHRoZSBGb3IgSSBibG9jazwvYnV0dG9uPjxicj48aHI+DQogIDxidXR0b24gaWQ9IiR7cHJlQXBwZW5kfXNNcyI+RGlzYWJsZTwvYnV0dG9uPiB2bSBzZWN1cml0eSBtYW5hZ2VyPGhyPg0KICA8YnV0dG9uIG9uY2xpY2s9IlRXdW5sb2NrZWQuZXh0TWFuYWdlci5zaG93KCk7Ij5NYW5hZ2UgY3VzdG9tIGZlYXR1cmVkIGV4dGVuc2lvbnM8L2J1dHRvbj48YnI+DQogIDxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLnNob3coKTsiPk1hbmFnZSBjdXN0b20gY29zdHVtZXM8L2J1dHRvbj48YnI+DQogIDxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5kcm9wTWFuYWdlci5zaG93KCk7Ij5NYW5hZ2UgY3VzdG9tIGJhY2tkcm9wczwvYnV0dG9uPjxicj4NCiAgPGJ1dHRvbiBvbmNsaWNrPSJ2bS5ydW50aW1lLmV4dGVuc2lvbk1hbmFnZXIucmVmcmVzaEJsb2NrcygpIj5SZWZyZXNoIEJsb2NrczwvYnV0dG9uPjxicj4NCiAgPGJ1dHRvbiBvbmNsaWNrPSJ2bS5yZWZyZXNoV29ya3NwYWNlKCkiPlJlZnJlc2ggV29ya3NwYWNlPC9idXR0b24+DQogIDxocj4NCiAgU3VibWl0IGFuIGV4dGVuc2lvbiB0aGF0IGNhbm5vdCBiZSBvbiB0aGUgZ2FsbGVyeSB0bzogPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL1N1cnZFeGUxUGMvdW5zYWZlLWV4dGVuc2lvbnMiPkhFUkUsIENsaWNrIG1lISE8L2E+DQogIDxocj4NCjwvZGl2PmA7DQogIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5pZCA9ICJUV3VubG9ja2VkLU1vZGFsRGl2IjsNCiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0pOw0KICAvLyAqY291Z2gqIGltYSBjb3B5IHBhc3RlIGZvciBiYWNrZHJvcHMsIGFuZCBzb3VuZHMsIGFuZCBleHRlbnNpb25zLi4uICpjb3VnaCoNCiAgLy9CYWNrZHJvcCBsaWJyYXJ5IGFkZGVyIG1vZGFsDQogIFRXdW5sb2NrZWQuZHJvcE1hbmFnZXIgPSB7DQogICAgbWVudU9wZW46IGZhbHNlLA0KICAgIGxzSWQ6ICJ0d3U6Y3VzdG9tQmFja2Ryb3BzIiwNCiAgICBlbGVtOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaWFsb2ciKSwNCiAgICBwb3AoKSB7DQogICAgICB0aGlzLmVsZW0ucmVtb3ZlKCk7DQogICAgfSwNCiAgICBjbG9zZSgpIHsNCiAgICAgIHRoaXMuZWxlbS5jbG9zZSgpOw0KICAgICAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLnNob3dNb2RhbCgpOw0KICAgIH0sDQogICAgc2hvdygpIHsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5jbG9zZSgpOw0KICAgICAgdGhpcy5lbGVtLnNob3dNb2RhbCgpOw0KICAgIH0sDQogICAgcmVmcmVzaE1lbnUoKSB7DQogICAgICBjb25zdCBtZW51QnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgYnV0dG9uIyR7cHJlQXBwZW5kfWRyb3BNZW51QnRuYCk7DQogICAgICBpZiAoVFd1bmxvY2tlZC5kcm9wTWFuYWdlci5lbGVtLm9wZW4gJiYgdGhpcy5tZW51T3Blbikgew0KICAgICAgICBtZW51QnRuLmNsaWNrKCk7DQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gew0KICAgICAgICAgIG1lbnVCdG4uY2xpY2soKTsNCiAgICAgICAgfSwgMTAwKTsNCiAgICAgIH0NCiAgICB9LA0KICAgIGFkZCgpIHsNCiAgICAgIGxldCBpTmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGlucHV0IyR7cHJlQXBwZW5kfWRyb3BpTmFtZWApOw0KICAgICAgbGV0IGlVcmwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBpbnB1dCMke3ByZUFwcGVuZH1kcm9waVVybGApOw0KICAgICAgdmFyIHRtcCA9IGlOYW1lLnZhbHVlOw0KICAgICAgaU5hbWUudmFsdWUgPSAiIjsNCiAgICAgIGlOYW1lID0gdG1wOw0KICAgICAgdG1wID0gaVVybC52YWx1ZTsNCiAgICAgIGlVcmwudmFsdWUgPSAiIjsNCiAgICAgIGlVcmwgPSB0bXA7DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNJZCkpOw0KICAgICAgZm91bmQucHVzaCh7IG5hbWU6IGlOYW1lLCB1cmw6IGlVcmwgfSk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzSWQsIEpTT04uc3RyaW5naWZ5KGZvdW5kKSk7DQogICAgICB0aGlzLnJlZnJlc2hNZW51KCk7DQogICAgfSwNCiAgICBnZXRVbCgpIHsNCiAgICAgIGxldCBpdGVtcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInVsIik7DQogICAgICBpZiAoIWxvY2FsU3RvcmFnZS5oYXNPd25Qcm9wZXJ0eSh0aGlzLmxzSWQpKQ0KICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzSWQsIEpTT04uc3RyaW5naWZ5KFtdKSk7DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNJZCkpOw0KICAgICAgY29uc3Qgbm9JdGVtcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsNCiAgICAgIG5vSXRlbXMuaW5uZXJIVE1MID0gIiZuYnNwOyZuYnNwO05vIGJhY2tkcm9wcyBmb3VuZCwgdHJ5IGFkZGluZyBzb21lISI7DQogICAgICBpZiAoZm91bmQubGVuZ3RoID09IDApIHJldHVybiBub0l0ZW1zOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmb3VuZC5sZW5ndGg7IGkrKykgew0KICAgICAgICBsZXQgZHJvcCA9IGZvdW5kW2ldOw0KICAgICAgICB2YXIgdG1wMiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7DQogICAgICAgIHRtcDIuaW5uZXJIVE1MID0gYCR7ZHJvcC5uYW1lfSZuYnNwOyZuYnNwOzxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5kcm9wTWFuYWdlci5wb3BJdGVtKCR7aX0pIj5SZW1vdmU8L2J1dHRvbj5gOw0KICAgICAgICBpdGVtcy5hcHBlbmRDaGlsZCh0bXAyKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBpdGVtczsNCiAgICB9LA0KICAgIHBvcEl0ZW0obnVtKSB7DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNJZCkpOw0KICAgICAgZm91bmQucG9wKG51bSk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzSWQsIEpTT04uc3RyaW5naWZ5KGZvdW5kKSk7DQogICAgICB0aGlzLnJlZnJlc2hNZW51KCk7DQogICAgfSwNCiAgICB1cGRhdGVNZW51KCkgew0KICAgICAgbGV0IG1lbnVCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBidXR0b24jJHtwcmVBcHBlbmR9ZHJvcE1lbnVCdG5gKTsNCiAgICAgIGxldCBtZW51ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgZGl2IyR7cHJlQXBwZW5kfWRyb3BNZW51YCk7DQogICAgICBpZiAobWVudS5zdHlsZS5kaXNwbGF5ID09ICJub25lIikgew0KICAgICAgICB0aGlzLm1lbnVPcGVuID0gdHJ1ZTsNCiAgICAgICAgbWVudUJ1dHRvbi5pbm5lckhUTUwgPSAiSGlkZSBtZW51IjsNCiAgICAgICAgbWVudS5zdHlsZS5kaXNwbGF5ID0gIiI7DQogICAgICAgIHdoaWxlIChtZW51Lmhhc0NoaWxkTm9kZXMoKSkgew0KICAgICAgICAgIG1lbnUuZmlyc3RDaGlsZC5yZW1vdmUoKTsNCiAgICAgICAgfQ0KICAgICAgICBtZW51LmFwcGVuZENoaWxkKHRoaXMuZ2V0VWwoKSk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLm1lbnVPcGVuID0gZmFsc2U7DQogICAgICAgIG1lbnVCdXR0b24uaW5uZXJIVE1MID0gIlNob3cgbWVudSI7DQogICAgICAgIG1lbnUuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICAgIH0NCiAgICB9LA0KICB9Ow0KICBUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLmVsZW0uaWQgPSAiVFd1bmxvY2tlZC1kcm9wTWFuYWdlciI7DQogIFRXdW5sb2NrZWQuZHJvcE1hbmFnZXIuZWxlbS5pbm5lckhUTUwgPSBgPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLmNsb3NlKCkiPkJhY2s8L2J1dHRvbj48aHI+DQogIDxoMz5BZGQgYSBjdXN0b20gYmFja2Ryb3AgaW1hZ2U6PC9oMz4NCiAgPGxhYmVsPkltYWdlIG5hbWU6IDxpbnB1dCBpZD0iJHtwcmVBcHBlbmR9ZHJvcGlOYW1lIi8+PGJyPjwvbGFiZWw+DQogIDxsYWJlbD5JbWFnZSB1cmw6IDxpbnB1dCBpZD0iJHtwcmVBcHBlbmR9ZHJvcGlVcmwiLz48YnI+PC9sYWJlbD4NCiAgPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLmFkZCgpIj5BZGQ8L2J1dHRvbj48aHI+DQogIDxzcGFuPkN1c3RvbSBpbWFnZXM6IDxkaXYgaWQ9IiR7cHJlQXBwZW5kfWRyb3BNZW51IiBzdHlsZT0iZGlzcGxheTpub25lOyI+PC9kaXY+DQogIDxidXR0b24gaWQ9IiR7cHJlQXBwZW5kfWRyb3BNZW51QnRuIiBvbmNsaWNrPSJUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLnVwZGF0ZU1lbnUoKSI+U2hvdyBtZW51PC9idXR0b24+PGJyPjwvc3Bhbj5gOw0KICBUV3VubG9ja2VkLmRyb3BNYW5hZ2VyLmVsZW0uY2xhc3NMaXN0LmFkZCgiVFd1bmxvY2tlZE1vZGFsIik7DQogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoVFd1bmxvY2tlZC5kcm9wTWFuYWdlci5lbGVtKTsNCiAgLy9Db3N0dW1lIGxpYnJhcnkgYWRkZXIgbW9kYWwNCiAgVFd1bmxvY2tlZC5jb3NNYW5hZ2VyID0gew0KICAgIG1lbnVPcGVuOiBmYWxzZSwNCiAgICBlbGVtOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaWFsb2ciKSwNCiAgICBsc0lkOiAidHd1OmN1c3RvbUltYWdlcyIsDQogICAgcG9wKCkgew0KICAgICAgdGhpcy5lbGVtLnJlbW92ZSgpOw0KICAgIH0sDQogICAgY2xvc2UoKSB7DQogICAgICB0aGlzLmVsZW0uY2xvc2UoKTsNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMub3B0aW9uc0VsbS5zaG93TW9kYWwoKTsNCiAgICB9LA0KICAgIHNob3coKSB7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uY2xvc2UoKTsNCiAgICAgIHRoaXMuZWxlbS5zaG93TW9kYWwoKTsNCiAgICB9LA0KICAgIHJlZnJlc2hNZW51KCkgew0KICAgICAgY29uc3QgbWVudUJ0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGJ1dHRvbiMke3ByZUFwcGVuZH1jb3NNZW51QnRuYCk7DQogICAgICBpZiAoVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLmVsZW0ub3BlbiAmJiB0aGlzLm1lbnVPcGVuKSB7DQogICAgICAgIG1lbnVCdG4uY2xpY2soKTsNCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7DQogICAgICAgICAgbWVudUJ0bi5jbGljaygpOw0KICAgICAgICB9LCAxMDApOw0KICAgICAgfQ0KICAgIH0sDQogICAgYWRkKCkgew0KICAgICAgbGV0IGlOYW1lID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgaW5wdXQjJHtwcmVBcHBlbmR9Y29zaU5hbWVgKTsNCiAgICAgIGxldCBpVXJsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgaW5wdXQjJHtwcmVBcHBlbmR9Y29zaVVybGApOw0KICAgICAgdmFyIHRtcCA9IGlOYW1lLnZhbHVlOw0KICAgICAgaU5hbWUudmFsdWUgPSAiIjsNCiAgICAgIGlOYW1lID0gdG1wOw0KICAgICAgdG1wID0gaVVybC52YWx1ZTsNCiAgICAgIGlVcmwudmFsdWUgPSAiIjsNCiAgICAgIGlVcmwgPSB0bXA7DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNJZCkpOw0KICAgICAgZm91bmQucHVzaCh7IG5hbWU6IGlOYW1lLCB1cmw6IGlVcmwgfSk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzSWQsIEpTT04uc3RyaW5naWZ5KGZvdW5kKSk7DQogICAgICB0aGlzLnJlZnJlc2hNZW51KCk7DQogICAgfSwNCiAgICBnZXRVbCgpIHsNCiAgICAgIGxldCBpdGVtcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInVsIik7DQogICAgICBpZiAoIWxvY2FsU3RvcmFnZS5oYXNPd25Qcm9wZXJ0eSh0aGlzLmxzSWQpKQ0KICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzSWQsIEpTT04uc3RyaW5naWZ5KFtdKSk7DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNJZCkpOw0KICAgICAgY29uc3Qgbm9JdGVtcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsNCiAgICAgIG5vSXRlbXMuaW5uZXJIVE1MID0gIiZuYnNwOyZuYnNwO05vIGNvc3R1bWVzIGZvdW5kLCB0cnkgYWRkaW5nIHNvbWUhIjsNCiAgICAgIGlmIChmb3VuZC5sZW5ndGggPT0gMCkgcmV0dXJuIG5vSXRlbXM7DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZvdW5kLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGxldCBjb3MgPSBmb3VuZFtpXTsNCiAgICAgICAgdmFyIHRtcDIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOw0KICAgICAgICB0bXAyLmlubmVySFRNTCA9IGAke2Nvcy5uYW1lfSZuYnNwOyZuYnNwOzxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLnBvcEl0ZW0oJHtpfSkiPlJlbW92ZTwvYnV0dG9uPmA7DQogICAgICAgIGl0ZW1zLmFwcGVuZENoaWxkKHRtcDIpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIGl0ZW1zOw0KICAgIH0sDQogICAgcG9wSXRlbShudW0pIHsNCiAgICAgIGxldCBmb3VuZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sc0lkKSk7DQogICAgICBmb3VuZC5wb3AobnVtKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMubHNJZCwgSlNPTi5zdHJpbmdpZnkoZm91bmQpKTsNCiAgICAgIHRoaXMucmVmcmVzaE1lbnUoKTsNCiAgICB9LA0KICAgIHVwZGF0ZU1lbnUoKSB7DQogICAgICBsZXQgbWVudUJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGJ1dHRvbiMke3ByZUFwcGVuZH1jb3NNZW51QnRuYCk7DQogICAgICBsZXQgbWVudSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGRpdiMke3ByZUFwcGVuZH1jb3NNZW51YCk7DQogICAgICBpZiAobWVudS5zdHlsZS5kaXNwbGF5ID09ICJub25lIikgew0KICAgICAgICB0aGlzLm1lbnVPcGVuID0gdHJ1ZTsNCiAgICAgICAgbWVudUJ1dHRvbi5pbm5lckhUTUwgPSAiSGlkZSBtZW51IjsNCiAgICAgICAgbWVudS5zdHlsZS5kaXNwbGF5ID0gIiI7DQogICAgICAgIHdoaWxlIChtZW51Lmhhc0NoaWxkTm9kZXMoKSkgew0KICAgICAgICAgIG1lbnUuZmlyc3RDaGlsZC5yZW1vdmUoKTsNCiAgICAgICAgfQ0KICAgICAgICBtZW51LmFwcGVuZENoaWxkKHRoaXMuZ2V0VWwoKSk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLm1lbnVPcGVuID0gZmFsc2U7DQogICAgICAgIG1lbnVCdXR0b24uaW5uZXJIVE1MID0gIlNob3cgbWVudSI7DQogICAgICAgIG1lbnUuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICAgIH0NCiAgICB9LA0KICB9Ow0KICBUV3VubG9ja2VkLmNvc01hbmFnZXIuZWxlbS5pZCA9ICJUV3VubG9ja2VkLWNvc01hbmFnZXIiOw0KICBUV3VubG9ja2VkLmNvc01hbmFnZXIuZWxlbS5pbm5lckhUTUwgPSBgPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmNvc01hbmFnZXIuY2xvc2UoKSI+QmFjazwvYnV0dG9uPjxocj4NCjxoMz5BZGQgYSBjdXN0b20gc3ByaXRlIC8gY29zdHVtZSBpbWFnZTo8L2gzPg0KPGxhYmVsPkltYWdlIG5hbWU6IDxpbnB1dCBpZD0iJHtwcmVBcHBlbmR9Y29zaU5hbWUiLz48YnI+PC9sYWJlbD4NCjxsYWJlbD5JbWFnZSB1cmw6IDxpbnB1dCBpZD0iJHtwcmVBcHBlbmR9Y29zaVVybCIvPjxicj48L2xhYmVsPg0KPGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmNvc01hbmFnZXIuYWRkKCkiPkFkZDwvYnV0dG9uPjxocj4NCjxzcGFuPkN1c3RvbSBpbWFnZXM6IDxkaXYgaWQ9IiR7cHJlQXBwZW5kfWNvc01lbnUiIHN0eWxlPSJkaXNwbGF5Om5vbmU7Ij48L2Rpdj4NCjxidXR0b24gaWQ9IiR7cHJlQXBwZW5kfWNvc01lbnVCdG4iIG9uY2xpY2s9IlRXdW5sb2NrZWQuY29zTWFuYWdlci51cGRhdGVNZW51KCkiPlNob3cgbWVudTwvYnV0dG9uPjxicj48L3NwYW4+YDsNCiAgVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLmVsZW0uY2xhc3NMaXN0LmFkZCgiVFd1bmxvY2tlZE1vZGFsIik7DQogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoVFd1bmxvY2tlZC5jb3NNYW5hZ2VyLmVsZW0pOw0KICAvL2V4dGVuc2lvbiBsaWJyYXJ5IGFkZGVyIG1vZGFsDQogIFRXdW5sb2NrZWQuZXh0TWFuYWdlciA9IHsNCiAgICBtZW51T3BlbjogZmFsc2UsDQogICAgZWxlbTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGlhbG9nIiksDQogICAgbHNJZDogInR3dTpjdXN0b21FeHRlbnNpb25zIiwNCiAgICBsc1NJZDogInR3dTpjdXN0b21FeHRlbnNpb25zU2V0dGluZ3MiLA0KICAgIHBvcCgpIHsNCiAgICAgIHRoaXMuZWxlbS5yZW1vdmUoKTsNCiAgICB9LA0KICAgIGNsb3NlKCkgew0KICAgICAgdGhpcy5lbGVtLmNsb3NlKCk7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLm9wdGlvbnNFbG0uc2hvd01vZGFsKCk7DQogICAgfSwNCiAgICBzaG93KCkgew0KICAgICAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLmNsb3NlKCk7DQogICAgICB0aGlzLmVsZW0uc2hvd01vZGFsKCk7DQogICAgfSwNCiAgICByZWZyZXNoTWVudSgpIHsNCiAgICAgIGNvbnN0IG1lbnVCdG4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBidXR0b24jJHtwcmVBcHBlbmR9ZXh0TWVudUJ0bmApOw0KICAgICAgaWYgKFRXdW5sb2NrZWQuZXh0TWFuYWdlci5lbGVtLm9wZW4gJiYgdGhpcy5tZW51T3Blbikgew0KICAgICAgICBtZW51QnRuLmNsaWNrKCk7DQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gew0KICAgICAgICAgIG1lbnVCdG4uY2xpY2soKTsNCiAgICAgICAgfSwgMTAwKTsNCiAgICAgIH0NCiAgICB9LA0KICAgIGFkZCgpIHsNCiAgICAgIGxldCBpTmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGlucHV0IyR7cHJlQXBwZW5kfWV4dGlOYW1lYCk7DQogICAgICBsZXQgaVVybCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYGlucHV0IyR7cHJlQXBwZW5kfWV4dGlVcmxgKTsNCiAgICAgIGxldCBhVXJsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgaW5wdXQjJHtwcmVBcHBlbmR9ZXh0YVVybGApOw0KICAgICAgbGV0IGJVcmwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGB0ZXh0YXJlYSMke3ByZUFwcGVuZH1leHRiVXJsYCk7DQogICAgICB2YXIgdG1wID0gaU5hbWUudmFsdWU7DQogICAgICBpTmFtZS52YWx1ZSA9ICIiOw0KICAgICAgaU5hbWUgPSB0bXA7DQogICAgICB0bXAgPSBpVXJsLnZhbHVlOw0KICAgICAgaVVybC52YWx1ZSA9ICIiOw0KICAgICAgaVVybCA9IHRtcDsNCiAgICAgIHRtcCA9IGFVcmwudmFsdWU7DQogICAgICBhVXJsLnZhbHVlID0gIiI7DQogICAgICBhVXJsID0gdG1wOw0KICAgICAgdG1wID0gYlVybC52YWx1ZTsNCiAgICAgIGJVcmwudmFsdWUgPSAiIjsNCiAgICAgIGJVcmwgPSB0bXA7DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNJZCkpOw0KICAgICAgZm91bmQucHVzaCh7IG5hbWU6IGlOYW1lLCB1cmw6IGlVcmwsIGltYWdlX3VybDogYVVybCwgZGVzY3JpcHRpb246IGJVcmwgfSk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzSWQsIEpTT04uc3RyaW5naWZ5KGZvdW5kKSk7DQogICAgICB0aGlzLnJlZnJlc2hNZW51KCk7DQogICAgfSwNCiAgICBnZXRVbCgpIHsNCiAgICAgIGxldCBpdGVtcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInVsIik7DQogICAgICBpZiAoIWxvY2FsU3RvcmFnZS5oYXNPd25Qcm9wZXJ0eSh0aGlzLmxzSWQpKQ0KICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzSWQsIEpTT04uc3RyaW5naWZ5KFtdKSk7DQogICAgICBsZXQgZm91bmQgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubHNJZCkpOw0KICAgICAgY29uc3Qgbm9JdGVtcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsNCiAgICAgIG5vSXRlbXMuaW5uZXJIVE1MID0gIiZuYnNwOyZuYnNwO05vIGV4dGVuc2lvbnMgZm91bmQsIHRyeSBhZGRpbmcgc29tZSEiOw0KICAgICAgaWYgKGZvdW5kLmxlbmd0aCA9PSAwKSByZXR1cm4gbm9JdGVtczsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZm91bmQubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgbGV0IGV4dCA9IGZvdW5kW2ldOw0KICAgICAgICB2YXIgdG1wMiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7DQogICAgICAgIHRtcDIuaW5uZXJIVE1MID0gYCR7ZXh0Lm5hbWV9Jm5ic3A7Jm5ic3A7PGJ1dHRvbiBvbmNsaWNrPSJUV3VubG9ja2VkLmV4dE1hbmFnZXIucG9wSXRlbSgke2l9KSI+UmVtb3ZlPC9idXR0b24+YDsNCiAgICAgICAgaXRlbXMuYXBwZW5kQ2hpbGQodG1wMik7DQogICAgICB9DQogICAgICByZXR1cm4gaXRlbXM7DQogICAgfSwNCiAgICBwb3BJdGVtKG51bSkgew0KICAgICAgbGV0IGZvdW5kID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzSWQpKTsNCiAgICAgIGZvdW5kLnBvcChudW0pOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc0lkLCBKU09OLnN0cmluZ2lmeShmb3VuZCkpOw0KICAgICAgdGhpcy5yZWZyZXNoTWVudSgpOw0KICAgIH0sDQogICAgdXBkYXRlTWVudSgpIHsNCiAgICAgIGxldCBtZW51QnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgYnV0dG9uIyR7cHJlQXBwZW5kfWV4dE1lbnVCdG5gKTsNCiAgICAgIGxldCBtZW51ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgZGl2IyR7cHJlQXBwZW5kfWV4dE1lbnVgKTsNCiAgICAgIGlmIChtZW51LnN0eWxlLmRpc3BsYXkgPT0gIm5vbmUiKSB7DQogICAgICAgIHRoaXMubWVudU9wZW4gPSB0cnVlOw0KICAgICAgICBtZW51QnV0dG9uLmlubmVySFRNTCA9ICJIaWRlIG1lbnUiOw0KICAgICAgICBtZW51LnN0eWxlLmRpc3BsYXkgPSAiIjsNCiAgICAgICAgd2hpbGUgKG1lbnUuaGFzQ2hpbGROb2RlcygpKSB7DQogICAgICAgICAgbWVudS5maXJzdENoaWxkLnJlbW92ZSgpOw0KICAgICAgICB9DQogICAgICAgIG1lbnUuYXBwZW5kQ2hpbGQodGhpcy5nZXRVbCgpKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMubWVudU9wZW4gPSBmYWxzZTsNCiAgICAgICAgbWVudUJ1dHRvbi5pbm5lckhUTUwgPSAiU2hvdyBtZW51IjsNCiAgICAgICAgbWVudS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgICAgfQ0KICAgIH0sDQogICAgZ2V0TWFya3MoKSB7DQogICAgICBsZXQgZm91bmQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmxzU0lkKTsNCiAgICAgIGlmIChmb3VuZCA9PSB1bmRlZmluZWQgfHwgZm91bmQgPT0gbnVsbCB8fCBmb3VuZCA9PSAndW5kZWZpbmVkJykgZm91bmQgPSB7DQogICAgICAgIG15R2FsbGVyeTogZmFsc2UsDQogICAgICAgIHNwR2FsbGVyeTogZmFsc2UNCiAgICAgIH0NCiAgICAgIGlmICh0eXBlb2YgZm91bmQgIT09ICdvYmplY3QnKSBmb3VuZCA9IEpTT04ucGFyc2UoZm91bmQpOw0KICAgICAgaWYgKCFmb3VuZC5oYXNPd25Qcm9wZXJ0eSgnbXlHYWxsZXJ5JykpIGZvdW5kLm15R2FsbGVyeSA9IGZhbHNlOw0KICAgICAgaWYgKCFmb3VuZC5oYXNPd25Qcm9wZXJ0eSgnc3BHYWxsZXJ5JykpIGZvdW5kLnNwR2FsbGVyeSA9IGZhbHNlOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sc1NJZCwgSlNPTi5zdHJpbmdpZnkoZm91bmQpKTsNCiAgICAgIHJldHVybiBmb3VuZDsNCiAgICB9LA0KICAgIHVwZGF0ZUNoZWNrbWFya3MoKSB7DQogICAgICBsZXQgZm91bmQgPSB0aGlzLmdldE1hcmtzKCk7DQogICAgICBmb3VuZC5teUdhbGxlcnkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBpbnB1dCMke3ByZUFwcGVuZH1leHRnTG9hZE1pbmVgKS5jaGVja2VkOw0KICAgICAgZm91bmQuc3BHYWxsZXJ5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgaW5wdXQjJHtwcmVBcHBlbmR9ZXh0Z0xvYWRTUGApLmNoZWNrZWQ7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmxzU0lkLCBKU09OLnN0cmluZ2lmeShmb3VuZCkpOw0KICAgIH0sDQogICAgZ2V0Q2hlY2soY2hlY2spIHsNCiAgICAgIGxldCBmb3VuZCA9IHRoaXMuZ2V0TWFya3MoKTsNCiAgICAgIHJldHVybiBmb3VuZFtjaGVja107DQogICAgfSwNCiAgfTsNCiAgVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmVsZW0uaWQgPSAiVFd1bmxvY2tlZC1leHRNYW5hZ2VyIjsNCiAgVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmVsZW0uaW5uZXJIVE1MID0gYDxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmNsb3NlKCkiPkJhY2s8L2J1dHRvbj48aHI+DQo8aDM+QWRkIGEgY3VzdG9tIGV4dGVuc2lvbjwvaDM+DQo8bGFiZWw+RXh0ZW5zaW9uIG5hbWU6IDxpbnB1dCBpZD0iJHtwcmVBcHBlbmR9ZXh0aU5hbWUiLz48YnI+PC9sYWJlbD4NCjxsYWJlbD5FeHRlbnNpb24gdXJsOiA8aW5wdXQgaWQ9IiR7cHJlQXBwZW5kfWV4dGlVcmwiLz48YnI+PC9sYWJlbD4NCjxsYWJlbD5FeHRlbnNpb24gaW1hZ2UgdXJsOiA8aW5wdXQgaWQ9IiR7cHJlQXBwZW5kfWV4dGFVcmwiLz48YnI+PC9sYWJlbD4NCjxsYWJlbD5FeHRlbnNpb24gZGVzY3JpcHRpb246IDx0ZXh0YXJlYSBpZD0iJHtwcmVBcHBlbmR9ZXh0YlVybCI+PC90ZXh0YXJlYT48YnI+PC9sYWJlbD4NCjxidXR0b24gb25jbGljaz0iVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmFkZCgpIj5BZGQ8L2J1dHRvbj48aHI+DQo8c3Bhbj5DdXN0b20gZXh0ZW5zaW9uczogPGRpdiBpZD0iJHtwcmVBcHBlbmR9ZXh0TWVudSIgc3R5bGU9ImRpc3BsYXk6bm9uZTsiPjwvZGl2Pg0KPGJ1dHRvbiBpZD0iJHtwcmVBcHBlbmR9ZXh0TWVudUJ0biIgb25jbGljaz0iVFd1bmxvY2tlZC5leHRNYW5hZ2VyLnVwZGF0ZU1lbnUoKSI+U2hvdyBtZW51PC9idXR0b24+PGJyPjwvc3Bhbj4NCjxsYWJlbD5hdXRvIGxvYWQgZnJvbSA8YSBocmVmPSJodHRwczovL3N1cnYuaXMtYS5kZXYvdW5zYWZlLWV4dGVuc2lvbnMvIj51bnNhZmUtZ2FsbGVyeTwvYT46IDxpbnB1dCBpZD0iJHtwcmVBcHBlbmR9ZXh0Z0xvYWRNaW5lIiB0eXBlPSJjaGVja2JveCIkeyhUV3VubG9ja2VkLmV4dE1hbmFnZXIuZ2V0Q2hlY2soJ215R2FsbGVyeScpID8gJyBjaGVja2VkJyA6ICcnKX0gb25jbGljaz0iVFd1bmxvY2tlZC5leHRNYW5hZ2VyLnVwZGF0ZUNoZWNrbWFya3MoKSIvPjxicj48L2xhYmVsPg0KPGxhYmVsPmF1dG8gbG9hZCBmcm9tIDxhIGhyZWY9Imh0dHBzOi8vc3Vydi5pcy1hLmRldi91bnNhZmUtZXh0ZW5zaW9ucy8iPnNoYXJrcG9vbHMgZ2FsbGVyeTwvYT46IDxpbnB1dCBpZD0iJHtwcmVBcHBlbmR9ZXh0Z0xvYWRTUCIgdHlwZT0iY2hlY2tib3giJHsoVFd1bmxvY2tlZC5leHRNYW5hZ2VyLmdldENoZWNrKCdzcEdhbGxlcnknKSA/ICcgY2hlY2tlZCcgOiAnJyl9IG9uY2xpY2s9IlRXdW5sb2NrZWQuZXh0TWFuYWdlci51cGRhdGVDaGVja21hcmtzKCkiLz48YnI+PC9sYWJlbD5gOw0KICBUV3VubG9ja2VkLmV4dE1hbmFnZXIuZWxlbS5jbGFzc0xpc3QuYWRkKCJUV3VubG9ja2VkTW9kYWwiKTsNCiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChUV3VubG9ja2VkLmV4dE1hbmFnZXIuZWxlbSk7DQogIGNvbnN0IGxvYWRFeHRlbnNpb25JbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHByZUFwcGVuZCArICJsZSIpOw0KICBjb25zdCBsb2FkRXh0ZW5zaW9uX3Vuc2FuZGJveGVkQ2hlY2sgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgNCiAgICBwcmVBcHBlbmQgKyAibGVDIg0KICApOw0KICBjb25zdCBzZWN1cml0eU1hbmFnZXJTd2l0Y2hCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChwcmVBcHBlbmQgKyAic01zIik7DQogIHNlY3VyaXR5TWFuYWdlclN3aXRjaEJ0bi5vbmNsaWNrID0gZnVuY3Rpb24gKCkgew0KICAgIGlmICh0aGlzLmlubmVyVGV4dCA9PSAiRGlzYWJsZSIpIHsNCiAgICAgIHRoaXMuaW5uZXJUZXh0ID0gIkVuYWJsZSI7DQogICAgICBUV3VubG9ja2VkLmRpc2FibGVQZXJtaXNzaW9uU2VjdXJpdHkoKTsNCiAgICB9IGVsc2Ugew0KICAgICAgdGhpcy5pbm5lclRleHQgPSAiRGlzYWJsZSI7DQogICAgICBUV3VubG9ja2VkLnJlc3RvcmVQZXJtaXNzaW9uU2VjdXJpdHkoKTsNCiAgICB9DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMuZXh0TWFuID0gZnVuY3Rpb24gKCkgew0KICAgIGlmIChsb2FkRXh0ZW5zaW9uX3Vuc2FuZGJveGVkQ2hlY2suY2hlY2tlZCkgew0KICAgICAgVFd1bmxvY2tlZC5sb2FkRXh0ZW5zaW9uVW5zYW5kYm94ZWQobG9hZEV4dGVuc2lvbklucHV0LnZhbHVlKTsNCiAgICB9IGVsc2Ugew0KICAgICAgdm0ucnVudGltZS5leHRlbnNpb25NYW5hZ2VyLmxvYWRFeHRlbnNpb25VUkwobG9hZEV4dGVuc2lvbklucHV0LnZhbHVlKTsNCiAgICB9DQogIH07DQoNCiAgVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24gPSB7fTsNCiAgVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24uZG9udEZpeEJ1dHRvbiA9IFRXdW5sb2NrZWQuaXNEZXNrdG9wOw0KICBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbi5vbGRIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsNCiAgVFd1bmxvY2tlZC51dGlscy5VcGRhdGVCdXR0b24udXBkYXRlID0gZnVuY3Rpb24gKCkgew0KICAgIGlmIChUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbi5kb250Rml4QnV0dG9uKSB7DQogICAgICBjbGVhckludGVydmFsKFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uLmJ0bkl2bCk7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbi5idG5JdmwgPSAic3RvcHBlZCI7DQogICAgICBUV3VubG9ja2VkLnV0aWxzLlVwZGF0ZUJ1dHRvbiA9ICIiOw0KICAgICAgZGVsZXRlIFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBpZiAoDQogICAgICAhVFd1bmxvY2tlZC5pc0Rlc2t0b3AgJiYNCiAgICAgIChkb2N1bWVudC5sb2NhdGlvbi5ocmVmICE9IFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uLm9sZEhyZWYgfHwNCiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIlRXdW5sb2NrZWQtTmF2QnRuIikgPT0gbnVsbCkNCiAgICApIHsNCiAgICAgIFRXdW5sb2NrZWQub3BlbkJ1dHRvbi5hZGRTZWxmVG9OYXYoKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQogIH07DQogIFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uLmJ0bkl2bCA9IHNldEludGVydmFsKA0KICAgIFRXdW5sb2NrZWQudXRpbHMuVXBkYXRlQnV0dG9uLnVwZGF0ZSwNCiAgICA1MA0KICApOw0KICBUV3VubG9ja2VkLnV0aWxzLnVwZGF0ZVRpY2sgPSBmdW5jdGlvbiAoKSB7DQogICAgaWYgKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvbltjbGFzc149Imd1aV9leHRlbnNpb24tYnV0dG9uIl0nKSkNCiAgICAgIFRXdW5sb2NrZWQudXRpbHMuZXh0QnRuQWRkTGlzdGVuKCk7DQogICAgbGV0IHRvb2xib3ggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJkaXYuYmxvY2tseVRvb2xib3hEaXYiKTsNCiAgICBpZiAodG9vbGJveCAmJiB0b29sYm94Lm9uY29udGV4dG1lbnUgPT0gbnVsbCkNCiAgICAgIHRvb2xib3gub25jb250ZXh0bWVudSA9IHRvb2xib3hNZW51Ow0KICB9Ow0KICBUV3VubG9ja2VkLnV0aWxzLnVwZGF0ZUl2bCA9IHNldEludGVydmFsKFRXdW5sb2NrZWQudXRpbHMudXBkYXRlVGljaywgNTApOw0KDQogIC8vVVNNDQogIFRXdW5sb2NrZWQuYXR0ZW1wdFJlbW92YWxPZlVTTXNjcmlwdCA9IGZ1bmN0aW9uICgpIHsNCiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiVFd1bmxvY2tlZC1TY3JpcHQtIiArIFRXdW5sb2NrZWQudG9wTG9hZGVyKTsNCiAgfTsNCg0KICAvL0FkZCB0aGUgbW9kYWwuDQogIFRXdW5sb2NrZWQub3BlbkJ1dHRvbiA9IFRXdW5sb2NrZWQuYWRkTWVudUJ0bigiVFctVW5sb2NrZWQiLCBmdW5jdGlvbiAoKSB7DQogICAgVFd1bmxvY2tlZC51dGlscy5vcHRpb25zRWxtLnNob3dNb2RhbCgpOw0KICB9KTsNCiAgVFd1bmxvY2tlZC5vcGVuQnV0dG9uLnNldElEKCJUV3VubG9ja2VkLU5hdkJ0biIpOw0KDQogIC8vTG9hZCBleHRlbnNpb25zIG91dCBvZiB1cmwNCiAgaWYgKFRXdW5sb2NrZWQudXRpbHMubG9hZFVleHRzRnJvbVVybCh0cnVlKSkgew0KICAgIFRXdW5sb2NrZWQudXRpbHMubG9hZFVyaUV4dEJ0biA9IFRXdW5sb2NrZWQuYWRkTWVudUJ0bigNCiAgICAgICJMb2FkIFVSTCBleHRlbnNpb25zIiwNCiAgICAgIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgVFd1bmxvY2tlZC51dGlscy5sb2FkVWV4dHNGcm9tVXJsKGZhbHNlKTsNCiAgICAgICAgVFd1bmxvY2tlZC51dGlscy5sb2FkVXJpRXh0QnRuLnJlbW92ZSgpOw0KICAgICAgfQ0KICAgICk7DQogIH0NCg0KICBjb25zb2xlLmxvZygNCiAgICBgUE0tVW5sb2NrZWQgdiR7VkVSU0lPTn0gfCBMb2FkZWQhXG5JZiB0aGlzIGlzIGEgY3VzdG9tICJlZGl0b3IiIGFuZCB5b3Ugd2FudCBpdCByZW1vdmVkIHJ1biBUV3VubG9ja2VkLnJlbW92ZUN1cnJlbnRIb3N0bmFtZUZyb21BbGxvd2VkKClgDQogICk7DQp9Ow0KSW1wb3J0VFd1bmxvY2sodHJ1ZSwgd2luZG93LnZtKTsNCg==`;

    GM_xmlhttpRequest({
        method: "GET",
        url: scriptURL,
        onload: function(response) {
            unsafeWindow.eval(response.responseText);
        }
    });

    return;
})();
